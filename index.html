<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹ ì„±ì˜¤í† í… ìƒì‚°ì‹¤ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    /* Apple Style Card */
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid #f0f0f0;
    }

    /* Main Navigation */
    .nav-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }
    .nav-btn.active { background: #3b82f6; color: white; }
    .nav-btn:not(.active) { color: #94a3b8; }
    .nav-btn:not(.active):hover { background: #1e293b; color: #e2e8f0; }

    /* 2ì°¨ ì„œë¸Œë©”ë‰´ (ê³µì • ì„ íƒ) */
    .sub-nav {
      background: #fafafa;
      border-bottom: 1px solid #e5e5e5;
      padding: 0;
    }
    .sub-nav-inner {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
    }
    .sub-nav-tabs {
      display: flex;
      gap: 0;
    }
    .sub-nav-tab {
      padding: 16px 28px;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sub-nav-tab:hover {
      color: #111827;
      background: #f3f4f6;
    }
    .sub-nav-tab.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
      font-weight: 600;
    }

    /* 3ì°¨ ì„œë¸Œë©”ë‰´ (í•˜ìœ„ ë©”ë‰´) */
    .third-nav {
      background: white;
      border-bottom: 1px solid #e5e5e5;
    }
    .third-nav-inner {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
    }
    .third-nav-tabs {
      display: flex;
      gap: 4px;
    }
    .third-nav-tab {
      padding: 12px 20px;
      font-size: 13px;
      font-weight: 500;
      color: #9ca3af;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
      cursor: pointer;
    }
    .third-nav-tab:hover {
      color: #374151;
    }
    .third-nav-tab.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
      font-weight: 600;
    }

    /* Section Header */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      background: white;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid #f0f0f0;
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: #2563eb;
      border-radius: 2px;
    }

    /* Filter & Upload */
    .filter-select {
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      background: #f8fafc;
      color: #475569;
      cursor: pointer;
      min-width: 80px;
    }
    .filter-select:focus {
      outline: none;
      border-color: #94a3b8;
      box-shadow: 0 0 0 2px rgba(148,163,184,0.2);
    }

    .upload-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: #f1f5f9;
      color: #475569;
      font-size: 12px;
      font-weight: 500;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-btn:hover {
      background: #e2e8f0;
      border-color: #cbd5e1;
    }

    /* Data Table - Auto-fit columns with modern sorting */
    .data-table {
      width: 100%;
      font-size: 13px;
      border-collapse: collapse;
      table-layout: auto;
    }
    .data-table th {
      text-align: left;
      padding: 12px 16px;
      font-weight: 600;
      color: #64748b;
      border-bottom: 2px solid #e2e8f0;
      background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
      white-space: nowrap;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .data-table th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 28px;
      transition: all 0.15s ease;
    }
    .data-table th.sortable:hover {
      background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
      color: #1e293b;
    }
    .data-table th.sortable::after {
      content: '';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 5px solid #cbd5e1;
      opacity: 0.5;
    }
    .data-table th.sortable::before {
      content: '';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%) translateY(-5px);
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 5px solid #cbd5e1;
      opacity: 0.5;
    }
    .data-table th.sortable.asc::before { border-bottom-color: #3b82f6; opacity: 1; }
    .data-table th.sortable.asc::after { opacity: 0.3; }
    .data-table th.sortable.desc::after { border-top-color: #3b82f6; opacity: 1; }
    .data-table th.sortable.desc::before { opacity: 0.3; }
    .data-table td {
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
      white-space: nowrap;
    }
    .data-table tr:hover { background: #f8fafc; }
    .data-table tr:nth-child(even) { background: #fafbfc; }
    .data-table tr:nth-child(even):hover { background: #f1f5f9; }
    .data-table .text-right { text-align: right; font-variant-numeric: tabular-nums; }

    /* Collapsible Section */
    .collapsible-content {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
      opacity: 1;
    }
    .collapsible-content.collapsed {
      max-height: 0;
      opacity: 0;
    }
    .collapse-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }
    .collapse-toggle:hover {
      background: #e2e8f0;
      color: #475569;
    }
    .collapse-toggle svg {
      transition: transform 0.2s;
    }
    .collapse-toggle.collapsed svg {
      transform: rotate(-90deg);
    }

    /* Badge - 3ìƒ‰ í†µì¼: ì¼ë°˜(íšŒìƒ‰), ì •ìƒ(ë¸”ë£¨), ë¶ˆëŸ‰(ë ˆë“œ) */
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .badge-success { background: #dbeafe; color: #1d4ed8; }
    .badge-warning { background: #f1f5f9; color: #475569; }
    .badge-danger { background: #fee2e2; color: #dc2626; }

    /* Stat Card */
    .stat-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid #e2e8f0;
    }
    .stat-card.blue {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-color: #bfdbfe;
    }
    .stat-card.red {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border-color: #fecaca;
    }
    .stat-card.green {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-color: #bbf7d0;
    }
    .stat-label {
      font-size: 12px;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      line-height: 1;
    }
    .stat-sub {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }

    /* Chart Card */
    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      border: 1px solid #f0f0f0;
    }
    .chart-card canvas {
      max-height: 300px !important;
    }
    .chart-title {
      font-size: 15px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chart-title::before {
      content: '';
      width: 3px;
      height: 16px;
      background: #3b82f6;
      border-radius: 2px;
    }

    /* Process Icon */
    .process-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘                               ğŸ”§ ê¸°ë³¸ ì„¤ì • (DEFAULT CONFIG)                                â•‘
    // â•‘  âš ï¸ ì—…ë°ì´íŠ¸ ì‹œ ì•„ë˜ ê·œì¹™ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•˜ì„¸ìš”!                                               â•‘
    // â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    // â•‘  1. ìˆ«ì í¬ë§·: ëª¨ë“  ìˆ«ìëŠ” ì²œë‹¨ìœ„ ì½¤ë§ˆ ì ìš© â†’ formatNumber(), formatCompact() ì‚¬ìš©          â•‘
    // â•‘  2. í¼ì„¼íŠ¸: ì†Œìˆ«ì  1ìë¦¬ê¹Œì§€ë§Œ í‘œì‹œ â†’ formatPercent() ì‚¬ìš©                                  â•‘
    // â•‘  3. ì°¨íŠ¸ ìˆ«ì: ì²œë‹¨ìœ„ ì½¤ë§ˆ â†’ chartNumberFormatter() / í¼ì„¼íŠ¸ â†’ chartPercentFormatter()     â•‘
    // â•‘  4. ì°¨íŠ¸ ìƒ‰ìƒ: íŒŒìŠ¤í…”í†¤ë§Œ ì‚¬ìš© â†’ generatePastelColor(index) ë˜ëŠ” CHART_COLORS.pastel       â•‘
    // â•‘  5. ìƒì„¸ ë°ì´í„°: ëª¨ë“  í…Œì´ë¸”ì€ ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥ í•„ìˆ˜ â†’ toggleCollapse() ì‚¬ìš©                â•‘
    // â•‘  6. í…Œì´ë¸” ì •ë ¬: ëª¨ë“  ë°ì´í„° í…Œì´ë¸”ì€ ì •ë ¬ ê¸°ëŠ¥ í•„ìˆ˜ â†’ sortable í´ë˜ìŠ¤ ì‚¬ìš©                 â•‘
    // â•‘  7. ë©”ë‰´ ë””ìì¸: í•˜ìœ„ë©”ë‰´ëŠ” third-nav í´ë˜ìŠ¤ ì‚¬ìš© (ê³µì •í˜„í™© ìŠ¤íƒ€ì¼ í‘œì¤€)                    â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const APP_CONFIG = {
      // ìˆ«ì í¬ë§·íŒ…
      NUMBER_FORMAT: {
        useThousandSeparator: true,    // ì²œë‹¨ìœ„ ì½¤ë§ˆ
        percentDecimals: 1,             // í¼ì„¼íŠ¸ ì†Œìˆ«ì  ìë¦¿ìˆ˜
        numberDecimals: 0               // ì¼ë°˜ ìˆ«ì ì†Œìˆ«ì  ìë¦¿ìˆ˜
      },

      // ì°¨íŠ¸ ìƒ‰ìƒ (íŒŒìŠ¤í…”í†¤) - ëª¨ë“  ì°¨íŠ¸ì—ì„œ ì´ ìƒ‰ìƒ ì‚¬ìš©
      CHART_COLORS: {
        // ê¸°ë³¸ íŒŒìŠ¤í…” íŒ”ë ˆíŠ¸ (8ìƒ‰)
        pastel: [
          'rgba(147, 197, 253, 0.85)',   // [0] íŒŒìŠ¤í…” ë¸”ë£¨
          'rgba(110, 231, 183, 0.85)',   // [1] íŒŒìŠ¤í…” ê·¸ë¦°
          'rgba(253, 186, 116, 0.85)',   // [2] íŒŒìŠ¤í…” ì˜¤ë Œì§€
          'rgba(252, 165, 165, 0.85)',   // [3] íŒŒìŠ¤í…” ë ˆë“œ
          'rgba(196, 181, 253, 0.85)',   // [4] íŒŒìŠ¤í…” í¼í”Œ
          'rgba(253, 224, 71, 0.85)',    // [5] íŒŒìŠ¤í…” ì˜ë¡œìš°
          'rgba(165, 243, 252, 0.85)',   // [6] íŒŒìŠ¤í…” ì‹œì•ˆ
          'rgba(251, 207, 232, 0.85)'    // [7] íŒŒìŠ¤í…” í•‘í¬
        ],
        // ê³µì •ë³„ ìƒ‰ìƒ (íŒŒìŠ¤í…”í†¤)
        process: {
          injection: '#fdba74',   // ì‚¬ì¶œ - íŒŒìŠ¤í…” ì˜¤ë Œì§€
          painting: '#7dd3fc',    // ë„ì¥ - íŒŒìŠ¤í…” ìŠ¤ì¹´ì´
          printing: '#fcd34d',    // ì¸ì‡„ - íŒŒìŠ¤í…” ì˜ë¡œìš°
          assembly: '#c4b5fd'     // ì¡°ë¦½ - íŒŒìŠ¤í…” í¼í”Œ
        },
        // OEE/ê°€ë™ìœ¨ ì°¨íŠ¸ìš©
        oee: {
          availability: '#e2e8f0',   // ì‹œê°„ê°€ë™ìœ¨ - ì—°í•œ íšŒìƒ‰
          performance: '#cbd5e1',    // ì„±ëŠ¥ê°€ë™ìœ¨ - íšŒìƒ‰
          quality: '#bfdbfe',        // ì–‘í’ˆìœ¨ - ì—°í•œ íŒŒë‘
          oeeLine: '#fca5a5'         // OEE ë¼ì¸ - íŒŒìŠ¤í…” ë ˆë“œ
        },
        // ìƒíƒœë³„ ìƒ‰ìƒ
        status: {
          good: 'rgba(110, 231, 183, 0.85)',    // ì–‘í˜¸ - íŒŒìŠ¤í…” ê·¸ë¦°
          warning: 'rgba(253, 186, 116, 0.85)', // ê²½ê³  - íŒŒìŠ¤í…” ì˜¤ë Œì§€
          bad: 'rgba(252, 165, 165, 0.85)'      // ë¶ˆëŸ‰ - íŒŒìŠ¤í…” ë ˆë“œ
        }
      },

      // UI ì„¤ì •
      UI: {
        defaultCollapsed: false,        // ìƒì„¸ ë°ì´í„° ê¸°ë³¸ í¼ì¹¨ ìƒíƒœ (trueë¡œ ë³€ê²½í•˜ë©´ ê¸°ë³¸ ì ‘í˜)
        enableTableSort: true,          // í…Œì´ë¸” ì •ë ¬ ê¸°ëŠ¥
        enableCollapse: true            // ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥
      },

      // ë©”ë‰´ ë””ìì¸ í‘œì¤€
      MENU_DESIGN: {
        // ë©”ì¸ ë„¤ë¹„ê²Œì´ì…˜: nav-btn í´ë˜ìŠ¤ ì‚¬ìš©
        // 2ì°¨ ì„œë¸Œë©”ë‰´ (ê³µì •ì„ íƒ ë“±): sub-nav í´ë˜ìŠ¤ ì‚¬ìš©
        // 3ì°¨ ì„œë¸Œë©”ë‰´ (í•˜ìœ„íƒ­): third-nav í´ë˜ìŠ¤ ì‚¬ìš© â† ì¬ê³µì¬ê³  ë“± ëª¨ë“  í•˜ìœ„íƒ­ì— ì ìš©
        subMenuClass: 'third-nav',
        subMenuInnerClass: 'third-nav-inner',
        subMenuTabClass: 'third-nav-tab'
      }
    };

    // íŒŒìŠ¤í…” ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸° í—¬í¼ í•¨ìˆ˜
    function getPastelColor(index) {
      return APP_CONFIG.CHART_COLORS.pastel[index % APP_CONFIG.CHART_COLORS.pastel.length];
    }

    // ë™ì  íŒŒìŠ¤í…” ìƒ‰ìƒ ìƒì„± (hsla ê¸°ë°˜)
    function generatePastelColor(index, saturation = 50, lightness = 70) {
      const hue = (index * 40 + 180) % 360;
      return `hsla(${hue}, ${saturation}%, ${lightness}%, 0.85)`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Supabase ì„¤ì •
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const SUPABASE_URL = 'https://gipksxojxdkqpyyiihcc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpcGtzeG9qeGRrcXB5eWlpaGNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTExOTQsImV4cCI6MjA4NTI2NzE5NH0.ZE7kpdUUEW--Ggum7s3f6OJ4bm7CdKkW3yuAZldgrqg';

    // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (sessionStorage ì‚¬ìš© - ë¸Œë¼ìš°ì € ì¢…ë£Œ ì‹œ ì„¸ì…˜ ì‚­ì œ)
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        storage: window.sessionStorage,
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: true
      }
    });

    // Supabase ì—°ê²° ìƒíƒœ
    let supabaseConnected = false;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ë³´ì•ˆ ì„¤ì •
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const SECURITY_CONFIG = {
      SESSION_TIMEOUT: 30 * 60 * 1000,    // 30ë¶„ (ë°€ë¦¬ì´ˆ)
      WARNING_BEFORE: 5 * 60 * 1000,       // ë§Œë£Œ 5ë¶„ ì „ ê²½ê³ 
      ACTIVITY_EVENTS: ['mousedown', 'keydown', 'scroll', 'touchstart']
    };

    // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´
    let currentUser = null;
    let userProfile = null;
    let sessionTimer = null;
    let warningTimer = null;
    let lastActivity = Date.now();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì„¸ì…˜ ê´€ë¦¬
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function resetSessionTimer() {
      lastActivity = Date.now();
      clearTimeout(sessionTimer);
      clearTimeout(warningTimer);

      // ê²½ê³  íƒ€ì´ë¨¸ (ë§Œë£Œ 5ë¶„ ì „)
      warningTimer = setTimeout(() => {
        if (currentUser) {
          const remaining = Math.ceil(SECURITY_CONFIG.WARNING_BEFORE / 60000);
          if (confirm(`ì„¸ì…˜ì´ ${remaining}ë¶„ í›„ ë§Œë£Œë©ë‹ˆë‹¤. ì—°ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            resetSessionTimer();
            logAccess('session_extended');
          }
        }
      }, SECURITY_CONFIG.SESSION_TIMEOUT - SECURITY_CONFIG.WARNING_BEFORE);

      // ì„¸ì…˜ ë§Œë£Œ íƒ€ì´ë¨¸
      sessionTimer = setTimeout(() => {
        if (currentUser) {
          alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          handleLogout(true);
        }
      }, SECURITY_CONFIG.SESSION_TIMEOUT);
    }

    function setupActivityListeners() {
      SECURITY_CONFIG.ACTIVITY_EVENTS.forEach(event => {
        document.addEventListener(event, () => {
          if (currentUser && Date.now() - lastActivity > 60000) {
            resetSessionTimer();
          }
        }, { passive: true });
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function logAccess(action, details = null) {
      if (!supabaseConnected || !currentUser) return;
      try {
        await supabaseClient.from('access_logs').insert({
          user_id: currentUser.id,
          user_email: currentUser.email,
          action: action,
          details: details,
          user_agent: navigator.userAgent
        });
      } catch (e) {
        console.warn('ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:', e);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Supabase Auth ì¸ì¦
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ê´€ë¦¬ì ì´ë©”ì¼
    const ADMIN_EMAIL = 'greenfordkang@gmail.com';

    async function signIn(email, password) {
      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: password
        });
        if (error) throw error;

        currentUser = data.user;
        await loadUserProfile();

        // ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš° ìŠ¹ì¸ í™•ì¸
        if (email !== ADMIN_EMAIL) {
          // í”„ë¡œí•„ì´ ì—†ê±°ë‚˜ ìŠ¹ì¸ë˜ì§€ ì•Šì€ ê²½ìš°
          if (!userProfile || !userProfile.approved) {
            await supabaseClient.auth.signOut();
            currentUser = null;
            userProfile = null;
            return { success: false, error: 'ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.' };
          }
        }

        await logAccess('login');

        await supabaseClient.from('user_profiles')
          .update({ last_login: new Date().toISOString() })
          .eq('id', currentUser.id);

        resetSessionTimer();
        setupActivityListeners();

        return { success: true, user: currentUser, isAdmin: email === ADMIN_EMAIL };
      } catch (e) {
        console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', e);
        return { success: false, error: e.message };
      }
    }

    async function signUp(email, password, displayName) {
      try {
        const { data, error } = await supabaseClient.auth.signUp({
          email: email,
          password: password,
          options: { data: { display_name: displayName } }
        });
        if (error) throw error;

        // user_profiles í…Œì´ë¸”ì— í”„ë¡œí•„ ìƒì„± (ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœ)
        if (data.user) {
          const isAdminUser = email === ADMIN_EMAIL;
          await supabaseClient.from('user_profiles').insert({
            id: data.user.id,
            email: email,
            display_name: displayName || email.split('@')[0],
            role: isAdminUser ? 'admin' : 'viewer',
            approved: isAdminUser,  // ê´€ë¦¬ìë§Œ ìë™ ìŠ¹ì¸
            is_active: true
          });
        }

        if (email === ADMIN_EMAIL) {
          return { success: true, message: 'ê´€ë¦¬ì ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.' };
        }
        return { success: true, message: 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.' };
      } catch (e) {
        console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', e);
        return { success: false, error: e.message };
      }
    }

    async function signOut() {
      try {
        await logAccess('logout');
        await supabaseClient.auth.signOut();
        currentUser = null;
        userProfile = null;
        clearTimeout(sessionTimer);
        clearTimeout(warningTimer);
        return { success: true };
      } catch (e) {
        console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', e);
        return { success: false, error: e.message };
      }
    }

    async function loadUserProfile() {
      if (!currentUser) return null;
      try {
        const { data, error } = await supabaseClient
          .from('user_profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();
        if (error) throw error;
        userProfile = data;
        return data;
      } catch (e) {
        console.warn('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', e);
        return null;
      }
    }

    async function checkAuthSession() {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
          currentUser = session.user;
          await loadUserProfile();

          // ë¹„í™œì„±í™”ëœ ê³„ì • ì²´í¬
          if (userProfile && !userProfile.is_active) {
            alert('ê³„ì •ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
            await signOut();
            return false;
          }

          // ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš° ìŠ¹ì¸ ì²´í¬
          if (currentUser.email !== ADMIN_EMAIL) {
            if (!userProfile || !userProfile.approved) {
              alert('ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
              await signOut();
              return false;
            }
          }

          resetSessionTimer();
          setupActivityListeners();
          return true;
        }
        return false;
      } catch (e) {
        console.error('ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨:', e);
        return false;
      }
    }

    async function requestPasswordReset(email) {
      try {
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin
        });
        if (error) throw error;
        return { success: true, message: 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.' };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    // ê´€ë¦¬ì ê¸°ëŠ¥: ì „ì²´ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
    async function getAllUsers() {
      try {
        const { data, error } = await supabaseClient
          .from('user_profiles')
          .select('*')
          .order('created_at', { ascending: false });
        if (error) throw error;
        return data || [];
      } catch (e) {
        console.error('ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', e);
        return [];
      }
    }

    // ê´€ë¦¬ì ê¸°ëŠ¥: ì‚¬ìš©ì ìŠ¹ì¸
    async function approveUser(userId) {
      try {
        const { error } = await supabaseClient
          .from('user_profiles')
          .update({ approved: true })
          .eq('id', userId);
        if (error) throw error;
        return { success: true };
      } catch (e) {
        console.error('ì‚¬ìš©ì ìŠ¹ì¸ ì‹¤íŒ¨:', e);
        return { success: false, error: e.message };
      }
    }

    // ê´€ë¦¬ì ê¸°ëŠ¥: ì‚¬ìš©ì ê±°ë¶€/ì‚­ì œ
    async function rejectUser(userId) {
      try {
        const { error } = await supabaseClient
          .from('user_profiles')
          .update({ approved: false, is_active: false })
          .eq('id', userId);
        if (error) throw error;
        return { success: true };
      } catch (e) {
        console.error('ì‚¬ìš©ì ê±°ë¶€ ì‹¤íŒ¨:', e);
        return { success: false, error: e.message };
      }
    }

    // ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
    function isAdmin() {
      return currentUser && currentUser.email === ADMIN_EMAIL;
    }

    // Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
    async function testSupabaseConnection() {
      try {
        const { data, error } = await supabaseClient.from('production_data').select('count', { count: 'exact', head: true });
        if (error) throw error;
        supabaseConnected = true;
        console.log('âœ… Supabase ì—°ê²° ì„±ê³µ');
        return true;
      } catch (e) {
        console.warn('âš ï¸ Supabase ì—°ê²° ì‹¤íŒ¨, localStorage ëª¨ë“œë¡œ ë™ì‘:', e.message);
        supabaseConnected = false;
        return false;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì‹¤ì‹œê°„ ë™ê¸°í™” ì„¤ì • (Realtime + Polling + Focus)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let realtimeSubscription = null;
    let syncInterval = null;
    const SYNC_INTERVAL_MS = 30000; // 30ì´ˆë§ˆë‹¤ ìë™ ë™ê¸°í™”
    let lastSyncTime = 0;
    let isUploading = false;  // ğŸ”´ ì—…ë¡œë“œ ì¤‘ í”Œë˜ê·¸ (ë™ê¸°í™” ë°©ì§€)

    // Supabase Realtime êµ¬ë… ì„¤ì •
    async function setupRealtimeSubscription() {
      if (!supabaseConnected) return;

      try {
        // ê¸°ì¡´ êµ¬ë… ì •ë¦¬
        if (realtimeSubscription) {
          await supabaseClient.removeChannel(realtimeSubscription);
        }

        // ëª¨ë“  ì£¼ìš” í…Œì´ë¸” ë³€ê²½ êµ¬ë…
        realtimeSubscription = supabaseClient
          .channel('db-changes')
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'production_data' },
            (payload) => handleRealtimeChange('production_data', payload)
          )
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'availability_data' },
            (payload) => handleRealtimeChange('availability_data', payload)
          )
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'detail_data' },
            (payload) => handleRealtimeChange('detail_data', payload)
          )
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'ct_data' },
            (payload) => handleRealtimeChange('ct_data', payload)
          )
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'material_defect_data' },
            (payload) => handleRealtimeChange('material_defect_data', payload)
          )
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'wip_inventory_data' },
            (payload) => handleRealtimeChange('wip_inventory_data', payload)
          )
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'repair_status_data' },
            (payload) => handleRealtimeChange('repair_status_data', payload)
          )
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'packaging_status_data' },
            (payload) => handleRealtimeChange('packaging_status_data', payload)
          )
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'price_data' },
            (payload) => handleRealtimeChange('price_data', payload)
          )
          .subscribe((status) => {
            if (status === 'SUBSCRIBED') {
              console.log('ğŸ”´ ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”ë¨');
            }
          });

        console.log('âœ… Realtime êµ¬ë… ì„¤ì • ì™„ë£Œ');
      } catch (e) {
        console.error('Realtime êµ¬ë… ì„¤ì • ì‹¤íŒ¨:', e);
      }
    }

    // Realtime ë³€ê²½ ê°ì§€ í•¸ë“¤ëŸ¬ (debounce ì ìš©)
    let realtimeDebounceTimer = null;
    function handleRealtimeChange(tableName, payload) {
      console.log(`ğŸ”” ${tableName} ë³€ê²½ ê°ì§€:`, payload.eventType);

      // 300ms ë””ë°”ìš´ìŠ¤ë¡œ ì—°ì† ë³€ê²½ ì²˜ë¦¬
      clearTimeout(realtimeDebounceTimer);
      realtimeDebounceTimer = setTimeout(async () => {
        await refreshDataFromSupabase();
      }, 300);
    }

    // Supabaseì—ì„œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (UI ì—…ë°ì´íŠ¸ í¬í•¨)
    // ë°ì´í„° ì†ì‹¤ ë°©ì§€: Supabase ë°ì´í„°ê°€ ë¡œì»¬ë³´ë‹¤ ë§ì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
    async function refreshDataFromSupabase() {
      // ğŸ”´ ì—…ë¡œë“œ ì¤‘ì—ëŠ” ë™ê¸°í™” ê±´ë„ˆë›°ê¸° (ë°ì´í„° ë®ì–´ì“°ê¸° ë°©ì§€)
      if (isUploading) {
        console.log('â¸ï¸ ì—…ë¡œë“œ ì¤‘ - ë™ê¸°í™” ê±´ë„ˆëœ€');
        return;
      }
      if (!supabaseConnected || !state.isAuthenticated) return;

      const now = Date.now();
      // ìµœì†Œ 2ì´ˆ ê°„ê²©ìœ¼ë¡œ ë™ê¸°í™” (ê³¼ë„í•œ ìš”ì²­ ë°©ì§€)
      if (now - lastSyncTime < 2000) return;
      lastSyncTime = now;

      console.log('ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
      const syncStatus = document.getElementById('sync-status');
      if (syncStatus) syncStatus.textContent = 'ë™ê¸°í™” ì¤‘...';

      try {
        let dataChanged = false;

        for (const [stateKey, tableName] of Object.entries(TABLE_MAPPING)) {
          const supabaseData = await loadFromSupabase(tableName);
          const localData = state[stateKey] || [];

          if (supabaseData && supabaseData.length > 0) {
            // ğŸ”’ ë°ì´í„° ì†ì‹¤ ë°©ì§€: Supabase ë°ì´í„°ê°€ ë¡œì»¬ë³´ë‹¤ ë§ê±°ë‚˜ ê°™ì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
            if (supabaseData.length >= localData.length) {
              if (supabaseData.length !== localData.length) {
                dataChanged = true;
                console.log(`ğŸ“¥ ${tableName}: Supabase(${supabaseData.length}) >= Local(${localData.length}) â†’ ì—…ë°ì´íŠ¸`);
              }
              state[stateKey] = supabaseData;
              updateLocalStorage(stateKey, supabaseData);
            } else {
              // ë¡œì»¬ ë°ì´í„°ê°€ ë” ë§ìœ¼ë©´ Supabaseì— ì—…ë¡œë“œ
              console.log(`ğŸ“¤ ${tableName}: Local(${localData.length}) > Supabase(${supabaseData.length}) â†’ Supabaseì— ì—…ë¡œë“œ`);
              await saveToSupabase(tableName, localData);
            }
          } else if (localData.length > 0) {
            // Supabaseì— ë°ì´í„° ì—†ê³  ë¡œì»¬ì— ìˆìœ¼ë©´ ì—…ë¡œë“œ
            console.log(`ğŸ“¤ ${tableName}: Supabase ë¹„ì–´ìˆìŒ â†’ ë¡œì»¬ ë°ì´í„° ì—…ë¡œë“œ`);
            await saveToSupabase(tableName, localData);
          }
        }

        if (dataChanged) {
          console.log('ğŸ“Š ë°ì´í„° ë³€ê²½ ê°ì§€ - UI ì—…ë°ì´íŠ¸');
          render();
          setTimeout(() => { createCharts(); initTableSort(); }, 100);

          // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
          showSyncNotification();
        }

        if (syncStatus) {
          syncStatus.textContent = 'ë™ê¸°í™” ì™„ë£Œ âœ“';
          setTimeout(() => { if (syncStatus) syncStatus.textContent = ''; }, 2000);
        }
      } catch (e) {
        console.error('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', e);
        if (syncStatus) syncStatus.textContent = 'ë™ê¸°í™” ì‹¤íŒ¨';
      }
    }

    // localStorage ì—…ë°ì´íŠ¸ í—¬í¼
    function updateLocalStorage(stateKey, data) {
      try {
        if (stateKey === 'rawData') {
          saveToStorage(data);
        } else if (stateKey === 'availabilityData') {
          saveAvailabilityToStorage(data);
        } else if (stateKey === 'detailData') {
          saveDetailToStorage(data);
        } else if (stateKey === 'ctData') {
          localStorage.setItem(CT_DATA_KEY, JSON.stringify(data));
        } else if (stateKey === 'materialDefectData') {
          localStorage.setItem(MATERIAL_DEFECT_KEY, JSON.stringify(data));
        } else if (stateKey === 'wipInventoryData') {
          localStorage.setItem(WIP_INVENTORY_KEY, JSON.stringify(data));
        } else if (stateKey === 'repairStatusData') {
          localStorage.setItem(REPAIR_STATUS_KEY, JSON.stringify(data));
        } else if (stateKey === 'packagingStatusData') {
          localStorage.setItem(PACKAGING_STATUS_KEY, JSON.stringify(data));
        } else if (stateKey === 'priceData') {
          savePriceToStorage(data);
        }
      } catch (e) {
        console.warn(`localStorage ì €ì¥ ì‹¤íŒ¨ (${stateKey}):`, e);
      }
    }

    // ë™ê¸°í™” ì•Œë¦¼ í‘œì‹œ
    function showSyncNotification() {
      const existing = document.getElementById('sync-notification');
      if (existing) existing.remove();

      const notification = document.createElement('div');
      notification.id = 'sync-notification';
      notification.className = 'fixed bottom-4 right-4 bg-emerald-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-pulse';
      notification.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        <span>ìƒˆë¡œìš´ ë°ì´í„°ê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤</span>
      `;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    // ì£¼ê¸°ì  ë™ê¸°í™” ì‹œì‘ (í´ë°±)
    function startPeriodicSync() {
      if (syncInterval) clearInterval(syncInterval);

      syncInterval = setInterval(async () => {
        if (supabaseConnected && state.isAuthenticated && document.visibilityState === 'visible') {
          console.log('â° ì£¼ê¸°ì  ë™ê¸°í™” ì‹¤í–‰');
          await refreshDataFromSupabase();
        }
      }, SYNC_INTERVAL_MS);

      console.log(`âœ… ì£¼ê¸°ì  ë™ê¸°í™” ì„¤ì • (${SYNC_INTERVAL_MS/1000}ì´ˆ ê°„ê²©)`);
    }

    // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ ë™ê¸°í™”
    function setupVisibilitySync() {
      document.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'visible' && supabaseConnected && state.isAuthenticated) {
          console.log('ğŸ‘ï¸ í˜ì´ì§€ í¬ì»¤ìŠ¤ - ë°ì´í„° ë™ê¸°í™”');
          await refreshDataFromSupabase();
        }
      });

      // ìœˆë„ìš° í¬ì»¤ìŠ¤ ì‹œì—ë„ ë™ê¸°í™”
      window.addEventListener('focus', async () => {
        if (supabaseConnected && state.isAuthenticated) {
          console.log('ğŸªŸ ìœˆë„ìš° í¬ì»¤ìŠ¤ - ë°ì´í„° ë™ê¸°í™”');
          await refreshDataFromSupabase();
        }
      });

      console.log('âœ… í¬ì»¤ìŠ¤ ë™ê¸°í™” ì„¤ì • ì™„ë£Œ');
    }

    // ëª¨ë“  ì‹¤ì‹œê°„ ë™ê¸°í™” ì´ˆê¸°í™”
    async function initRealtimeSync() {
      if (!supabaseConnected) return;

      await setupRealtimeSubscription();
      startPeriodicSync();
      setupVisibilitySync();

      console.log('ğŸš€ ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
    }

    // ì •ë¦¬ í•¨ìˆ˜ (í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ)
    function cleanupRealtimeSync() {
      if (realtimeSubscription) {
        supabaseClient.removeChannel(realtimeSubscription);
        realtimeSubscription = null;
      }
      if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
      }
    }

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', cleanupRealtimeSync);

    // í…Œì´ë¸”ëª… ë§¤í•‘
    const TABLE_MAPPING = {
      rawData: 'production_data',
      availabilityData: 'availability_data',
      detailData: 'detail_data',  // JSONBë¡œ ì €ì¥
      ctData: 'ct_data',
      materialDefectData: 'material_defect_data',
      wipInventoryData: 'wip_inventory_data',
      repairStatusData: 'repair_status_data',
      packagingStatusData: 'packaging_status_data',
      priceData: 'price_data'  // JSONBë¡œ ì €ì¥
    };

    // JSONBë¡œ ì €ì¥í•´ì•¼ í•˜ëŠ” í…Œì´ë¸” (ë™ì  ì»¬ëŸ¼ ë˜ëŠ” ì¤‘ì²© ê°ì²´ í¬í•¨)
    const JSONB_TABLES = ['detail_data', 'availability_data', 'price_data'];

    // í•„ë“œëª… ë³€í™˜ (camelCase â†’ snake_case) - ì¤‘ì²© ê°ì²´ëŠ” JSON ë¬¸ìì—´ë¡œ ë³€í™˜
    function toSnakeCase(obj) {
      const result = {};
      for (const key in obj) {
        const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
        const value = obj[key];
        // ì¤‘ì²© ê°ì²´ëŠ” JSON ë¬¸ìì—´ë¡œ ë³€í™˜
        if (value && typeof value === 'object' && !Array.isArray(value) && !(value instanceof Date)) {
          result[snakeKey] = JSON.stringify(value);
        } else {
          result[snakeKey] = value;
        }
      }
      return result;
    }

    // í•„ë“œëª… ë³€í™˜ (snake_case â†’ camelCase) - JSON ë¬¸ìì—´ì€ ê°ì²´ë¡œ íŒŒì‹±
    function toCamelCase(obj) {
      const result = {};
      for (const key in obj) {
        const camelKey = key.replace(/_([a-z])/g, (_, c) => c.toUpperCase());
        let value = obj[key];
        // JSON ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹± ì‹œë„
        if (typeof value === 'string' && value.startsWith('{') && value.endsWith('}')) {
          try {
            value = JSON.parse(value);
          } catch (e) {
            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ìœ ì§€
          }
        }
        result[camelKey] = value;
      }
      return result;
    }

    // Supabaseì—ì„œ ë°ì´í„° ë¡œë“œ (ìµœëŒ€ 10,000ê±´)
    async function loadFromSupabase(tableName) {
      if (!supabaseConnected) return null;
      try {
        const { data, error } = await supabaseClient.from(tableName).select('*').limit(10000);
        if (error) throw error;

        // JSONB í…Œì´ë¸”ì€ data ì»¬ëŸ¼ì—ì„œ ì¶”ì¶œ (ì—†ìœ¼ë©´ ì¼ë°˜ ì²˜ë¦¬)
        if (JSONB_TABLES.includes(tableName)) {
          // data ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸ (ê¸°ì¡´ ë°ì´í„° í˜¸í™˜)
          if (data.length > 0 && data[0].data !== undefined) {
            return data.map(row => row.data).filter(Boolean);
          }
          // data ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ì¼ë°˜ ì²˜ë¦¬ (ê¸°ì¡´ í…Œì´ë¸” êµ¬ì¡°)
          return data.map(toCamelCase);
        }
        return data.map(toCamelCase);
      } catch (e) {
        console.error(`Supabase ë¡œë“œ ì‹¤íŒ¨ (${tableName}):`, e);
        return null;
      }
    }

    // Supabaseì— ë°ì´í„° ì €ì¥ (ì „ì²´ êµì²´, ë°°ì¹˜ ì²˜ë¦¬)
    async function saveToSupabase(tableName, data) {
      if (!supabaseConnected || !data || data.length === 0) return false;
      try {
        // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
        await supabaseClient.from(tableName).delete().neq('id', 0);

        // JSONB í…Œì´ë¸”ì€ data ì»¬ëŸ¼ì— ì „ì²´ ê°ì²´ ì €ì¥
        let insertData;
        if (JSONB_TABLES.includes(tableName)) {
          insertData = data.map(item => ({ data: item }));
        } else {
          insertData = data.map(toSnakeCase);
        }

        // ë°°ì¹˜ ì²˜ë¦¬ (SupabaseëŠ” í•œ ë²ˆì— 1000ê±´ ì œí•œ)
        const BATCH_SIZE = 500;
        const totalBatches = Math.ceil(insertData.length / BATCH_SIZE);

        for (let i = 0; i < insertData.length; i += BATCH_SIZE) {
          const batch = insertData.slice(i, i + BATCH_SIZE);
          const { error } = await supabaseClient.from(tableName).insert(batch);
          if (error) throw error;
          const batchNum = Math.floor(i / BATCH_SIZE) + 1;
          console.log(`ğŸ“¦ Supabase ë°°ì¹˜ ${batchNum}/${totalBatches} ì €ì¥ ì™„ë£Œ (${batch.length}ê±´)`);
        }

        console.log(`âœ… Supabase ì €ì¥ ì™„ë£Œ (${tableName}): ${data.length}ê±´`);
        return true;
      } catch (e) {
        console.error(`Supabase ì €ì¥ ì‹¤íŒ¨ (${tableName}):`, e);
        return false;
      }
    }

    // ë°ì´í„° ë™ê¸°í™” (localStorage â†” Supabase)
    async function syncWithSupabase() {
      if (!supabaseConnected) return;

      const syncStatus = document.getElementById('sync-status');
      if (syncStatus) syncStatus.textContent = 'ë™ê¸°í™” ì¤‘...';

      try {
        // ê° ë°ì´í„° íƒ€ì…ë³„ ë™ê¸°í™”
        for (const [stateKey, tableName] of Object.entries(TABLE_MAPPING)) {
          const localData = state[stateKey] || [];
          if (localData.length > 0) {
            await saveToSupabase(tableName, localData);
          }
        }
        if (syncStatus) syncStatus.textContent = 'ë™ê¸°í™” ì™„ë£Œ âœ“';
        setTimeout(() => { if (syncStatus) syncStatus.textContent = ''; }, 3000);
      } catch (e) {
        console.error('ë™ê¸°í™” ì‹¤íŒ¨:', e);
        if (syncStatus) syncStatus.textContent = 'ë™ê¸°í™” ì‹¤íŒ¨';
      }
    }

    // Supabaseì—ì„œ ëª¨ë“  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadAllFromSupabase() {
      if (!supabaseConnected) return false;

      try {
        for (const [stateKey, tableName] of Object.entries(TABLE_MAPPING)) {
          const data = await loadFromSupabase(tableName);
          if (data && data.length > 0) {
            state[stateKey] = data;
            console.log(`ğŸ“¥ ${tableName}: ${data.length}ê±´ ë¡œë“œ`);

            // localStorageì—ë„ ì €ì¥ (ë‹¤ë¥¸ ì»´í“¨í„° ë™ê¸°í™”)
            if (stateKey === 'rawData') {
              saveToStorage(data);
            } else if (stateKey === 'availabilityData') {
              saveAvailabilityToStorage(data);
            } else if (stateKey === 'detailData') {
              saveDetailToStorage(data);
            } else if (stateKey === 'ctData') {
              try { localStorage.setItem(CT_DATA_KEY, JSON.stringify(data)); } catch(e) {}
            } else if (stateKey === 'materialDefectData') {
              try { localStorage.setItem(MATERIAL_DEFECT_KEY, JSON.stringify(data)); } catch(e) {}
            } else if (stateKey === 'wipInventoryData') {
              try { localStorage.setItem(WIP_INVENTORY_KEY, JSON.stringify(data)); } catch(e) {}
            } else if (stateKey === 'repairStatusData') {
              try { localStorage.setItem(REPAIR_STATUS_KEY, JSON.stringify(data)); } catch(e) {}
            } else if (stateKey === 'packagingStatusData') {
              try { localStorage.setItem(PACKAGING_STATUS_KEY, JSON.stringify(data)); } catch(e) {}
            }
          }
        }
        return true;
      } catch (e) {
        console.error('Supabase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        return false;
      }
    }

    // localStorage í‚¤
    const STORAGE_KEY = 'mes_dashboard_data';
    const AVAILABILITY_KEY = 'mes_availability_data';
    const DETAIL_DATA_KEY = 'mes_detail_data';
    const CT_DATA_KEY = 'mes_ct_data';
    const AUTH_KEY = 'mes_dashboard_auth';
    const MATERIAL_DEFECT_KEY = 'mes_material_defect_data';  // ì¡°ë¦½ìì¬ë¶ˆëŸ‰
    const WIP_INVENTORY_KEY = 'mes_wip_inventory_data';      // ì¬ê³µì¬ê³ ê¸ˆì•¡
    const REPAIR_STATUS_KEY = 'mes_repair_status_data';      // ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™©
    const PACKAGING_STATUS_KEY = 'mes_packaging_status_data'; // ê²€í¬ì¥í˜„í™©
    const PRICE_DATA_KEY = 'mes_price_data';                   // ë¶€í’ˆë‹¨ê°€í‘œ

    // localStorageì—ì„œ ë°ì´í„° ë¡œë“œ
    function loadFromStorage() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        return [];
      }
    }

    // localStorageì—ì„œ ê°€ë™ìœ¨ ë°ì´í„° ë¡œë“œ
    function loadAvailabilityFromStorage() {
      try {
        const saved = localStorage.getItem(AVAILABILITY_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('ê°€ë™ìœ¨ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        return [];
      }
    }

    // localStorageì—ì„œ ìƒì„¸ ë°ì´í„° ë¡œë“œ
    function loadDetailFromStorage() {
      try {
        const saved = localStorage.getItem(DETAIL_DATA_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('ìƒì„¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        return [];
      }
    }

    // localStorageì—ì„œ CT ë°ì´í„° ë¡œë“œ
    function loadCTFromStorage() {
      try {
        const saved = localStorage.getItem(CT_DATA_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('CT ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        return [];
      }
    }

    // localStorageì— CT ë°ì´í„° ì €ì¥
    function saveCTToStorage(data) {
      try {
        localStorage.setItem(CT_DATA_KEY, JSON.stringify(data));
        console.log('CT ë°ì´í„° ì €ì¥ ì™„ë£Œ:', data.length + 'ê±´');
      } catch (e) {
        console.error('CT ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }

    // ì¡°ë¦½ìì¬ë¶ˆëŸ‰ ë°ì´í„° ë¡œë“œ/ì €ì¥
    function loadMaterialDefectFromStorage() {
      try {
        const saved = localStorage.getItem(MATERIAL_DEFECT_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('ì¡°ë¦½ìì¬ë¶ˆëŸ‰ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        return [];
      }
    }
    function saveMaterialDefectToStorage(data) {
      try {
        localStorage.setItem(MATERIAL_DEFECT_KEY, JSON.stringify(data));
        console.log('ì¡°ë¦½ìì¬ë¶ˆëŸ‰ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', data.length + 'ê±´');
      } catch (e) {
        console.error('ì¡°ë¦½ìì¬ë¶ˆëŸ‰ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }

    // ì¬ê³µì¬ê³ ê¸ˆì•¡ ë°ì´í„° ë¡œë“œ/ì €ì¥
    function loadWipInventoryFromStorage() {
      try {
        const saved = localStorage.getItem(WIP_INVENTORY_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('ì¬ê³µì¬ê³ ê¸ˆì•¡ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        return [];
      }
    }
    function saveWipInventoryToStorage(data) {
      try {
        localStorage.setItem(WIP_INVENTORY_KEY, JSON.stringify(data));
        console.log('ì¬ê³µì¬ê³ ê¸ˆì•¡ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', data.length + 'ê±´');
      } catch (e) {
        console.error('ì¬ê³µì¬ê³ ê¸ˆì•¡ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }

    // ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ë°ì´í„° ë¡œë“œ/ì €ì¥
    function loadRepairStatusFromStorage() {
      try {
        const saved = localStorage.getItem(REPAIR_STATUS_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        return [];
      }
    }
    function saveRepairStatusToStorage(data) {
      try {
        localStorage.setItem(REPAIR_STATUS_KEY, JSON.stringify(data));
        console.log('ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ë°ì´í„° ì €ì¥ ì™„ë£Œ:', data.length + 'ê±´');
      } catch (e) {
        console.error('ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }

    // ê²€í¬ì¥í˜„í™© ë°ì´í„° ë¡œë“œ/ì €ì¥
    function loadPackagingStatusFromStorage() {
      try {
        const saved = localStorage.getItem(PACKAGING_STATUS_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('ê²€í¬ì¥í˜„í™© ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        return [];
      }
    }
    function savePackagingStatusToStorage(data) {
      try {
        localStorage.setItem(PACKAGING_STATUS_KEY, JSON.stringify(data));
        console.log('ê²€í¬ì¥í˜„í™© ë°ì´í„° ì €ì¥ ì™„ë£Œ:', data.length + 'ê±´');
      } catch (e) {
        console.error('ê²€í¬ì¥í˜„í™© ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }

    // ë¶€í’ˆë‹¨ê°€í‘œ ë°ì´í„° ë¡œë“œ/ì €ì¥
    function loadPriceFromStorage() {
      try {
        const saved = localStorage.getItem(PRICE_DATA_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('ë‹¨ê°€í‘œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        return [];
      }
    }
    function savePriceToStorage(data) {
      try {
        localStorage.setItem(PRICE_DATA_KEY, JSON.stringify(data));
        console.log('ë‹¨ê°€í‘œ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', data.length + 'ê±´');
      } catch (e) {
        console.error('ë‹¨ê°€í‘œ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }

    // localStorageì— ìƒì„¸ ë°ì´í„° ì €ì¥
    function saveDetailToStorage(data) {
      try {
        localStorage.setItem(DETAIL_DATA_KEY, JSON.stringify(data));
        console.log('ìƒì„¸ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', data.length + 'ê±´');
      } catch (e) {
        console.error('ìƒì„¸ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
        try {
          localStorage.setItem(DETAIL_DATA_KEY, JSON.stringify(data.slice(-3000)));
        } catch (e2) {
          console.error('ì¶•ì†Œ ì €ì¥ë„ ì‹¤íŒ¨:', e2);
        }
      }
    }

    // localStorageì— ë°ì´í„° ì €ì¥
    function saveToStorage(data) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        console.log('ë°ì´í„° ì €ì¥ ì™„ë£Œ:', data.length + 'ê±´');
      } catch (e) {
        console.error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
        alert('ë°ì´í„°ê°€ ë„ˆë¬´ ì»¤ì„œ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data.slice(-5000)));
        } catch (e2) {
          console.error('ì¶•ì†Œ ì €ì¥ë„ ì‹¤íŒ¨:', e2);
        }
      }
    }

    // localStorageì— ê°€ë™ìœ¨ ë°ì´í„° ì €ì¥
    function saveAvailabilityToStorage(data) {
      try {
        localStorage.setItem(AVAILABILITY_KEY, JSON.stringify(data));
        console.log('ê°€ë™ìœ¨ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', data.length + 'ê±´');
      } catch (e) {
        console.error('ê°€ë™ìœ¨ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }

    // ë°ì´í„° ì‚­ì œ
    function clearStorage() {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(AVAILABILITY_KEY);
      localStorage.removeItem(DETAIL_DATA_KEY);
      localStorage.removeItem(CT_DATA_KEY);
      localStorage.removeItem(MATERIAL_DEFECT_KEY);
      localStorage.removeItem(WIP_INVENTORY_KEY);
      localStorage.removeItem(REPAIR_STATUS_KEY);
      localStorage.removeItem(PACKAGING_STATUS_KEY);
      state.rawData = [];
      state.availabilityData = [];
      state.detailData = [];
      state.ctData = [];
      state.materialDefectData = [];
      state.wipInventoryData = [];
      state.repairStatusData = [];
      state.packagingStatusData = [];
      render();
    }

    // ê³µí†µ í•˜ìœ„ë©”ë‰´ (ëª¨ë“  ê³µì •)
    const commonSubMenus = [
      { id: 'production', name: 'ìƒì‚°í˜„í™©', icon: 'ğŸ“Š' },
      { id: 'uph', name: 'UPHí˜„í™©', icon: 'âš¡' },
      { id: 'cycletime', name: 'Cycle Time', icon: 'â±ï¸' },
      { id: 'packaging', name: 'ê²€í¬ì¥í˜„í™©', icon: 'ğŸ“¦' }
    ];

    // ì¡°ë¦½ê³µì • ì¶”ê°€ í•˜ìœ„ë©”ë‰´
    const assemblyExtraMenus = [
      { id: 'defect-repair', name: 'ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™©', icon: 'ğŸ”§' },
      { id: 'material-defect', name: 'ìì¬ë¶ˆëŸ‰í˜„í™©', icon: 'âš ï¸' }
    ];

    // ê³µì • ì„œë¸Œë©”ë‰´ ì •ì˜ (Laser ì œì™¸)
    const processMenus = [
      { id: 'injection', name: 'ì‚¬ì¶œê³µì •', icon: 'ğŸ’‰', color: '#3B82F6', subMenus: [...commonSubMenus] },
      { id: 'painting', name: 'ë„ì¥ê³µì •', icon: 'ğŸ¨', color: '#10B981', subMenus: [...commonSubMenus] },
      { id: 'printing', name: 'ì¸ì‡„ê³µì •', icon: 'ğŸ–¨ï¸', color: '#F59E0B', subMenus: [...commonSubMenus] },
      { id: 'assembly', name: 'ì¡°ë¦½ê³µì •', icon: 'ğŸ”§', color: '#EF4444', subMenus: [...commonSubMenus, ...assemblyExtraMenus] }
    ];

    // ê³µì • ë°ì´í„° ë§¤í•‘ (Laser ì œì™¸)
    const processDataMapping = {
      'injection': 'ì‚¬ì¶œ',
      'painting': 'ë„ì¥',
      'printing': 'ì¸ì‡„',
      'assembly': 'ì¡°ë¦½'
    };

    // ì§‘ê³„ì—ì„œ ì œì™¸í•  ê³µì •
    const excludedProcesses = ['Laser', 'LASER', 'laser', 'ì¸ì‡„'];

    // ìƒíƒœ ê´€ë¦¬
    let state = {
      isAuthenticated: false,  // Supabase Authë¡œ ê´€ë¦¬
      activeTab: 'overview',
      activeProcess: null,
      activeSubMenu: 'production',  // ê¸°ë³¸ê°’: ìƒì‚°í˜„í™©
      wipSubTab: 'status',  // ì¬ê³µì¬ê³  í•˜ìœ„íƒ­: status(í˜„í™©), price(ë‹¨ê°€í‘œ)
      rawData: loadFromStorage(),
      availabilityData: loadAvailabilityFromStorage(),
      detailData: loadDetailFromStorage(),
      ctData: loadCTFromStorage(),
      materialDefectData: loadMaterialDefectFromStorage(),
      wipInventoryData: loadWipInventoryFromStorage(),
      repairStatusData: loadRepairStatusFromStorage(),
      packagingStatusData: loadPackagingStatusFromStorage(),
      priceData: loadPriceFromStorage(),
      filters: { process: 'all', equipment: 'all', product: 'all' },
      selectedMonth: new Date().getMonth() + 1,  // í˜„ì¬ ì›” ê¸°ë³¸ê°’ (1-12)
      pivot: {
        rows: 'ê³µì •',
        cols: 'í’ˆì¢…',
        values: 'ìƒì‚°ìˆ˜ëŸ‰',
        aggFunc: 'sum'
      }
    };

    // ì›” ì„ íƒ ë³€ê²½
    function setSelectedMonth(month) {
      state.selectedMonth = parseInt(month);
      render();
      setTimeout(() => { createCharts(); initTableSort(); }, 100);
    }

    // í”¼ë´‡ ì„¤ì • ë³€ê²½
    function setPivotConfig(key, value) {
      state.pivot[key] = value;
      render();
    }

    // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
    let charts = {};

    // CSV íŒŒì‹±
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = lines[0].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = [];
        let current = '';
        let inQuotes = false;

        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        if (values.length >= 20) {
          const row = {};
          headers.forEach((header, index) => {
            let value = values[index] || '';
            value = value.replace(/,/g, '').replace(/"/g, '');
            row[header] = value;
          });

          if (row['í’ˆëª©ëª…'] !== 'TOTAL' && row['ìƒì‚°ì¼ì']) {
            data.push({
              date: row['ìƒì‚°ì¼ì'] || '',
              process: row['ê³µì •'] || '',
              itemCode: row['í’ˆëª©ì½”ë“œ'] || '',
              itemName: row['í’ˆëª©ëª…'] || '',
              equipment: row['ì„¤ë¹„/LINE'] || '',
              productType: row['í’ˆì¢…'] || 'ê¸°íƒ€',
              standardQty: parseFloat(row['í‘œì¤€ìƒì‚°ëŸ‰']) || 0,
              productionQty: parseFloat(row['ìƒì‚°ìˆ˜ëŸ‰']) || 0,
              goodQty: parseFloat(row['ì–‘í’ˆìˆ˜ëŸ‰']) || 0,
              defectQty: parseFloat(row['ë¶ˆëŸ‰ìˆ˜ëŸ‰']) || 0,
              disposalQty: parseFloat(row['íê¸°ìˆ˜ëŸ‰']) || 0,
              yieldRate: parseFloat(row['ìˆ˜ìœ¨(%)']) || 0,
            });
          }
        }
      }
      return data;
    }

    // ê°€ë™ìœ¨ CSV íŒŒì‹±
    function parseAvailabilityCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 3) return [];

      // í—¤ë”ëŠ” 2ë²ˆì§¸ ì¤„ (ì¸ë±ìŠ¤ 1)
      const headers = lines[1].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));
      const data = [];

      for (let i = 2; i < lines.length; i++) {
        const values = [];
        let current = '';
        let inQuotes = false;

        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          let value = values[index] || '';
          value = value.replace(/,/g, '').replace(/"/g, '');
          row[header] = value;
        });

        // TOTAL í–‰ ì œì™¸, ê³µì •ì´ ìˆëŠ” í–‰ë§Œ
        if (row['ê³µì •'] && row['ê³µì •'] !== '' && row['ì„¤ë¹„/LINE'] !== 'TOTAL') {
          // ë¹„ê°€ë™ ìœ í˜•ë³„ ì‹œê°„ íŒŒì‹±
          const downtimeByType = {
            moldChange: parseFloat(row['ë¹„ê°€ë™ì‹œê°„(ë¶„)'] || row['ê¸ˆí˜•êµí™˜']) || 0,         // ê¸ˆí˜•êµí™˜
            setupWait: parseFloat(row['ë¹„ê°€ë™ì‹œê°„(ë¶„)_1'] || row['ì¡°ê±´ì„¤ì •ëŒ€ê¸°']) || 0,    // ì¡°ê±´ì„¤ì •ëŒ€ê¸°
            setup: parseFloat(row['ë¹„ê°€ë™ì‹œê°„(ë¶„)_2'] || row['ì¡°ê±´ì„¤ì •']) || 0,            // ì¡°ê±´ì„¤ì •
            materialChange: parseFloat(row['ë¹„ê°€ë™ì‹œê°„(ë¶„)_3'] || row['ì›ë£Œêµí™˜/ê±´ì¡°']) || 0, // ì›ë£Œêµí™˜/ê±´ì¡°
            breakdown: parseFloat(row['ë¹„ê°€ë™ì‹œê°„(ë¶„)_4'] || row['ê³ ì¥']) || 0,            // ê³ ì¥
            waiting: parseFloat(row['ë¹„ê°€ë™ì‹œê°„(ë¶„)_5'] || row['ëŒ€ê¸°']) || 0,              // ëŒ€ê¸°
            maintenance: parseFloat(row['ë¹„ê°€ë™ì‹œê°„(ë¶„)_6'] || row['ì •ë¹„']) || 0,          // ì •ë¹„
            other: 0  // ê¸°íƒ€ (ê³„ì‚°)
          };

          // ë¹„ê°€ë™í•©ê³„ì—ì„œ ìœ í˜•ë³„ í•©ê³„ë¥¼ ëº€ ë‚˜ë¨¸ì§€ë¥¼ ê¸°íƒ€ë¡œ
          const totalDowntime = parseFloat(row['ë¹„ê°€ë™í•©ê³„']) || 0;
          const knownDowntime = Object.values(downtimeByType).reduce((a, b) => a + b, 0);
          downtimeByType.other = Math.max(0, totalDowntime - knownDowntime);

          data.push({
            date: row['ìƒì‚°ì¼ì'] || '',
            process: row['ê³µì •'] || '',
            equipment: row['ì„¤ë¹„/LINE'] || '',
            operatingTime: parseFloat(row['ì¡°ì—…ì‹œê°„(ë¶„)']) || 0,
            runningTime: parseFloat(row['ê°€ë™ì‹œê°„(ë¶„)']) || 0,
            timeAvailability: parseFloat(row['ì‹œê°„ê°€ë™ìœ¨(%)']) || 0,
            equipmentAvailability: parseFloat(row['ì„¤ë¹„ê°€ë™ìœ¨(%)']) || 0,
            totalDowntime: totalDowntime,
            plannedStop: parseFloat(row['ê³„íšì •ì§€í•©ê³„']) || 0,
            downtimeByType: downtimeByType
          });
        }
      }
      return data;
    }

    // CT í˜„í™© CSV íŒŒì‹±
    function parseCTCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 3) return [];

      // í—¤ë”ëŠ” 2ë²ˆì§¸ ì¤„ (ì¸ë±ìŠ¤ 1)
      const headers = lines[1].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));
      const data = [];

      for (let i = 2; i < lines.length; i++) {
        const values = [];
        let current = '';
        let inQuotes = false;

        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          let value = values[index] || '';
          value = value.replace(/,/g, '').replace(/"/g, '');
          row[header] = value;
        });

        // ê³µì •êµ¬ë¶„ê³¼ ì„¤ë¹„ëª…(ë˜ëŠ” ë¼ì¸ëª…)ì´ ìˆëŠ” í–‰ë§Œ
        const equipmentName = row['ì„¤ë¹„ëª…'] || row['ë¼ì¸ëª…'] || '';
        if (row['ê³µì •êµ¬ë¶„'] && equipmentName) {
          const standardCT = parseFloat(row['í‘œì¤€ C/T[ì´ˆ]']) || 0;
          const actualCT = parseFloat(row['ì‹¤ì œ C/T[ì´ˆ]']) || 0;
          const efficiency = parseFloat(row['íš¨ìœ¨[%]']) || (standardCT > 0 && actualCT > 0 ? (standardCT / actualCT * 100) : 0);

          data.push({
            process: row['ê³µì •êµ¬ë¶„'] || '',
            product: row['í’ˆì¢…'] || '',
            partCode: row['ë¶€í’ˆì½”ë“œ'] || '',
            partName: row['ë¶€í’ˆëª…'] || row['ê³ ê°ì‚¬ P/N'] || '',
            equipment: equipmentName,
            cavity: parseInt(row['ì‚¬ìš©CAVITY']) || 1,
            standardCT: standardCT,
            actualCT: actualCT,
            efficiency: efficiency,
            workTime: parseFloat(row['ì‘ì—…ì‹œê°„[ë¶„]']) || 0,
            quantity: parseInt(row['ìƒì‚°ìˆ˜ëŸ‰']?.replace(/,/g, '')) || 0
          });
        }
      }
      return data;
    }

    // CT CSV ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (ê¸°ì¡´ - ëª¨ë“  ê³µì • í†µí•©)
    function handleCTUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        const newData = parseCTCSV(e.target.result);
        if (newData.length > 0) {
          state.ctData = newData;
          saveCTToStorage(newData);
          alert(`CT í˜„í™© ë°ì´í„° ${newData.length}ê±´ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          render();
          setTimeout(() => { createCharts(); initTableSort(); }, 100);
          // Supabase ë™ê¸°í™”
          if (supabaseConnected) await saveToSupabase('ct_data', newData);
        } else {
          alert('ìœ íš¨í•œ CT ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // ê³µì •ë³„ CT ë°ì´í„° ê°œìˆ˜ ì¡°íšŒ
    function getCTCountByProcess(processName) {
      if (!state.ctData || state.ctData.length === 0) return 0;
      return filterCTByProcess(state.ctData, processName).length;
    }

    // ê³µì •ë³„ CT CSV ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    function handleCTUploadByProcess(event, processName) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        isUploading = true;
        try {
          const newData = parseCTCSV(e.target.result);
          if (newData.length > 0) {
            // ğŸ”„ Supabaseì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ (ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ë°ì´í„° í¬í•¨)
            if (supabaseConnected) {
              const supabaseData = await loadFromSupabase('ct_data');
              if (supabaseData && supabaseData.length > 0) {
                state.ctData = supabaseData;
                console.log('ğŸ“¥ Supabaseì—ì„œ CT ë°ì´í„° ë¡œë“œ:', supabaseData.length + 'ê±´');
              }
            }

            // ì—…ë¡œë“œëœ ë°ì´í„°ì— ê³µì •ëª…ê³¼ ì›” ì •ë³´ ì§€ì •
            const processedData = newData.map(d => ({
              ...d,
              process: processName,
              month: state.selectedMonth
            }));

            // ê¸°ì¡´ ë°ì´í„°ì—ì„œ í•´ë‹¹ ê³µì • + í•´ë‹¹ ì›” ë°ì´í„°ë§Œ ì œê±° í›„ ìƒˆ ë°ì´í„° ì¶”ê°€
            const otherData = (state.ctData || []).filter(d => !(d.process === processName && d.month === state.selectedMonth));
            state.ctData = [...otherData, ...processedData];
            saveCTToStorage(state.ctData);

            // ê³µì •ë³„ ê±´ìˆ˜ í‘œì‹œ
            const ctByProcess = {};
            state.ctData.forEach(d => {
              const key = `${d.month || '?'}ì›” ${d.process}`;
              ctByProcess[key] = (ctByProcess[key] || 0) + 1;
            });
            const summary = Object.entries(ctByProcess).map(([k, v]) => `${k}: ${v}ê±´`).join('\n');

            alert(`${state.selectedMonth}ì›” ${processName} CT ${processedData.length}ê±´ ì—…ë¡œë“œ ì™„ë£Œ!\n\n[ì „ì²´ CT í˜„í™©]\n${summary}`);
            render();
            setTimeout(() => { createCharts(); initTableSort(); }, 100);

            // ğŸ”„ Supabaseì— ë™ê¸°í™” (month ì»¬ëŸ¼ í¬í•¨)
            if (supabaseConnected) {
              await saveToSupabase('ct_data', state.ctData);
              console.log('âœ… CT ë°ì´í„° Supabase ë™ê¸°í™” ì™„ë£Œ:', state.ctData.length + 'ê±´');
            }
          } else {
            alert('ìœ íš¨í•œ CT ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          }
        } finally {
          isUploading = false;
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // ê³µì •ë³„ CT ë°ì´í„° ì‚­ì œ
    async function deleteCTByProcess(processName) {
      if (!confirm(`${processName} ê³µì • CT ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      state.ctData = state.ctData.filter(d => d.process !== processName);
      saveCTToStorage(state.ctData);
      render();
      setTimeout(() => { createCharts(); initTableSort(); }, 100);
      // ğŸ”„ Supabase ë™ê¸°í™”
      if (supabaseConnected) {
        await saveToSupabase('ct_data', state.ctData);
        console.log('âœ… CT ë°ì´í„° ì‚­ì œ í›„ Supabase ë™ê¸°í™” ì™„ë£Œ');
      }
    }

    // ì¡°ë¦½ìì¬ë¶ˆëŸ‰ CSV íŒŒì‹±
    function parseMaterialDefectCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = [];
      let current = '';
      let inQuotes = false;
      for (let char of lines[0]) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headers.push(current.trim().replace(/^\uFEFF/, '')); current = ''; }
        else current += char;
      }
      headers.push(current.trim());

      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = [];
        current = '';
        inQuotes = false;
        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          if (header && header !== '') {
            let value = values[index] || '';
            value = value.replace(/,/g, '').replace(/"/g, '');
            row[header] = value;
          }
        });

        if (row['ë¶€í’ˆì½”ë“œ'] && row['ë¶€í’ˆì½”ë“œ'] !== '') {
          data.push({
            partCode: row['ë¶€í’ˆì½”ë“œ'] || '',
            customerPN: row['ê³ ê°ì‚¬ P/N'] || '',
            partName: row['ë¶€í’ˆëª…'] || '',
            spec: row['ê·œê²©'] || '',
            date: row['ìƒì‚°ì¼ì'] || '',
            defectTotal: parseInt(row['ë¶ˆëŸ‰í•©ê³„']?.replace(/,/g, '')) || 0,
            rawData: row
          });
        }
      }
      return data;
    }

    // ì¡°ë¦½ìì¬ë¶ˆëŸ‰ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    function handleMaterialDefectUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const data = parseMaterialDefectCSV(e.target.result);
        if (data.length > 0) {
          state.materialDefectData = data;
          saveMaterialDefectToStorage(data);
          alert(`ì¡°ë¦½ìì¬ë¶ˆëŸ‰ ë°ì´í„° ${data.length}ê±´ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          render();
          setTimeout(() => { initTableSort(); }, 100);
          // Supabase ë™ê¸°í™”
          if (supabaseConnected) await saveToSupabase('material_defect_data', data);
        } else {
          alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // ì¬ê³µì¬ê³ ê¸ˆì•¡ CSV íŒŒì‹±
    function parseWipInventoryCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = [];
      let current = '';
      let inQuotes = false;
      for (let char of lines[0]) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headers.push(current.trim().replace(/^\uFEFF/, '')); current = ''; }
        else current += char;
      }
      headers.push(current.trim());

      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = [];
        current = '';
        inQuotes = false;
        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          if (header && header !== '') {
            let value = values[index] || '';
            value = value.replace(/"/g, '');
            row[header] = value;
          }
        });

        if (row['í’ˆëª©ì½”ë“œ'] && row['í’ˆëª©ì½”ë“œ'] !== '') {
          data.push({
            itemType: row['í’ˆëª©ìœ í˜•'] || '',
            itemCode: row['í’ˆëª©ì½”ë“œ'] || '',
            customerPN: row['ê³ ê°ì‚¬ P/N'] || '',
            itemName: row['í’ˆëª©ëª…'] || '',
            spec: row['ê·œê²©'] || '',
            stock: parseInt(row['ì¬ê³ ']?.replace(/,/g, '')) || 0,
            unitCost: parseInt(row['ì œì¡°ì›ê°€']?.replace(/,/g, '')) || 0,
            stockValue: parseInt(row['ì¬ê³ ê¸ˆì•¡']?.replace(/,/g, '')) || 0
          });
        }
      }
      return data;
    }

    // ì¬ê³µì¬ê³ ê¸ˆì•¡ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    function handleWipInventoryUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const data = parseWipInventoryCSV(e.target.result);
        if (data.length > 0) {
          state.wipInventoryData = data;
          saveWipInventoryToStorage(data);
          alert(`ì¬ê³µì¬ê³ ê¸ˆì•¡ ë°ì´í„° ${data.length}ê±´ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          render();
          setTimeout(() => { initTableSort(); }, 100);
          // Supabase ë™ê¸°í™”
          if (supabaseConnected) await saveToSupabase('wip_inventory_data', data);
        } else {
          alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© CSV íŒŒì‹±
    function parseRepairStatusCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = [];
      let current = '';
      let inQuotes = false;
      for (let char of lines[0]) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headers.push(current.trim().replace(/^\uFEFF/, '')); current = ''; }
        else current += char;
      }
      headers.push(current.trim());

      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = [];
        current = '';
        inQuotes = false;
        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          if (header && header !== '') {
            let value = values[index] || '';
            value = value.replace(/"/g, '');
            row[header] = value;
          }
        });

        if (row['ë¶€í’ˆì½”ë“œ'] && row['ë¶€í’ˆì½”ë“œ'] !== '') {
          data.push({
            itemType: row['í’ˆëª©ìœ í˜•'] || '',
            partCode: row['ë¶€í’ˆì½”ë“œ'] || '',
            customerPN: row['ê³ ê°ì‚¬ P/N'] || '',
            partName: row['ë¶€í’ˆëª…'] || '',
            spec: row['ê·œê²©'] || '',
            date: row['ìƒì‚°ì¼ì'] || '',
            workOrder: row['ì‘ì—…ì§€ì‹œë²ˆí˜¸'] || '',
            productionQty: parseInt(row['ìƒì‚°ìˆ˜ëŸ‰']?.replace(/,/g, '')) || 0,
            repairQty: parseInt(row['ìˆ˜ë¦¬ìˆ˜ëŸ‰']?.replace(/,/g, '')) || 0
          });
        }
      }
      return data;
    }

    // ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    function handleRepairStatusUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const data = parseRepairStatusCSV(e.target.result);
        if (data.length > 0) {
          state.repairStatusData = data;
          saveRepairStatusToStorage(data);
          alert(`ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ë°ì´í„° ${data.length}ê±´ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          render();
          setTimeout(() => { initTableSort(); }, 100);
          // Supabase ë™ê¸°í™”
          if (supabaseConnected) await saveToSupabase('repair_status_data', data);
        } else {
          alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // ê²€í¬ì¥í˜„í™© CSV íŒŒì‹±
    function parsePackagingStatusCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = [];
      let current = '';
      let inQuotes = false;
      for (let char of lines[0]) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headers.push(current.trim().replace(/^\uFEFF/, '')); current = ''; }
        else current += char;
      }
      headers.push(current.trim());

      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = [];
        current = '';
        inQuotes = false;
        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          if (header && header !== '') {
            let value = values[index] || '';
            value = value.replace(/"/g, '');
            row[header] = value;
          }
        });

        if (row['í’ˆëª©ì½”ë“œ'] && row['í’ˆëª©ì½”ë“œ'] !== '') {
          // ìƒì‚° Lot Noì—ì„œ ë‚ ì§œ ì¶”ì¶œ (1PMA260102004 -> 2026-01-02)
          const lotNo = row['ìƒì‚° Lot No'] || '';
          let productionDate = '';
          if (lotNo.length >= 11) {
            const yearPart = lotNo.substring(3, 5);
            const monthPart = lotNo.substring(5, 7);
            const dayPart = lotNo.substring(7, 9);
            productionDate = `2026-${monthPart}-${dayPart}`;
          }

          data.push({
            process: row['ê³µì •'] || '',
            processType: row['ê³µì •êµ¬ë¶„'] || '',
            itemCode: row['í’ˆëª©ì½”ë“œ'] || '',
            customerPN: row['ê³ ê°ì‚¬ P/N'] || '',
            itemName: row['í’ˆëª©ëª…'] || '',
            lotNo: lotNo,
            equipmentCode: row['ì„¤ë¹„(ë¼ì¸)ì½”ë“œ'] || '',
            equipmentName: row['ì„¤ë¹„(ë¼ì¸)ëª…'] || '',
            defectQty: parseInt(row['ë¶ˆëŸ‰ìˆ˜ëŸ‰']?.replace(/,/g, '')) || 0,
            repairQty: parseInt(row['ìˆ˜ë¦¬ìˆ˜ëŸ‰']?.replace(/,/g, '')) || 0,
            disposalQty: parseInt(row['íê¸°ìˆ˜ëŸ‰']?.replace(/,/g, '')) || 0,
            productionDate: productionDate
          });
        }
      }
      return data;
    }

    // ê²€í¬ì¥í˜„í™© ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    function handlePackagingStatusUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const data = parsePackagingStatusCSV(e.target.result);
        if (data.length > 0) {
          state.packagingStatusData = data;
          savePackagingStatusToStorage(data);
          alert(`ê²€í¬ì¥í˜„í™© ë°ì´í„° ${data.length}ê±´ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          render();
          setTimeout(() => { createCharts(); initTableSort(); }, 100);
          // Supabase ë™ê¸°í™”
          if (supabaseConnected) await saveToSupabase('packaging_status_data', data);
        } else {
          alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // ì—…ì¢…ë³„ ìƒì„¸ CSV íŒŒì‹±
    function parseDetailCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      // í—¤ë” íŒŒì‹± (ì²« ë²ˆì§¸ ë˜ëŠ” ë‘ ë²ˆì§¸ ì¤„)
      let headerLine = lines[0];
      let startRow = 1;
      if (headerLine.split(',')[1] === 'ì‚¬ì—…ì¥' || lines[1].split(',')[1] === 'ì‚¬ì—…ì¥') {
        headerLine = lines[1].includes('ì‚¬ì—…ì¥') ? lines[1] : lines[0];
        startRow = headerLine === lines[1] ? 2 : 1;
      }

      const headers = [];
      let current = '';
      let inQuotes = false;
      for (let char of headerLine) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headers.push(current.trim().replace(/^\uFEFF/, '')); current = ''; }
        else current += char;
      }
      headers.push(current.trim());

      const data = [];
      for (let i = startRow; i < lines.length; i++) {
        const values = [];
        current = '';
        inQuotes = false;
        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          if (header && header !== '') {
            let value = values[index] || '';
            value = value.replace(/,/g, '').replace(/"/g, '');
            row[header] = value;
          }
        });

        // ë¹ˆ í–‰ì´ ì•„ë‹Œ ê²½ìš°ë§Œ ì¶”ê°€
        if (row['ê³µì •'] && row['ê³µì •'] !== '') {
          data.push(row);
        }
      }
      return data;
    }

    // ìƒì„¸ ë°ì´í„° ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    function handleDetailUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const text = e.target.result;
        const data = parseDetailCSV(text);

        if (data.length > 0) {
          state.detailData = data;
          saveDetailToStorage(data);
          alert(`ìƒì„¸ ë°ì´í„° ${data.length}ê±´ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          render();
          // Supabase ë™ê¸°í™”
          if (supabaseConnected) await saveToSupabase('detail_data', data);
        } else {
          alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // í”¼ë´‡ í…Œì´ë¸” ìƒì„±
    function generatePivotTable(data, rowField, colField, valueField, aggFunc) {
      if (!data || data.length === 0) return { rows: [], cols: [], values: {} };

      // ìœ ë‹ˆí¬ í–‰/ì—´ ê°’ ì¶”ì¶œ
      const rowValues = [...new Set(data.map(d => d[rowField] || '(ì—†ìŒ)'))].sort();
      const colValues = [...new Set(data.map(d => d[colField] || '(ì—†ìŒ)'))].sort();

      // í”¼ë´‡ ë°ì´í„° ê³„ì‚°
      const pivotData = {};
      const rowTotals = {};
      const colTotals = {};
      let grandTotal = 0;

      rowValues.forEach(r => {
        pivotData[r] = {};
        rowTotals[r] = { sum: 0, count: 0 };
        colValues.forEach(c => {
          pivotData[r][c] = { sum: 0, count: 0 };
        });
      });
      colValues.forEach(c => {
        colTotals[c] = { sum: 0, count: 0 };
      });

      // ë°ì´í„° ì§‘ê³„
      data.forEach(d => {
        const r = d[rowField] || '(ì—†ìŒ)';
        const c = d[colField] || '(ì—†ìŒ)';
        let v = parseFloat(String(d[valueField] || '0').replace(/,/g, '')) || 0;

        if (pivotData[r] && pivotData[r][c]) {
          pivotData[r][c].sum += v;
          pivotData[r][c].count++;
          rowTotals[r].sum += v;
          rowTotals[r].count++;
          colTotals[c].sum += v;
          colTotals[c].count++;
          grandTotal += v;
        }
      });

      // ì§‘ê³„ í•¨ìˆ˜ ì ìš©
      const getValue = (obj) => {
        if (aggFunc === 'sum') return obj.sum;
        if (aggFunc === 'count') return obj.count;
        if (aggFunc === 'avg') return obj.count > 0 ? obj.sum / obj.count : 0;
        return obj.sum;
      };

      return {
        rows: rowValues,
        cols: colValues,
        values: pivotData,
        rowTotals,
        colTotals,
        grandTotal,
        getValue
      };
    }

    // ìƒì„¸ ë°ì´í„° í•„ë“œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function getDetailFields() {
      if (state.detailData.length === 0) return [];
      return Object.keys(state.detailData[0]).filter(k => k && k !== '');
    }

    // ìˆ«ì í•„ë“œ ëª©ë¡ (í”¼ë´‡ ê°’ìœ¼ë¡œ ì‚¬ìš©)
    function getNumericFields() {
      const numericCandidates = ['ìƒì‚°ìˆ˜ëŸ‰', 'ì–‘í’ˆìˆ˜ëŸ‰', 'ë¶ˆëŸ‰ìˆ˜ëŸ‰', 'íê¸°ìˆ˜ëŸ‰', 'ì‘ì—…ì‹œê°„(ë¶„)', 'ì‘ì—…ì¸ì›', 'UPH', 'UPPH', 'ë¶ˆëŸ‰ìœ¨', 'íê¸°ìœ¨'];
      const fields = getDetailFields();
      return fields.filter(f => numericCandidates.includes(f) ||
        (state.detailData.length > 0 && !isNaN(parseFloat(String(state.detailData[0][f] || '0').replace(/,/g, '')))));
    }

    // ê³µì •ë³„ ì‹œê°„ê°€ë™ìœ¨ ê³„ì‚° (ê°€ë™ìœ¨ ë°ì´í„° ê¸°ë°˜ - CSVì˜ ì‹œê°„ê°€ë™ìœ¨(%) ê°’ ì‚¬ìš©)
    // targetMonth íŒŒë¼ë¯¸í„°: íŠ¹ì • ì›”(1-12)ë§Œ í•„í„°ë§í•˜ì—¬ ê³„ì‚°, nullì´ë©´ ì „ì²´ ë°ì´í„° ì‚¬ìš©
    function getProcessAvailability(targetMonth = null) {
      if (state.availabilityData.length === 0) return {};

      // ì›”ë³„ í•„í„°ë§ ì ìš©
      const filteredData = targetMonth !== null
        ? state.availabilityData.filter(row => {
            if (!row.date) return false;
            const dateStr = String(row.date);
            let rowMonth = null;
            if (dateStr.includes('-')) {
              rowMonth = parseInt(dateStr.split('-')[1]) || null;
            } else if (dateStr.includes('/')) {
              const parts = dateStr.split('/');
              rowMonth = parts[0].length === 4 ? parseInt(parts[1]) : parseInt(parts[0]);
            }
            return rowMonth === targetMonth;
          })
        : state.availabilityData;

      if (filteredData.length === 0) return {};

      const grouped = {};
      filteredData.forEach(row => {
        if (!grouped[row.process]) {
          grouped[row.process] = {
            totalOperatingTime: 0,
            weightedAvailability: 0,
            count: 0,
            sumAvailability: 0
          };
        }
        grouped[row.process].totalOperatingTime += row.operatingTime;
        // ê°€ì¤‘ í‰ê· ì„ ìœ„í•´ ì¡°ì—…ì‹œê°„ * ì‹œê°„ê°€ë™ìœ¨ ëˆ„ì 
        grouped[row.process].weightedAvailability += row.timeAvailability * row.operatingTime;
        grouped[row.process].count++;
        grouped[row.process].sumAvailability += row.timeAvailability;
      });

      const result = {};
      Object.keys(grouped).forEach(process => {
        const g = grouped[process];
        // ê°€ì¤‘ í‰ê·  ì‹œê°„ê°€ë™ìœ¨ (ì¡°ì—…ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ CSVì˜ ì‹œê°„ê°€ë™ìœ¨ ê°’ ì‚¬ìš©)
        result[process] = g.totalOperatingTime > 0
          ? g.weightedAvailability / g.totalOperatingTime
          : (g.count > 0 ? g.sumAvailability / g.count : 0);
      });
      return result;
    }

    // ë‚ ì§œì—ì„œ ì—°ë„ì™€ ì›” ì¶”ì¶œ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›: YYYY-MM-DD, YYYY/MM/DD, MM/DD/YYYY ë“±)
    function extractYearMonth(dateStr) {
      if (!dateStr) return { year: null, month: null };
      const str = String(dateStr);
      let year = null, month = null;

      if (str.includes('-')) {
        const parts = str.split('-');
        if (parts[0].length === 4) {
          // YYYY-MM-DD í˜•ì‹
          year = parseInt(parts[0]) || null;
          month = parseInt(parts[1]) || null;
        }
      } else if (str.includes('/')) {
        const parts = str.split('/');
        if (parts[0].length === 4) {
          // YYYY/MM/DD í˜•ì‹
          year = parseInt(parts[0]) || null;
          month = parseInt(parts[1]) || null;
        } else if (parts[2] && parts[2].length === 4) {
          // MM/DD/YYYY í˜•ì‹
          year = parseInt(parts[2]) || null;
          month = parseInt(parts[0]) || null;
        }
      }
      return { year, month };
    }

    // ì›”ë³„ OEE ë°ì´í„° ê³„ì‚° (1ì›”~12ì›” ì „ì²´)
    // ê° ì›”ë³„ë¡œ í•´ë‹¹ ì›”ì˜ ê°€ë™ìœ¨ ë°ì´í„°ë¥¼ ê°œë³„ì ìœ¼ë¡œ ì‚¬ìš©
    function getMonthlyOEEData(data) {
      // ì „ì²´ í‰ê·  ê°€ë™ìœ¨ (ì›”ë³„ ê°€ë™ìœ¨ ë°ì´í„°ê°€ ì—†ì„ ë•Œ í´ë°±ìš©)
      const overallAvailability = getProcessAvailability();
      const defaultAvailability = Object.keys(overallAvailability).length > 0
        ? Object.values(overallAvailability).reduce((a, b) => a + b, 0) / Object.keys(overallAvailability).length
        : 80; // ê¸°ë³¸ê°’

      // ë°ì´í„°ì—ì„œ ì—°ë„ ì¶”ì¶œ (ì—†ìœ¼ë©´ í˜„ì¬ ì—°ë„)
      let year = new Date().getFullYear();
      if (data.length > 0 && data[0].date) {
        const extracted = extractYearMonth(data[0].date);
        if (extracted.year) year = extracted.year;
      }

      // 1ì›”~12ì›” ëª¨ë“  ì›” ì´ˆê¸°í™”
      const allMonths = {};
      for (let m = 1; m <= 12; m++) {
        const monthStr = `${year}-${String(m).padStart(2, '0')}`;
        allMonths[monthStr] = { month: monthStr, label: `${m}ì›”`, monthNum: m, production: 0, good: 0, standard: 0, hasData: false };
      }

      // ìƒì‚° ë°ì´í„°ê°€ ìˆëŠ” ì›” ì±„ìš°ê¸° (ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ ì§€ì›)
      data.forEach(row => {
        if (!row.date) return;
        const { year: rowYear, month: rowMonth } = extractYearMonth(row.date);
        if (rowMonth) {
          const monthStr = `${rowYear || year}-${String(rowMonth).padStart(2, '0')}`;
          if (allMonths[monthStr]) {
            allMonths[monthStr].production += row.productionQty;
            allMonths[monthStr].good += row.goodQty;
            allMonths[monthStr].standard += row.standardQty;
            allMonths[monthStr].hasData = true;
          }
        }
      });

      // ê°€ë™ìœ¨ ë°ì´í„°ê°€ ìˆëŠ” ì›”ë„ ì²´í¬ (ìƒì‚° ë°ì´í„° ì—†ì–´ë„ ê°€ë™ìœ¨ ìˆìœ¼ë©´ í‘œì‹œ)
      state.availabilityData.forEach(row => {
        if (!row.date) return;
        const { year: rowYear, month: rowMonth } = extractYearMonth(row.date);
        if (rowMonth) {
          const monthStr = `${rowYear || year}-${String(rowMonth).padStart(2, '0')}`;
          if (allMonths[monthStr] && !allMonths[monthStr].hasData) {
            allMonths[monthStr].hasAvailabilityData = true;
          }
        }
      });

      return Object.values(allMonths)
        .sort((a, b) => a.month.localeCompare(b.month))
        .map(d => {
          // ìƒì‚° ë°ì´í„°ë„ ì—†ê³  ê°€ë™ìœ¨ ë°ì´í„°ë„ ì—†ìœ¼ë©´ null
          if (!d.hasData && !d.hasAvailabilityData) {
            return { ...d, availability: null, performance: null, quality: null, oee: null };
          }

          // í•´ë‹¹ ì›”ì˜ ê°€ë™ìœ¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          const monthlyProcessAvailability = getProcessAvailability(d.monthNum);

          // í•´ë‹¹ ì›”ì— ê°€ë™ìœ¨ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì „ì²´ í‰ê·  ì‚¬ìš©
          let availability;
          if (Object.keys(monthlyProcessAvailability).length > 0) {
            availability = Object.values(monthlyProcessAvailability).reduce((a, b) => a + b, 0) / Object.keys(monthlyProcessAvailability).length;
          } else {
            availability = defaultAvailability;
          }
          availability = Math.min(availability, 100);

          // ìƒì‚° ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì„±ëŠ¥ê°€ë™ìœ¨, ì–‘í’ˆìœ¨ì€ 0
          const performance = d.standard > 0 ? Math.min((d.production / d.standard) * 100, 100) : 0;
          const quality = d.production > 0 ? (d.good / d.production) * 100 : 0;
          const oee = (availability / 100) * (performance / 100) * (quality / 100) * 100;
          return {
            ...d,
            availability: availability.toFixed(1),
            performance: performance.toFixed(1),
            quality: quality.toFixed(1),
            oee: oee.toFixed(1)
          };
        });
    }

    // í•„í„°ë§ëœ ë°ì´í„°
    function getFilteredData() {
      return state.rawData.filter(row => {
        // Laser ê³µì • ì œì™¸
        if (excludedProcesses.includes(row.process)) return false;

        // ì›” í•„í„°ë§ - ìƒì‚°ì¼ìì—ì„œ ì›” ì¶”ì¶œí•˜ì—¬ ë¹„êµ
        if (row.date) {
          const dateStr = String(row.date);
          let rowMonth = null;

          // ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬: YYYY-MM-DD, YYYY/MM/DD, MM/DD, M/D ë“±
          if (dateStr.includes('-')) {
            const parts = dateStr.split('-');
            rowMonth = parseInt(parts[1]) || null;
          } else if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            // MM/DD/YYYY ë˜ëŠ” YYYY/MM/DD í˜•ì‹ ëª¨ë‘ ì²˜ë¦¬
            if (parts[0].length === 4) {
              rowMonth = parseInt(parts[1]) || null;
            } else {
              rowMonth = parseInt(parts[0]) || null;
            }
          }

          if (rowMonth && rowMonth !== state.selectedMonth) return false;
        }

        if (state.filters.process !== 'all' && row.process !== state.filters.process) return false;
        if (state.filters.equipment !== 'all' && row.equipment !== state.filters.equipment) return false;
        if (state.filters.product !== 'all' && row.productType !== state.filters.product) return false;
        return true;
      });
    }

    // ë…„ê°„ ë°ì´í„° (ì›” í•„í„° ì œì™¸, ê³µì •/ì„¤ë¹„/í’ˆëª© í•„í„°ë§Œ ì ìš©)
    function getYearlyData() {
      return state.rawData.filter(row => {
        if (excludedProcesses.includes(row.process)) return false;
        if (state.filters.process !== 'all' && row.process !== state.filters.process) return false;
        if (state.filters.equipment !== 'all' && row.equipment !== state.filters.equipment) return false;
        if (state.filters.product !== 'all' && row.productType !== state.filters.product) return false;
        return true;
      });
    }

    // ê³ ìœ ê°’ ì¶”ì¶œ (Laser ì œì™¸)
    function getUniqueValues(key) {
      let values = [...new Set(state.rawData.map(r => r[key]).filter(Boolean))];
      if (key === 'process') {
        values = values.filter(v => !excludedProcesses.includes(v));
      }
      return values;
    }

    // í’ˆëª©ëª…ìœ¼ë¡œ ë‹¨ê°€ ì¡°íšŒ (ì¬ê³µì¬ê³  ë°ì´í„° ê¸°ë°˜)
    function getUnitCostByItemName(itemName) {
      if (!itemName || !state.wipInventoryData || state.wipInventoryData.length === 0) return 0;
      const item = state.wipInventoryData.find(w => w.itemName === itemName);
      return item ? (item.unitCost || 0) : 0;
    }

    // ìš”ì•½ í†µê³„
    function getSummaryStats(data) {
      if (data.length === 0) return null;
      const totalProduction = data.reduce((sum, r) => sum + r.productionQty, 0);
      const totalGood = data.reduce((sum, r) => sum + r.goodQty, 0);
      const totalDefect = data.reduce((sum, r) => sum + r.defectQty, 0);
      const totalDisposal = data.reduce((sum, r) => sum + r.disposalQty, 0);
      const totalStandard = data.reduce((sum, r) => sum + r.standardQty, 0);

      // ê¸ˆì•¡ ê³„ì‚° (í’ˆëª©ì½”ë“œë¡œ ë‹¨ê°€ ë§¤ì¹­)
      let totalProductionAmount = 0;
      let totalDefectAmount = 0;
      let totalDisposalAmount = 0;
      let matchedCount = 0;
      let unmatchedCount = 0;

      data.forEach(r => {
        const unitPrice = getUnitPriceByCode(r.itemCode);
        if (unitPrice && unitPrice > 0) {
          totalProductionAmount += r.productionQty * unitPrice;
          totalDefectAmount += r.defectQty * unitPrice;
          totalDisposalAmount += r.disposalQty * unitPrice;
          matchedCount++;
        } else {
          unmatchedCount++;
        }
      });

      return {
        totalProduction, totalGood, totalDefect, totalDisposal, totalStandard,
        totalProductionAmount, totalDefectAmount, totalDisposalAmount,
        priceMatchRate: data.length > 0 ? ((matchedCount / data.length) * 100).toFixed(1) : 0,
        avgYield: totalProduction > 0 ? (totalGood / totalProduction * 100).toFixed(1) : 0,
        avgDefectRate: totalProduction > 0 ? (totalDefect / totalProduction * 100).toFixed(1) : 0,
        avgDisposalRate: totalProduction > 0 ? (totalDisposal / totalProduction * 100).toFixed(1) : 0,
        achievementRate: totalStandard > 0 ? (totalProduction / totalStandard * 100).toFixed(1) : 0,
        uniqueItems: new Set(data.map(r => r.itemCode)).size,
        uniqueDates: new Set(data.map(r => r.date)).size,
        totalRecords: data.length
      };
    }

    // ì¼ë³„ ë°ì´í„°
    function getDailyData(data) {
      const grouped = {};
      data.forEach(row => {
        if (!grouped[row.date]) grouped[row.date] = { date: row.date, production: 0, good: 0, standard: 0 };
        grouped[row.date].production += row.productionQty;
        grouped[row.date].good += row.goodQty;
        grouped[row.date].standard += row.standardQty;
      });
      return Object.values(grouped).sort((a, b) => a.date.localeCompare(b.date));
    }

    // ê³µì • ì •ë ¬ ìˆœì„œ (ì‚¬ì¶œ > ë„ì¥ > ì¡°ë¦½ > ì¸ì‡„) - Laser ì œì™¸
    const processOrder = ['ì‚¬ì¶œ', 'ë„ì¥', 'ì¡°ë¦½', 'ì¸ì‡„'];

    // ê³µì •ë³„ ë°ì´í„° (Laser ì œì™¸)
    function getProcessData(data) {
      const grouped = {};
      data.forEach(row => {
        // Laser ê³µì • ì œì™¸
        if (excludedProcesses.includes(row.process)) return;
        if (!grouped[row.process]) grouped[row.process] = { process: row.process, production: 0, good: 0, defect: 0, disposal: 0 };
        grouped[row.process].production += row.productionQty;
        grouped[row.process].good += row.goodQty;
        grouped[row.process].defect += row.defectQty;
        grouped[row.process].disposal += row.disposalQty;
      });

      // ì§€ì •ëœ ìˆœì„œë¡œ ì •ë ¬
      return Object.values(grouped)
        .sort((a, b) => {
          const orderA = processOrder.indexOf(a.process);
          const orderB = processOrder.indexOf(b.process);
          // ìˆœì„œì— ì—†ëŠ” ê³µì •ì€ ë§¨ ë’¤ë¡œ
          if (orderA === -1) return 1;
          if (orderB === -1) return -1;
          return orderA - orderB;
        })
        .map(d => ({
          ...d, yieldRate: d.production > 0 ? (d.good / d.production * 100).toFixed(1) : 0
        }));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜ (APP_CONFIG ê¸°ì¤€ ì ìš©)
    // - ëª¨ë“  ìˆ«ì: ì²œë‹¨ìœ„ ì½¤ë§ˆ â†’ formatNumber(), formatCompact()
    // - í¼ì„¼íŠ¸: ì†Œìˆ«ì  1ìë¦¬ â†’ formatPercent()
    // - ì°¨íŠ¸ ë¼ë²¨: chartNumberFormatter(), chartPercentFormatter()
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // ì¼ë°˜ ìˆ«ì: ì²œë‹¨ìœ„ ì½¤ë§ˆ
    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return '0';
      return Number(num).toLocaleString();
    }

    // ì†Œìˆ˜ì  nìë¦¬ + ì²œë‹¨ìœ„ ì½¤ë§ˆ
    function formatDecimal(num, decimals = 1) {
      if (num === null || num === undefined || isNaN(num)) return '0';
      return Number(parseFloat(num).toFixed(decimals)).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    // ì°¨íŠ¸ìš© ìˆ«ì: ì²œë‹¨ìœ„ ì½¤ë§ˆ (ì»´íŒ©íŠ¸)
    function formatCompact(num) {
      if (num === null || num === undefined || isNaN(num)) return '0';
      return Number(num).toLocaleString();
    }

    // í¼ì„¼íŠ¸: ì†Œìˆ«ì  1ìë¦¬ (APP_CONFIG.NUMBER_FORMAT.percentDecimals ì ìš©)
    function formatPercent(num) {
      if (num === null || num === undefined || isNaN(num)) return '0.0%';
      return parseFloat(num).toFixed(APP_CONFIG.NUMBER_FORMAT.percentDecimals) + '%';
    }

    // ì°¨íŠ¸ ë°ì´í„°ë¼ë²¨ìš© í¬ë§·í„° (ìˆ«ì - ì²œë‹¨ìœ„ ì½¤ë§ˆ)
    function chartNumberFormatter(value) {
      if (value === null || value === undefined) return '';
      return formatNumber(value);
    }

    // ì°¨íŠ¸ ë°ì´í„°ë¼ë²¨ìš© í¬ë§·í„° (í¼ì„¼íŠ¸ - ì†Œìˆ«ì  1ìë¦¬)
    function chartPercentFormatter(value) {
      if (value === null || value === undefined) return '';
      return formatPercent(value);
    }

    // CT ì €ì¡° ì‹¤ì  ìƒì„¸ ë¦¬ìŠ¤íŠ¸ ë¹Œë”
    function buildCtLowPerfList(ctData, processName) {
      const processCT = filterCTByProcess(ctData, processName);
      const filteredCT = processCT.filter(d => d.efficiency > 0);
      const sortedCT = [...filteredCT].sort((a, b) => a.efficiency - b.efficiency);
      const worstItems = sortedCT.slice(0, 20);

      if (worstItems.length === 0) return '';

      const toggleBtnClass = collapseState.ctLowPerf ? 'rotate-180' : '';
      const toggleBtnText = collapseState.ctLowPerf ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°';
      const collapseClass = collapseState.ctLowPerf ? 'collapsed' : '';

      let rows = '';
      worstItems.forEach((item, idx) => {
        const effClass = item.efficiency < 80 ? 'text-red-600 font-bold' :
                        item.efficiency < 90 ? 'text-amber-600 font-semibold' :
                        item.efficiency < 100 ? 'text-blue-600' : 'text-emerald-600';
        const statusBadge = item.efficiency < 80 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">ìœ„í—˜</span>' :
                           item.efficiency < 90 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">ì£¼ì˜</span>' :
                           item.efficiency < 100 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">ë¯¸ë‹¬</span>' :
                           '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">ì–‘í˜¸</span>';
        const rankClass = idx < 3 ? 'text-red-500' : 'text-slate-400';
        rows += '<tr>' +
          '<td class="text-center font-bold ' + rankClass + '">' + (idx + 1) + '</td>' +
          '<td class="font-medium">' + item.equipment + '</td>' +
          '<td class="text-slate-600">' + (item.partName || item.partCode || '-') + '</td>' +
          '<td class="text-right">' + formatDecimal(item.standardCT, 1) + 's</td>' +
          '<td class="text-right">' + formatDecimal(item.actualCT, 1) + 's</td>' +
          '<td class="text-right ' + effClass + '">' + formatPercent(item.efficiency) + '</td>' +
          '<td class="text-center">' + statusBadge + '</td>' +
          '</tr>';
      });

      const footerText = sortedCT.length > 20 ?
        '<div class="text-center text-sm text-slate-500 mt-4">ìƒìœ„ 20ê±´ í‘œì‹œ ì¤‘ (ì „ì²´ ' + sortedCT.length + 'ê±´)</div>' : '';

      return '<div class="card">' +
        '<div class="flex justify-between items-center mb-4">' +
          '<h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">' +
            '<span class="text-xl">âš ï¸</span>' +
            '<span>CT ë‹¬ì„±ë¥  ì €ì¡° í•­ëª©</span>' +
            '<span class="text-sm font-normal text-slate-500">(íš¨ìœ¨ ë‚®ì€ ìˆœ)</span>' +
          '</h3>' +
          '<button id="toggle-ctLowPerf" onclick="toggleCollapse(\'ctLowPerf\')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">' +
            '<svg class="w-4 h-4 transition-transform ' + toggleBtnClass + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>' +
            toggleBtnText +
          '</button>' +
        '</div>' +
        '<div id="collapse-ctLowPerf" class="collapsible-content ' + collapseClass + '">' +
          '<div class="overflow-x-auto">' +
            '<table class="data-table w-full">' +
              '<thead>' +
                '<tr>' +
                  '<th class="text-center sortable" data-type="number" data-col="0" style="width: 50px;">ìˆœìœ„</th>' +
                  '<th class="text-left sortable" data-type="equipment" data-col="1">ì„¤ë¹„ëª…</th>' +
                  '<th class="text-left sortable" data-type="string" data-col="2">ë¶€í’ˆëª…</th>' +
                  '<th class="text-right sortable" data-type="number" data-col="3">í‘œì¤€CT</th>' +
                  '<th class="text-right sortable" data-type="number" data-col="4">ì‹¤ì CT</th>' +
                  '<th class="text-right sortable" data-type="number" data-col="5">ë‹¬ì„±ë¥ </th>' +
                  '<th class="text-center sortable" data-type="string" data-col="6">ìƒíƒœ</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' + rows + '</tbody>' +
            '</table>' +
          '</div>' +
          footerText +
        '</div>' +
      '</div>';
    }

    // í’ˆëª©ë³„ ë¶ˆëŸ‰ìœ¨ ìƒì„¸ ë¦¬ìŠ¤íŠ¸ ë¹Œë”
    function buildItemDefectList(data) {
      const itemStats = {};
      data.forEach(d => {
        const itemName = d.itemName || d.product || 'ë¯¸ë¶„ë¥˜';
        if (!itemStats[itemName]) {
          itemStats[itemName] = { production: 0, good: 0, defect: 0, disposal: 0, process: d.process || '' };
        }
        // rawData í•„ë“œëª…: productionQty, goodQty, defectQty, disposalQty
        itemStats[itemName].production += d.productionQty || d.production || 0;
        itemStats[itemName].good += d.goodQty || d.good || 0;
        itemStats[itemName].defect += d.defectQty || d.defect || 0;
        itemStats[itemName].disposal += d.disposalQty || d.disposal || 0;
      });

      const itemList = Object.entries(itemStats)
        .map(([name, s]) => {
          const unitCost = getUnitCostByItemName(name);
          return {
            name,
            process: s.process,
            production: s.production,
            good: s.good,
            defect: s.defect,
            disposal: s.disposal,
            defectRate: s.production > 0 ? (s.defect / s.production * 100) : 0,
            yieldRate: s.production > 0 ? (s.good / s.production * 100) : 0,
            defectCost: s.defect * unitCost  // ë¶ˆëŸ‰ê¸ˆì•¡ = ë¶ˆëŸ‰ìˆ˜ëŸ‰ Ã— ë‹¨ê°€
          };
        })
        .filter(item => item.production > 0)
        .sort((a, b) => b.defectRate - a.defectRate);

      const topItems = itemList.slice(0, 30);
      if (topItems.length === 0) return '';

      const toggleBtnClass = collapseState.itemDefect ? 'rotate-180' : '';
      const toggleBtnText = collapseState.itemDefect ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°';
      const collapseClass = collapseState.itemDefect ? 'collapsed' : '';

      let rows = '';
      topItems.forEach((item, idx) => {
        const defectClass = item.defectRate >= 5 ? 'text-red-600 font-bold' :
                           item.defectRate >= 3 ? 'text-amber-600 font-semibold' :
                           item.defectRate >= 1 ? 'text-blue-600' : 'text-emerald-600';
        const statusBadge = item.defectRate >= 5 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">ìœ„í—˜</span>' :
                           item.defectRate >= 3 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">ì£¼ì˜</span>' :
                           item.defectRate >= 1 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">ê´€ë¦¬</span>' :
                           '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">ì–‘í˜¸</span>';
        const rankClass = idx < 3 ? 'text-red-500' : 'text-slate-400';
        rows += '<tr>' +
          '<td class="text-center font-bold ' + rankClass + '">' + (idx + 1) + '</td>' +
          '<td class="font-medium">' + item.name + '</td>' +
          '<td class="text-slate-500">' + item.process + '</td>' +
          '<td class="text-right">' + formatNumber(item.production) + '</td>' +
          '<td class="text-right text-emerald-600">' + formatNumber(item.good) + '</td>' +
          '<td class="text-right text-red-500">' + formatNumber(item.defect) + '</td>' +
          '<td class="text-right text-red-600 font-medium">' + formatNumber(item.defectCost) + 'ì›</td>' +
          '<td class="text-right ' + defectClass + '">' + formatPercent(item.defectRate) + '</td>' +
          '<td class="text-right text-blue-600">' + formatPercent(item.yieldRate) + '</td>' +
          '<td class="text-center">' + statusBadge + '</td>' +
          '</tr>';
      });

      const footerText = itemList.length > 30 ?
        '<div class="text-center text-sm text-slate-500 mt-4">ìƒìœ„ 30ê±´ í‘œì‹œ ì¤‘ (ì „ì²´ ' + itemList.length + 'ê±´)</div>' : '';

      return '<div class="card">' +
        '<div class="flex justify-between items-center mb-4">' +
          '<h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">' +
            '<span class="text-xl">ğŸ“‹</span>' +
            '<span>í’ˆëª©ë³„ ë¶ˆëŸ‰ìœ¨ í˜„í™©</span>' +
            '<span class="text-sm font-normal text-slate-500">(ë¶ˆëŸ‰ìœ¨ ë†’ì€ ìˆœ)</span>' +
          '</h3>' +
          '<button id="toggle-itemDefect" onclick="toggleCollapse(\'itemDefect\')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">' +
            '<svg class="w-4 h-4 transition-transform ' + toggleBtnClass + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>' +
            toggleBtnText +
          '</button>' +
        '</div>' +
        '<div id="collapse-itemDefect" class="collapsible-content ' + collapseClass + '">' +
          '<div class="overflow-x-auto">' +
            '<table class="data-table w-full">' +
              '<thead>' +
                '<tr>' +
                  '<th class="text-center sortable" data-type="number" data-col="0" style="width: 50px;">ìˆœìœ„</th>' +
                  '<th class="text-left sortable" data-type="string" data-col="1">í’ˆëª©ëª…</th>' +
                  '<th class="text-left sortable" data-type="string" data-col="2">ê³µì •</th>' +
                  '<th class="text-right sortable" data-type="number" data-col="3">ìƒì‚°ìˆ˜ëŸ‰</th>' +
                  '<th class="text-right sortable" data-type="number" data-col="4">ì–‘í’ˆìˆ˜ëŸ‰</th>' +
                  '<th class="text-right sortable" data-type="number" data-col="5">ë¶ˆëŸ‰ìˆ˜ëŸ‰</th>' +
                  '<th class="text-right sortable" data-type="number" data-col="6">ë¶ˆëŸ‰ê¸ˆì•¡</th>' +
                  '<th class="text-right sortable" data-type="number" data-col="7">ë¶ˆëŸ‰ìœ¨</th>' +
                  '<th class="text-right sortable" data-type="number" data-col="8">ìˆ˜ìœ¨</th>' +
                  '<th class="text-center sortable" data-type="string" data-col="9">ìƒíƒœ</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' + rows + '</tbody>' +
            '</table>' +
          '</div>' +
          footerText +
        '</div>' +
      '</div>';
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadExcel(data, headers, filename) {
      if (!data || data.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // BOM for UTF-8
      const BOM = '\uFEFF';

      // í—¤ë” í–‰
      let csv = headers.join(',') + '\n';

      // ë°ì´í„° í–‰
      data.forEach(row => {
        const values = headers.map(header => {
          let value = row[header] ?? '';
          // ì‰¼í‘œ, ë”°ì˜´í‘œ, ì¤„ë°”ê¿ˆì´ ìˆìœ¼ë©´ ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°
          if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
            value = '"' + value.replace(/"/g, '""') + '"';
          }
          return value;
        });
        csv += values.join(',') + '\n';
      });

      // ë‹¤ìš´ë¡œë“œ
      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename + '_' + new Date().toISOString().slice(0, 10) + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ìì¬ë¶ˆëŸ‰ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadMaterialDefectExcel() {
      const data = state.materialDefectData || [];
      if (data.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const headers = ['ë¶€í’ˆì½”ë“œ', 'ê³ ê°ì‚¬ P/N', 'ë¶€í’ˆëª…', 'ê·œê²©', 'ìƒì‚°ì¼ì', 'ë¶ˆëŸ‰í•©ê³„'];
      const exportData = data.map(d => ({
        'ë¶€í’ˆì½”ë“œ': d.partCode,
        'ê³ ê°ì‚¬ P/N': d.customerPN,
        'ë¶€í’ˆëª…': d.partName,
        'ê·œê²©': d.spec,
        'ìƒì‚°ì¼ì': d.date,
        'ë¶ˆëŸ‰í•©ê³„': d.defectTotal
      }));

      downloadExcel(exportData, headers, 'ìì¬ë¶ˆëŸ‰í˜„í™©');
    }

    // ë¶ˆëŸ‰ìˆ˜ë¦¬ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadRepairStatusExcel() {
      const data = state.repairStatusData || [];
      if (data.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const headers = ['í’ˆëª©ìœ í˜•', 'ë¶€í’ˆì½”ë“œ', 'ê³ ê°ì‚¬ P/N', 'ë¶€í’ˆëª…', 'ê·œê²©', 'ìƒì‚°ì¼ì', 'ì‘ì—…ì§€ì‹œë²ˆí˜¸', 'ìƒì‚°ìˆ˜ëŸ‰', 'ìˆ˜ë¦¬ìˆ˜ëŸ‰'];
      const exportData = data.map(d => ({
        'í’ˆëª©ìœ í˜•': d.itemType,
        'ë¶€í’ˆì½”ë“œ': d.partCode,
        'ê³ ê°ì‚¬ P/N': d.customerPN,
        'ë¶€í’ˆëª…': d.partName,
        'ê·œê²©': d.spec,
        'ìƒì‚°ì¼ì': d.date,
        'ì‘ì—…ì§€ì‹œë²ˆí˜¸': d.workOrder,
        'ìƒì‚°ìˆ˜ëŸ‰': d.productionQty,
        'ìˆ˜ë¦¬ìˆ˜ëŸ‰': d.repairQty
      }));

      downloadExcel(exportData, headers, 'ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™©');
    }

    // ê²€í¬ì¥í˜„í™© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadPackagingExcel() {
      const data = state.packagingStatusData || [];
      if (data.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const headers = ['ê³µì •', 'ê³µì •êµ¬ë¶„', 'í’ˆëª©ì½”ë“œ', 'ê³ ê°ì‚¬ P/N', 'í’ˆëª©ëª…', 'ìƒì‚° Lot No', 'ì„¤ë¹„ì½”ë“œ', 'ì„¤ë¹„ëª…', 'ë¶ˆëŸ‰ìˆ˜ëŸ‰', 'ìˆ˜ë¦¬ìˆ˜ëŸ‰', 'íê¸°ìˆ˜ëŸ‰', 'ìƒì‚°ì¼ì'];
      const exportData = data.map(d => ({
        'ê³µì •': d.process,
        'ê³µì •êµ¬ë¶„': d.processType,
        'í’ˆëª©ì½”ë“œ': d.itemCode,
        'ê³ ê°ì‚¬ P/N': d.customerPN,
        'í’ˆëª©ëª…': d.itemName,
        'ìƒì‚° Lot No': d.lotNo,
        'ì„¤ë¹„ì½”ë“œ': d.equipmentCode,
        'ì„¤ë¹„ëª…': d.equipmentName,
        'ë¶ˆëŸ‰ìˆ˜ëŸ‰': d.defectQty,
        'ìˆ˜ë¦¬ìˆ˜ëŸ‰': d.repairQty,
        'íê¸°ìˆ˜ëŸ‰': d.disposalQty,
        'ìƒì‚°ì¼ì': d.productionDate
      }));

      downloadExcel(exportData, headers, 'ê²€í¬ì¥í˜„í™©');
    }

    // ì¬ê³µì¬ê³  ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadWipInventoryExcel() {
      const data = state.wipInventoryData || [];
      if (data.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const headers = ['í’ˆëª©ìœ í˜•', 'í’ˆëª©ì½”ë“œ', 'ê³ ê°ì‚¬ P/N', 'í’ˆëª©ëª…', 'ê·œê²©', 'ì¬ê³ ', 'ì œì¡°ì›ê°€', 'ì¬ê³ ê¸ˆì•¡'];
      const exportData = data.map(d => ({
        'í’ˆëª©ìœ í˜•': d.itemType,
        'í’ˆëª©ì½”ë“œ': d.itemCode,
        'ê³ ê°ì‚¬ P/N': d.customerPN,
        'í’ˆëª©ëª…': d.itemName,
        'ê·œê²©': d.spec,
        'ì¬ê³ ': d.stock,
        'ì œì¡°ì›ê°€': d.unitCost,
        'ì¬ê³ ê¸ˆì•¡': d.stockValue
      }));

      downloadExcel(exportData, headers, 'ì¬ê³µì¬ê³ ê¸ˆì•¡');
    }

    // ìƒì‚°ë°ì´í„° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadProductionDataExcel() {
      const data = getFilteredData();
      if (data.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const headers = ['ìƒì‚°ì¼ì', 'ê³µì •', 'í’ˆì¢…', 'ê³ ê°ì‚¬', 'ì„¤ë¹„(ë¼ì¸)ëª…', 'í’ˆëª©ëª…', 'ìƒì‚°ìˆ˜ëŸ‰', 'ì–‘í’ˆìˆ˜ëŸ‰', 'ë¶ˆëŸ‰ìˆ˜ëŸ‰', 'íê¸°ìˆ˜ëŸ‰', 'ì‘ì—…ì‹œê°„(ë¶„)', 'ì‘ì—…ì¸ì›', 'UPH', 'UPPH'];
      const exportData = data.map(d => ({
        'ìƒì‚°ì¼ì': d['ìƒì‚°ì¼ì'],
        'ê³µì •': d['ê³µì •'],
        'í’ˆì¢…': d['í’ˆì¢…'],
        'ê³ ê°ì‚¬': d['ê³ ê°ì‚¬'],
        'ì„¤ë¹„(ë¼ì¸)ëª…': d['ì„¤ë¹„(ë¼ì¸)ëª…'],
        'í’ˆëª©ëª…': d['í’ˆëª©ëª…'],
        'ìƒì‚°ìˆ˜ëŸ‰': d['ìƒì‚°ìˆ˜ëŸ‰'],
        'ì–‘í’ˆìˆ˜ëŸ‰': d['ì–‘í’ˆìˆ˜ëŸ‰'],
        'ë¶ˆëŸ‰ìˆ˜ëŸ‰': d['ë¶ˆëŸ‰ìˆ˜ëŸ‰'],
        'íê¸°ìˆ˜ëŸ‰': d['íê¸°ìˆ˜ëŸ‰'],
        'ì‘ì—…ì‹œê°„(ë¶„)': d['ì‘ì—…ì‹œê°„(ë¶„)'],
        'ì‘ì—…ì¸ì›': d['ì‘ì—…ì¸ì›'],
        'UPH': d['UPH'],
        'UPPH': d['UPPH']
      }));

      downloadExcel(exportData, headers, 'ìƒì‚°ë°ì´í„°');
    }

    // í”¼ë´‡ í…Œì´ë¸” ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadPivotExcel() {
      const data = state.detailData || [];
      if (data.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const headers = Object.keys(data[0] || {});
      downloadExcel(data, headers, 'í”¼ë´‡ë°ì´í„°');
    }

    // OEE ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadOEEExcel() {
      const filteredData = getFilteredData();
      const oeeData = getOEEData(filteredData);
      if (oeeData.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const headers = ['ê³µì •', 'ìƒì‚°ìˆ˜ëŸ‰', 'ì–‘í’ˆìˆ˜ëŸ‰', 'ì‹œê°„ê°€ë™ìœ¨(%)', 'ì„±ëŠ¥ê°€ë™ìœ¨(%)', 'ì–‘í’ˆìœ¨(%)', 'ì¢…í•©íš¨ìœ¨(OEE)(%)'];
      const exportData = oeeData.map(d => ({
        'ê³µì •': d.process,
        'ìƒì‚°ìˆ˜ëŸ‰': d.production,
        'ì–‘í’ˆìˆ˜ëŸ‰': d.good,
        'ì‹œê°„ê°€ë™ìœ¨(%)': d.availability,
        'ì„±ëŠ¥ê°€ë™ìœ¨(%)': d.performance,
        'ì–‘í’ˆìœ¨(%)': d.quality,
        'ì¢…í•©íš¨ìœ¨(OEE)(%)': d.oee
      }));

      downloadExcel(exportData, headers, 'OEE_ì¢…í•©íš¨ìœ¨');
    }

    // ë¹„ê°€ë™ í˜„í™© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadDowntimeExcel() {
      const downtimeData = state.downtimeData || [];
      if (downtimeData.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const headers = Object.keys(downtimeData[0] || {});
      downloadExcel(downtimeData, headers, 'ë¹„ê°€ë™í˜„í™©');
    }

    // ì„¤ë¹„ ì •ë ¬ (1í˜¸ê¸°~24í˜¸ê¸° ìˆœ)
    function sortEquipments(equipments) {
      return [...equipments].sort((a, b) => {
        const numA = parseInt(a.equipment.match(/(\d+)í˜¸ê¸°/)?.[1] || '999');
        const numB = parseInt(b.equipment.match(/(\d+)í˜¸ê¸°/)?.[1] || '999');
        return numA - numB;
      });
    }

    // í…Œì´ë¸” ì •ë ¬ ê¸°ëŠ¥
    function initTableSort() {
      document.querySelectorAll('.data-table').forEach(table => {
        // ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ìœ¼ë¡œ ë³€ê²½ (theadì— í•œ ë²ˆë§Œ ë°”ì¸ë”©)
        const thead = table.querySelector('thead');
        if (!thead) return;

        // ê¸°ì¡´ í•¸ë“¤ëŸ¬ ì œê±° í›„ ìƒˆë¡œ ë°”ì¸ë”©
        thead.onclick = function(e) {
          const clickedTh = e.target.closest('th.sortable');
          if (!clickedTh) return;

          const sortType = clickedTh.dataset.type || 'string';
          const headerRow = clickedTh.parentElement;
          const tbody = table.querySelector('tbody');
          if (!headerRow || !tbody) return;

          // ì»¬ëŸ¼ ì¸ë±ìŠ¤: data-col ì†ì„± ìš°ì„ , ì—†ìœ¼ë©´ DOM ìœ„ì¹˜ë¡œ ê³„ì‚°
          let colIndex;
          if (clickedTh.dataset.col !== undefined) {
            colIndex = parseInt(clickedTh.dataset.col);
          } else {
            const siblings = Array.from(headerRow.children);
            colIndex = siblings.indexOf(clickedTh);
          }
          if (colIndex === -1 || isNaN(colIndex)) return;

          const rows = Array.from(tbody.querySelectorAll('tr'));
          const isAsc = clickedTh.classList.contains('asc');

          // ì •ë ¬ ë°©í–¥ í† ê¸€
          headerRow.querySelectorAll('th').forEach(h => h.classList.remove('asc', 'desc'));
          clickedTh.classList.add(isAsc ? 'desc' : 'asc');

          // ì •ë ¬ ìˆ˜í–‰
          rows.sort((a, b) => {
            const aCell = a.cells[colIndex];
            const bCell = b.cells[colIndex];

            if (!aCell || !bCell) return 0;

            let aVal, bVal;

            if (sortType === 'number') {
              aVal = parseFloat(aCell.textContent.replace(/[,%sì´ˆ]/g, '')) || 0;
              bVal = parseFloat(bCell.textContent.replace(/[,%sì´ˆ]/g, '')) || 0;
            } else if (sortType === 'equipment') {
              const aMatch = aCell.textContent.match(/(\d+)í˜¸ê¸°/);
              const bMatch = bCell.textContent.match(/(\d+)í˜¸ê¸°/);
              aVal = aMatch ? parseInt(aMatch[1]) : 999;
              bVal = bMatch ? parseInt(bMatch[1]) : 999;
            } else {
              aVal = aCell.textContent.trim().toLowerCase();
              bVal = bCell.textContent.trim().toLowerCase();
            }

            let result;
            if (typeof aVal === 'number' && typeof bVal === 'number') {
              result = aVal - bVal;
            } else {
              result = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            }

            return isAsc ? -result : result;
          });

          rows.forEach(row => tbody.appendChild(row));
        };
      });
    }

    // ì°¨íŠ¸ íŒŒê´´
    function destroyCharts() {
      Object.values(charts).forEach(chart => chart && chart.destroy());
      charts = {};
    }

    // ë¡œê·¸ì¸ í™”ë©´
    function renderLogin() {
      if (isSignUpMode) {
        return `
          <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6">
            <div class="w-full max-w-md bg-white/5 backdrop-blur-xl p-10 rounded-3xl border border-white/10 shadow-2xl">
              <div class="text-center mb-8">
                <h1 class="text-xl font-bold text-white mb-2">ê³„ì • ë“±ë¡</h1>
                <p class="text-slate-400 text-sm">ì‹ ì„±ì˜¤í† í… ìƒì‚°ì‹¤ ëŒ€ì‹œë³´ë“œ</p>
              </div>
              <div class="space-y-4">
                <input type="text" id="displayNameInput" placeholder="ì´ë¦„ (ì„ íƒì‚¬í•­)"
                  class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <input type="email" id="emailInput" placeholder="ì´ë©”ì¼ ì£¼ì†Œ"
                  class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)"
                  class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  onkeypress="if(event.key==='Enter')handleSignUp()">
                <button onclick="handleSignUp()"
                  class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-400 hover:to-blue-500 py-4 rounded-xl font-bold text-lg text-white transition-all shadow-lg">
                  ê³„ì • ìƒì„±
                </button>
              </div>
              <div class="mt-6 text-center">
                <button onclick="toggleAuthMode()" class="text-slate-400 hover:text-white text-sm transition-colors">
                  â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
              </div>
              <p class="mt-4 text-center text-slate-500 text-xs">ì²« ë²ˆì§¸ ë“±ë¡ìëŠ” ê´€ë¦¬ì ê¶Œí•œì„ ë°›ìŠµë‹ˆë‹¤</p>
            </div>
          </div>
        `;
      }

      return `
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6">
          <div class="w-full max-w-md bg-white/5 backdrop-blur-xl p-10 rounded-3xl border border-white/10 shadow-2xl">
            <div class="text-center mb-8">
              <h1 class="text-2xl font-bold text-white mb-2">ì‹ ì„±ì˜¤í† í…</h1>
              <p class="text-emerald-400 text-sm font-medium tracking-wide">ìƒì‚°ì‹¤ ëŒ€ì‹œë³´ë“œ</p>
            </div>
            <div class="space-y-4">
              <input type="email" id="emailInput" placeholder="ì´ë©”ì¼ ì£¼ì†Œ"
                class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
              <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸"
                class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                onkeypress="if(event.key==='Enter')handleLogin()">
              <button id="loginBtn" onclick="handleLogin()"
                class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 py-4 rounded-xl font-bold text-lg text-white transition-all shadow-lg">
                ì‹œìŠ¤í…œ ì ‘ì†
              </button>
            </div>
            <div class="mt-6 flex justify-between items-center">
              <button onclick="handlePasswordReset()" class="text-slate-400 hover:text-white text-sm transition-colors">
                ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°
              </button>
              <button onclick="toggleAuthMode()" class="text-emerald-400 hover:text-emerald-300 text-sm transition-colors font-medium">
                ê³„ì • ë“±ë¡ â†’
              </button>
            </div>
            <div class="mt-6 pt-6 border-t border-white/10">
              <p class="text-center text-slate-500 text-xs">ğŸ”’ Supabase Auth ë³´ì•ˆ ì¸ì¦</p>
            </div>
          </div>
        </div>
      `;
    }

    // í˜„ì¬ ê³µì •ì˜ í•˜ìœ„ë©”ë‰´ ê°€ì ¸ì˜¤ê¸°
    function getCurrentSubMenus() {
      if (!state.activeProcess) return [];
      const process = processMenus.find(p => p.id === state.activeProcess);
      return process ? process.subMenus : [];
    }

    // ë©”ì¸ ëŒ€ì‹œë³´ë“œ
    function renderDashboard() {
      const filteredData = getFilteredData();  // ì›”ë³„ í•„í„°ë§ëœ ë°ì´í„°
      const yearlyData = getYearlyData();      // ë…„ê°„ ë°ì´í„° (ì›” í•„í„° ì œì™¸)
      const stats = getSummaryStats(filteredData);
      const yearlyStats = getSummaryStats(yearlyData);  // ë…„ê°„ í†µê³„
      const equipments = getUniqueValues('equipment');
      const currentSubMenus = getCurrentSubMenus();

      return `
        <div class="min-h-screen bg-[#f5f5f7]">
          <!-- Main Navigation -->
          <nav class="bg-slate-900 px-6 py-3 flex items-center justify-between sticky top-0 z-50">
            <div class="flex items-center gap-8">
              <div class="flex items-center gap-3">
                <div class="flex gap-0.5">
                  <div class="w-1 h-4 bg-emerald-400 rounded-full opacity-70"></div>
                  <div class="w-1 h-5 bg-emerald-500 rounded-full"></div>
                  <div class="w-1 h-4 bg-emerald-400 rounded-full opacity-70"></div>
                </div>
                <div>
                  <h1 class="text-sm font-bold text-white tracking-tight leading-none">ì‹ ì„±ì˜¤í† í…</h1>
                  <p class="text-[10px] text-emerald-400 font-medium tracking-wider">PRODUCTION</p>
                </div>
              </div>
              <div class="flex gap-1">
                <button onclick="setTab('overview')" class="nav-btn ${state.activeTab === 'overview' ? 'active' : ''}">ì¢…í•©í˜„í™©</button>
                <button onclick="setTab('process')" class="nav-btn ${state.activeTab === 'process' ? 'active' : ''}">ê³µì •í˜„í™©</button>
                <button onclick="setTab('downtime')" class="nav-btn ${state.activeTab === 'downtime' ? 'active' : ''}">ë¹„ê°€ë™í˜„í™©</button>
                <button onclick="setTab('wip-inventory')" class="nav-btn ${state.activeTab === 'wip-inventory' ? 'active' : ''}">ì¬ê³µì¬ê³ </button>
                <button onclick="setTab('quality')" class="nav-btn ${state.activeTab === 'quality' ? 'active' : ''}">í’ˆì§ˆë¶„ì„</button>
                <button onclick="setTab('data')" class="nav-btn ${state.activeTab === 'data' ? 'active' : ''}">ë°ì´í„°ì¡°íšŒ</button>
                <button onclick="setTab('upload')" class="nav-btn ${state.activeTab === 'upload' ? 'active' : ''}">íŒŒì¼ì—…ë¡œë“œ</button>
                ${isAdmin() ? `<button onclick="setTab('admin')" class="nav-btn ${state.activeTab === 'admin' ? 'active' : ''}" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white;">ğŸ‘‘ ê´€ë¦¬ì</button>` : ''}
              </div>
            </div>
            <div class="flex items-center gap-4">
              ${userProfile ? `
                <span class="flex items-center gap-2 text-white text-sm">
                  <span class="px-2 py-1 rounded text-xs font-medium ${
                    userProfile.role === 'admin' ? 'bg-red-500/20 text-red-400' :
                    userProfile.role === 'editor' ? 'bg-blue-500/20 text-blue-400' :
                    'bg-slate-500/20 text-slate-400'
                  }">${userProfile.role === 'admin' ? 'ê´€ë¦¬ì' : userProfile.role === 'editor' ? 'í¸ì§‘ì' : 'ì¡°íšŒì'}</span>
                  ${userProfile.display_name || currentUser?.email?.split('@')[0]}
                </span>
              ` : ''}
              <span class="flex items-center gap-2 text-blue-400 text-sm font-medium">
                <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span>
                ${state.rawData.length.toLocaleString()}ê±´
              </span>
              <span class="flex items-center gap-2 ${supabaseConnected ? 'text-emerald-400' : 'text-slate-500'} text-sm">
                <span class="w-2 h-2 ${supabaseConnected ? 'bg-emerald-400' : 'bg-slate-500'} rounded-full"></span>
                ${supabaseConnected ? 'ğŸ”’ ì—°ê²°ë¨' : 'Offline'}
              </span>
              <span id="sync-status" class="text-amber-400 text-xs"></span>
              ${supabaseConnected ? `<button onclick="syncWithSupabase()" class="text-sky-400 hover:text-sky-300 text-sm font-medium transition-colors">ë™ê¸°í™”</button>` : ''}
              <button onclick="handleLogout()" class="text-slate-400 hover:text-white text-sm font-medium transition-colors">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
          </nav>

          <!-- 2ì°¨ ì„œë¸Œë©”ë‰´ (ì¬ê³µì¬ê³ ) - third-nav ìŠ¤íƒ€ì¼ ì ìš© -->
          ${state.activeTab === 'wip-inventory' ? `
            <div class="third-nav">
              <div class="third-nav-inner">
                <div class="third-nav-tabs">
                  <div class="third-nav-tab ${state.wipSubTab === 'status' ? 'active' : ''}" onclick="setWipSubTab('status')">
                    ğŸ“Š ì¬ê³µì¬ê³ í˜„í™©
                  </div>
                  <div class="third-nav-tab ${state.wipSubTab === 'price' ? 'active' : ''}" onclick="setWipSubTab('price')">
                    ğŸ’° ì¬ê³µì¬ê³ ë‹¨ê°€í‘œ
                  </div>
                </div>
              </div>
            </div>
          ` : ''}

          <!-- 2ì°¨ ì„œë¸Œë©”ë‰´ (ê³µì • ì„ íƒ) -->
          ${state.activeTab === 'process' ? `
            <div class="sub-nav">
              <div class="sub-nav-inner">
                <div class="sub-nav-tabs">
                  ${processMenus.map(p => `
                    <div class="sub-nav-tab ${state.activeProcess === p.id ? 'active' : ''}" onclick="setProcess('${p.id}')">
                      ${p.name}
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          ` : ''}

          <!-- 3ì°¨ ì„œë¸Œë©”ë‰´ (í•˜ìœ„ ë©”ë‰´) -->
          ${state.activeTab === 'process' && state.activeProcess && currentSubMenus.length > 0 ? `
            <div class="third-nav">
              <div class="third-nav-inner">
                <div class="third-nav-tabs">
                  ${currentSubMenus.map(sub => `
                    <div class="third-nav-tab ${state.activeSubMenu === sub.id ? 'active' : ''}" onclick="setSubMenu('${sub.id}')">
                      ${sub.name}
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          ` : ''}

          <main class="p-6 max-w-[1400px] mx-auto">
            ${state.activeTab === 'upload' ? renderFileUpload() : ''}
            ${state.activeTab === 'downtime' ? renderDowntime() : ''}
            ${state.activeTab === 'wip-inventory' ? renderWipInventoryPage() : ''}
            ${state.activeTab === 'admin' ? '<div id="admin-panel-container"><div class="text-center py-8"><div class="animate-spin w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full mx-auto"></div><p class="mt-4 text-slate-500">ì‚¬ìš©ì ëª©ë¡ ë¡œë”© ì¤‘...</p></div></div>' : ''}
            ${state.activeTab !== 'upload' && state.activeTab !== 'downtime' && state.activeTab !== 'wip-inventory' && state.activeTab !== 'admin' ? (state.rawData.length === 0 ? renderUploadPrompt() : `
              ${state.activeTab === 'overview' ? renderOverview(stats, filteredData, yearlyData, yearlyStats) : ''}
              ${state.activeTab === 'process' ? renderProcess(filteredData) : ''}
              ${state.activeTab === 'quality' ? renderQuality(stats, filteredData) : ''}
              ${state.activeTab === 'data' ? renderDataTable(filteredData) : ''}
            `) : ''}
          </main>
        </div>
      `;
    }

    // ê´€ë¦¬ì íŒ¨ë„ - ì‚¬ìš©ì ê´€ë¦¬
    async function renderAdminPanel() {
      const users = await getAllUsers();
      const pendingUsers = users.filter(u => !u.approved && u.email !== ADMIN_EMAIL);
      const approvedUsers = users.filter(u => u.approved || u.email === ADMIN_EMAIL);

      return `
        <div class="space-y-6">
          <div class="section-header">
            <div class="section-title">ğŸ‘‘ ê´€ë¦¬ì íŒ¨ë„ - ì‚¬ìš©ì ê´€ë¦¬</div>
          </div>

          <!-- ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì -->
          <div class="card">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <span class="w-3 h-3 bg-amber-500 rounded-full animate-pulse"></span>
              ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ (${pendingUsers.length}ëª…)
            </h3>
            ${pendingUsers.length === 0 ? `
              <div class="text-center py-8 text-slate-400">
                <div class="text-4xl mb-2">âœ…</div>
                <p>ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</p>
              </div>
            ` : `
              <div class="overflow-x-auto">
                <table class="data-table w-full">
                  <thead>
                    <tr>
                      <th>ì´ë©”ì¼</th>
                      <th>ì´ë¦„</th>
                      <th>ê°€ì…ì¼</th>
                      <th class="text-center">ì‘ì—…</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${pendingUsers.map(user => `
                      <tr class="bg-amber-50">
                        <td class="font-medium">${user.email}</td>
                        <td>${user.display_name || '-'}</td>
                        <td>${new Date(user.created_at).toLocaleDateString('ko-KR')}</td>
                        <td class="text-center">
                          <button onclick="handleApproveUser('${user.id}')"
                            class="px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white text-sm rounded-lg mr-2 transition-colors">
                            âœ“ ìŠ¹ì¸
                          </button>
                          <button onclick="handleRejectUser('${user.id}')"
                            class="px-3 py-1.5 bg-rose-500 hover:bg-rose-600 text-white text-sm rounded-lg transition-colors">
                            âœ• ê±°ë¶€
                          </button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>

          <!-- ìŠ¹ì¸ëœ ì‚¬ìš©ì ëª©ë¡ -->
          <div class="card">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <span class="w-3 h-3 bg-emerald-500 rounded-full"></span>
              ìŠ¹ì¸ëœ ì‚¬ìš©ì (${approvedUsers.length}ëª…)
            </h3>
            <div class="overflow-x-auto">
              <table class="data-table w-full">
                <thead>
                  <tr>
                    <th>ì´ë©”ì¼</th>
                    <th>ì´ë¦„</th>
                    <th>ì—­í• </th>
                    <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                    <th>ê°€ì…ì¼</th>
                    <th class="text-center">ìƒíƒœ</th>
                  </tr>
                </thead>
                <tbody>
                  ${approvedUsers.map(user => `
                    <tr>
                      <td class="font-medium">
                        ${user.email}
                        ${user.email === ADMIN_EMAIL ? '<span class="ml-2 px-2 py-0.5 bg-amber-100 text-amber-700 text-xs rounded-full">ê´€ë¦¬ì</span>' : ''}
                      </td>
                      <td>${user.display_name || '-'}</td>
                      <td>
                        ${user.email === ADMIN_EMAIL ?
                          '<span class="px-2 py-1 bg-amber-100 text-amber-700 text-xs rounded-full font-medium">admin</span>' :
                          `<select onchange="handleChangeRole('${user.id}', this.value)"
                            class="px-2 py-1 text-xs rounded-lg border border-slate-200 bg-white cursor-pointer
                            focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                            ${user.role === 'admin' ? 'text-amber-700 bg-amber-50' : user.role === 'editor' ? 'text-blue-700 bg-blue-50' : 'text-slate-600 bg-slate-50'}">
                            <option value="viewer" ${(user.role || 'viewer') === 'viewer' ? 'selected' : ''}>ğŸ‘ï¸ viewer (ì¡°íšŒ)</option>
                            <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>âœï¸ editor (í¸ì§‘)</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>ğŸ‘‘ admin (ê´€ë¦¬)</option>
                          </select>`
                        }
                      </td>
                      <td>${user.last_login ? new Date(user.last_login).toLocaleString('ko-KR') : '-'}</td>
                      <td>${new Date(user.created_at).toLocaleDateString('ko-KR')}</td>
                      <td class="text-center">
                        ${user.email === ADMIN_EMAIL ?
                          '<span class="text-amber-500">ğŸ‘‘</span>' :
                          `<button onclick="handleRejectUser('${user.id}')" class="px-2 py-1 text-xs text-rose-500 hover:bg-rose-50 rounded transition-colors">ë¹„í™œì„±í™”</button>`
                        }
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // ì‚¬ìš©ì ìŠ¹ì¸ í•¸ë“¤ëŸ¬
    async function handleApproveUser(userId) {
      if (!confirm('ì´ ì‚¬ìš©ìë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const result = await approveUser(userId);
      if (result.success) {
        alert('ì‚¬ìš©ìê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        render();
      } else {
        alert('ìŠ¹ì¸ ì‹¤íŒ¨: ' + result.error);
      }
    }

    // ì‚¬ìš©ì ê±°ë¶€ í•¸ë“¤ëŸ¬
    async function handleRejectUser(userId) {
      if (!confirm('ì´ ì‚¬ìš©ìë¥¼ ê±°ë¶€/ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const result = await rejectUser(userId);
      if (result.success) {
        alert('ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        render();
      } else {
        alert('ì²˜ë¦¬ ì‹¤íŒ¨: ' + result.error);
      }
    }

    // ì‚¬ìš©ì ì—­í•  ë³€ê²½ í•¸ë“¤ëŸ¬
    async function handleChangeRole(userId, newRole) {
      const roleNames = { viewer: 'ì¡°íšŒì', editor: 'í¸ì§‘ì', admin: 'ê´€ë¦¬ì' };
      if (!confirm(`ì´ ì‚¬ìš©ìì˜ ì—­í• ì„ "${roleNames[newRole]}"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ viewer: ë°ì´í„° ì¡°íšŒë§Œ ê°€ëŠ¥\nâ€¢ editor: ë°ì´í„° ì—…ë¡œë“œ ê°€ëŠ¥\nâ€¢ admin: ëª¨ë“  ê¶Œí•œ (ì‚¬ìš©ì ê´€ë¦¬ í¬í•¨)`)) {
        render(); // ì·¨ì†Œì‹œ ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('user_profiles')
          .update({ role: newRole })
          .eq('id', userId);

        if (error) throw error;

        alert(`ì—­í• ì´ "${roleNames[newRole]}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        render();
      } catch (err) {
        console.error('ì—­í•  ë³€ê²½ ì‹¤íŒ¨:', err);
        alert('ì—­í•  ë³€ê²½ ì‹¤íŒ¨: ' + err.message);
        render(); // ì—ëŸ¬ì‹œ ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
      }
    }

    // ì—…ë¡œë“œ ì•ˆë‚´
    function renderUploadPrompt() {
      return `
        <div class="card text-center py-16" style="background: linear-gradient(135deg, #f8fafc 0%, #fff 100%);">
          <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-slate-800 mb-2">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h2>
          <p class="text-slate-500 mb-8">MESì—ì„œ ì¶”ì¶œí•œ CSV íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ì‹œì‘í•©ë‹ˆë‹¤</p>

          <div class="inline-flex items-center gap-3 px-5 py-3 bg-white rounded-xl shadow-sm border border-slate-200 mb-8">
            <span class="text-slate-500 text-sm font-medium">ëŒ€ìƒì›”</span>
            <select class="bg-slate-50 border-0 rounded-lg px-4 py-2 text-slate-700 font-semibold text-base focus:ring-2 focus:ring-blue-500 cursor-pointer" onchange="setSelectedMonth(this.value)">
              ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}ì›”</option>`).join('')}
            </select>
          </div>

          <div class="flex items-center justify-center gap-4 flex-wrap max-w-2xl mx-auto">
            <label class="group flex-1 min-w-[180px] max-w-[220px] p-5 bg-white rounded-2xl border-2 border-dashed border-slate-200 hover:border-emerald-400 hover:shadow-lg cursor-pointer transition-all duration-300">
              <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-emerald-50 group-hover:bg-emerald-100 flex items-center justify-center text-2xl transition-colors">ğŸ“Š</div>
              <div class="font-semibold text-slate-700 mb-1">ìƒì‚°ì‹¤ì </div>
              <div class="text-xs text-slate-400">CSV íŒŒì¼ ì„ íƒ</div>
              <input type="file" accept=".csv" onchange="handleFileUpload(event)" class="hidden">
            </label>
            <label class="group flex-1 min-w-[180px] max-w-[220px] p-5 bg-white rounded-2xl border-2 border-dashed border-slate-200 hover:border-blue-400 hover:shadow-lg cursor-pointer transition-all duration-300">
              <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-blue-50 group-hover:bg-blue-100 flex items-center justify-center text-2xl transition-colors">âš™ï¸</div>
              <div class="font-semibold text-slate-700 mb-1">ê°€ë™ìœ¨</div>
              <div class="text-xs text-slate-400">CSV íŒŒì¼ ì„ íƒ</div>
              <input type="file" accept=".csv" onchange="handleAvailabilityUpload(event)" class="hidden">
            </label>
            <label class="group flex-1 min-w-[180px] max-w-[220px] p-5 bg-white rounded-2xl border-2 border-dashed border-slate-200 hover:border-amber-400 hover:shadow-lg cursor-pointer transition-all duration-300">
              <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-amber-50 group-hover:bg-amber-100 flex items-center justify-center text-2xl transition-colors">â±ï¸</div>
              <div class="font-semibold text-slate-700 mb-1">CTí˜„í™©</div>
              <div class="text-xs text-slate-400">CSV íŒŒì¼ ì„ íƒ</div>
              <input type="file" accept=".csv" onchange="handleCTUpload(event)" class="hidden">
            </label>
          </div>
          ${state.ctData.length > 0 ? `<div class="mt-6 inline-flex items-center gap-2 px-4 py-2 bg-amber-50 text-amber-700 rounded-lg text-sm font-medium"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>CTí˜„í™© ${state.ctData.length.toLocaleString()}ê±´ ë¡œë“œë¨</div>` : ''}
        </div>
      `;
    }

    // íŒŒì¼ ì—…ë¡œë“œ ê´€ë¦¬ í˜ì´ì§€
    function renderFileUpload() {
      return `
        <div class="card mb-6" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
          <div class="flex items-center justify-between mb-8">
            <div>
              <h2 class="text-2xl font-bold text-slate-800 mb-1">ë°ì´í„° ì—…ë¡œë“œ</h2>
              <p class="text-slate-500 text-sm">MESì—ì„œ ì¶”ì¶œí•œ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            </div>
            <div class="flex items-center gap-3 px-5 py-3 bg-white rounded-xl shadow-sm border border-slate-200">
              <span class="text-slate-500 text-sm font-medium">ëŒ€ìƒì›”</span>
              <select class="bg-slate-50 border-0 rounded-lg px-4 py-2 text-slate-700 font-semibold text-base focus:ring-2 focus:ring-blue-500 cursor-pointer" onchange="setSelectedMonth(this.value)">
                ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}ì›”</option>`).join('')}
              </select>
            </div>
          </div>

          <!-- ë©”ì¸ ì—…ë¡œë“œ ì˜ì—­ -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-8">
            <!-- ìƒì‚°ì‹¤ì  -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-emerald-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-emerald-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-emerald-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">ğŸ“Š</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">ìƒì‚°ì‹¤ì </h3>
                  <p class="text-xs text-slate-400 mb-4">ìƒì‚°ìˆ˜ëŸ‰, ì–‘í’ˆ, ë¶ˆëŸ‰</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ì—…ë¡œë“œ
                    <input type="file" accept=".csv" onchange="handleFileUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.rawData.length > 0 ? 'text-emerald-600' : 'text-slate-400'}">
                ${state.rawData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.rawData.length.toLocaleString()}ê±´</span>` : 'ë°ì´í„° ì—†ìŒ'}
              </div>
            </div>

            <!-- ê°€ë™ìœ¨ -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-blue-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-blue-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">âš™ï¸</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">ê°€ë™ìœ¨</h3>
                  <p class="text-xs text-slate-400 mb-4">ê°€ë™ì‹œê°„, ì‹œê°„ê°€ë™ìœ¨</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ì—…ë¡œë“œ
                    <input type="file" accept=".csv" onchange="handleAvailabilityUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.availabilityData.length > 0 ? 'text-blue-600' : 'text-slate-400'}">
                ${state.availabilityData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.availabilityData.length.toLocaleString()}ê±´</span>` : 'ë°ì´í„° ì—†ìŒ'}
              </div>
            </div>

            <!-- ì—…ì¢…ë³„ ë°ì´í„° -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-slate-400 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-slate-400 to-slate-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">ğŸ“‹</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">ì—…ì¢…ë³„ ë°ì´í„°</h3>
                  <p class="text-xs text-slate-400 mb-4">í”¼ë´‡ ë¶„ì„ìš©</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-slate-600 hover:bg-slate-700 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ì—…ë¡œë“œ
                    <input type="file" accept=".csv" onchange="handleDetailUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.detailData.length > 0 ? 'text-slate-600' : 'text-slate-400'}">
                ${state.detailData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.detailData.length.toLocaleString()}ê±´</span>` : 'ë°ì´í„° ì—†ìŒ'}
              </div>
            </div>

            <!-- ë¶€í’ˆë‹¨ê°€í‘œ -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-amber-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-400 to-amber-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-amber-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">ğŸ’°</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">ë¶€í’ˆë‹¨ê°€í‘œ</h3>
                  <p class="text-xs text-slate-400 mb-4">ìƒì‚°ê¸ˆì•¡ ì‚°ì¶œìš©</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-amber-500 hover:bg-amber-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ì—…ë¡œë“œ
                    <input type="file" accept=".csv" onchange="handlePriceUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.priceData.length > 0 ? 'text-amber-600' : 'text-slate-400'}">
                ${state.priceData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.priceData.length.toLocaleString()}ê±´</span>` : 'ë°ì´í„° ì—†ìŒ'}
              </div>
            </div>
          </div>

          <!-- CTí˜„í™© ì„¹ì…˜ -->
          <div class="mb-5">
            <div class="flex items-center gap-2 mb-4">
              <div class="w-8 h-8 rounded-lg bg-amber-100 flex items-center justify-center text-lg">â±ï¸</div>
              <h3 class="font-bold text-slate-700">Cycle Time ë°ì´í„°</h3>
              <span class="text-xs text-slate-400 ml-2">ê³µì •ë³„ ë¶„ë¦¬ ì—…ë¡œë“œ</span>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
            <!-- CT - ì‚¬ì¶œ -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-orange-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-400 to-orange-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-orange-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">ğŸ’‰</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">CT - ì‚¬ì¶œ</h3>
                  <p class="text-xs text-slate-400 mb-4">Injection Molding</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-orange-500 hover:bg-orange-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ì—…ë¡œë“œ
                    <input type="file" accept=".csv" onchange="handleCTUploadByProcess(event, 'ì‚¬ì¶œ')" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${getCTCountByProcess('ì‚¬ì¶œ') > 0 ? 'text-orange-600' : 'text-slate-400'}">
                ${getCTCountByProcess('ì‚¬ì¶œ') > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${getCTCountByProcess('ì‚¬ì¶œ').toLocaleString()}ê±´</span>` : 'ë°ì´í„° ì—†ìŒ'}
              </div>
            </div>

            <!-- CT - ë„ì¥ -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-sky-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-sky-400 to-sky-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-sky-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">ğŸ¨</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">CT - ë„ì¥</h3>
                  <p class="text-xs text-slate-400 mb-4">Painting Process</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-sky-500 hover:bg-sky-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ì—…ë¡œë“œ
                    <input type="file" accept=".csv" onchange="handleCTUploadByProcess(event, 'ë„ì¥')" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${getCTCountByProcess('ë„ì¥') > 0 ? 'text-sky-600' : 'text-slate-400'}">
                ${getCTCountByProcess('ë„ì¥') > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${getCTCountByProcess('ë„ì¥').toLocaleString()}ê±´</span>` : 'ë°ì´í„° ì—†ìŒ'}
              </div>
            </div>

            <!-- CT - ì¡°ë¦½ -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-violet-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-violet-400 to-violet-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-violet-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">ğŸ”§</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">CT - ì¡°ë¦½</h3>
                  <p class="text-xs text-slate-400 mb-4">Assembly Line</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-violet-500 hover:bg-violet-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ì—…ë¡œë“œ
                    <input type="file" accept=".csv" onchange="handleCTUploadByProcess(event, 'ì¡°ë¦½')" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${getCTCountByProcess('ì¡°ë¦½') > 0 ? 'text-violet-600' : 'text-slate-400'}">
                ${getCTCountByProcess('ì¡°ë¦½') > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${getCTCountByProcess('ì¡°ë¦½').toLocaleString()}ê±´</span>` : 'ë°ì´í„° ì—†ìŒ'}
              </div>
            </div>
          </div>

          <!-- ì¡°ë¦½ê³µì • ê´€ë ¨ ë°ì´í„° ì„¹ì…˜ -->
          <div class="mb-5 mt-8">
            <div class="flex items-center gap-2 mb-4">
              <div class="w-8 h-8 rounded-lg bg-rose-100 flex items-center justify-center text-lg">ğŸ”§</div>
              <h3 class="font-bold text-slate-700">ì¡°ë¦½ê³µì • ë°ì´í„°</h3>
              <span class="text-xs text-slate-400 ml-2">ìì¬ë¶ˆëŸ‰, ì¬ê³ , ìˆ˜ë¦¬, ê²€í¬ì¥</span>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
            <!-- ì¡°ë¦½ìì¬ë¶ˆëŸ‰ -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-rose-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-rose-400 to-rose-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-rose-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">âš ï¸</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">ì¡°ë¦½ìì¬ë¶ˆëŸ‰</h3>
                  <p class="text-xs text-slate-400 mb-4">Material Defects</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-rose-500 hover:bg-rose-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ì—…ë¡œë“œ
                    <input type="file" accept=".csv" onchange="handleMaterialDefectUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.materialDefectData.length > 0 ? 'text-rose-600' : 'text-slate-400'}">
                ${state.materialDefectData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.materialDefectData.length.toLocaleString()}ê±´</span>` : 'ë°ì´í„° ì—†ìŒ'}
              </div>
            </div>

            <!-- ì¬ê³µì¬ê³ ê¸ˆì•¡ -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-teal-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-teal-400 to-teal-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-teal-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">ğŸ’°</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">ì¬ê³µì¬ê³ ê¸ˆì•¡</h3>
                  <p class="text-xs text-slate-400 mb-4">WIP Inventory</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-teal-500 hover:bg-teal-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ì—…ë¡œë“œ
                    <input type="file" accept=".csv" onchange="handleWipInventoryUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.wipInventoryData.length > 0 ? 'text-teal-600' : 'text-slate-400'}">
                ${state.wipInventoryData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.wipInventoryData.length.toLocaleString()}ê±´</span>` : 'ë°ì´í„° ì—†ìŒ'}
              </div>
            </div>

            <!-- ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-indigo-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-400 to-indigo-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-indigo-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">ğŸ”¨</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™©</h3>
                  <p class="text-xs text-slate-400 mb-4">Repair Status</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ì—…ë¡œë“œ
                    <input type="file" accept=".csv" onchange="handleRepairStatusUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.repairStatusData.length > 0 ? 'text-indigo-600' : 'text-slate-400'}">
                ${state.repairStatusData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.repairStatusData.length.toLocaleString()}ê±´</span>` : 'ë°ì´í„° ì—†ìŒ'}
              </div>
            </div>

            <!-- ê²€í¬ì¥í˜„í™© -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-purple-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-400 to-purple-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-purple-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">ğŸ“¦</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">ê²€í¬ì¥í˜„í™©</h3>
                  <p class="text-xs text-slate-400 mb-4">Packaging Status</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-purple-500 hover:bg-purple-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ì—…ë¡œë“œ
                    <input type="file" accept=".csv" onchange="handlePackagingStatusUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.packagingStatusData.length > 0 ? 'text-purple-600' : 'text-slate-400'}">
                ${state.packagingStatusData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.packagingStatusData.length.toLocaleString()}ê±´</span>` : 'ë°ì´í„° ì—†ìŒ'}
              </div>
            </div>
          </div>
        </div>

        <!-- ë°ì´í„° í˜„í™© ìš”ì•½ -->
        <div class="card" style="background: white;">
          <div class="flex items-center justify-between mb-5">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-lg">ğŸ“‹</div>
              <h3 class="font-bold text-slate-700">ì—…ë¡œë“œ í˜„í™©</h3>
            </div>
            <button onclick="if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { clearStorage(); }" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg text-xs font-medium transition-colors border border-red-200">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              ì „ì²´ ì´ˆê¸°í™”
            </button>
          </div>
          <div class="overflow-hidden rounded-xl border border-slate-200">
            <table class="data-table" style="margin: 0;">
              <thead>
                <tr>
                  <th class="sortable" data-type="string" data-col="0">ë°ì´í„° ìœ í˜•</th>
                  <th class="sortable text-right" data-type="number" data-col="1">ê±´ìˆ˜</th>
                  <th class="sortable" data-type="string" data-col="2">ìƒíƒœ</th>
                  <th class="text-center" style="width: 80px;">ê´€ë¦¬</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-emerald-100 flex items-center justify-center text-sm">ğŸ“Š</span><span class="font-medium">ìƒì‚°ì‹¤ì </span></div></td>
                  <td class="text-right font-semibold">${state.rawData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.rawData.length > 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'}">${state.rawData.length > 0 ? 'í™œì„±' : 'ì—†ìŒ'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('ìƒì‚°ì‹¤ì  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.removeItem('${STORAGE_KEY}'); state.rawData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.rawData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-blue-100 flex items-center justify-center text-sm">âš™ï¸</span><span class="font-medium">ê°€ë™ìœ¨</span></div></td>
                  <td class="text-right font-semibold">${state.availabilityData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.availabilityData.length > 0 ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'}">${state.availabilityData.length > 0 ? 'í™œì„±' : 'ì—†ìŒ'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('ê°€ë™ìœ¨ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.removeItem('${AVAILABILITY_KEY}'); state.availabilityData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.availabilityData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-slate-200 flex items-center justify-center text-sm">ğŸ“‹</span><span class="font-medium">ì—…ì¢…ë³„ ë°ì´í„°</span></div></td>
                  <td class="text-right font-semibold">${state.detailData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.detailData.length > 0 ? 'bg-slate-200 text-slate-700' : 'bg-slate-100 text-slate-500'}">${state.detailData.length > 0 ? 'í™œì„±' : 'ì—†ìŒ'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('ì—…ì¢…ë³„ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { clearDetailData(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.detailData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-orange-100 flex items-center justify-center text-sm">ğŸ’‰</span><span class="font-medium">CT - ì‚¬ì¶œ</span></div></td>
                  <td class="text-right font-semibold">${getCTCountByProcess('ì‚¬ì¶œ').toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${getCTCountByProcess('ì‚¬ì¶œ') > 0 ? 'bg-orange-100 text-orange-700' : 'bg-slate-100 text-slate-500'}">${getCTCountByProcess('ì‚¬ì¶œ') > 0 ? 'í™œì„±' : 'ì—†ìŒ'}</span></td>
                  <td class="text-center"><button onclick="deleteCTByProcess('ì‚¬ì¶œ')" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${getCTCountByProcess('ì‚¬ì¶œ') === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-sky-100 flex items-center justify-center text-sm">ğŸ¨</span><span class="font-medium">CT - ë„ì¥</span></div></td>
                  <td class="text-right font-semibold">${getCTCountByProcess('ë„ì¥').toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${getCTCountByProcess('ë„ì¥') > 0 ? 'bg-sky-100 text-sky-700' : 'bg-slate-100 text-slate-500'}">${getCTCountByProcess('ë„ì¥') > 0 ? 'í™œì„±' : 'ì—†ìŒ'}</span></td>
                  <td class="text-center"><button onclick="deleteCTByProcess('ë„ì¥')" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${getCTCountByProcess('ë„ì¥') === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-violet-100 flex items-center justify-center text-sm">ğŸ”§</span><span class="font-medium">CT - ì¡°ë¦½</span></div></td>
                  <td class="text-right font-semibold">${getCTCountByProcess('ì¡°ë¦½').toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${getCTCountByProcess('ì¡°ë¦½') > 0 ? 'bg-violet-100 text-violet-700' : 'bg-slate-100 text-slate-500'}">${getCTCountByProcess('ì¡°ë¦½') > 0 ? 'í™œì„±' : 'ì—†ìŒ'}</span></td>
                  <td class="text-center"><button onclick="deleteCTByProcess('ì¡°ë¦½')" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${getCTCountByProcess('ì¡°ë¦½') === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-rose-100 flex items-center justify-center text-sm">âš ï¸</span><span class="font-medium">ì¡°ë¦½ìì¬ë¶ˆëŸ‰</span></div></td>
                  <td class="text-right font-semibold">${state.materialDefectData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.materialDefectData.length > 0 ? 'bg-rose-100 text-rose-700' : 'bg-slate-100 text-slate-500'}">${state.materialDefectData.length > 0 ? 'í™œì„±' : 'ì—†ìŒ'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('ì¡°ë¦½ìì¬ë¶ˆëŸ‰ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.removeItem(MATERIAL_DEFECT_KEY); state.materialDefectData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.materialDefectData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-teal-100 flex items-center justify-center text-sm">ğŸ’°</span><span class="font-medium">ì¬ê³µì¬ê³ ê¸ˆì•¡</span></div></td>
                  <td class="text-right font-semibold">${state.wipInventoryData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.wipInventoryData.length > 0 ? 'bg-teal-100 text-teal-700' : 'bg-slate-100 text-slate-500'}">${state.wipInventoryData.length > 0 ? 'í™œì„±' : 'ì—†ìŒ'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('ì¬ê³µì¬ê³ ê¸ˆì•¡ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.removeItem(WIP_INVENTORY_KEY); state.wipInventoryData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.wipInventoryData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-indigo-100 flex items-center justify-center text-sm">ğŸ”¨</span><span class="font-medium">ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™©</span></div></td>
                  <td class="text-right font-semibold">${state.repairStatusData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.repairStatusData.length > 0 ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-500'}">${state.repairStatusData.length > 0 ? 'í™œì„±' : 'ì—†ìŒ'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.removeItem(REPAIR_STATUS_KEY); state.repairStatusData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.repairStatusData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-purple-100 flex items-center justify-center text-sm">ğŸ“¦</span><span class="font-medium">ê²€í¬ì¥í˜„í™©</span></div></td>
                  <td class="text-right font-semibold">${state.packagingStatusData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.packagingStatusData.length > 0 ? 'bg-purple-100 text-purple-700' : 'bg-slate-100 text-slate-500'}">${state.packagingStatusData.length > 0 ? 'í™œì„±' : 'ì—†ìŒ'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('ê²€í¬ì¥í˜„í™© ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.removeItem(PACKAGING_STATUS_KEY); state.packagingStatusData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.packagingStatusData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ë¹„ê°€ë™í˜„í™© í˜ì´ì§€
    function renderDowntime() {
      if (state.availabilityData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="text-6xl mb-4">âš ï¸</div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">ê°€ë™ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-slate-500 mb-6">ë¹„ê°€ë™í˜„í™© ë¶„ì„ì„ ìœ„í•´ ê°€ë™ìœ¨ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              ğŸ“¤ íŒŒì¼ì—…ë¡œë“œ í˜ì´ì§€ë¡œ ì´ë™
            </button>
          </div>
        `;
      }

      // ì›”ë³„ í•„í„°ë§ëœ ê°€ë™ìœ¨ ë°ì´í„°
      const filteredAvailability = state.availabilityData.filter(d => {
        if (!d.date) return true; // ë‚ ì§œ ì—†ìœ¼ë©´ í¬í•¨
        const dateStr = String(d.date);
        let rowMonth = null;
        if (dateStr.includes('-')) {
          rowMonth = parseInt(dateStr.split('-')[1]) || null;
        } else if (dateStr.includes('/')) {
          const parts = dateStr.split('/');
          rowMonth = parts[0].length === 4 ? parseInt(parts[1]) : parseInt(parts[0]);
        }
        return !rowMonth || rowMonth === state.selectedMonth;
      });

      // ë¹„ê°€ë™ ë°ì´í„° ê³„ì‚°
      const downtimeData = filteredAvailability.map(d => ({
        ...d,
        downtimeMinutes: d.operatingTime - d.runningTime,
        downtimeRate: d.operatingTime > 0 ? ((d.operatingTime - d.runningTime) / d.operatingTime * 100) : 0
      }));

      // ê³µì •ë³„ ë¹„ê°€ë™ ì§‘ê³„
      const processSummary = {};
      downtimeData.forEach(d => {
        if (excludedProcesses.includes(d.process)) return;
        if (!processSummary[d.process]) {
          processSummary[d.process] = {
            process: d.process,
            totalOperating: 0,
            totalRunning: 0,
            totalDowntime: 0,
            equipmentCount: new Set(),
            records: []
          };
        }
        processSummary[d.process].totalOperating += d.operatingTime;
        processSummary[d.process].totalRunning += d.runningTime;
        processSummary[d.process].totalDowntime += d.downtimeMinutes;
        processSummary[d.process].equipmentCount.add(d.equipment);
        processSummary[d.process].records.push(d);
      });

      // ê³µì •ë³„ ìš”ì•½ ë°°ì—´
      const processStats = Object.values(processSummary).map(p => ({
        ...p,
        equipmentCount: p.equipmentCount.size,
        avgDowntimeRate: p.totalOperating > 0 ? (p.totalDowntime / p.totalOperating * 100) : 0,
        avgAvailability: p.totalOperating > 0 ? (p.totalRunning / p.totalOperating * 100) : 0
      })).sort((a, b) => b.totalDowntime - a.totalDowntime);

      // ì „ì²´ í†µê³„
      const totalStats = {
        totalOperating: processStats.reduce((sum, p) => sum + p.totalOperating, 0),
        totalDowntime: processStats.reduce((sum, p) => sum + p.totalDowntime, 0),
        totalEquipment: processStats.reduce((sum, p) => sum + p.equipmentCount, 0)
      };
      totalStats.avgDowntimeRate = totalStats.totalOperating > 0
        ? (totalStats.totalDowntime / totalStats.totalOperating * 100) : 0;

      // ì„¤ë¹„ë³„ ë¹„ê°€ë™ TOP 10
      const equipmentDowntime = {};
      downtimeData.forEach(d => {
        if (excludedProcesses.includes(d.process)) return;
        const key = `${d.process}_${d.equipment}`;
        if (!equipmentDowntime[key]) {
          equipmentDowntime[key] = { process: d.process, equipment: d.equipment, totalDowntime: 0, totalOperating: 0, count: 0 };
        }
        equipmentDowntime[key].totalDowntime += d.downtimeMinutes;
        equipmentDowntime[key].totalOperating += d.operatingTime;
        equipmentDowntime[key].count++;
      });

      const topDowntimeEquipment = Object.values(equipmentDowntime)
        .map(e => ({ ...e, downtimeRate: e.totalOperating > 0 ? (e.totalDowntime / e.totalOperating * 100) : 0 }))
        .sort((a, b) => b.totalDowntime - a.totalDowntime)
        .slice(0, 10);

      // ê³µì •ë³„ ìƒ‰ìƒ
      const processColors = {
        'ì‚¬ì¶œ': { bg: 'bg-orange-100', border: 'border-orange-300', text: 'text-orange-600', chart: '#fdba74' },
        'ë„ì¥': { bg: 'bg-sky-100', border: 'border-sky-300', text: 'text-sky-600', chart: '#7dd3fc' },
        'ì¸ì‡„': { bg: 'bg-amber-100', border: 'border-amber-300', text: 'text-amber-600', chart: '#fcd34d' },
        'ì¡°ë¦½': { bg: 'bg-violet-100', border: 'border-violet-300', text: 'text-violet-600', chart: '#c4b5fd' }
      };

      return `
        <div class="section-header">
          <div class="section-title">ë¹„ê°€ë™í˜„í™© ë¶„ì„</div>
          <div class="flex items-center gap-3">
            <select class="filter-select" style="background: #f1f5f9; border-color: #cbd5e1; font-weight: 500;" onchange="setSelectedMonth(this.value)">
              ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}ì›”</option>`).join('')}
            </select>
            <span class="text-sm text-slate-500">ì´ ${state.availabilityData.length.toLocaleString()}ê±´ ë¶„ì„</span>
          </div>
        </div>

        <!-- ì „ì²´ ìš”ì•½ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="card text-center" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid #fca5a5;">
            <div class="text-3xl font-bold text-red-700">${formatDecimal(totalStats.totalDowntime / 60, 1)}h</div>
            <div class="text-sm text-red-600 mt-1">ì´ ë¹„ê°€ë™ì‹œê°„</div>
          </div>
          <div class="card text-center" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b;">
            <div class="text-3xl font-bold text-amber-700">${formatPercent(totalStats.avgDowntimeRate)}</div>
            <div class="text-sm text-amber-600 mt-1">í‰ê·  ë¹„ê°€ë™ìœ¨</div>
          </div>
          <div class="card text-center" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6;">
            <div class="text-3xl font-bold text-blue-700">${formatPercent(100 - totalStats.avgDowntimeRate)}</div>
            <div class="text-sm text-blue-600 mt-1">í‰ê·  ê°€ë™ìœ¨</div>
          </div>
          <div class="card text-center" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-left: 4px solid #6366f1;">
            <div class="text-3xl font-bold text-indigo-700">${totalStats.totalEquipment}</div>
            <div class="text-sm text-indigo-600 mt-1">ë¶„ì„ ì„¤ë¹„ìˆ˜</div>
          </div>
        </div>

        <!-- ê³µì •ë³„ ë¹„ê°€ë™ í˜„í™© -->
        <div class="card mb-6">
          <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ“Š ê³µì •ë³„ ë¹„ê°€ë™ í˜„í™©</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            ${processStats.map(p => {
              const colors = processColors[p.process] || { bg: 'bg-slate-100', border: 'border-slate-400', text: 'text-slate-700' };
              const downtimeHours = formatDecimal(p.totalDowntime / 60, 1);
              const barWidth = totalStats.totalDowntime > 0 ? (p.totalDowntime / totalStats.totalDowntime * 100) : 0;
              return `
                <div class="p-4 rounded-xl ${colors.bg} border-l-4 ${colors.border}">
                  <div class="flex justify-between items-start mb-2">
                    <span class="font-bold ${colors.text}">${p.process}</span>
                    <span class="text-xs px-2 py-1 rounded-full bg-white/60 ${colors.text}">${formatNumber(p.equipmentCount)}ì„¤ë¹„</span>
                  </div>
                  <div class="text-2xl font-bold ${colors.text} mb-1">${downtimeHours}h</div>
                  <div class="text-sm ${colors.text} opacity-75">ë¹„ê°€ë™ìœ¨ ${formatPercent(p.avgDowntimeRate)}</div>
                  <div class="mt-3 h-2 bg-white/50 rounded-full overflow-hidden">
                    <div class="h-full rounded-full transition-all" style="width: ${barWidth.toFixed(1)}%; background: ${processColors[p.process]?.chart || '#64748b'}"></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- ê³µì •ë³„ ë¹„ê°€ë™ì‹œê°„ ì°¨íŠ¸ -->
          <div class="card">
            <div class="chart-title">ê³µì •ë³„ ë¹„ê°€ë™ì‹œê°„ ë¹„êµ</div>
            <div style="height: 280px;"><canvas id="downtimeByProcessChart"></canvas></div>
          </div>

          <!-- ì„¤ë¹„ë³„ ë¹„ê°€ë™ TOP 10 ì°¨íŠ¸ (ìœ í˜•ë³„ ìŠ¤íƒ) -->
          <div class="card">
            <div class="chart-title">ì„¤ë¹„ë³„ ë¹„ê°€ë™ì‹œê°„ TOP 10 (ìœ í˜•ë³„)</div>
            <div style="height: 350px;"><canvas id="downtimeByEquipmentChart"></canvas></div>
          </div>
        </div>

        <!-- ë¹„ê°€ë™ ìƒì„¸ í…Œì´ë¸” -->
        <div class="card">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-bold text-slate-800">ğŸ“‹ ê³µì •ë³„ ë¹„ê°€ë™ ìƒì„¸</h3>
              <button id="toggle-downtime" class="collapse-toggle" onclick="toggleCollapse('downtime')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                ì ‘ê¸°
              </button>
            </div>
            <button onclick="downloadDowntimeExcel()" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
              ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
          <div id="collapse-downtime" class="collapsible-content">
            <div class="overflow-x-auto">
              <table class="data-table">
                <thead>
                  <tr>
                    <th class="sortable" data-type="string" data-col="0">ê³µì •</th>
                    <th class="sortable text-right" data-type="number" data-col="1">ì„¤ë¹„ìˆ˜</th>
                    <th class="sortable text-right" data-type="number" data-col="2">ì¡°ì—…ì‹œê°„(h)</th>
                    <th class="sortable text-right" data-type="number" data-col="3">ê°€ë™ì‹œê°„(h)</th>
                    <th class="sortable text-right" data-type="number" data-col="4">ë¹„ê°€ë™ì‹œê°„(h)</th>
                    <th class="sortable text-right" data-type="number" data-col="5">ë¹„ê°€ë™ìœ¨</th>
                    <th class="sortable text-right" data-type="number" data-col="6">ê°€ë™ìœ¨</th>
                  </tr>
                </thead>
                <tbody>
                  ${processStats.map(p => {
                    const colors = processColors[p.process] || { text: 'text-slate-700' };
                    const downtimeRateClass = p.avgDowntimeRate > 20 ? 'text-red-600 font-bold' :
                                             p.avgDowntimeRate > 10 ? 'text-amber-600' : 'text-slate-600';
                    return `
                      <tr>
                        <td class="font-medium ${colors.text}">${p.process}</td>
                        <td class="text-right">${formatNumber(p.equipmentCount)}</td>
                        <td class="text-right">${formatDecimal(p.totalOperating / 60, 1)}</td>
                        <td class="text-right">${formatDecimal(p.totalRunning / 60, 1)}</td>
                        <td class="text-right font-medium text-red-600">${formatDecimal(p.totalDowntime / 60, 1)}</td>
                        <td class="text-right ${downtimeRateClass}">${formatPercent(p.avgDowntimeRate)}</td>
                        <td class="text-right text-blue-600">${formatPercent(p.avgAvailability)}</td>
                      </tr>
                    `;
                  }).join('')}
                  <tr class="bg-slate-100 font-bold">
                    <td>í•©ê³„</td>
                    <td class="text-right">${formatNumber(totalStats.totalEquipment)}</td>
                    <td class="text-right">${formatDecimal(totalStats.totalOperating / 60, 1)}</td>
                    <td class="text-right">${formatDecimal((totalStats.totalOperating - totalStats.totalDowntime) / 60, 1)}</td>
                    <td class="text-right text-red-600">${formatDecimal(totalStats.totalDowntime / 60, 1)}</td>
                    <td class="text-right">${formatPercent(totalStats.avgDowntimeRate)}</td>
                    <td class="text-right text-blue-600">${formatPercent(100 - totalStats.avgDowntimeRate)}</td>
                </tr>
              </tbody>
            </table>
            </div>
          </div>
        </div>

        <!-- ì„¤ë¹„ë³„ ë¹„ê°€ë™ TOP 10 í…Œì´ë¸” -->
        <div class="card mt-6">
          <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ”§ ë¹„ê°€ë™ì‹œê°„ TOP 10 ì„¤ë¹„</h3>
          <div class="overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th class="sortable text-center" data-type="number" data-col="0" style="width: 60px;">ìˆœìœ„</th>
                  <th class="sortable" data-type="string" data-col="1">ê³µì •</th>
                  <th class="sortable" data-type="equipment" data-col="2">ì„¤ë¹„ëª…</th>
                  <th class="sortable text-right" data-type="number" data-col="3">ë¹„ê°€ë™ì‹œê°„(h)</th>
                  <th class="sortable text-right" data-type="number" data-col="4">ì¡°ì—…ì‹œê°„(h)</th>
                  <th class="sortable text-right" data-type="number" data-col="5">ë¹„ê°€ë™ìœ¨</th>
                  <th class="sortable" data-type="string" data-col="6">ìƒíƒœ</th>
                </tr>
              </thead>
              <tbody>
                ${topDowntimeEquipment.map((e, idx) => {
                  const colors = processColors[e.process] || { text: 'text-slate-700' };
                  const statusBadge = e.downtimeRate > 30 ? '<span class="badge" style="background: #fee2e2; color: #dc2626;">ìœ„í—˜</span>' :
                                     e.downtimeRate > 15 ? '<span class="badge" style="background: #fef3c7; color: #d97706;">ì£¼ì˜</span>' :
                                     '<span class="badge" style="background: #dcfce7; color: #16a34a;">ì–‘í˜¸</span>';
                  return `
                    <tr>
                      <td class="text-center font-bold ${idx < 3 ? 'text-red-500' : 'text-slate-500'}">${idx + 1}</td>
                      <td class="${colors.text}">${e.process}</td>
                      <td class="font-medium">${e.equipment}</td>
                      <td class="text-right font-medium text-red-600">${formatDecimal(e.totalDowntime / 60, 1)}</td>
                      <td class="text-right">${formatDecimal(e.totalOperating / 60, 1)}</td>
                      <td class="text-right">${formatPercent(e.downtimeRate)}</td>
                      <td>${statusBadge}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ì¬ê³µì¬ê³  í˜ì´ì§€ ë©”ì¸ ë Œë”ë§
    function renderWipInventoryPage() {
      const wipData = state.wipInventoryData || [];

      if (wipData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center shadow-lg">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">ì¬ê³µì¬ê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-slate-500 mb-6">íŒŒì¼ì—…ë¡œë“œ ë©”ë‰´ì—ì„œ ì¬ê³µì¬ê³ ê¸ˆì•¡ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              ğŸ“¤ íŒŒì¼ì—…ë¡œë“œ í˜ì´ì§€ë¡œ ì´ë™
            </button>
          </div>
        `;
      }

      // ì„œë¸Œíƒ­ì— ë”°ë¼ ë‹¤ë¥¸ ì½˜í…ì¸  ë Œë”ë§
      if (state.wipSubTab === 'status') {
        return renderWipInventoryStatus(wipData);
      } else {
        return renderWipInventoryPriceTable(wipData);
      }
    }

    // ì¬ê³µì¬ê³ í˜„í™© íƒ­
    function renderWipInventoryStatus(wipData) {
      // í†µê³„ ê³„ì‚°
      const totalStock = wipData.reduce((sum, d) => sum + d.stock, 0);
      const totalValue = wipData.reduce((sum, d) => sum + d.stockValue, 0);
      const avgCost = wipData.length > 0 ? totalValue / totalStock : 0;
      const uniqueItems = wipData.length;

      // í’ˆëª©ìœ í˜•ë³„ ì§‘ê³„
      const typeData = {};
      wipData.forEach(d => {
        const type = d.itemType || 'ê¸°íƒ€';
        if (!typeData[type]) {
          typeData[type] = { type, stock: 0, value: 0, count: 0 };
        }
        typeData[type].stock += d.stock;
        typeData[type].value += d.stockValue;
        typeData[type].count++;
      });
      const typeList = Object.values(typeData).sort((a, b) => b.value - a.value);

      // ê·œê²©ë³„ ì§‘ê³„
      const specData = {};
      wipData.forEach(d => {
        const spec = d.spec || 'ê¸°íƒ€';
        if (!specData[spec]) {
          specData[spec] = { spec, stock: 0, value: 0, count: 0 };
        }
        specData[spec].stock += d.stock;
        specData[spec].value += d.stockValue;
        specData[spec].count++;
      });
      const specList = Object.values(specData).sort((a, b) => b.value - a.value);

      // ì¬ê³ ê¸ˆì•¡ TOP 10
      const topValueItems = [...wipData].sort((a, b) => b.stockValue - a.stockValue).slice(0, 10);

      // ì¬ê³ ìˆ˜ëŸ‰ TOP 10
      const topStockItems = [...wipData].sort((a, b) => b.stock - a.stock).slice(0, 10);

      return `
        <div class="section-header">
          <div class="section-title">
            <span class="inline-flex items-center gap-2">
              <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white text-xl shadow-md">ğŸ“¦</span>
              ì¬ê³µì¬ê³  í˜„í™© ë¶„ì„
            </span>
          </div>
          <div class="text-sm text-slate-500">${formatNumber(uniqueItems)}ê°œ í’ˆëª© ë¶„ì„</div>
        </div>

        <!-- ìš”ì•½ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card" style="background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); border-left: 4px solid #14b8a6;">
            <div class="stat-label">ì´ ì¬ê³ ìˆ˜ëŸ‰</div>
            <div class="stat-value text-teal-600">${formatNumber(totalStock)} EA</div>
            <div class="stat-sub">${formatNumber(uniqueItems)}ê°œ í’ˆëª©</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0ea5e9;">
            <div class="stat-label">ì´ ì¬ê³ ê¸ˆì•¡</div>
            <div class="stat-value text-sky-600">${formatNumber(Math.round(totalValue / 10000))} ë§Œì›</div>
            <div class="stat-sub">${formatNumber(totalValue)} ì›</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border-left: 4px solid #eab308;">
            <div class="stat-label">í‰ê·  ë‹¨ê°€</div>
            <div class="stat-value text-amber-600">${formatNumber(Math.round(avgCost))} ì›</div>
            <div class="stat-sub">í’ˆëª©ë‹¹ í‰ê· </div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-left: 4px solid #a855f7;">
            <div class="stat-label">í’ˆëª©ìœ í˜•</div>
            <div class="stat-value text-purple-600">${typeList.length} ì¢…</div>
            <div class="stat-sub">ìœ í˜• ë¶„ë¥˜</div>
          </div>
        </div>

        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">í’ˆëª©ìœ í˜•ë³„ ì¬ê³ ê¸ˆì•¡ êµ¬ì„±</div>
            <div style="height: 280px;"><canvas id="wipTypeChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ê·œê²©ë³„ ì¬ê³ ê¸ˆì•¡ TOP 10</div>
            <div style="height: 280px;"><canvas id="wipSpecChart"></canvas></div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">ì¬ê³ ê¸ˆì•¡ TOP 10 í’ˆëª©</div>
            <div style="height: 280px;"><canvas id="wipTopValueChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ì¬ê³ ìˆ˜ëŸ‰ TOP 10 í’ˆëª©</div>
            <div style="height: 280px;"><canvas id="wipTopStockChart"></canvas></div>
          </div>
        </div>

        <!-- í’ˆëª©ìœ í˜•ë³„ ìƒì„¸ í…Œì´ë¸” -->
        <div class="card mb-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              <span>ğŸ“Š í’ˆëª©ìœ í˜•ë³„ ì¬ê³ í˜„í™©</span>
              <span class="text-sm font-normal text-slate-500">(${typeList.length}ê°œ ìœ í˜•)</span>
            </h3>
            <div class="flex items-center gap-2">
              <button onclick="downloadWipInventoryExcel()" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-emerald-700 bg-emerald-100 hover:bg-emerald-200 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Excel
              </button>
              <button id="toggle-wipType" onclick="toggleCollapse('wipType')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                <svg class="w-4 h-4 transition-transform ${collapseState.wipType ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                ${collapseState.wipType ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°'}
              </button>
            </div>
          </div>
          <div id="collapse-wipType" class="collapsible-content ${collapseState.wipType ? 'collapsed' : ''}">
            <div class="overflow-x-auto">
              <table class="data-table w-full">
                <thead>
                  <tr>
                    <th class="text-left sortable" data-type="string" data-col="0">í’ˆëª©ìœ í˜•</th>
                    <th class="text-right sortable" data-type="number" data-col="1">í’ˆëª©ìˆ˜</th>
                    <th class="text-right sortable" data-type="number" data-col="2">ì¬ê³ ìˆ˜ëŸ‰</th>
                    <th class="text-right sortable" data-type="number" data-col="3">ì¬ê³ ê¸ˆì•¡</th>
                    <th class="text-right sortable" data-type="number" data-col="4">í‰ê· ë‹¨ê°€</th>
                    <th class="text-right sortable" data-type="number" data-col="5">êµ¬ì„±ë¹„</th>
                  </tr>
                </thead>
                <tbody>
                  ${typeList.map(t => `
                    <tr>
                      <td class="font-medium">${t.type}</td>
                      <td class="text-right">${formatNumber(t.count)}</td>
                      <td class="text-right text-teal-600">${formatNumber(t.stock)}</td>
                      <td class="text-right text-sky-600 font-semibold">${formatNumber(t.value)}</td>
                      <td class="text-right">${formatNumber(Math.round(t.value / t.stock))}</td>
                      <td class="text-right">
                        <div class="flex items-center justify-end gap-2">
                          <div class="w-16 h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div class="h-full bg-teal-400 rounded-full" style="width: ${formatDecimal(t.value / totalValue * 100, 1)}%"></div>
                          </div>
                          <span class="text-sm">${formatPercent(t.value / totalValue * 100)}</span>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                  <tr class="bg-slate-100 font-bold">
                    <td>í•©ê³„</td>
                    <td class="text-right">${formatNumber(uniqueItems)}</td>
                    <td class="text-right text-teal-700">${formatNumber(totalStock)}</td>
                    <td class="text-right text-sky-700">${formatNumber(totalValue)}</td>
                    <td class="text-right">${formatNumber(Math.round(avgCost))}</td>
                    <td class="text-right">100%</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ê·œê²©ë³„ ìƒì„¸ í…Œì´ë¸” -->
        <div class="card">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              <span>ğŸ“‹ ê·œê²©ë³„ ì¬ê³ í˜„í™©</span>
              <span class="text-sm font-normal text-slate-500">(${specList.length}ê°œ ê·œê²©)</span>
            </h3>
            <button id="toggle-wipSpec" onclick="toggleCollapse('wipSpec')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
              <svg class="w-4 h-4 transition-transform ${collapseState.wipSpec ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              ${collapseState.wipSpec ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°'}
            </button>
          </div>
          <div id="collapse-wipSpec" class="collapsible-content ${collapseState.wipSpec ? 'collapsed' : ''}">
            <div class="overflow-x-auto">
              <table class="data-table w-full">
                <thead>
                  <tr>
                    <th class="text-left sortable" data-type="string" data-col="0">ê·œê²©</th>
                    <th class="text-right sortable" data-type="number" data-col="1">í’ˆëª©ìˆ˜</th>
                    <th class="text-right sortable" data-type="number" data-col="2">ì¬ê³ ìˆ˜ëŸ‰</th>
                    <th class="text-right sortable" data-type="number" data-col="3">ì¬ê³ ê¸ˆì•¡</th>
                    <th class="text-right sortable" data-type="number" data-col="4">í‰ê· ë‹¨ê°€</th>
                    <th class="text-right sortable" data-type="number" data-col="5">êµ¬ì„±ë¹„</th>
                  </tr>
                </thead>
                <tbody>
                  ${specList.slice(0, 15).map(s => `
                    <tr>
                      <td class="font-medium">${s.spec}</td>
                      <td class="text-right">${formatNumber(s.count)}</td>
                      <td class="text-right text-teal-600">${formatNumber(s.stock)}</td>
                      <td class="text-right text-sky-600 font-semibold">${formatNumber(s.value)}</td>
                      <td class="text-right">${formatNumber(Math.round(s.value / s.stock))}</td>
                      <td class="text-right">${formatPercent(s.value / totalValue * 100)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${specList.length > 15 ? `<div class="text-center text-sm text-slate-500 mt-4">ìƒìœ„ 15ê°œ ê·œê²© í‘œì‹œ ì¤‘ (ì „ì²´ ${specList.length}ê°œ)</div>` : ''}
          </div>
        </div>
      `;
    }

    // ì¬ê³µì¬ê³ ë‹¨ê°€í‘œ íƒ­
    function renderWipInventoryPriceTable(wipData) {
      // ì „ì²´ í†µê³„
      const totalValue = wipData.reduce((sum, d) => sum + d.stockValue, 0);
      const totalStock = wipData.reduce((sum, d) => sum + d.stock, 0);

      // ë‹¨ê°€ êµ¬ê°„ë³„ ë¶„í¬
      const priceRanges = [
        { label: '1,000ì› ë¯¸ë§Œ', min: 0, max: 1000, count: 0, value: 0, stock: 0 },
        { label: '1,000~5,000ì›', min: 1000, max: 5000, count: 0, value: 0, stock: 0 },
        { label: '5,000~10,000ì›', min: 5000, max: 10000, count: 0, value: 0, stock: 0 },
        { label: '10,000~20,000ì›', min: 10000, max: 20000, count: 0, value: 0, stock: 0 },
        { label: '20,000~50,000ì›', min: 20000, max: 50000, count: 0, value: 0, stock: 0 },
        { label: '50,000ì› ì´ìƒ', min: 50000, max: Infinity, count: 0, value: 0, stock: 0 }
      ];

      wipData.forEach(d => {
        const range = priceRanges.find(r => d.unitCost >= r.min && d.unitCost < r.max);
        if (range) {
          range.count++;
          range.value += d.stockValue;
          range.stock += d.stock;
        }
      });

      // ê³ ê°€ í’ˆëª© TOP 20 (ë‹¨ê°€ ê¸°ì¤€)
      const highPriceItems = [...wipData].sort((a, b) => b.unitCost - a.unitCost).slice(0, 20);

      // ì €ê°€ í’ˆëª© TOP 20 (ë‹¨ê°€ ê¸°ì¤€)
      const lowPriceItems = [...wipData].filter(d => d.unitCost > 0).sort((a, b) => a.unitCost - b.unitCost).slice(0, 20);

      return `
        <div class="section-header">
          <div class="section-title">
            <span class="inline-flex items-center gap-2">
              <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center text-white text-xl shadow-md">ğŸ’°</span>
              ì¬ê³µì¬ê³  ë‹¨ê°€í‘œ
            </span>
          </div>
          <div class="text-sm text-slate-500">${formatNumber(wipData.length)}ê°œ í’ˆëª© ë‹¨ê°€ ë¶„ì„</div>
        </div>

        <!-- ìš”ì•½ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card" style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-left: 4px solid #f59e0b;">
            <div class="stat-label">ìµœê³  ë‹¨ê°€</div>
            <div class="stat-value text-amber-600">${formatNumber(Math.max(...wipData.map(d => d.unitCost)))} ì›</div>
            <div class="stat-sub">ìµœê³ ê°€ í’ˆëª©</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-left: 4px solid #10b981;">
            <div class="stat-label">ìµœì € ë‹¨ê°€</div>
            <div class="stat-value text-emerald-600">${formatNumber(Math.min(...wipData.filter(d => d.unitCost > 0).map(d => d.unitCost)))} ì›</div>
            <div class="stat-sub">ìµœì €ê°€ í’ˆëª©</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0ea5e9;">
            <div class="stat-label">í‰ê·  ë‹¨ê°€</div>
            <div class="stat-value text-sky-600">${formatNumber(Math.round(totalValue / totalStock))} ì›</div>
            <div class="stat-sub">ê°€ì¤‘ í‰ê· </div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%); border-left: 4px solid #d946ef;">
            <div class="stat-label">ì¤‘ê°„ ë‹¨ê°€</div>
            <div class="stat-value text-fuchsia-600">${formatNumber(wipData.sort((a, b) => a.unitCost - b.unitCost)[Math.floor(wipData.length / 2)]?.unitCost || 0)} ì›</div>
            <div class="stat-sub">ì¤‘ì•™ê°’</div>
          </div>
        </div>

        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">ë‹¨ê°€ êµ¬ê°„ë³„ í’ˆëª© ë¶„í¬</div>
            <div style="height: 280px;"><canvas id="wipPriceRangeChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ë‹¨ê°€ êµ¬ê°„ë³„ ì¬ê³ ê¸ˆì•¡ ë¶„í¬</div>
            <div style="height: 280px;"><canvas id="wipPriceValueChart"></canvas></div>
          </div>
        </div>

        <!-- ë‹¨ê°€ êµ¬ê°„ë³„ í…Œì´ë¸” -->
        <div class="card mb-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              <span>ğŸ“Š ë‹¨ê°€ êµ¬ê°„ë³„ ë¶„í¬</span>
            </h3>
            <button id="toggle-wipPrice" onclick="toggleCollapse('wipPrice')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
              <svg class="w-4 h-4 transition-transform ${collapseState.wipPrice ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              ${collapseState.wipPrice ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°'}
            </button>
          </div>
          <div id="collapse-wipPrice" class="collapsible-content ${collapseState.wipPrice ? 'collapsed' : ''}">
            <div class="overflow-x-auto">
              <table class="data-table w-full">
                <thead>
                  <tr>
                    <th class="text-left sortable" data-type="string" data-col="0">ë‹¨ê°€ êµ¬ê°„</th>
                    <th class="text-right sortable" data-type="number" data-col="1">í’ˆëª©ìˆ˜</th>
                    <th class="text-right sortable" data-type="number" data-col="2">ì¬ê³ ìˆ˜ëŸ‰</th>
                    <th class="text-right sortable" data-type="number" data-col="3">ì¬ê³ ê¸ˆì•¡</th>
                    <th class="text-right sortable" data-type="number" data-col="4">êµ¬ì„±ë¹„</th>
                  </tr>
                </thead>
                <tbody>
                  ${priceRanges.map(r => `
                    <tr>
                      <td class="font-medium">${r.label}</td>
                      <td class="text-right">${formatNumber(r.count)}</td>
                      <td class="text-right text-teal-600">${formatNumber(r.stock)}</td>
                      <td class="text-right text-sky-600 font-semibold">${formatNumber(r.value)}</td>
                      <td class="text-right">
                        <div class="flex items-center justify-end gap-2">
                          <div class="w-20 h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div class="h-full bg-amber-400 rounded-full" style="width: ${totalValue > 0 ? formatDecimal(r.value / totalValue * 100, 1) : 0}%"></div>
                          </div>
                          <span class="text-sm">${totalValue > 0 ? formatPercent(r.value / totalValue * 100) : '0.0%'}</span>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ê³ ê°€/ì €ê°€ í’ˆëª© í…Œì´ë¸” -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span class="text-xl">ğŸ’</span>
                <span>ê³ ê°€ í’ˆëª© TOP 20</span>
              </h3>
              <button id="toggle-wipHighPrice" onclick="toggleCollapse('wipHighPrice')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                <svg class="w-4 h-4 transition-transform ${collapseState.wipHighPrice ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                ${collapseState.wipHighPrice ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°'}
              </button>
            </div>
            <div id="collapse-wipHighPrice" class="collapsible-content ${collapseState.wipHighPrice ? 'collapsed' : ''}">
              <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table w-full">
                  <thead class="sticky top-0 bg-white">
                    <tr>
                      <th class="text-center sortable" data-type="number" data-col="0" style="width: 40px;">ìˆœìœ„</th>
                      <th class="text-left sortable" data-type="string" data-col="1">í’ˆëª©ëª…</th>
                      <th class="text-right sortable" data-type="number" data-col="2">ë‹¨ê°€</th>
                      <th class="text-right sortable" data-type="number" data-col="3">ì¬ê³ </th>
                      <th class="text-right sortable" data-type="number" data-col="4">ê¸ˆì•¡</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${highPriceItems.map((item, idx) => `
                      <tr>
                        <td class="text-center font-bold ${idx < 3 ? 'text-amber-500' : 'text-slate-400'}">${idx + 1}</td>
                        <td class="font-medium text-sm">${item.itemName?.substring(0, 25) || item.itemCode}${item.itemName?.length > 25 ? '...' : ''}</td>
                        <td class="text-right text-amber-600 font-semibold">${formatNumber(item.unitCost)}</td>
                        <td class="text-right">${formatNumber(item.stock)}</td>
                        <td class="text-right text-sky-600">${formatNumber(item.stockValue)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span class="text-xl">ğŸ·ï¸</span>
                <span>ì €ê°€ í’ˆëª© TOP 20</span>
              </h3>
              <button id="toggle-wipLowPrice" onclick="toggleCollapse('wipLowPrice')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                <svg class="w-4 h-4 transition-transform ${collapseState.wipLowPrice ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                ${collapseState.wipLowPrice ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°'}
              </button>
            </div>
            <div id="collapse-wipLowPrice" class="collapsible-content ${collapseState.wipLowPrice ? 'collapsed' : ''}">
              <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table w-full">
                  <thead class="sticky top-0 bg-white">
                    <tr>
                      <th class="text-center sortable" data-type="number" data-col="0" style="width: 40px;">ìˆœìœ„</th>
                      <th class="text-left sortable" data-type="string" data-col="1">í’ˆëª©ëª…</th>
                      <th class="text-right sortable" data-type="number" data-col="2">ë‹¨ê°€</th>
                      <th class="text-right sortable" data-type="number" data-col="3">ì¬ê³ </th>
                      <th class="text-right sortable" data-type="number" data-col="4">ê¸ˆì•¡</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${lowPriceItems.map((item, idx) => `
                      <tr>
                        <td class="text-center font-bold ${idx < 3 ? 'text-emerald-500' : 'text-slate-400'}">${idx + 1}</td>
                        <td class="font-medium text-sm">${item.itemName?.substring(0, 25) || item.itemCode}${item.itemName?.length > 25 ? '...' : ''}</td>
                        <td class="text-right text-emerald-600 font-semibold">${formatNumber(item.unitCost)}</td>
                        <td class="text-right">${formatNumber(item.stock)}</td>
                        <td class="text-right text-sky-600">${formatNumber(item.stockValue)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ì¬ê³µì¬ê³  ì°¨íŠ¸ ìƒì„±
    function createWipInventoryCharts() {
      const wipData = state.wipInventoryData || [];
      if (wipData.length === 0) return;

      const totalValue = wipData.reduce((sum, d) => sum + d.stockValue, 0);

      // í’ˆëª©ìœ í˜•ë³„ ì§‘ê³„
      const typeData = {};
      wipData.forEach(d => {
        const type = d.itemType || 'ê¸°íƒ€';
        if (!typeData[type]) typeData[type] = { type, value: 0 };
        typeData[type].value += d.stockValue;
      });
      const typeList = Object.values(typeData).sort((a, b) => b.value - a.value);

      // ê·œê²©ë³„ ì§‘ê³„
      const specData = {};
      wipData.forEach(d => {
        const spec = d.spec || 'ê¸°íƒ€';
        if (!specData[spec]) specData[spec] = { spec, value: 0 };
        specData[spec].value += d.stockValue;
      });
      const specList = Object.values(specData).sort((a, b) => b.value - a.value).slice(0, 10);

      // TOP 10 í’ˆëª©
      const topValueItems = [...wipData].sort((a, b) => b.stockValue - a.stockValue).slice(0, 10);
      const topStockItems = [...wipData].sort((a, b) => b.stock - a.stock).slice(0, 10);

      // í’ˆëª©ìœ í˜•ë³„ ì°¨íŠ¸
      const typeChartCtx = document.getElementById('wipTypeChart');
      if (typeChartCtx) {
        if (charts.wipType) charts.wipType.destroy();
        charts.wipType = new Chart(typeChartCtx, {
          type: 'doughnut',
          data: {
            labels: typeList.map(t => t.type),
            datasets: [{
              data: typeList.map(t => t.value),
              backgroundColor: typeList.map((_, i) => generatePastelColor(i)),
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { boxWidth: 12, padding: 8 } },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.label}: ${formatNumber(ctx.raw)}ì› (${formatPercent(ctx.raw / totalValue * 100)})`
                }
              }
            }
          }
        });
      }

      // ê·œê²©ë³„ ì°¨íŠ¸
      const specChartCtx = document.getElementById('wipSpecChart');
      if (specChartCtx) {
        if (charts.wipSpec) charts.wipSpec.destroy();
        charts.wipSpec = new Chart(specChartCtx, {
          type: 'bar',
          data: {
            labels: specList.map(s => s.spec),
            datasets: [{
              label: 'ì¬ê³ ê¸ˆì•¡',
              data: specList.map(s => s.value),
              backgroundColor: specList.map((_, i) => generatePastelColor(i + 2)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: 'end',
                align: 'right',
                color: '#475569',
                font: { size: 10, weight: '600' },
                formatter: (value) => formatCompact(value)
              }
            },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatCompact(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }

      // ì¬ê³ ê¸ˆì•¡ TOP 10 ì°¨íŠ¸
      const topValueCtx = document.getElementById('wipTopValueChart');
      if (topValueCtx) {
        if (charts.wipTopValue) charts.wipTopValue.destroy();
        charts.wipTopValue = new Chart(topValueCtx, {
          type: 'bar',
          data: {
            labels: topValueItems.map(i => (i.itemName || i.itemCode).substring(0, 12) + '...'),
            datasets: [{
              label: 'ì¬ê³ ê¸ˆì•¡',
              data: topValueItems.map(i => i.stockValue),
              backgroundColor: topValueItems.map((_, idx) => generatePastelColor(idx + 1)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: 'end',
                align: 'right',
                color: '#475569',
                font: { size: 10, weight: '600' },
                formatter: (value) => formatCompact(value)
              }
            },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatCompact(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }

      // ì¬ê³ ìˆ˜ëŸ‰ TOP 10 ì°¨íŠ¸
      const topStockCtx = document.getElementById('wipTopStockChart');
      if (topStockCtx) {
        if (charts.wipTopStock) charts.wipTopStock.destroy();
        charts.wipTopStock = new Chart(topStockCtx, {
          type: 'bar',
          data: {
            labels: topStockItems.map(i => (i.itemName || i.itemCode).substring(0, 12) + '...'),
            datasets: [{
              label: 'ì¬ê³ ìˆ˜ëŸ‰',
              data: topStockItems.map(i => i.stock),
              backgroundColor: topStockItems.map((_, idx) => generatePastelColor(idx)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: 'end',
                align: 'right',
                color: '#475569',
                font: { size: 10, weight: '600' },
                formatter: (value) => formatNumber(value)
              }
            },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }

      // ë‹¨ê°€ êµ¬ê°„ë³„ ë¶„í¬ ì°¨íŠ¸
      const priceRanges = [
        { label: '~1ì²œ', min: 0, max: 1000, count: 0, value: 0 },
        { label: '1~5ì²œ', min: 1000, max: 5000, count: 0, value: 0 },
        { label: '5ì²œ~1ë§Œ', min: 5000, max: 10000, count: 0, value: 0 },
        { label: '1~2ë§Œ', min: 10000, max: 20000, count: 0, value: 0 },
        { label: '2~5ë§Œ', min: 20000, max: 50000, count: 0, value: 0 },
        { label: '5ë§Œ~', min: 50000, max: Infinity, count: 0, value: 0 }
      ];

      wipData.forEach(d => {
        const range = priceRanges.find(r => d.unitCost >= r.min && d.unitCost < r.max);
        if (range) {
          range.count++;
          range.value += d.stockValue;
        }
      });

      const priceRangeCtx = document.getElementById('wipPriceRangeChart');
      if (priceRangeCtx) {
        if (charts.wipPriceRange) charts.wipPriceRange.destroy();
        charts.wipPriceRange = new Chart(priceRangeCtx, {
          type: 'bar',
          data: {
            labels: priceRanges.map(r => r.label),
            datasets: [{
              label: 'í’ˆëª©ìˆ˜',
              data: priceRanges.map(r => r.count),
              backgroundColor: 'rgba(147, 197, 253, 0.85)',
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: 'end',
                align: 'top',
                color: '#475569',
                font: { size: 11, weight: '600' },
                formatter: (value) => formatNumber(value)
              }
            },
            scales: {
              y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      const priceValueCtx = document.getElementById('wipPriceValueChart');
      if (priceValueCtx) {
        if (charts.wipPriceValue) charts.wipPriceValue.destroy();
        charts.wipPriceValue = new Chart(priceValueCtx, {
          type: 'doughnut',
          data: {
            labels: priceRanges.map(r => r.label),
            datasets: [{
              data: priceRanges.map(r => r.value),
              backgroundColor: [
                'rgba(147, 197, 253, 0.85)',
                'rgba(110, 231, 183, 0.85)',
                'rgba(253, 186, 116, 0.85)',
                'rgba(252, 165, 165, 0.85)',
                'rgba(196, 181, 253, 0.85)',
                'rgba(249, 168, 212, 0.85)'
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { boxWidth: 12, padding: 8 } },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.label}: ${formatNumber(ctx.raw)}ì›`
                }
              }
            }
          }
        });
      }
    }

    // ê³µì •ë³„ OEE(ì¢…í•©íš¨ìœ¨) ê³„ì‚°
    // OEE = ì‹œê°„ê°€ë™ìœ¨ Ã— ì„±ëŠ¥ê°€ë™ìœ¨ Ã— ì–‘í’ˆìœ¨ (ê°ê° 0~1 ì‚¬ì´ ê°’ìœ¼ë¡œ ê³„ì‚°)
    // targetMonth íŒŒë¼ë¯¸í„°: íŠ¹ì • ì›”ì˜ ê°€ë™ìœ¨ë§Œ ì‚¬ìš© (nullì´ë©´ ì „ì²´ ë°ì´í„°)
    function getOEEData(data, targetMonth = null) {
      // ê°€ë™ìœ¨ ë°ì´í„°ì—ì„œ ê³µì •ë³„ ì‹œê°„ê°€ë™ìœ¨ ê°€ì ¸ì˜¤ê¸° (ì›”ë³„ í•„í„°ë§ ì ìš©)
      const processAvailability = getProcessAvailability(targetMonth);

      const grouped = {};
      data.forEach(row => {
        // Laser ê³µì • ì œì™¸
        if (excludedProcesses.includes(row.process)) return;
        if (!grouped[row.process]) {
          grouped[row.process] = {
            process: row.process,
            production: 0,
            good: 0,
            defect: 0,
            standard: 0,
            records: 0
          };
        }
        grouped[row.process].production += row.productionQty;
        grouped[row.process].good += row.goodQty;
        grouped[row.process].defect += row.defectQty;
        grouped[row.process].standard += row.standardQty;
        grouped[row.process].records++;
      });

      return Object.values(grouped)
        .sort((a, b) => {
          const orderA = processOrder.indexOf(a.process);
          const orderB = processOrder.indexOf(b.process);
          if (orderA === -1) return 1;
          if (orderB === -1) return -1;
          return orderA - orderB;
        })
        .map(d => {
          // ì‹œê°„ê°€ë™ìœ¨: ê°€ë™ìœ¨ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê³„ì‚°
          const availability = processAvailability[d.process] !== undefined
            ? Math.min(processAvailability[d.process], 100)
            : (d.standard > 0 ? Math.min((d.production / d.standard) * 100, 100) : 0);

          // ì„±ëŠ¥ê°€ë™ìœ¨: ì‹¤ì œ ìƒì‚°ëŸ‰ / í‘œì¤€ ìƒì‚°ëŸ‰ (ìµœëŒ€ 100%)
          const performance = d.standard > 0 ? Math.min((d.production / d.standard) * 100, 100) : 0;

          // ì–‘í’ˆìœ¨: ì–‘í’ˆ / ìƒì‚°ëŸ‰
          const quality = d.production > 0 ? (d.good / d.production) * 100 : 0;

          // ì¢…í•©íš¨ìœ¨ OEE = (ì‹œê°„ê°€ë™ìœ¨/100) Ã— (ì„±ëŠ¥ê°€ë™ìœ¨/100) Ã— (ì–‘í’ˆìœ¨/100) Ã— 100
          const oee = (availability / 100) * (performance / 100) * (quality / 100) * 100;

          return {
            ...d,
            availability: availability.toFixed(1),
            performance: performance.toFixed(1),
            quality: quality.toFixed(1),
            oee: oee.toFixed(1)
          };
        });
    }

    // ì¢…í•©í˜„í™© - Apple ìŠ¤íƒ€ì¼
    function renderOverview(stats, data, yearlyData, yearlyStats) {
      // ë…„ê°„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
      if (!yearlyStats && !stats) return '<p class="text-center text-slate-500 py-8">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

      // ì›”ë³„ í†µê³„ (ì„ íƒëœ ì›”) - í•´ë‹¹ ì›”ì˜ ê°€ë™ìœ¨ ë°ì´í„° ì‚¬ìš©
      const monthlyOeeData = stats ? getOEEData(data, state.selectedMonth) : [];
      const monthlyTotalOEE = monthlyOeeData.length > 0
        ? (monthlyOeeData.reduce((sum, d) => sum + parseFloat(d.oee), 0) / monthlyOeeData.length).toFixed(1)
        : '-';

      // ë…„ê°„ í†µê³„ (í•­ìƒ í‘œì‹œ) - ì „ì²´ ê°€ë™ìœ¨ ë°ì´í„° ì‚¬ìš©
      const yearlyOeeData = yearlyStats ? getOEEData(yearlyData, null) : [];
      const yearlyTotalOEE = yearlyOeeData.length > 0
        ? (yearlyOeeData.reduce((sum, d) => sum + parseFloat(d.oee), 0) / yearlyOeeData.length).toFixed(1)
        : 0;

      // í‘œì‹œìš© ë°ì´í„° (ì›”ë³„ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì›”ë³„, ì—†ìœ¼ë©´ ë…„ê°„ ì‚¬ìš©)
      const displayStats = stats || yearlyStats;
      const displayOeeData = monthlyOeeData.length > 0 ? monthlyOeeData : yearlyOeeData;
      const displayTotalOEE = stats ? monthlyTotalOEE : yearlyTotalOEE;

      return `
        <!-- Section Header -->
        <div class="section-header">
          <div class="section-title">ê³µì •ë³„ ì¢…í•©íš¨ìœ¨ (OEE)</div>
          <div class="flex items-center gap-3">
            <select class="filter-select" style="background: #f1f5f9; border-color: #cbd5e1; font-weight: 500;" onchange="setSelectedMonth(this.value)">
              ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}ì›”</option>`).join('')}
            </select>
            <select class="filter-select" onchange="setFilter('process', this.value)">
              <option value="all">All</option>
              ${getUniqueValues('process').map(p => `<option value="${p}" ${state.filters.process === p ? 'selected' : ''}>${p}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="flex gap-4 mb-2">
          ${state.availabilityData.length > 0 ? `<span class="text-sm text-blue-600">âœ“ ê°€ë™ìœ¨ ${state.availabilityData.length}ê±´</span>` : ''}
          ${state.ctData.length > 0 ? `<span class="text-sm text-amber-600">âœ“ CTí˜„í™© ${state.ctData.length}ê±´</span>` : ''}
        </div>

        <!-- Total OEE Card -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card ${parseFloat(displayTotalOEE) >= 85 ? 'green' : parseFloat(displayTotalOEE) >= 60 ? '' : 'red'}">
            <div class="stat-label">${state.selectedMonth}ì›” ì¢…í•©íš¨ìœ¨ (OEE)</div>
            <div class="stat-value ${parseFloat(displayTotalOEE) >= 85 ? 'text-emerald-600' : parseFloat(displayTotalOEE) >= 60 ? 'text-slate-600' : 'text-red-400'}">${displayTotalOEE === '-' ? '-' : displayTotalOEE + '%'}</div>
            <div class="stat-sub">${stats ? 'ì‹œê°„ê°€ë™ìœ¨ Ã— ì„±ëŠ¥ê°€ë™ìœ¨ Ã— ì–‘í’ˆìœ¨' : 'í•´ë‹¹ ì›” ë°ì´í„° ì—†ìŒ'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">í‰ê·  ì‹œê°„ê°€ë™ìœ¨</div>
            <div class="stat-value text-slate-600">${displayOeeData.length > 0 ? formatPercent(displayOeeData.reduce((sum, d) => sum + parseFloat(d.availability), 0) / displayOeeData.length) : '-'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">í‰ê·  ì„±ëŠ¥ê°€ë™ìœ¨</div>
            <div class="stat-value text-slate-600">${displayOeeData.length > 0 ? formatPercent(displayOeeData.reduce((sum, d) => sum + parseFloat(d.performance), 0) / displayOeeData.length) : '-'}</div>
          </div>
          <div class="stat-card blue">
            <div class="stat-label">í‰ê·  ì–‘í’ˆìœ¨</div>
            <div class="stat-value text-blue-600">${displayStats ? displayStats.avgYield + '%' : '-'}</div>
          </div>
        </div>

        <!-- Monthly OEE Chart -->
        <div class="chart-card mb-6">
          <div class="chart-title">ì›”ë³„ ì¢…í•©íš¨ìœ¨ (OEE) ì¶”ì´</div>
          <div style="height: 280px;"><canvas id="monthlyOeeChart"></canvas></div>
        </div>

        <!-- OEE by Process Table (ë…„ê°„ ëˆ„ì ) -->
        <div class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-base font-bold text-slate-800">ê³µì •ë³„ ì¢…í•©íš¨ìœ¨ ìƒì„¸ <span class="text-sm font-normal text-slate-500">(ë…„ê°„ ëˆ„ì )</span></h3>
              <button id="toggle-oee" class="collapse-toggle" onclick="toggleCollapse('oee')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                ì ‘ê¸°
              </button>
            </div>
            <button onclick="downloadOEEExcel()" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
              ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
          <div id="collapse-oee" class="collapsible-content">
            <table class="data-table">
              <thead>
                <tr>
                  <th class="sortable" data-type="string" data-col="0">ê³µì •</th>
                  <th class="sortable text-right" data-type="number" data-col="1">ìƒì‚°ìˆ˜ëŸ‰</th>
                  <th class="sortable text-right" data-type="number" data-col="2">ì–‘í’ˆìˆ˜ëŸ‰</th>
                  <th class="sortable text-right" data-type="number" data-col="3">ì‹œê°„ê°€ë™ìœ¨</th>
                  <th class="sortable text-right" data-type="number" data-col="4">ì„±ëŠ¥ê°€ë™ìœ¨</th>
                  <th class="sortable text-right" data-type="number" data-col="5">ì–‘í’ˆìœ¨</th>
                  <th class="sortable text-right" data-type="number" data-col="6">ì¢…í•©íš¨ìœ¨(OEE)</th>
                </tr>
              </thead>
              <tbody>
                ${displayOeeData.map(d => `
                  <tr>
                    <td class="font-medium">${d.process}</td>
                    <td class="text-right">${formatNumber(d.production)}</td>
                    <td class="text-right text-blue-600">${formatNumber(d.good)}</td>
                    <td class="text-right">${d.availability}%</td>
                    <td class="text-right">${d.performance}%</td>
                    <td class="text-right">${d.quality}%</td>
                    <td class="text-right">
                      <span class="badge ${parseFloat(d.oee) >= 85 ? 'badge-success' : parseFloat(d.oee) >= 60 ? 'badge-warning' : 'badge-danger'}">
                        ${d.oee}%
                      </span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- OEE Chart -->
        <div class="chart-card">
          <div class="chart-title">ê³µì •ë³„ ì¢…í•©íš¨ìœ¨ (OEE) ë¹„êµ <span class="text-sm font-normal text-slate-400">(ë…„ê°„ ëˆ„ì )</span></div>
          <div style="height: 280px;"><canvas id="oeeChart"></canvas></div>
        </div>
      `;
    }

    // ê³µì •í˜„í™©
    function renderProcess(data) {
      if (!state.activeProcess) {
        return `
          <div class="text-center py-16">
            <div class="text-6xl mb-4">ğŸ‘†</div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">ê³µì •ì„ ì„ íƒí•˜ì„¸ìš”</h3>
            <p class="text-slate-500">ìƒë‹¨ ë©”ë‰´ì—ì„œ í™•ì¸í•  ê³µì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
          </div>
        `;
      }

      const processInfo = processMenus.find(p => p.id === state.activeProcess);
      const processName = processDataMapping[state.activeProcess];
      const filteredData = data.filter(d => d.process === processName);
      const stats = getSummaryStats(filteredData);

      // ì„¤ë¹„ë³„ ë°ì´í„°
      const equipmentData = {};
      filteredData.forEach(row => {
        if (!equipmentData[row.equipment]) {
          equipmentData[row.equipment] = { equipment: row.equipment, production: 0, good: 0, defect: 0 };
        }
        equipmentData[row.equipment].production += row.productionQty;
        equipmentData[row.equipment].good += row.goodQty;
        equipmentData[row.equipment].defect += row.defectQty;
      });
      const equipments = Object.values(equipmentData);

      // í˜„ì¬ ì„ íƒëœ í•˜ìœ„ë©”ë‰´ì— ë”°ë¼ ë‹¤ë¥¸ ì½˜í…ì¸  í‘œì‹œ
      const subMenuContent = renderSubMenuContent(state.activeSubMenu, filteredData, stats, processInfo, equipments);

      return `
        <!-- Section Header -->
        <div class="section-header">
          <div class="section-title">
            ${processInfo.name} - ${getCurrentSubMenuName()}
          </div>
          <div class="flex items-center gap-3">
            <select class="filter-select" style="background: #f1f5f9; border-color: #cbd5e1; font-weight: 500;" onchange="setSelectedMonth(this.value)">
              ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}ì›”</option>`).join('')}
            </select>
            <select class="filter-select" onchange="setFilter('equipment', this.value)">
              <option value="all">All</option>
              ${equipments.map(e => `<option value="${e.equipment}" ${state.filters.equipment === e.equipment ? 'selected' : ''}>${e.equipment}</option>`).join('')}
            </select>
          </div>
        </div>

        ${subMenuContent}
      `;
    }

    // í˜„ì¬ í•˜ìœ„ë©”ë‰´ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    function getCurrentSubMenuName() {
      const subMenus = getCurrentSubMenus();
      const current = subMenus.find(s => s.id === state.activeSubMenu);
      return current ? current.name : 'ìƒì‚°í˜„í™©';
    }

    // í•˜ìœ„ë©”ë‰´ë³„ ì½˜í…ì¸  ë Œë”ë§
    function renderSubMenuContent(subMenuId, data, stats, processInfo, equipments) {
      if (!stats) return '<p class="text-center text-slate-500 py-8">í•´ë‹¹ ê³µì •ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

      switch(subMenuId) {
        case 'production':
          return renderProductionContent(data, stats, processInfo, equipments);
        case 'uph':
          return renderUPHContent(data, stats, processInfo, equipments);
        case 'cycletime':
          return renderCycleTimeContent(data, stats, processInfo, equipments);
        case 'packaging':
          return renderPackagingContent(data, stats, processInfo, equipments);
        case 'defect-repair':
          return renderDefectRepairContent(data, stats, processInfo, equipments);
        case 'material-defect':
          return renderMaterialDefectContent(data, stats, processInfo, equipments);
        default:
          return renderProductionContent(data, stats, processInfo, equipments);
      }
    }

    // ìƒì‚°í˜„í™© ì½˜í…ì¸ 
    function renderProductionContent(data, stats, processInfo, equipments) {
      const hasPrice = state.priceData && state.priceData.length > 0;
      return `
        <!-- Summary Cards - ìˆ˜ëŸ‰ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
          <div class="stat-card">
            <div class="stat-label">ì´ ìƒì‚°ìˆ˜ëŸ‰</div>
            <div class="stat-value" style="color: ${processInfo.color}">${formatNumber(stats.totalProduction)} EA</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);">
            <div class="stat-label">ğŸ’° ì´ ìƒì‚°ê¸ˆì•¡</div>
            <div class="stat-value text-amber-600">${hasPrice ? formatNumber(Math.round(stats.totalProductionAmount)) + ' ì›' : 'ë‹¨ê°€í‘œ í•„ìš”'}</div>
            ${hasPrice ? `<div class="stat-sub text-amber-500">ë§¤ì¹­ìœ¨ ${stats.priceMatchRate}%</div>` : ''}
          </div>
          <div class="stat-card">
            <div class="stat-label">ìˆ˜ìœ¨</div>
            <div class="stat-value text-blue-600">${stats.avgYield}%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ëª©í‘œë‹¬ì„±ë¥ </div>
            <div class="stat-value text-emerald-600">${stats.achievementRate}%</div>
          </div>
        </div>
        <!-- Summary Cards - ë¶ˆëŸ‰/íê¸° -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="stat-card">
            <div class="stat-label">ë¶ˆëŸ‰ìœ¨</div>
            <div class="stat-value text-red-500">${stats.avgDefectRate}%</div>
            <div class="stat-sub">${formatNumber(stats.totalDefect)} EA</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
            <div class="stat-label">ğŸ’¸ ë¶ˆëŸ‰ê¸ˆì•¡</div>
            <div class="stat-value text-red-600">${hasPrice ? formatNumber(Math.round(stats.totalDefectAmount)) + ' ì›' : '-'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">íê¸°ìœ¨</div>
            <div class="stat-value text-rose-500">${stats.avgDisposalRate}%</div>
            <div class="stat-sub">${formatNumber(stats.totalDisposal)} EA</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);">
            <div class="stat-label">ğŸ—‘ï¸ íê¸°ê¸ˆì•¡</div>
            <div class="stat-value text-rose-600">${hasPrice ? formatNumber(Math.round(stats.totalDisposalAmount)) + ' ì›' : '-'}</div>
          </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">ì¼ë³„ ìƒì‚° ì¶”ì´</div>
            <div style="height: 320px;"><canvas id="processDetailDailyChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ì„¤ë¹„ë³„ ìƒì‚°í˜„í™©</div>
            <div style="height: 320px;"><canvas id="processDetailEquipmentChart"></canvas></div>
          </div>
        </div>

        <!-- Equipment Table -->
        <div class="card">
          <h3 class="text-base font-bold text-slate-800 mb-4">ì„¤ë¹„ë³„ ìƒì„¸ í˜„í™©</h3>
          <table class="data-table" id="equipmentTable">
            <thead>
              <tr>
                <th class="sortable" data-type="equipment" data-col="0">ì„¤ë¹„/LINE</th>
                <th class="sortable text-right" data-type="number" data-col="1">ìƒì‚°ìˆ˜ëŸ‰</th>
                <th class="sortable text-right" data-type="number" data-col="2">ì–‘í’ˆìˆ˜ëŸ‰</th>
                <th class="sortable text-right" data-type="number" data-col="3">ë¶ˆëŸ‰ìˆ˜ëŸ‰</th>
                <th class="sortable text-right" data-type="number" data-col="4">ìˆ˜ìœ¨</th>
              </tr>
            </thead>
            <tbody>
              ${sortEquipments(equipments).map(eq => `
                <tr>
                  <td class="font-medium">${eq.equipment}</td>
                  <td class="text-right">${formatNumber(eq.production)}</td>
                  <td class="text-right text-blue-600">${formatNumber(eq.good)}</td>
                  <td class="text-right text-red-500">${formatNumber(eq.defect)}</td>
                  <td class="text-right">
                    <span class="badge ${(eq.good/eq.production*100) >= 95 ? 'badge-success' : (eq.good/eq.production*100) >= 90 ? 'badge-warning' : 'badge-danger'}">
                      ${formatPercent(eq.good/eq.production*100)}
                    </span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // UPHí˜„í™© ì½˜í…ì¸ 
    function renderUPHContent(data, stats, processInfo, equipments) {
      return `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
          <div class="stat-card">
            <div class="stat-label">í‰ê·  UPH</div>
            <div class="stat-value" style="color: ${processInfo.color}">${formatNumber(Math.round(stats.totalProduction / stats.uniqueDates / 8))} EA/H</div>
            <div class="stat-sub">ì‹œê°„ë‹¹ ìƒì‚°ëŸ‰</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ìµœëŒ€ UPH</div>
            <div class="stat-value text-blue-600">${formatNumber(Math.round(stats.totalProduction / stats.uniqueDates / 6))} EA/H</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ëª©í‘œ ë‹¬ì„±ë¥ </div>
            <div class="stat-value text-blue-600">${stats.achievementRate}%</div>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">ì¼ë³„ UPH ì¶”ì´</div>
          <div style="height: 250px;"><canvas id="uphChart"></canvas></div>
        </div>
      `;
    }

    // Cycle Time ì½˜í…ì¸ 
    // CT ë°ì´í„° ê³µì • í•„í„°ë§ í—¬í¼ (ìœ ì—°í•œ ë§¤ì¹­)
    function filterCTByProcess(ctData, processName, filterByMonth = true) {
      if (!ctData || ctData.length === 0 || !processName) return [];
      const pName = processName.toLowerCase();
      return ctData.filter(d => {
        const ctProcess = (d.process || '').toLowerCase();
        // ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, ê³µì •ëª…ì„ í¬í•¨í•˜ëŠ” ê²½ìš° ë§¤ì¹­
        const processMatch = ctProcess === pName || ctProcess.includes(pName) || pName.includes(ctProcess);

        // ğŸ”´ ì›”ë³„ í•„í„°ë§ (ì—„ê²© ëª¨ë“œ)
        if (filterByMonth) {
          // month í•„ë“œê°€ ì—†ëŠ” ë°ì´í„°ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ (ì¬ì—…ë¡œë“œ í•„ìš”)
          if (!d.month) return false;
          // ì„ íƒëœ ì›”ê³¼ ë‹¤ë¥´ë©´ ì œì™¸
          if (d.month !== state.selectedMonth) return false;
        }

        return processMatch;
      });
    }

    function renderCycleTimeContent(data, stats, processInfo, equipments) {
      // CT ë°ì´í„°ì—ì„œ í˜„ì¬ ê³µì • í•„í„°ë§ (ì˜ì–´ ID -> í•œê¸€ ê³µì •ëª… ë§¤í•‘)
      const currentProcessId = state.activeProcess;
      const currentProcessName = processDataMapping[currentProcessId] || currentProcessId;
      let ctStats = { avgActualCT: 0, avgStandardCT: 0, avgEfficiency: 0, count: 0 };
      let filteredCTCount = 0;

      if (state.ctData && state.ctData.length > 0) {
        const filteredCT = filterCTByProcess(state.ctData, currentProcessName);

        filteredCTCount = filteredCT.length;

        if (filteredCT.length > 0) {
          const validCT = filteredCT.filter(d => d.actualCT > 0 && d.standardCT > 0);
          ctStats.avgActualCT = validCT.reduce((sum, d) => sum + d.actualCT, 0) / validCT.length || 0;
          ctStats.avgStandardCT = validCT.reduce((sum, d) => sum + d.standardCT, 0) / validCT.length || 0;
          ctStats.avgEfficiency = validCT.reduce((sum, d) => sum + d.efficiency, 0) / validCT.length || 0;
          ctStats.count = filteredCT.length;
        }
      }

      const ctDiff = ctStats.avgActualCT - ctStats.avgStandardCT;
      const ctDiffText = ctDiff >= 0 ? `+${formatDecimal(ctDiff, 1)}sec` : `${formatDecimal(ctDiff, 1)}sec`;
      const efficiencyColor = ctStats.avgEfficiency >= 100 ? 'text-emerald-600' : ctStats.avgEfficiency >= 90 ? 'text-blue-600' : 'text-red-500';

      // í˜„ì¬ ê³µì •ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
      const noDataForProcess = state.ctData.length > 0 && filteredCTCount === 0;

      return `
        ${state.ctData.length > 0
          ? `<div class="text-sm text-amber-600 mb-4">âœ“ CTí˜„í™© ì´ ${state.ctData.length}ê±´ (${currentProcessName}: ${filteredCTCount}ê±´)</div>`
          : '<div class="text-sm text-slate-400 mb-4">CT ë°ì´í„° ì—†ìŒ - íŒŒì¼ì—…ë¡œë“œ ë©”ë‰´ì—ì„œ ë“±ë¡í•˜ì„¸ìš”</div>'}
        ${noDataForProcess ? `
          <div class="card text-center py-12 mb-6">
            <div class="text-5xl mb-4">ğŸ“­</div>
            <h3 class="text-lg font-bold text-slate-600 mb-2">${currentProcessName} ê³µì •ì˜ CT ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-sm text-slate-400">íŒŒì¼ì—…ë¡œë“œ ë©”ë‰´ì—ì„œ í•´ë‹¹ ê³µì •ì˜ CTí˜„í™© CSVë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”</p>
          </div>
        ` : `
          <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
            <div class="stat-card">
              <div class="stat-label">í‰ê·  ì‹¤ì œ CT</div>
              <div class="stat-value" style="color: ${processInfo.color}">${ctStats.avgActualCT > 0 ? formatDecimal(ctStats.avgActualCT, 1) : '-'} sec</div>
              <div class="stat-sub">${ctStats.count > 0 ? `í‘œì¤€ CT ëŒ€ë¹„ ${ctDiffText}` : 'ë°ì´í„° ì—†ìŒ'}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">í‰ê·  í‘œì¤€ CT</div>
              <div class="stat-value text-slate-600">${ctStats.avgStandardCT > 0 ? formatDecimal(ctStats.avgStandardCT, 1) : '-'} sec</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">í‰ê·  CT ë‹¬ì„±ë¥ </div>
              <div class="stat-value ${efficiencyColor}">${ctStats.avgEfficiency > 0 ? formatPercent(ctStats.avgEfficiency) : '-'}</div>
            </div>
          </div>
          <div class="chart-card mb-6">
            <div class="chart-title">ì„¤ë¹„ë³„ Cycle Time ë¹„êµ (${currentProcessName})</div>
            <div style="height: 320px;"><canvas id="cycleTimeChart"></canvas></div>
          </div>

          <!-- CT ì €ì¡° ì‹¤ì  ìƒì„¸ ë¦¬ìŠ¤íŠ¸ -->
          ${buildCtLowPerfList(state.ctData, currentProcessName)}
        `}`;
    }

    // ê²€í¬ì¥í˜„í™© ì½˜í…ì¸ 
    function renderPackagingContent(data, stats, processInfo, equipments) {
      // ì—…ë¡œë“œëœ ê²€í¬ì¥í˜„í™© ë°ì´í„° ì‚¬ìš© - í˜„ì¬ ê³µì •ìœ¼ë¡œ í•„í„°ë§
      const allPackagingData = state.packagingStatusData || [];
      const currentProcessName = processDataMapping[processInfo.id] || '';

      // í˜„ì¬ ê³µì •ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë§Œ í•„í„°ë§
      const packagingData = allPackagingData.filter(d => {
        const processName = d.process || '';
        return processName.includes(currentProcessName) || currentProcessName.includes(processName);
      });

      // ì „ì²´ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
      if (allPackagingData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-lg">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">ê²€í¬ì¥í˜„í™© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-slate-500 mb-6">íŒŒì¼ì—…ë¡œë“œ ë©”ë‰´ì—ì„œ ê²€í¬ì¥í˜„í™© CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              ğŸ“¤ íŒŒì¼ì—…ë¡œë“œ í˜ì´ì§€ë¡œ ì´ë™
            </button>
          </div>
        `;
      }

      // í˜„ì¬ ê³µì • ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
      if (packagingData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-slate-400 to-slate-500 flex items-center justify-center shadow-lg">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">${processInfo.name} ê²€í¬ì¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-slate-500 mb-6">ì—…ë¡œë“œëœ ê²€í¬ì¥í˜„í™© ë°ì´í„° ì¤‘ ${currentProcessName}ê³µì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            <div class="text-sm text-slate-400">ì „ì²´ ì—…ë¡œë“œ ë°ì´í„°: ${allPackagingData.length.toLocaleString()}ê±´</div>
          </div>
        `;
      }

      // í†µê³„ ê³„ì‚°
      const totalDefect = packagingData.reduce((sum, d) => sum + d.defectQty, 0);
      const totalRepair = packagingData.reduce((sum, d) => sum + d.repairQty, 0);
      const totalDisposal = packagingData.reduce((sum, d) => sum + d.disposalQty, 0);
      const uniqueParts = new Set(packagingData.map(d => d.itemCode)).size;
      const uniqueDates = new Set(packagingData.map(d => d.productionDate)).size;
      const uniqueEquipments = new Set(packagingData.map(d => d.equipmentName)).size;

      // ì¼ë³„ ì§‘ê³„
      const dailySummary = {};
      packagingData.forEach(d => {
        if (!dailySummary[d.productionDate]) {
          dailySummary[d.productionDate] = { date: d.productionDate, defect: 0, repair: 0, disposal: 0 };
        }
        dailySummary[d.productionDate].defect += d.defectQty;
        dailySummary[d.productionDate].repair += d.repairQty;
        dailySummary[d.productionDate].disposal += d.disposalQty;
      });
      const dailyList = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      // ê³µì •êµ¬ë¶„ë³„ ì§‘ê³„
      const processTypeSummary = {};
      packagingData.forEach(d => {
        const pType = d.processType || 'ë¯¸ë¶„ë¥˜';
        if (!processTypeSummary[pType]) {
          processTypeSummary[pType] = { processType: pType, defect: 0, repair: 0, disposal: 0, count: 0 };
        }
        processTypeSummary[pType].defect += d.defectQty;
        processTypeSummary[pType].repair += d.repairQty;
        processTypeSummary[pType].disposal += d.disposalQty;
        processTypeSummary[pType].count++;
      });
      const processTypeList = Object.values(processTypeSummary).sort((a, b) => b.defect - a.defect);

      // ì„¤ë¹„ë³„ ì§‘ê³„
      const equipmentSummary = {};
      packagingData.forEach(d => {
        const eqName = d.equipmentName || 'ë¯¸ë¶„ë¥˜';
        if (!equipmentSummary[eqName]) {
          equipmentSummary[eqName] = { equipment: eqName, defect: 0, repair: 0, disposal: 0, count: 0 };
        }
        equipmentSummary[eqName].defect += d.defectQty;
        equipmentSummary[eqName].repair += d.repairQty;
        equipmentSummary[eqName].disposal += d.disposalQty;
        equipmentSummary[eqName].count++;
      });
      const equipmentList = Object.values(equipmentSummary).sort((a, b) => b.defect - a.defect);

      // í’ˆëª©ë³„ ì§‘ê³„ (TOP 10)
      const itemSummary = {};
      packagingData.forEach(d => {
        if (!itemSummary[d.itemCode]) {
          itemSummary[d.itemCode] = {
            itemCode: d.itemCode,
            itemName: d.itemName,
            defect: 0,
            repair: 0,
            disposal: 0
          };
        }
        itemSummary[d.itemCode].defect += d.defectQty;
        itemSummary[d.itemCode].repair += d.repairQty;
        itemSummary[d.itemCode].disposal += d.disposalQty;
      });
      const itemList = Object.values(itemSummary).sort((a, b) => b.defect - a.defect);

      return `
        <!-- ìš”ì•½ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card">
            <div class="stat-label">ì´ ë¶ˆëŸ‰ìˆ˜ëŸ‰</div>
            <div class="stat-value text-red-600">${formatNumber(totalDefect)} EA</div>
            <div class="stat-sub">${uniqueDates}ì¼ê°„ ë°ì´í„°</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ì´ ìˆ˜ë¦¬ìˆ˜ëŸ‰</div>
            <div class="stat-value text-purple-600">${formatNumber(totalRepair)} EA</div>
            <div class="stat-sub">${uniqueParts}ê°œ í’ˆëª©</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ì´ íê¸°ìˆ˜ëŸ‰</div>
            <div class="stat-value text-orange-600">${formatNumber(totalDisposal)} EA</div>
            <div class="stat-sub">${uniqueEquipments}ê°œ ì„¤ë¹„</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ìˆ˜ë¦¬ìœ¨</div>
            <div class="stat-value text-emerald-600">${totalDefect > 0 ? formatPercent(totalRepair / totalDefect * 100) : '0.0%'}</div>
            <div class="stat-sub">ìˆ˜ë¦¬ / ë¶ˆëŸ‰</div>
          </div>
        </div>

        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">ì¼ë³„ ê²€í¬ì¥ í˜„í™©</div>
            <div style="height: 250px;"><canvas id="packagingDailyChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ê³µì •êµ¬ë¶„ë³„ í˜„í™©</div>
            <div style="height: 250px;"><canvas id="packagingProcessChart"></canvas></div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">ì„¤ë¹„ë³„ ë¶ˆëŸ‰ í˜„í™© TOP 5</div>
            <div style="height: 250px;"><canvas id="packagingEquipmentChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">í’ˆëª©ë³„ ë¶ˆëŸ‰ TOP 5</div>
            <div style="height: 250px;"><canvas id="packagingItemChart"></canvas></div>
          </div>
        </div>

        <!-- ìƒì„¸ ë°ì´í„° í…Œì´ë¸” -->
        <div class="card mb-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              <span>ğŸ“‹ í’ˆëª©ë³„ ê²€í¬ì¥ í˜„í™©</span>
              <span class="text-sm font-normal text-slate-500">(${itemList.length}ê°œ í’ˆëª©)</span>
            </h3>
            <div class="flex gap-2">
              <button onclick="toggleCollapse('packaging')" class="collapse-toggle inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                <svg class="w-4 h-4 transition-transform ${collapseState.packaging ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                ${collapseState.packaging ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°'}
              </button>
              <button onclick="downloadPackagingExcel()" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-emerald-700 bg-emerald-100 hover:bg-emerald-200 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Excel ë‹¤ìš´ë¡œë“œ
              </button>
            </div>
          </div>
          <div class="collapsible-content ${collapseState.packaging ? 'collapsed' : ''}">
            <div class="overflow-x-auto">
              <table class="data-table w-full">
                <thead>
                  <tr>
                    <th class="text-left sortable" data-type="number" data-col="0">ìˆœìœ„</th>
                    <th class="text-left sortable" data-type="string" data-col="1">í’ˆëª©ì½”ë“œ</th>
                    <th class="text-left sortable" data-type="string" data-col="2">í’ˆëª©ëª…</th>
                    <th class="text-right sortable" data-type="number" data-col="3">ë¶ˆëŸ‰ìˆ˜ëŸ‰</th>
                    <th class="text-right sortable" data-type="number" data-col="4">ìˆ˜ë¦¬ìˆ˜ëŸ‰</th>
                    <th class="text-right sortable" data-type="number" data-col="5">íê¸°ìˆ˜ëŸ‰</th>
                    <th class="text-right sortable" data-type="number" data-col="6">ìˆ˜ë¦¬ìœ¨</th>
                  </tr>
                </thead>
                <tbody>
                  ${itemList.map((item, idx) => `
                    <tr>
                      <td class="text-slate-500">${idx + 1}</td>
                      <td class="font-mono text-xs">${item.itemCode}</td>
                      <td>${item.itemName}</td>
                      <td class="text-right font-semibold text-red-600">${formatNumber(item.defect)}</td>
                      <td class="text-right text-purple-600">${formatNumber(item.repair)}</td>
                      <td class="text-right text-orange-600">${formatNumber(item.disposal)}</td>
                      <td class="text-right">${item.defect > 0 ? formatPercent(item.repair / item.defect * 100) : '0.0%'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ì½˜í…ì¸  (ì¡°ë¦½ê³µì • ì „ìš©) - ì—…ë¡œë“œ ë°ì´í„° ê¸°ë°˜
    function renderDefectRepairContent(data, stats, processInfo, equipments) {
      // ì—…ë¡œë“œëœ ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ë°ì´í„° ì‚¬ìš©
      const repairData = state.repairStatusData || [];

      // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
      if (repairData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-indigo-500 to-indigo-600 flex items-center justify-center shadow-lg">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-slate-500 mb-6">íŒŒì¼ì—…ë¡œë“œ ë©”ë‰´ì—ì„œ ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              ğŸ“¤ íŒŒì¼ì—…ë¡œë“œ í˜ì´ì§€ë¡œ ì´ë™
            </button>
          </div>
        `;
      }

      // í†µê³„ ê³„ì‚°
      const totalProduction = repairData.reduce((sum, d) => sum + d.productionQty, 0);
      const totalRepair = repairData.reduce((sum, d) => sum + d.repairQty, 0);
      const repairRate = totalProduction > 0 ? formatPercent(totalRepair / totalProduction * 100) : '0.0%';
      const uniqueParts = new Set(repairData.map(d => d.partCode)).size;
      const uniqueDates = new Set(repairData.map(d => d.date)).size;

      // í’ˆëª©ë³„ ìˆ˜ë¦¬ ì§‘ê³„
      const partSummary = {};
      repairData.forEach(d => {
        if (!partSummary[d.partCode]) {
          partSummary[d.partCode] = {
            partCode: d.partCode,
            partName: d.partName,
            spec: d.spec,
            totalProduction: 0,
            totalRepair: 0
          };
        }
        partSummary[d.partCode].totalProduction += d.productionQty;
        partSummary[d.partCode].totalRepair += d.repairQty;
      });

      // ìˆ˜ë¦¬ìœ¨ ê¸°ì¤€ ì •ë ¬ (ë†’ì€ ìˆœ)
      const partList = Object.values(partSummary)
        .map(p => ({ ...p, repairRate: p.totalProduction > 0 ? (p.totalRepair / p.totalProduction * 100) : 0 }))
        .sort((a, b) => b.totalRepair - a.totalRepair);

      // ì¼ë³„ ìˆ˜ë¦¬ ì§‘ê³„
      const dailySummary = {};
      repairData.forEach(d => {
        if (!dailySummary[d.date]) {
          dailySummary[d.date] = { date: d.date, production: 0, repair: 0 };
        }
        dailySummary[d.date].production += d.productionQty;
        dailySummary[d.date].repair += d.repairQty;
      });
      const dailyList = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      return `
        <!-- ìš”ì•½ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card">
            <div class="stat-label">ì´ ìƒì‚°ìˆ˜ëŸ‰</div>
            <div class="stat-value" style="color: ${processInfo.color}">${formatNumber(totalProduction)} EA</div>
            <div class="stat-sub">${uniqueDates}ì¼ê°„ ìƒì‚°</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ì´ ìˆ˜ë¦¬ìˆ˜ëŸ‰</div>
            <div class="stat-value text-indigo-600">${formatNumber(totalRepair)} EA</div>
            <div class="stat-sub">${uniqueParts}ê°œ í’ˆëª©</div>
          </div>
          <div class="stat-card red">
            <div class="stat-label">ìˆ˜ë¦¬ìœ¨</div>
            <div class="stat-value text-red-500">${repairRate}</div>
            <div class="stat-sub">ìˆ˜ë¦¬ / ìƒì‚°</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ì´ ë°ì´í„°</div>
            <div class="stat-value text-slate-600">${formatNumber(repairData.length)} ê±´</div>
            <div class="stat-sub">ì—…ë¡œë“œ ë ˆì½”ë“œ</div>
          </div>
        </div>

        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">ì¼ë³„ ìˆ˜ë¦¬ ì¶”ì´</div>
            <div style="height: 280px;"><canvas id="repairDailyChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">í’ˆëª©ë³„ ìˆ˜ë¦¬ TOP 10</div>
            <div style="height: 280px;"><canvas id="repairPartChart"></canvas></div>
          </div>
        </div>

        <!-- í’ˆëª©ë³„ ìƒì„¸ í…Œì´ë¸” -->
        <div class="card">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-base font-bold text-slate-800">í’ˆëª©ë³„ ìˆ˜ë¦¬í˜„í™© ìƒì„¸</h3>
              <button id="toggle-repairStatus" class="collapse-toggle" onclick="toggleCollapse('repairStatus')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                ì ‘ê¸°
              </button>
            </div>
            <div class="flex items-center gap-3">
              <span class="text-sm text-slate-500">${formatNumber(partList.length)}ê°œ í’ˆëª©</span>
              <button onclick="downloadRepairStatusExcel()" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
              </button>
            </div>
          </div>
          <div id="collapse-repairStatus" class="collapsible-content">
            <div class="overflow-x-auto">
              <table class="data-table" id="repairDetailTable">
                <thead>
                  <tr>
                    <th class="sortable" data-type="string" data-col="0">ë¶€í’ˆì½”ë“œ</th>
                    <th class="sortable" data-type="string" data-col="1">ë¶€í’ˆëª…</th>
                    <th class="sortable" data-type="string" data-col="2">ê·œê²©</th>
                    <th class="sortable text-right" data-type="number" data-col="3">ìƒì‚°ìˆ˜ëŸ‰</th>
                    <th class="sortable text-right" data-type="number" data-col="4">ìˆ˜ë¦¬ìˆ˜ëŸ‰</th>
                    <th class="sortable text-right" data-type="number" data-col="5">ìˆ˜ë¦¬ìœ¨</th>
                  </tr>
                </thead>
                <tbody>
                  ${partList.slice(0, 50).map(p => `
                    <tr>
                      <td class="font-mono text-sm">${p.partCode}</td>
                      <td class="font-medium">${p.partName}</td>
                      <td class="text-slate-500">${p.spec || '-'}</td>
                      <td class="text-right">${formatNumber(p.totalProduction)}</td>
                      <td class="text-right text-indigo-600 font-semibold">${formatNumber(p.totalRepair)}</td>
                      <td class="text-right">
                        <span class="badge ${p.repairRate >= 10 ? 'badge-danger' : p.repairRate >= 5 ? 'badge-warning' : 'badge-success'}">
                          ${formatPercent(p.repairRate)}
                        </span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${partList.length > 50 ? `<p class="text-sm text-slate-400 mt-3 text-center">ìƒìœ„ 50ê°œ í’ˆëª©ë§Œ í‘œì‹œë©ë‹ˆë‹¤</p>` : ''}
          </div>
        </div>
      `;
    }

    // ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ì°¨íŠ¸ ìƒì„±
    function createRepairCharts() {
      const repairData = state.repairStatusData || [];
      if (repairData.length === 0) return;

      // ì¼ë³„ ì§‘ê³„
      const dailySummary = {};
      repairData.forEach(d => {
        if (!dailySummary[d.date]) {
          dailySummary[d.date] = { date: d.date, production: 0, repair: 0 };
        }
        dailySummary[d.date].production += d.productionQty;
        dailySummary[d.date].repair += d.repairQty;
      });
      const dailyList = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      // í’ˆëª©ë³„ ì§‘ê³„
      const partSummary = {};
      repairData.forEach(d => {
        if (!partSummary[d.partCode]) {
          partSummary[d.partCode] = { partName: d.partName, repair: 0 };
        }
        partSummary[d.partCode].repair += d.repairQty;
      });
      const topParts = Object.entries(partSummary)
        .map(([code, v]) => ({ code, name: v.partName, repair: v.repair }))
        .sort((a, b) => b.repair - a.repair)
        .slice(0, 10);

      // ì¼ë³„ ìˆ˜ë¦¬ ì°¨íŠ¸
      const dailyCtx = document.getElementById('repairDailyChart');
      if (dailyCtx) {
        if (charts.repairDaily) charts.repairDaily.destroy();
        charts.repairDaily = new Chart(dailyCtx, {
          type: 'bar',
          data: {
            labels: dailyList.map(d => d.date.substring(5)),
            datasets: [
              {
                label: 'ìˆ˜ë¦¬ìˆ˜ëŸ‰',
                data: dailyList.map(d => d.repair),
                backgroundColor: 'rgba(165, 180, 252, 0.85)',
                borderRadius: 4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // í’ˆëª©ë³„ ìˆ˜ë¦¬ ì°¨íŠ¸
      const partCtx = document.getElementById('repairPartChart');
      if (partCtx) {
        if (charts.repairPart) charts.repairPart.destroy();
        charts.repairPart = new Chart(partCtx, {
          type: 'bar',
          data: {
            labels: topParts.map(p => p.name.length > 15 ? p.name.substring(0, 15) + '...' : p.name),
            datasets: [{
              label: 'ìˆ˜ë¦¬ìˆ˜ëŸ‰',
              data: topParts.map(p => p.repair),
              backgroundColor: topParts.map((_, i) => generatePastelColor(i + 4)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }
    }

    // ìì¬ë¶ˆëŸ‰ ì°¨íŠ¸ ìƒì„±
    function createMaterialDefectCharts() {
      const defectData = state.materialDefectData || [];
      if (defectData.length === 0) return;

      // ê³µì •ë³„ ë¶ˆëŸ‰ ì§‘ê³„
      const processDefects = {};
      const processTypes = ['ì¡°ë¦½', 'ë ˆì´ì ¸', 'ì¸ì‡„', 'ë„ì¥', 'ì¦ì°©', 'ë„ê¸ˆ', 'ì‚¬ì¶œ'];
      processTypes.forEach(p => processDefects[p] = 0);

      defectData.forEach(d => {
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0) {
              processTypes.forEach(p => {
                if (key.includes(`(${p})`)) {
                  processDefects[p] += val;
                }
              });
            }
          });
        }
      });

      // ì¼ë³„ ë¶ˆëŸ‰ ì§‘ê³„
      const dailySummary = {};
      defectData.forEach(d => {
        const date = d.date || 'N/A';
        if (!dailySummary[date]) {
          dailySummary[date] = { date, total: 0 };
        }
        dailySummary[date].total += d.defectTotal || 0;
      });
      const dailyList = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      // í’ˆëª©ë³„ ë¶ˆëŸ‰ ì§‘ê³„
      const partSummary = {};
      defectData.forEach(d => {
        if (!partSummary[d.partCode]) {
          partSummary[d.partCode] = { partName: d.partName, total: 0 };
        }
        partSummary[d.partCode].total += d.defectTotal || 0;
      });
      const topParts = Object.entries(partSummary)
        .map(([code, v]) => ({ code, name: v.partName, total: v.total }))
        .sort((a, b) => b.total - a.total)
        .slice(0, 10);

      // ì¼ë³„ ë¶ˆëŸ‰ ì°¨íŠ¸
      const dailyCtx = document.getElementById('materialDailyChart');
      if (dailyCtx) {
        if (charts.materialDaily) charts.materialDaily.destroy();
        charts.materialDaily = new Chart(dailyCtx, {
          type: 'bar',
          data: {
            labels: dailyList.map(d => d.date.substring(5)),
            datasets: [{
              label: 'ë¶ˆëŸ‰ìˆ˜ëŸ‰',
              data: dailyList.map(d => d.total),
              backgroundColor: 'rgba(252, 165, 165, 0.85)',
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // ê³µì •ë³„ ë¶ˆëŸ‰ ì°¨íŠ¸ (ë„ë„›)
      const processCtx = document.getElementById('materialProcessChart');
      if (processCtx) {
        if (charts.materialProcess) charts.materialProcess.destroy();
        const processData = processTypes.map(p => processDefects[p]).filter(v => v > 0);
        const processLabels = processTypes.filter(p => processDefects[p] > 0);
        charts.materialProcess = new Chart(processCtx, {
          type: 'doughnut',
          data: {
            labels: processLabels,
            datasets: [{
              data: processData,
              backgroundColor: [
                'rgba(252, 165, 165, 0.85)',
                'rgba(253, 186, 116, 0.85)',
                'rgba(110, 231, 183, 0.85)',
                'rgba(147, 197, 253, 0.85)',
                'rgba(196, 181, 253, 0.85)',
                'rgba(249, 168, 212, 0.85)',
                'rgba(94, 234, 212, 0.85)'
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { boxWidth: 12, padding: 12 } }
            }
          }
        });
      }

      // í’ˆëª©ë³„ ë¶ˆëŸ‰ ì°¨íŠ¸
      const partCtx = document.getElementById('materialPartChart');
      if (partCtx) {
        if (charts.materialPart) charts.materialPart.destroy();
        charts.materialPart = new Chart(partCtx, {
          type: 'bar',
          data: {
            labels: topParts.map(p => p.name.length > 20 ? p.name.substring(0, 20) + '...' : p.name),
            datasets: [{
              label: 'ë¶ˆëŸ‰ìˆ˜ëŸ‰',
              data: topParts.map(p => p.total),
              backgroundColor: topParts.map((_, i) => generatePastelColor(i + 3)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }

      // ë¶ˆëŸ‰ìœ í˜•ë³„ ì§‘ê³„
      const defectTypeSummary = {};
      defectData.forEach(d => {
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0 && key.includes('(') && key.includes(')')) {
              if (!defectTypeSummary[key]) {
                defectTypeSummary[key] = 0;
              }
              defectTypeSummary[key] += val;
            }
          });
        }
      });
      const topDefectTypes = Object.entries(defectTypeSummary)
        .map(([type, total]) => ({ type, total }))
        .sort((a, b) => b.total - a.total)
        .slice(0, 15);

      // ë¶ˆëŸ‰ìœ í˜• TOP 15 ì°¨íŠ¸
      const defectTypeCtx = document.getElementById('defectTypeChart');
      if (defectTypeCtx) {
        if (charts.defectType) charts.defectType.destroy();
        charts.defectType = new Chart(defectTypeCtx, {
          type: 'bar',
          data: {
            labels: topDefectTypes.map(t => t.type.length > 15 ? t.type.substring(0, 15) + '...' : t.type),
            datasets: [{
              label: 'ë¶ˆëŸ‰ìˆ˜ëŸ‰',
              data: topDefectTypes.map(t => t.total),
              backgroundColor: topDefectTypes.map((_, i) => generatePastelColor(i)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false }, ticks: { font: { size: 10 } } }
            }
          }
        });
      }

      // ë¶€í’ˆë³„ ë¶ˆëŸ‰ìœ í˜• ì§‘ê³„ (TOP 10 ë¶€í’ˆ)
      const partDefectTypes = {};
      defectData.forEach(d => {
        const partKey = d.partCode;
        if (!partDefectTypes[partKey]) {
          partDefectTypes[partKey] = { partCode: d.partCode, partName: d.partName, defects: {} };
        }
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0 && key.includes('(') && key.includes(')')) {
              if (!partDefectTypes[partKey].defects[key]) {
                partDefectTypes[partKey].defects[key] = 0;
              }
              partDefectTypes[partKey].defects[key] += val;
            }
          });
        }
      });

      const partDefectList = Object.values(partDefectTypes).map(p => {
        const totalDefect = Object.values(p.defects).reduce((sum, v) => sum + v, 0);
        return { ...p, totalDefect };
      }).sort((a, b) => b.totalDefect - a.totalDefect).slice(0, 10);

      // ë¶€í’ˆë³„ ë¶ˆëŸ‰ìœ í˜• ìŠ¤íƒ ì°¨íŠ¸
      const partDefectTypeCtx = document.getElementById('partDefectTypeChart');
      if (partDefectTypeCtx) {
        if (charts.partDefectType) charts.partDefectType.destroy();

        // ì£¼ìš” ë¶ˆëŸ‰ìœ í˜• ì¶”ì¶œ (ì „ì²´ì—ì„œ TOP 5)
        const mainTypes = topDefectTypes.slice(0, 5).map(t => t.type);
        const colors = [
          'rgba(252, 165, 165, 0.85)',
          'rgba(253, 186, 116, 0.85)',
          'rgba(147, 197, 253, 0.85)',
          'rgba(110, 231, 183, 0.85)',
          'rgba(196, 181, 253, 0.85)'
        ];

        const datasets = mainTypes.map((type, idx) => ({
          label: type.length > 12 ? type.substring(0, 12) + '...' : type,
          data: partDefectList.map(p => p.defects[type] || 0),
          backgroundColor: colors[idx],
          borderRadius: 2
        }));

        // ê¸°íƒ€ ë¶ˆëŸ‰ìœ í˜• í•©ê³„
        const otherData = partDefectList.map(p => {
          const mainTotal = mainTypes.reduce((sum, t) => sum + (p.defects[t] || 0), 0);
          return p.totalDefect - mainTotal;
        });

        if (otherData.some(v => v > 0)) {
          datasets.push({
            label: 'ê¸°íƒ€',
            data: otherData,
            backgroundColor: 'rgba(203, 213, 225, 0.85)',
            borderRadius: 2
          });
        }

        charts.partDefectType = new Chart(partDefectTypeCtx, {
          type: 'bar',
          data: {
            labels: partDefectList.map(p => (p.partName || p.partCode).length > 12 ? (p.partName || p.partCode).substring(0, 12) + '...' : (p.partName || p.partCode)),
            datasets: datasets
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8, font: { size: 10 } } }
            },
            scales: {
              x: { stacked: true, beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } }
            }
          }
        });
      }
    }

    // ê²€í¬ì¥í˜„í™© ì°¨íŠ¸ ìƒì„±
    function createPackagingCharts() {
      const allPackagingData = state.packagingStatusData || [];
      if (allPackagingData.length === 0) return;

      // í˜„ì¬ ê³µì •ìœ¼ë¡œ í•„í„°ë§
      const currentProcessName = processDataMapping[state.activeProcess] || '';
      const packagingData = allPackagingData.filter(d => {
        const processName = d.process || '';
        return processName.includes(currentProcessName) || currentProcessName.includes(processName);
      });

      if (packagingData.length === 0) return;

      // ì¼ë³„ ì§‘ê³„
      const dailySummary = {};
      packagingData.forEach(d => {
        if (!dailySummary[d.productionDate]) {
          dailySummary[d.productionDate] = { date: d.productionDate, defect: 0, repair: 0, disposal: 0 };
        }
        dailySummary[d.productionDate].defect += d.defectQty;
        dailySummary[d.productionDate].repair += d.repairQty;
        dailySummary[d.productionDate].disposal += d.disposalQty;
      });
      const dailyList = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      // ê³µì •êµ¬ë¶„ë³„ ì§‘ê³„
      const processTypeSummary = {};
      packagingData.forEach(d => {
        const pType = d.processType || 'ë¯¸ë¶„ë¥˜';
        if (!processTypeSummary[pType]) {
          processTypeSummary[pType] = { processType: pType, defect: 0, repair: 0, disposal: 0 };
        }
        processTypeSummary[pType].defect += d.defectQty;
        processTypeSummary[pType].repair += d.repairQty;
        processTypeSummary[pType].disposal += d.disposalQty;
      });
      const processTypeList = Object.values(processTypeSummary).sort((a, b) => b.defect - a.defect);

      // ì„¤ë¹„ë³„ ì§‘ê³„
      const equipmentSummary = {};
      packagingData.forEach(d => {
        const eqName = d.equipmentName || 'ë¯¸ë¶„ë¥˜';
        if (!equipmentSummary[eqName]) {
          equipmentSummary[eqName] = { equipment: eqName, defect: 0, repair: 0, disposal: 0 };
        }
        equipmentSummary[eqName].defect += d.defectQty;
        equipmentSummary[eqName].repair += d.repairQty;
        equipmentSummary[eqName].disposal += d.disposalQty;
      });
      const equipmentList = Object.values(equipmentSummary).sort((a, b) => b.defect - a.defect).slice(0, 5);

      // í’ˆëª©ë³„ ì§‘ê³„
      const itemSummary = {};
      packagingData.forEach(d => {
        if (!itemSummary[d.itemCode]) {
          itemSummary[d.itemCode] = { itemCode: d.itemCode, itemName: d.itemName, defect: 0, repair: 0, disposal: 0 };
        }
        itemSummary[d.itemCode].defect += d.defectQty;
        itemSummary[d.itemCode].repair += d.repairQty;
        itemSummary[d.itemCode].disposal += d.disposalQty;
      });
      const itemList = Object.values(itemSummary).sort((a, b) => b.defect - a.defect).slice(0, 5);

      // ì¼ë³„ ê²€í¬ì¥ ì°¨íŠ¸
      const dailyCtx = document.getElementById('packagingDailyChart');
      if (dailyCtx) {
        if (charts.packagingDaily) charts.packagingDaily.destroy();
        charts.packagingDaily = new Chart(dailyCtx, {
          type: 'bar',
          data: {
            labels: dailyList.map(d => d.date.substring(5)),
            datasets: [
              {
                label: 'ë¶ˆëŸ‰',
                data: dailyList.map(d => d.defect),
                backgroundColor: 'rgba(252, 165, 165, 0.85)',
                borderRadius: 4
              },
              {
                label: 'ìˆ˜ë¦¬',
                data: dailyList.map(d => d.repair),
                backgroundColor: 'rgba(196, 181, 253, 0.85)',
                borderRadius: 4
              },
              {
                label: 'íê¸°',
                data: dailyList.map(d => d.disposal),
                backgroundColor: 'rgba(253, 186, 116, 0.85)',
                borderRadius: 4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8 } }
            },
            scales: {
              y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // ê³µì •êµ¬ë¶„ë³„ ì°¨íŠ¸
      const processCtx = document.getElementById('packagingProcessChart');
      if (processCtx) {
        if (charts.packagingProcess) charts.packagingProcess.destroy();
        charts.packagingProcess = new Chart(processCtx, {
          type: 'doughnut',
          data: {
            labels: processTypeList.map(p => p.processType),
            datasets: [{
              data: processTypeList.map(p => p.defect),
              backgroundColor: processTypeList.map((_, i) => generatePastelColor(i + 4))
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8 } }
            }
          }
        });
      }

      // ì„¤ë¹„ë³„ ë¶ˆëŸ‰ ì°¨íŠ¸
      const equipmentCtx = document.getElementById('packagingEquipmentChart');
      if (equipmentCtx) {
        if (charts.packagingEquipment) charts.packagingEquipment.destroy();
        charts.packagingEquipment = new Chart(equipmentCtx, {
          type: 'bar',
          data: {
            labels: equipmentList.map(e => e.equipment.length > 10 ? e.equipment.substring(0, 10) + '...' : e.equipment),
            datasets: [
              {
                label: 'ë¶ˆëŸ‰',
                data: equipmentList.map(e => e.defect),
                backgroundColor: 'rgba(252, 165, 165, 0.85)',
                borderRadius: 4
              },
              {
                label: 'ìˆ˜ë¦¬',
                data: equipmentList.map(e => e.repair),
                backgroundColor: 'rgba(196, 181, 253, 0.85)',
                borderRadius: 4
              }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8 } }
            },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }

      // í’ˆëª©ë³„ ë¶ˆëŸ‰ ì°¨íŠ¸
      const itemCtx = document.getElementById('packagingItemChart');
      if (itemCtx) {
        if (charts.packagingItem) charts.packagingItem.destroy();
        charts.packagingItem = new Chart(itemCtx, {
          type: 'bar',
          data: {
            labels: itemList.map(i => (i.itemName || i.itemCode).length > 10 ? (i.itemName || i.itemCode).substring(0, 10) + '...' : (i.itemName || i.itemCode)),
            datasets: [{
              label: 'ë¶ˆëŸ‰ìˆ˜ëŸ‰',
              data: itemList.map(i => i.defect),
              backgroundColor: itemList.map((_, idx) => generatePastelColor(idx + 4)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }
    }

    // ìì¬ë¶ˆëŸ‰í˜„í™© ì½˜í…ì¸  (ì¡°ë¦½ê³µì • ì „ìš©)
    function renderMaterialDefectContent(data, stats, processInfo, equipments) {
      const defectData = state.materialDefectData || [];

      if (defectData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="text-6xl mb-4">ğŸ“¦</div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">ìì¬ë¶ˆëŸ‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-slate-500 mb-6">ì¡°ë¦½ìì¬ë¶ˆëŸ‰ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              ğŸ“¤ íŒŒì¼ì—…ë¡œë“œ í˜ì´ì§€ë¡œ ì´ë™
            </button>
          </div>
        `;
      }

      // í†µê³„ ê³„ì‚°
      const totalDefects = defectData.reduce((sum, d) => sum + (d.defectTotal || 0), 0);
      const uniqueParts = new Set(defectData.map(d => d.partCode)).size;
      const uniqueDates = new Set(defectData.map(d => d.date)).size;
      const avgDefectPerPart = uniqueParts > 0 ? formatDecimal(totalDefects / uniqueParts, 1) : '0';

      // ê³µì •ë³„ ë¶ˆëŸ‰ ì§‘ê³„
      const processDefects = {};
      const processTypes = ['ì¡°ë¦½', 'ë ˆì´ì ¸', 'ì¸ì‡„', 'ë„ì¥', 'ì¦ì°©', 'ë„ê¸ˆ', 'ì‚¬ì¶œ'];
      processTypes.forEach(p => processDefects[p] = 0);

      defectData.forEach(d => {
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0) {
              processTypes.forEach(p => {
                if (key.includes(`(${p})`)) {
                  processDefects[p] += val;
                }
              });
            }
          });
        }
      });

      // í’ˆëª©ë³„ ë¶ˆëŸ‰ ì§‘ê³„
      const partSummary = {};
      defectData.forEach(d => {
        const key = d.partCode;
        if (!partSummary[key]) {
          partSummary[key] = { partCode: d.partCode, partName: d.partName, customerPN: d.customerPN, total: 0, count: 0 };
        }
        partSummary[key].total += d.defectTotal || 0;
        partSummary[key].count++;
      });
      const topParts = Object.values(partSummary).sort((a, b) => b.total - a.total).slice(0, 10);

      // ì¼ë³„ ë¶ˆëŸ‰ ì§‘ê³„
      const dailySummary = {};
      defectData.forEach(d => {
        const date = d.date || 'N/A';
        if (!dailySummary[date]) {
          dailySummary[date] = { date, total: 0, count: 0 };
        }
        dailySummary[date].total += d.defectTotal || 0;
        dailySummary[date].count++;
      });
      const dailyData = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      // ë¶ˆëŸ‰ìœ í˜•ë³„ ì§‘ê³„
      const defectTypeSummary = {};
      defectData.forEach(d => {
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0 && key.includes('(') && key.includes(')')) {
              if (!defectTypeSummary[key]) {
                defectTypeSummary[key] = { type: key, total: 0, count: 0 };
              }
              defectTypeSummary[key].total += val;
              defectTypeSummary[key].count++;
            }
          });
        }
      });
      const topDefectTypes = Object.values(defectTypeSummary).sort((a, b) => b.total - a.total).slice(0, 15);

      // ë¶€í’ˆë³„ ë¶ˆëŸ‰ìœ í˜• ì§‘ê³„ (TOP 10 ë¶€í’ˆì˜ ë¶ˆëŸ‰ìœ í˜• ë¶„ì„)
      const partDefectTypes = {};
      defectData.forEach(d => {
        const partKey = d.partCode;
        if (!partDefectTypes[partKey]) {
          partDefectTypes[partKey] = { partCode: d.partCode, partName: d.partName, defects: {} };
        }
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0 && key.includes('(') && key.includes(')')) {
              if (!partDefectTypes[partKey].defects[key]) {
                partDefectTypes[partKey].defects[key] = 0;
              }
              partDefectTypes[partKey].defects[key] += val;
            }
          });
        }
      });

      // ê° ë¶€í’ˆë³„ë¡œ ì´ ë¶ˆëŸ‰ìˆ˜ëŸ‰ ê³„ì‚° í›„ TOP 10 ì¶”ì¶œ
      const partDefectList = Object.values(partDefectTypes).map(p => {
        const totalDefect = Object.values(p.defects).reduce((sum, v) => sum + v, 0);
        const topTypes = Object.entries(p.defects)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
          .map(([type, count]) => ({ type, count }));
        return { ...p, totalDefect, topTypes };
      }).sort((a, b) => b.totalDefect - a.totalDefect).slice(0, 10);

      return `
        <div class="section-header">
          <div class="section-title">ìì¬ë¶ˆëŸ‰ í˜„í™© ë¶„ì„</div>
          <div class="text-sm text-slate-500">ì´ ${formatNumber(defectData.length)}ê±´ ë°ì´í„° ë¶„ì„</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card red">
            <div class="stat-label">ì´ ë¶ˆëŸ‰ ìˆ˜ëŸ‰</div>
            <div class="stat-value text-red-500">${formatNumber(totalDefects)} EA</div>
            <div class="stat-sub">${uniqueDates}ì¼ê°„ ë°œìƒ</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ë¶ˆëŸ‰ í’ˆëª© ìˆ˜</div>
            <div class="stat-value">${formatNumber(uniqueParts)} ì¢…</div>
            <div class="stat-sub">í’ˆëª©ë‹¹ í‰ê·  ${avgDefectPerPart} EA</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ìµœë‹¤ ë¶ˆëŸ‰ ê³µì •</div>
            <div class="stat-value text-orange-500">${Object.entries(processDefects).sort((a,b) => b[1] - a[1])[0]?.[0] || '-'}</div>
            <div class="stat-sub">${formatNumber(Object.entries(processDefects).sort((a,b) => b[1] - a[1])[0]?.[1] || 0)} EA</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ì´ ë°ì´í„°</div>
            <div class="stat-value">${formatNumber(defectData.length)} ê±´</div>
            <div class="stat-sub">ìƒì„¸ ë¶ˆëŸ‰ ê¸°ë¡</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
          <div class="chart-card">
            <div class="chart-title">ì¼ë³„ ë¶ˆëŸ‰ ì¶”ì´</div>
            <div style="height: 280px;"><canvas id="materialDailyChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ê³µì •ë³„ ë¶ˆëŸ‰ ë¶„í¬</div>
            <div style="height: 280px;"><canvas id="materialProcessChart"></canvas></div>
          </div>
        </div>

        <div class="chart-card mb-6">
          <div class="chart-title">í’ˆëª©ë³„ ë¶ˆëŸ‰ TOP 10</div>
          <div style="height: 300px;"><canvas id="materialPartChart"></canvas></div>
        </div>

        <!-- ë¶ˆëŸ‰ìœ í˜• ë¶„ì„ ì„¹ì…˜ -->
        <div class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-base font-bold text-slate-800">ğŸ” ë¶ˆëŸ‰ìœ í˜•ë³„ ë¶„ì„</h3>
              <button id="toggle-defectType" class="collapse-toggle" onclick="toggleCollapse('defectType')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                ì ‘ê¸°
              </button>
            </div>
            <span class="text-sm text-slate-500">${topDefectTypes.length}ê°œ ë¶ˆëŸ‰ìœ í˜•</span>
          </div>
          <div id="collapse-defectType" class="collapsible-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="chart-card" style="box-shadow: none; border: 1px solid #e2e8f0;">
                <div class="chart-title">ë¶ˆëŸ‰ìœ í˜• TOP 15</div>
                <div style="height: 320px;"><canvas id="defectTypeChart"></canvas></div>
              </div>
              <div>
                <div class="chart-title mb-3">ë¶ˆëŸ‰ìœ í˜• ìˆœìœ„</div>
                <div class="overflow-x-auto">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th class="sortable" data-type="number" data-col="0" style="width: 50px;">ìˆœìœ„</th>
                        <th class="sortable" data-type="string" data-col="1">ë¶ˆëŸ‰ìœ í˜•</th>
                        <th class="text-right sortable" data-type="number" data-col="2">ìˆ˜ëŸ‰</th>
                        <th class="text-right sortable" data-type="number" data-col="3">ë¹„ìœ¨</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${topDefectTypes.map((t, idx) => {
                        const pctVal = totalDefects > 0 ? (t.total / totalDefects) * 100 : 0;
                        return `
                          <tr>
                            <td class="text-center font-bold ${idx < 3 ? 'text-red-500' : 'text-slate-500'}">${idx + 1}</td>
                            <td class="font-medium">${t.type}</td>
                            <td class="text-right text-red-600 font-semibold">${formatNumber(t.total)}</td>
                            <td class="text-right">
                              <div class="flex items-center justify-end gap-2">
                                <div class="w-16 h-2 bg-slate-200 rounded-full overflow-hidden">
                                  <div class="h-full bg-red-400 rounded-full" style="width: ${Math.min(pctVal * 2, 100)}%"></div>
                                </div>
                                <span class="text-sm text-slate-600">${formatPercent(pctVal)}</span>
                              </div>
                            </td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ë¶€í’ˆë³„ ë¶ˆëŸ‰ìœ í˜• ë¶„ì„ -->
        <div class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-base font-bold text-slate-800">ğŸ“¦ ë¶€í’ˆë³„ ë¶ˆëŸ‰ìœ í˜• ë¶„ì„</h3>
              <button id="toggle-partDefectType" class="collapse-toggle" onclick="toggleCollapse('partDefectType')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                ì ‘ê¸°
              </button>
            </div>
            <span class="text-sm text-slate-500">TOP 10 ë¶€í’ˆ</span>
          </div>
          <div id="collapse-partDefectType" class="collapsible-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="chart-card" style="box-shadow: none; border: 1px solid #e2e8f0;">
                <div class="chart-title">ë¶€í’ˆë³„ ë¶ˆëŸ‰ìœ í˜• êµ¬ì„±</div>
                <div style="height: 350px;"><canvas id="partDefectTypeChart"></canvas></div>
              </div>
              <div>
                <div class="chart-title mb-3">ë¶€í’ˆë³„ ì£¼ìš” ë¶ˆëŸ‰ìœ í˜•</div>
                <div class="space-y-3" style="max-height: 350px; overflow-y: auto;">
                  ${partDefectList.map((p, idx) => `
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                      <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                          <span class="w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${idx < 3 ? 'bg-red-100 text-red-600' : 'bg-slate-200 text-slate-600'}">${idx + 1}</span>
                          <span class="font-medium text-sm text-slate-800 truncate" style="max-width: 180px;" title="${p.partName}">${p.partName || p.partCode}</span>
                        </div>
                        <span class="text-red-600 font-bold text-sm">${formatNumber(p.totalDefect)} EA</span>
                      </div>
                      <div class="flex flex-wrap gap-1">
                        ${p.topTypes.map(t => `
                          <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-white border border-slate-200 rounded text-xs">
                            <span class="text-slate-600">${t.type.replace(/\(.*?\)/, '').trim() || t.type}</span>
                            <span class="font-semibold text-red-500">${t.count}</span>
                          </span>
                        `).join('')}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="chart-title">ìƒì„¸ ë°ì´í„°</div>
              <button id="toggle-materialDefect" class="collapse-toggle" onclick="toggleCollapse('materialDefect')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                ì ‘ê¸°
              </button>
            </div>
            <button onclick="downloadMaterialDefectExcel()" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
              ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
          <div id="collapse-materialDefect" class="collapsible-content">
            <div class="overflow-x-auto">
              <table class="data-table">
                <thead>
                  <tr>
                    <th class="sortable" data-type="string" data-col="0">ë¶€í’ˆì½”ë“œ</th>
                    <th class="sortable" data-type="string" data-col="1">ê³ ê°ì‚¬ P/N</th>
                    <th class="sortable" data-type="string" data-col="2">ë¶€í’ˆëª…</th>
                    <th class="sortable" data-type="string" data-col="3">ê·œê²©</th>
                    <th class="sortable" data-type="string" data-col="4">ìƒì‚°ì¼ì</th>
                    <th class="sortable text-right" data-type="number" data-col="5">ë¶ˆëŸ‰í•©ê³„</th>
                  </tr>
                </thead>
                <tbody>
                  ${defectData.slice(0, 100).map(d => `
                    <tr>
                      <td>${d.partCode || '-'}</td>
                      <td>${d.customerPN || '-'}</td>
                      <td>${d.partName || '-'}</td>
                      <td>${d.spec || '-'}</td>
                      <td>${d.date || '-'}</td>
                      <td class="text-right font-medium text-red-600">${formatNumber(d.defectTotal || 0)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${defectData.length > 100 ? `<div class="text-center text-slate-500 text-sm mt-4">ìƒìœ„ 100ê±´ë§Œ í‘œì‹œ (ì „ì²´ ${formatNumber(defectData.length)}ê±´)</div>` : ''}
          </div>
        </div>
      `;
    }

    // í’ˆì§ˆë¶„ì„
    function renderQuality(stats, data) {
      if (!stats) return '<p class="text-center text-slate-500 py-8">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

      // ë¶ˆëŸ‰ê¸ˆì•¡ ê³„ì‚° (ë¶ˆëŸ‰ìˆ˜ëŸ‰ Ã— ë‹¨ê°€)
      const totalDefectCost = data.reduce((sum, d) => {
        const unitCost = getUnitCostByItemName(d.itemName);
        return sum + ((d.defectQty || 0) * unitCost);
      }, 0);

      return `
        <div class="section-header">
          <div class="section-title">í’ˆì§ˆ ë¶„ì„ ë¦¬í¬íŠ¸</div>
          <div class="flex items-center gap-3">
            <select class="filter-select" onchange="setFilter('process', this.value)">
              <option value="all">All</option>
              ${getUniqueValues('process').map(p => `<option value="${p}" ${state.filters.process === p ? 'selected' : ''}>${p}</option>`).join('')}
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card blue">
            <div class="stat-label">í‰ê·  ìˆ˜ìœ¨</div>
            <div class="stat-value text-blue-600">${stats.avgYield}%</div>
            <div class="stat-sub">ì–‘í’ˆ: ${formatNumber(stats.totalGood)} EA</div>
          </div>
          <div class="stat-card red">
            <div class="stat-label">ë¶ˆëŸ‰ ê¸ˆì•¡</div>
            <div class="stat-value text-red-600" style="font-size: 24px;">${formatNumber(totalDefectCost)}</div>
            <div class="stat-sub">ì› (ë¶ˆëŸ‰ ${formatNumber(stats.totalDefect)} EA)</div>
          </div>
          <div class="stat-card red">
            <div class="stat-label">í‰ê·  ë¶ˆëŸ‰ìœ¨</div>
            <div class="stat-value text-red-400">${stats.avgDefectRate}%</div>
            <div class="stat-sub">ë¶ˆëŸ‰: ${formatNumber(stats.totalDefect)} EA</div>
          </div>
          <div class="stat-card red">
            <div class="stat-label">í‰ê·  íê¸°ìœ¨</div>
            <div class="stat-value text-red-400">${stats.avgDisposalRate}%</div>
            <div class="stat-sub">íê¸°: ${formatNumber(stats.totalDisposal)} EA</div>
          </div>
        </div>

        <div class="chart-card mb-6">
          <div class="chart-title">ê³µì •ë³„ í’ˆì§ˆ ì§€í‘œ</div>
          <div style="height: 280px;"><canvas id="qualityChart"></canvas></div>
        </div>

        <!-- í’ˆëª©ë³„ ë¶ˆëŸ‰ìœ¨ ìƒì„¸ ë¦¬ìŠ¤íŠ¸ -->
        ${buildItemDefectList(data)}
      `;
    }

    // ë°ì´í„° í…Œì´ë¸”
    function renderDataTable(data) {
      const fields = getDetailFields();
      const numericFields = ['ìƒì‚°ìˆ˜ëŸ‰', 'ì–‘í’ˆìˆ˜ëŸ‰', 'ë¶ˆëŸ‰ìˆ˜ëŸ‰', 'íê¸°ìˆ˜ëŸ‰', 'ì‘ì—…ì‹œê°„(ë¶„)', 'ì‘ì—…ì¸ì›', 'UPH', 'UPPH'];
      const categoryFields = ['ê³µì •', 'í’ˆì¢…', 'ê³ ê°ì‚¬', 'ì„¤ë¹„(ë¼ì¸)ëª…', 'í’ˆëª©ëª…', 'ìƒì‚°ì¼ì', 'ê²€ì‚¬ìœ í˜•', 'ì¡°ë‹¬êµ¬ë¶„', 'ì‘ì—…ì', 'ì¬ì§ˆì½”ë“œ1'];

      // í”¼ë´‡ í…Œì´ë¸” ìƒì„±
      const pivotResult = state.detailData.length > 0
        ? generatePivotTable(state.detailData, state.pivot.rows, state.pivot.cols, state.pivot.values, state.pivot.aggFunc)
        : null;

      return `
        <div class="section-header">
          <div class="section-title">ìƒì„¸ ë°ì´í„° ì¡°íšŒ (í”¼ë´‡)</div>
          <div class="flex items-center gap-3">
            <select class="filter-select" style="background: #f1f5f9; border-color: #cbd5e1; font-weight: 500;" onchange="setSelectedMonth(this.value)">
              ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}ì›”</option>`).join('')}
            </select>
            ${state.detailData.length > 0 ? `
              <button onclick="downloadPivotExcel()" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
              </button>
              <button onclick="clearDetailData()" class="px-4 py-2 bg-slate-100 hover:bg-rose-100 text-slate-600 hover:text-rose-600 text-sm font-medium rounded-lg transition-colors">ì´ˆê¸°í™”</button>
            ` : ''}
          </div>
        </div>

        ${state.detailData.length === 0 ? `
          <div class="card text-center py-16">
            <div class="text-6xl mb-4">ğŸ“Š</div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">ì—…ì¢…ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-slate-500 mb-6">í”¼ë´‡ ë¶„ì„ì„ ìœ„í•´ ì—…ì¢…ë³„ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              ğŸ“¤ íŒŒì¼ì—…ë¡œë“œ í˜ì´ì§€ë¡œ ì´ë™
            </button>
          </div>
        ` : `
          <!-- í”¼ë´‡ ì„¤ì • -->
          <div class="card mb-4">
            <div class="flex flex-wrap items-center gap-4">
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-slate-600">í–‰:</span>
                <select class="filter-select text-sm" onchange="setPivotConfig('rows', this.value)">
                  ${categoryFields.map(f => `<option value="${f}" ${state.pivot.rows === f ? 'selected' : ''}>${f}</option>`).join('')}
                </select>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-slate-600">ì—´:</span>
                <select class="filter-select text-sm" onchange="setPivotConfig('cols', this.value)">
                  ${categoryFields.map(f => `<option value="${f}" ${state.pivot.cols === f ? 'selected' : ''}>${f}</option>`).join('')}
                </select>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-slate-600">ê°’:</span>
                <select class="filter-select text-sm" onchange="setPivotConfig('values', this.value)">
                  ${numericFields.map(f => `<option value="${f}" ${state.pivot.values === f ? 'selected' : ''}>${f}</option>`).join('')}
                </select>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-slate-600">ì§‘ê³„:</span>
                <select class="filter-select text-sm" onchange="setPivotConfig('aggFunc', this.value)">
                  <option value="sum" ${state.pivot.aggFunc === 'sum' ? 'selected' : ''}>í•©ê³„</option>
                  <option value="count" ${state.pivot.aggFunc === 'count' ? 'selected' : ''}>ê°œìˆ˜</option>
                  <option value="avg" ${state.pivot.aggFunc === 'avg' ? 'selected' : ''}>í‰ê· </option>
                </select>
              </div>
              <span class="text-sm text-slate-400 ml-auto">ì´ ${state.detailData.length.toLocaleString()}ê±´</span>
            </div>
          </div>

          <!-- í”¼ë´‡ í…Œì´ë¸” -->
          <div class="card">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <h3 class="text-base font-bold text-slate-800">í”¼ë´‡ í…Œì´ë¸” ê²°ê³¼</h3>
                <button id="toggle-pivot" class="collapse-toggle" onclick="toggleCollapse('pivot')">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                  ì ‘ê¸°
                </button>
              </div>
            </div>
            <div id="collapse-pivot" class="collapsible-content">
              <div class="overflow-x-auto">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th class="sortable bg-slate-100 font-bold" data-type="string" data-col="0">${state.pivot.rows} \\ ${state.pivot.cols}</th>
                      ${pivotResult.cols.map((c, idx) => `<th class="sortable text-right bg-slate-50" data-type="number" data-col="${idx + 1}">${c}</th>`).join('')}
                      <th class="sortable text-right bg-blue-50 text-blue-700 font-bold" data-type="number" data-col="${pivotResult.cols.length + 1}">í•©ê³„</th>
                    </tr>
                  </thead>
                <tbody>
                  ${pivotResult.rows.map(r => `
                    <tr>
                      <td class="font-medium bg-slate-50">${r}</td>
                      ${pivotResult.cols.map(c => {
                        const val = pivotResult.getValue(pivotResult.values[r][c]);
                        return `<td class="text-right">${formatNumber(Math.round(val))}</td>`;
                      }).join('')}
                      <td class="text-right bg-blue-50 text-blue-700 font-bold">${formatNumber(Math.round(pivotResult.getValue(pivotResult.rowTotals[r])))}</td>
                    </tr>
                  `).join('')}
                </tbody>
                <tfoot>
                  <tr class="bg-slate-100 font-bold">
                    <td>í•©ê³„</td>
                    ${pivotResult.cols.map(c => `<td class="text-right">${formatNumber(Math.round(pivotResult.getValue(pivotResult.colTotals[c])))}</td>`).join('')}
                    <td class="text-right bg-blue-100 text-blue-800">${formatNumber(Math.round(state.pivot.aggFunc === 'count' ? pivotResult.grandTotal : (state.pivot.aggFunc === 'avg' ? pivotResult.grandTotal / state.detailData.length : pivotResult.grandTotal)))}</td>
                  </tr>
                </tfoot>
                </table>
              </div>
            </div>
          </div>
        `}
      `;
    }

    // ìƒì„¸ ë°ì´í„° ì´ˆê¸°í™”
    function clearDetailData() {
      if (confirm('ìƒì„¸ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem(DETAIL_DATA_KEY);
        state.detailData = [];
        render();
      }
    }

    // ì°¨íŠ¸ ìƒì„±
    function createCharts() {
      console.log('=== createCharts started ===');
      try {
      destroyCharts();
      const filteredData = getFilteredData();  // ì›”ë³„ ë°ì´í„°
      const yearlyData = getYearlyData();      // ë…„ê°„ ë°ì´í„° (ì›” í•„í„° ì œì™¸)

      // Chart.js ê¸€ë¡œë²Œ ì„¤ì • - Apple ìŠ¤íƒ€ì¼
      Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, SF Pro Display, sans-serif';
      Chart.defaults.color = '#6b7280';

      // ì°¨íŠ¸ íˆ´íŒ ìˆ«ì í¬ë§·íŒ… (ì²œë‹¨ìœ„ ì½¤ë§ˆ)
      Chart.defaults.plugins.tooltip.callbacks.label = function(context) {
        let label = context.dataset.label || '';
        if (label) label += ': ';
        if (context.parsed.y !== null && context.parsed.y !== undefined) {
          label += formatNumber(context.parsed.y);
        } else if (context.parsed !== null && context.parsed !== undefined) {
          label += formatNumber(context.parsed);
        }
        return label;
      };

      // ë°ì´í„° ë¼ë²¨ í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
      Chart.register(ChartDataLabels);

      // ê³µí†µ ë°ì´í„°ë¼ë²¨ ì˜µì…˜
      const dataLabelOptions = {
        anchor: 'end',
        align: 'end',
        color: '#374151',
        font: { size: 11, weight: '600' },
        formatter: (value) => formatCompact(value),
        padding: 4
      };

      // OEE ì°¨íŠ¸ (ë§‰ëŒ€: 3ëŒ€ ì§€í‘œ, êº¾ì€ì„ : OEE ë³´ì¡°ì¶•) - ì›”ë³„ ë°ì´í„° ì—†ìœ¼ë©´ ë…„ê°„ ë°ì´í„° ì‚¬ìš©
      const oeeCanvas = document.getElementById('oeeChart');
      if (oeeCanvas) {
        const monthlyOeeForChart = getOEEData(filteredData);
        const yearlyOeeForChart = getOEEData(yearlyData);
        const oeeData = monthlyOeeForChart.length > 0 ? monthlyOeeForChart : yearlyOeeForChart;
        charts.oee = new Chart(oeeCanvas, {
          type: 'bar',
          data: {
            labels: oeeData.map(d => d.process),
            datasets: [
              { label: 'ì‹œê°„ê°€ë™ìœ¨', data: oeeData.map(d => parseFloat(d.availability)), backgroundColor: '#e2e8f0', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'ì„±ëŠ¥ê°€ë™ìœ¨', data: oeeData.map(d => parseFloat(d.performance)), backgroundColor: '#cbd5e1', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'ì–‘í’ˆìœ¨', data: oeeData.map(d => parseFloat(d.quality)), backgroundColor: '#bfdbfe', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'OEE', data: oeeData.map(d => parseFloat(d.oee)), type: 'line', borderColor: '#fca5a5', borderWidth: 3, fill: false, pointRadius: 8, pointBackgroundColor: '#fca5a5', pointBorderColor: '#fff', pointBorderWidth: 2, tension: 0.3, yAxisID: 'y1', order: 1 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 40, right: 10 } },
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
              datalabels: {
                anchor: 'end',
                align: 'top',
                offset: 2,
                color: '#64748b',
                font: { size: 9, weight: '600' },
                formatter: (value) => formatPercent(value),
                display: (ctx) => ctx.datasetIndex !== 3
              }
            },
            scales: {
              y: { type: 'linear', position: 'left', beginAtZero: true, max: 120, grid: { color: '#f3f4f6' }, ticks: { callback: (v) => formatPercent(v) }, title: { display: true, text: 'ê°€ë™ìœ¨/ì–‘í’ˆìœ¨', color: '#64748b', font: { size: 11 } } },
              y1: { type: 'linear', position: 'right', beginAtZero: true, max: 100, grid: { display: false }, ticks: { callback: (v) => formatPercent(v), color: '#fca5a5' }, title: { display: true, text: 'OEE', color: '#fca5a5', font: { size: 11, weight: 'bold' } } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // ì›”ë³„ OEE ì°¨íŠ¸ (ë§‰ëŒ€: 3ëŒ€ ì§€í‘œ, êº¾ì€ì„ : OEE ë³´ì¡°ì¶•) - ë…„ê°„ ë°ì´í„° ì‚¬ìš©
      const monthlyOeeCanvas = document.getElementById('monthlyOeeChart');
      if (monthlyOeeCanvas) {
        const monthlyData = getMonthlyOEEData(yearlyData);  // ë…„ê°„ ë°ì´í„°ë¡œ ì›”ë³„ ì¶”ì´ í‘œì‹œ
        charts.monthlyOee = new Chart(monthlyOeeCanvas, {
          type: 'bar',
          data: {
            labels: monthlyData.map(d => d.label),
            datasets: [
              { label: 'ì‹œê°„ê°€ë™ìœ¨', data: monthlyData.map(d => d.availability !== null ? parseFloat(d.availability) : null), backgroundColor: '#e2e8f0', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'ì„±ëŠ¥ê°€ë™ìœ¨', data: monthlyData.map(d => d.performance !== null ? parseFloat(d.performance) : null), backgroundColor: '#cbd5e1', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'ì–‘í’ˆìœ¨', data: monthlyData.map(d => d.quality !== null ? parseFloat(d.quality) : null), backgroundColor: '#bfdbfe', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'OEE (%)', data: monthlyData.map(d => d.oee !== null ? parseFloat(d.oee) : null), type: 'line', borderColor: '#fca5a5', borderWidth: 3, fill: false, pointRadius: 8, pointBackgroundColor: '#fca5a5', pointBorderColor: '#fff', pointBorderWidth: 2, tension: 0.3, yAxisID: 'y1', order: 1 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 40, right: 10 } },
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
              datalabels: {
                anchor: 'end',
                align: 'top',
                offset: 4,
                color: '#fca5a5',
                font: { size: 11, weight: 'bold' },
                formatter: (value, ctx) => value !== null ? formatPercent(value) : '',
                display: (ctx) => ctx.datasetIndex === 3 && ctx.dataset.data[ctx.dataIndex] !== null
              }
            },
            scales: {
              y: { type: 'linear', position: 'left', beginAtZero: true, max: 120, grid: { color: '#f3f4f6' }, ticks: { callback: (v) => formatPercent(v) }, title: { display: true, text: 'ê°€ë™ìœ¨/ì–‘í’ˆìœ¨ (%)', color: '#64748b', font: { size: 11 } } },
              y1: { type: 'linear', position: 'right', beginAtZero: true, max: 100, grid: { display: false }, ticks: { callback: (v) => formatPercent(v), color: '#fca5a5' }, title: { display: true, text: 'OEE (%)', color: '#fca5a5', font: { size: 11, weight: 'bold' } } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // í’ˆì§ˆ ì°¨íŠ¸
      const qualityCanvas = document.getElementById('qualityChart');
      if (qualityCanvas) {
        const processData = getProcessData(filteredData);
        charts.quality = new Chart(qualityCanvas, {
          type: 'bar',
          data: {
            labels: processData.map(d => d.process),
            datasets: [
              { label: 'ë¶ˆëŸ‰', data: processData.map(d => d.defect), backgroundColor: '#fecaca', borderRadius: 4, yAxisID: 'y' },
              { label: 'íê¸°', data: processData.map(d => d.disposal), backgroundColor: '#fde8e8', borderRadius: 4, yAxisID: 'y' },
              { label: 'ìˆ˜ìœ¨(%)', data: processData.map(d => parseFloat(d.yieldRate)), type: 'line', borderColor: '#93c5fd', borderWidth: 3, fill: false, yAxisID: 'y1', pointRadius: 5, pointBackgroundColor: '#93c5fd', pointBorderColor: '#fff', pointBorderWidth: 2 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 30 } },
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
              datalabels: {
                anchor: 'end',
                align: 'end',
                color: '#374151',
                font: { size: 10, weight: '600' },
                formatter: (value, ctx) => ctx.dataset.label === 'ìˆ˜ìœ¨(%)' ? formatPercent(value) : formatCompact(value)
              }
            },
            scales: {
              y: { beginAtZero: true, position: 'left', grid: { color: '#f3f4f6' }, ticks: { callback: v => formatNumber(v) } },
              y1: { beginAtZero: false, min: 80, max: 100, position: 'right', grid: { drawOnChartArea: false } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // ê³µì • ìƒì„¸ ì°¨íŠ¸ë“¤
      if (state.activeProcess) {
        const processName = processDataMapping[state.activeProcess];
        const processFilteredData = filteredData.filter(d => d.process === processName);
        const processInfo = processMenus.find(p => p.id === state.activeProcess);
        const dailyData = getDailyData(processFilteredData);

        // ì„¤ë¹„ë³„ ì§‘ê³„
        const equipmentData = {};
        processFilteredData.forEach(row => {
          if (!equipmentData[row.equipment]) {
            equipmentData[row.equipment] = { equipment: row.equipment, production: 0, good: 0, defect: 0 };
          }
          equipmentData[row.equipment].production += row.productionQty;
          equipmentData[row.equipment].good += row.goodQty;
          equipmentData[row.equipment].defect += row.defectQty;
        });
        const equipments = Object.values(equipmentData);

        // ì¼ë³„ ì°¨íŠ¸
        const processDetailDailyCanvas = document.getElementById('processDetailDailyChart');
        if (processDetailDailyCanvas) {
          charts.processDetailDaily = new Chart(processDetailDailyCanvas, {
            type: 'bar',
            data: {
              labels: dailyData.map(d => d.date.slice(5)),
              datasets: [
                { label: 'ìƒì‚°', data: dailyData.map(d => d.production), backgroundColor: '#bfdbfe', borderRadius: 4, barPercentage: 0.6 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 25 } },
              plugins: {
                legend: { display: false },
                datalabels: {
                  anchor: 'end',
                  align: 'end',
                  color: '#374151',
                  font: { size: 10, weight: '600' },
                  formatter: (value) => formatCompact(value),
                  display: (ctx) => ctx.dataIndex % 2 === 0
                }
              },
              scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { callback: (v) => formatCompact(v) } },
                x: { grid: { display: false } }
              }
            }
          });
        }

        // ì„¤ë¹„ë³„ ì°¨íŠ¸ - ì „ì²´ ì„¤ë¹„ (1í˜¸ê¸°~ìˆœ ì •ë ¬) + ìˆ˜ìœ¨ ë¼ì¸
        const processDetailEquipmentCanvas = document.getElementById('processDetailEquipmentChart');
        if (processDetailEquipmentCanvas) {
          // ì „ì²´ ì„¤ë¹„ (1í˜¸ê¸°~ìˆœ ì •ë ¬)
          const sortedEquipments = sortEquipments(equipments);
          const equipLabels = sortedEquipments.map(e => e.equipment.replace(/_.*/, ''));
          const yieldRates = sortedEquipments.map(e => (e.good / e.production * 100).toFixed(1));

          charts.processDetailEquipment = new Chart(processDetailEquipmentCanvas, {
            type: 'bar',
            data: {
              labels: equipLabels,
              datasets: [
                {
                  label: 'ì–‘í’ˆ',
                  data: sortedEquipments.map(e => e.good),
                  backgroundColor: '#93c5fd',
                  borderRadius: 4,
                  barPercentage: 0.8,
                  yAxisID: 'y'
                },
                {
                  label: 'ìˆ˜ìœ¨(%)',
                  data: yieldRates,
                  type: 'line',
                  borderColor: '#fca5a5',
                  backgroundColor: '#fca5a5',
                  borderWidth: 2,
                  pointRadius: 3,
                  pointBackgroundColor: '#fff',
                  pointBorderWidth: 2,
                  tension: 0.3,
                  yAxisID: 'y1'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 20 } },
              plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
                datalabels: {
                  display: (ctx) => ctx.datasetIndex === 1,
                  anchor: 'end',
                  align: 'top',
                  offset: 4,
                  color: '#dc2626',
                  font: { size: 9, weight: '600' },
                  formatter: (value) => formatPercent(value)
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: '#f3f4f6' },
                  ticks: { callback: (v) => formatCompact(v) },
                  title: { display: true, text: 'ì–‘í’ˆìˆ˜ëŸ‰', font: { size: 11 }, color: '#64748b' }
                },
                y1: {
                  position: 'right',
                  min: 80,
                  max: 100,
                  grid: { display: false },
                  ticks: { callback: (v) => formatPercent(v) },
                  title: { display: true, text: 'ìˆ˜ìœ¨', font: { size: 11 }, color: '#fca5a5' }
                },
                x: { grid: { display: false }, ticks: { font: { size: 10 } } }
              }
            }
          });
        }

        // UPH ì°¨íŠ¸
        const uphCanvas = document.getElementById('uphChart');
        if (uphCanvas) {
          charts.uph = new Chart(uphCanvas, {
            type: 'bar',
            data: {
              labels: dailyData.map(d => d.date.slice(5)),
              datasets: [
                { label: 'UPH', data: dailyData.map(d => Math.round(d.production / 8)), backgroundColor: '#bfdbfe', borderRadius: 4, barPercentage: 0.6 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 30 } },
              plugins: {
                legend: { display: false },
                datalabels: {
                  ...dataLabelOptions,
                  display: (ctx) => ctx.dataIndex % 2 === 0
                }
              },
              scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { callback: (v) => formatCompact(v) } },
                x: { grid: { display: false } }
              }
            }
          });
        }

        // Cycle Time ì°¨íŠ¸ - CT í˜„í™© ë°ì´í„° ê¸°ë°˜ (ì„¤ë¹„ë³„ í‘œì¤€ CT ëŒ€ë¹„ ì‹¤ì  ë¹„êµ)
        const cycleTimeCanvas = document.getElementById('cycleTimeChart');
        if (cycleTimeCanvas) {
          // CT ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
          let ctChartData = [];
          const currentProcessId = state.activeProcess;
          const currentProcessName = processDataMapping[currentProcessId] || currentProcessId;

          if (state.ctData && state.ctData.length > 0) {
            // í˜„ì¬ ê³µì •ì— ë§ëŠ” CT ë°ì´í„° í•„í„°ë§ (ìœ ì—°í•œ ë§¤ì¹­)
            const filteredCT = filterCTByProcess(state.ctData, currentProcessName);

            // ì„¤ë¹„ë³„ë¡œ ê·¸ë£¹í•‘í•˜ì—¬ í‰ê·  ê³„ì‚° (ì „ì²´ ì„¤ë¹„ëª… ìœ ì§€)
            const equipmentMap = {};
            filteredCT.forEach(d => {
              // ì „ì²´ ì„¤ë¹„ëª… ì‚¬ìš© (ì˜ˆ: ë„ì¥_X,Y_1í˜¸ê¸°, ë„ì¥_SPINDLE_2í˜¸ê¸°)
              const equipName = d.equipment;
              if (!equipmentMap[equipName]) {
                equipmentMap[equipName] = { standardCT: [], actualCT: [], efficiency: [], count: 0 };
              }
              if (d.standardCT > 0) equipmentMap[equipName].standardCT.push(d.standardCT);
              if (d.actualCT > 0) equipmentMap[equipName].actualCT.push(d.actualCT);
              if (d.efficiency > 0) equipmentMap[equipName].efficiency.push(d.efficiency);
              equipmentMap[equipName].count++;
            });

            // ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  í˜¸ê¸°ìˆœ ì •ë ¬
            ctChartData = Object.entries(equipmentMap).map(([name, data]) => ({
              equipment: name,
              standardCT: data.standardCT.length > 0 ? (data.standardCT.reduce((a,b) => a+b, 0) / data.standardCT.length) : 0,
              actualCT: data.actualCT.length > 0 ? (data.actualCT.reduce((a,b) => a+b, 0) / data.actualCT.length) : 0,
              efficiency: data.efficiency.length > 0 ? (data.efficiency.reduce((a,b) => a+b, 0) / data.efficiency.length) : 0
            })).filter(d => d.actualCT > 0).sort((a, b) => {
              // í˜¸ê¸° ë²ˆí˜¸ ì¶”ì¶œí•˜ì—¬ ì •ë ¬
              const numA = parseInt(a.equipment.match(/(\d+)í˜¸ê¸°/)?.[1] || '999');
              const numB = parseInt(b.equipment.match(/(\d+)í˜¸ê¸°/)?.[1] || '999');
              return numA - numB;
            });
          }

          // CT ë°ì´í„°ê°€ ì „í˜€ ì—†ì„ ë•Œë§Œ ë”ë¯¸ ë°ì´í„° ì‚¬ìš© (ì—…ë¡œë“œí–ˆëŠ”ë° í•´ë‹¹ ê³µì • ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì°¨íŠ¸ ì•ˆê·¸ë¦¼)
          if (ctChartData.length === 0 && (!state.ctData || state.ctData.length === 0)) {
            const ctSortedEquipments = sortEquipments(equipments);
            ctChartData = ctSortedEquipments.map(e => {
              const stdCT = 11 + Math.random() * 2;
              const actCT = stdCT - 0.5 + Math.random() * 1.5;
              return {
                equipment: e.equipment,  // ì „ì²´ ì„¤ë¹„ëª… ì‚¬ìš©
                standardCT: stdCT,
                actualCT: actCT,
                efficiency: (stdCT / actCT * 100)
              };
            });
          }

          // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì°¨íŠ¸ ê·¸ë¦¬ì§€ ì•ŠìŒ
          if (ctChartData.length === 0) return;

          const ctLabels = ctChartData.map(d => d.equipment);
          const standardCTData = ctChartData.map(d => d.standardCT.toFixed(1));
          const actualCTData = ctChartData.map(d => d.actualCT.toFixed(1));
          const efficiencyData = ctChartData.map(d => d.efficiency.toFixed(1));
          // íš¨ìœ¨ 100% ë¯¸ë§Œ(ì‹¤ì œCTê°€ í‘œì¤€ë³´ë‹¤ í° ê²½ìš°) = ë¹¨ê°•, 100% ì´ìƒ = íŒŒë‘
          const ctColors = efficiencyData.map(eff => parseFloat(eff) < 100 ? 'rgba(252, 165, 165, 0.7)' : 'rgba(147, 197, 253, 0.7)');

          charts.cycleTime = new Chart(cycleTimeCanvas, {
            type: 'bar',
            data: {
              labels: ctLabels,
              datasets: [
                {
                  label: 'ì‹¤ì œ CT',
                  data: actualCTData,
                  backgroundColor: ctColors,
                  borderColor: efficiencyData.map(eff => parseFloat(eff) < 100 ? '#fca5a5' : '#93c5fd'),
                  borderWidth: 1,
                  borderRadius: 4,
                  barPercentage: 0.75
                },
                {
                  label: 'í‘œì¤€ CT',
                  data: standardCTData,
                  type: 'line',
                  borderColor: '#94a3b8',
                  backgroundColor: '#94a3b8',
                  borderWidth: 2,
                  pointRadius: 4,
                  pointStyle: 'rectRot',
                  pointBackgroundColor: '#fff',
                  pointBorderWidth: 2,
                  fill: false
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 25 } },
              plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
                datalabels: {
                  display: true,
                  anchor: (ctx) => ctx.datasetIndex === 0 ? 'end' : 'end',
                  align: (ctx) => ctx.datasetIndex === 0 ? 'top' : 'bottom',
                  offset: (ctx) => ctx.datasetIndex === 0 ? 2 : -2,
                  color: (ctx) => {
                    if (ctx.datasetIndex === 0) {
                      return parseFloat(efficiencyData[ctx.dataIndex]) < 100 ? '#dc2626' : '#059669';
                    }
                    return '#94a3b8';
                  },
                  font: { size: 9, weight: '600' },
                  formatter: (value, ctx) => {
                    if (ctx.datasetIndex === 0) {
                      return formatPercent(parseFloat(efficiencyData[ctx.dataIndex]));
                    }
                    return parseFloat(value) > 0 ? formatDecimal(value, 1) + 's' : '';
                  },
                  backgroundColor: (ctx) => ctx.datasetIndex === 1 ? 'rgba(255,255,255,0.8)' : 'transparent',
                  borderRadius: 3,
                  padding: (ctx) => ctx.datasetIndex === 1 ? { left: 3, right: 3, top: 1, bottom: 1 } : 0
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  grid: { color: '#f3f4f6' },
                  ticks: { callback: (v) => v + 's' },
                  title: { display: true, text: 'Cycle Time (ì´ˆ)', font: { size: 11 }, color: '#64748b' }
                },
                x: { grid: { display: false }, ticks: { font: { size: 9 } } }
              }
            }
          });
        }

        // ê²€í¬ì¥ ì°¨íŠ¸
        const packagingCanvas = document.getElementById('packagingChart');
        if (packagingCanvas) {
          charts.packaging = new Chart(packagingCanvas, {
            type: 'bar',
            data: {
              labels: dailyData.map(d => d.date.slice(5)),
              datasets: [
                { label: 'ê²€ì‚¬ì™„ë£Œ', data: dailyData.map(d => d.good), backgroundColor: '#e2e8f0', borderRadius: 4, barPercentage: 0.6 },
                { label: 'í¬ì¥ì™„ë£Œ', data: dailyData.map(d => Math.round(d.good * 0.98)), backgroundColor: '#bfdbfe', borderRadius: 4, barPercentage: 0.6 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 30 } },
              plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
                datalabels: {
                  ...dataLabelOptions,
                  display: (ctx) => ctx.datasetIndex === 0 && ctx.dataIndex % 3 === 0
                }
              },
              scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { callback: (v) => formatCompact(v) } },
                x: { grid: { display: false } }
              }
            }
          });
        }

        // ë¶ˆëŸ‰ìˆ˜ë¦¬ ì°¨íŠ¸
        const defectRepairCanvas = document.getElementById('defectRepairChart');
        if (defectRepairCanvas) {
          const defectTypes = ['ì™¸ê´€ë¶ˆëŸ‰', 'ì¹˜ìˆ˜ë¶ˆëŸ‰', 'ê¸°ëŠ¥ë¶ˆëŸ‰', 'ì¡°ë¦½ë¶ˆëŸ‰', 'ê¸°íƒ€'];
          charts.defectRepair = new Chart(defectRepairCanvas, {
            type: 'bar',
            data: {
              labels: defectTypes,
              datasets: [
                { label: 'ë°œìƒ', data: defectTypes.map(() => Math.round(Math.random() * 100 + 50)), backgroundColor: '#fecaca', borderRadius: 4 },
                { label: 'ìˆ˜ë¦¬ì™„ë£Œ', data: defectTypes.map(() => Math.round(Math.random() * 80 + 30)), backgroundColor: '#bfdbfe', borderRadius: 4 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 30 } },
              plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
                datalabels: dataLabelOptions
              },
              scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { callback: v => formatNumber(v) } },
                x: { grid: { display: false } }
              }
            }
          });
        }

        // ìì¬ë¶ˆëŸ‰ ì°¨íŠ¸
        const materialDefectCanvas = document.getElementById('materialDefectChart');
        if (materialDefectCanvas) {
          const materials = ['PCB', 'ì»¤ë„¥í„°', 'í•˜ìš°ì§•', 'ì¼€ì´ë¸”', 'ê¸°íƒ€'];
          charts.materialDefect = new Chart(materialDefectCanvas, {
            type: 'bar',
            data: {
              labels: materials,
              datasets: [
                { label: 'ë¶ˆëŸ‰ê±´ìˆ˜', data: materials.map(() => Math.round(Math.random() * 30 + 10)), backgroundColor: '#fecaca', borderRadius: 4 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 30 } },
              plugins: {
                legend: { display: false },
                datalabels: dataLabelOptions
              },
              scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { callback: v => formatNumber(v) } },
                x: { grid: { display: false } }
              }
            }
          });
        }
      }

      // ë¹„ê°€ë™í˜„í™© ì°¨íŠ¸ - if (state.activeProcess) ë¸”ë¡ ë°–ì—ì„œ ì‹¤í–‰
      console.log('=== About to create downtime charts ===');

        // ë¹„ê°€ë™í˜„í™© ì°¨íŠ¸ë“¤
        // ê³µì •ë³„ ë¹„ê°€ë™ì‹œê°„ ì°¨íŠ¸
        const downtimeByProcessCanvas = document.getElementById('downtimeByProcessChart');
        console.log('Downtime chart canvas:', downtimeByProcessCanvas, 'Data length:', state.availabilityData.length);
        if (downtimeByProcessCanvas && state.availabilityData.length > 0) {
          try {
          if (charts.downtimeByProcess) charts.downtimeByProcess.destroy();
          const downtimeData = state.availabilityData.map(d => ({
            ...d,
            downtimeMinutes: d.operatingTime - d.runningTime
          }));

          const processSummary = {};
          downtimeData.forEach(d => {
            if (excludedProcesses.includes(d.process)) return;
            if (!processSummary[d.process]) {
              processSummary[d.process] = { totalDowntime: 0, totalOperating: 0 };
            }
            processSummary[d.process].totalDowntime += d.downtimeMinutes;
            processSummary[d.process].totalOperating += d.operatingTime;
          });

          const processLabels = Object.keys(processSummary);
          console.log('Process Labels:', processLabels, 'Process Summary:', processSummary);
          const processColors = {
            'ì‚¬ì¶œ': '#fdba74', 'ë„ì¥': '#7dd3fc', 'ì¸ì‡„': '#fcd34d', 'ì¡°ë¦½': '#c4b5fd'
          };

          if (processLabels.length === 0) {
            console.warn('No process labels found for downtime chart');
          }

          charts.downtimeByProcess = new Chart(downtimeByProcessCanvas, {
            type: 'bar',
            data: {
              labels: processLabels,
              datasets: [
                {
                  label: 'ë¹„ê°€ë™ì‹œê°„(h)',
                  data: processLabels.map(p => parseFloat((processSummary[p].totalDowntime / 60).toFixed(1))),
                  backgroundColor: processLabels.map(p => processColors[p] || '#94a3b8'),
                  borderRadius: 6,
                  barPercentage: 0.6,
                  datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: '#374151',
                    font: { size: 12, weight: '600' },
                    formatter: (value) => formatDecimal(value, 1) + 'h'
                  }
                },
                {
                  label: 'ë¹„ê°€ë™ìœ¨(%)',
                  data: processLabels.map(p => parseFloat((processSummary[p].totalDowntime / processSummary[p].totalOperating * 100).toFixed(1))),
                  type: 'line',
                  borderColor: '#f87171',
                  backgroundColor: '#f87171',
                  borderWidth: 3,
                  pointRadius: 8,
                  pointBackgroundColor: '#fff',
                  pointBorderWidth: 3,
                  fill: false,
                  yAxisID: 'y1',
                  datalabels: {
                    anchor: 'end',
                    align: 'top',
                    offset: 8,
                    color: '#dc2626',
                    font: { size: 12, weight: 'bold' },
                    formatter: (value) => formatDecimal(value, 1) + '%',
                    backgroundColor: 'rgba(255, 255, 255, 0.85)',
                    borderRadius: 4,
                    padding: { top: 4, bottom: 4, left: 6, right: 6 }
                  }
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 40 } },
              plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 } },
                datalabels: {
                  display: true
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  position: 'left',
                  grid: { color: '#f3f4f6' },
                  ticks: { callback: (v) => formatNumber(v) },
                  title: { display: true, text: 'ë¹„ê°€ë™ì‹œê°„ (h)', font: { size: 10 }, color: '#64748b' }
                },
                y1: {
                  beginAtZero: true,
                  position: 'right',
                  grid: { display: false },
                  max: 50,
                  title: { display: true, text: 'ë¹„ê°€ë™ìœ¨ (%)', font: { size: 10 }, color: '#fca5a5' },
                  ticks: { callback: (v) => formatPercent(v) }
                },
                x: { grid: { display: false } }
              }
            }
          });
          console.log('Downtime by process chart created successfully');
          } catch (e) {
            console.error('Error creating downtime by process chart:', e);
          }
        }

        // ì„¤ë¹„ë³„ ë¹„ê°€ë™ TOP 10 ì°¨íŠ¸ (ìœ í˜•ë³„ ìŠ¤íƒ)
        const downtimeByEquipmentCanvas = document.getElementById('downtimeByEquipmentChart');
        console.log('Equipment chart canvas:', downtimeByEquipmentCanvas);
        if (downtimeByEquipmentCanvas && state.availabilityData.length > 0) {
          try {
          if (charts.downtimeByEquipment) charts.downtimeByEquipment.destroy();

          // ì„¤ë¹„ë³„ ë¹„ê°€ë™ ìœ í˜•ë³„ í•©ê³„ ê³„ì‚°
          const equipmentDowntime = {};
          state.availabilityData.forEach(d => {
            if (excludedProcesses.includes(d.process)) return;
            const key = `${d.process}_${d.equipment}`;
            if (!equipmentDowntime[key]) {
              equipmentDowntime[key] = {
                process: d.process,
                equipment: d.equipment,
                totalDowntime: 0,
                totalOperating: 0,
                // ë¹„ê°€ë™ ìœ í˜•ë³„ í•©ê³„
                moldChange: 0,      // ê¸ˆí˜•êµí™˜
                setupWait: 0,       // ì¡°ê±´ì„¤ì •ëŒ€ê¸°
                setup: 0,           // ì¡°ê±´ì„¤ì •
                materialChange: 0,  // ì›ë£Œêµí™˜/ê±´ì¡°
                breakdown: 0,       // ê³ ì¥
                waiting: 0,         // ëŒ€ê¸°
                maintenance: 0,     // ì •ë¹„
                other: 0            // ê¸°íƒ€
              };
            }
            equipmentDowntime[key].totalDowntime += (d.operatingTime - d.runningTime);
            equipmentDowntime[key].totalOperating += d.operatingTime;

            // ë¹„ê°€ë™ ìœ í˜•ë³„ í•©ì‚° (CSVì—ì„œ íŒŒì‹±ëœ ë°ì´í„° ì‚¬ìš©)
            if (d.downtimeByType) {
              equipmentDowntime[key].moldChange += d.downtimeByType.moldChange || 0;
              equipmentDowntime[key].setupWait += d.downtimeByType.setupWait || 0;
              equipmentDowntime[key].setup += d.downtimeByType.setup || 0;
              equipmentDowntime[key].materialChange += d.downtimeByType.materialChange || 0;
              equipmentDowntime[key].breakdown += d.downtimeByType.breakdown || 0;
              equipmentDowntime[key].waiting += d.downtimeByType.waiting || 0;
              equipmentDowntime[key].maintenance += d.downtimeByType.maintenance || 0;
              equipmentDowntime[key].other += d.downtimeByType.other || 0;
            }
          });

          const topEquipment = Object.values(equipmentDowntime)
            .sort((a, b) => b.totalDowntime - a.totalDowntime)
            .slice(0, 10);

          // ë¹„ê°€ë™ ìœ í˜•ë³„ ìƒ‰ìƒ ì •ì˜ (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)
          const downtimeTypes = [
            { name: 'ê¸ˆí˜•êµí™˜', key: 'moldChange', color: '#ef4444' },       // ë¹¨ê°•
            { name: 'ì¡°ê±´ì„¤ì •ëŒ€ê¸°', key: 'setupWait', color: '#f59e0b' },    // ì£¼í™©
            { name: 'ì¡°ê±´ì„¤ì •', key: 'setup', color: '#eab308' },            // ë…¸ë‘
            { name: 'ì›ë£Œêµí™˜/ê±´ì¡°', key: 'materialChange', color: '#22c55e' }, // ì´ˆë¡
            { name: 'ê³ ì¥', key: 'breakdown', color: '#dc2626' },            // ì§„ë¹¨ê°•
            { name: 'ëŒ€ê¸°', key: 'waiting', color: '#3b82f6' },              // íŒŒë‘
            { name: 'ì •ë¹„', key: 'maintenance', color: '#8b5cf6' },          // ë³´ë¼
            { name: 'ê¸°íƒ€', key: 'other', color: '#6b7280' }                 // íšŒìƒ‰
          ];

          // ë°ì´í„°ê°€ ìˆëŠ” ìœ í˜•ë§Œ í•„í„°ë§
          const activeTypes = downtimeTypes.filter(type =>
            topEquipment.some(e => (e[type.key] || 0) > 0)
          );

          // ì„¤ë¹„ë³„ ìœ í˜•ë³„ ë¹„ê°€ë™ì‹œê°„ ë°ì´í„° ìƒì„± (ì‹¤ì œ ë°ì´í„°)
          const datasets = activeTypes.map(type => ({
            label: type.name,
            data: topEquipment.map(e => parseFloat(((e[type.key] || 0) / 60).toFixed(1))),
            backgroundColor: type.color,
            borderRadius: 0,
            barPercentage: 0.75
          }));

          charts.downtimeByEquipment = new Chart(downtimeByEquipmentCanvas, {
            type: 'bar',
            data: {
              labels: topEquipment.map(e => e.equipment.length > 12 ? e.equipment.substring(0, 12) + '...' : e.equipment),
              datasets: datasets
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { right: 60 } },
              plugins: {
                legend: {
                  display: true,
                  position: 'bottom',
                  labels: { boxWidth: 12, padding: 15, font: { size: 10 } }
                },
                tooltip: {
                  callbacks: {
                    label: (ctx) => `${ctx.dataset.label}: ${formatDecimal(ctx.raw, 1)}h`,
                    afterBody: (tooltipItems) => {
                      const idx = tooltipItems[0].dataIndex;
                      const total = topEquipment[idx].totalDowntime / 60;
                      return `\nì´ ë¹„ê°€ë™: ${formatDecimal(total, 1)}h`;
                    }
                  }
                },
                datalabels: {
                  display: (ctx) => ctx.datasetIndex === activeTypes.length - 1,
                  anchor: 'end',
                  align: 'right',
                  offset: 4,
                  color: '#374151',
                  font: { size: 10, weight: '600' },
                  formatter: (value, ctx) => {
                    const total = topEquipment[ctx.dataIndex].totalDowntime / 60;
                    return formatDecimal(total, 1) + 'h';
                  }
                }
              },
              scales: {
                x: {
                  stacked: true,
                  beginAtZero: true,
                  grid: { color: '#f3f4f6' },
                  ticks: { callback: (v) => formatNumber(v) },
                  title: { display: true, text: 'ë¹„ê°€ë™ì‹œê°„ (h)', font: { size: 10 }, color: '#64748b' }
                },
                y: {
                  stacked: true,
                  grid: { display: false },
                  ticks: { font: { size: 9 } }
                }
              }
            }
          });
          console.log('Downtime by equipment chart created successfully');
          } catch (e) {
            console.error('Error creating downtime by equipment chart:', e);
          }
        }

      // ë¶ˆëŸ‰ìˆ˜ë¦¬í˜„í™© ì°¨íŠ¸ (ì—…ë¡œë“œ ë°ì´í„° ê¸°ë°˜)
      createRepairCharts();

      // ìì¬ë¶ˆëŸ‰í˜„í™© ì°¨íŠ¸ (ì—…ë¡œë“œ ë°ì´í„° ê¸°ë°˜)
      createMaterialDefectCharts();

      // ê²€í¬ì¥í˜„í™© ì°¨íŠ¸ (ì—…ë¡œë“œ ë°ì´í„° ê¸°ë°˜)
      createPackagingCharts();

      // ì¬ê³µì¬ê³  ì°¨íŠ¸ (ì—…ë¡œë“œ ë°ì´í„° ê¸°ë°˜)
      createWipInventoryCharts();

      console.log('=== createCharts completed ===');
      } catch (e) {
        console.error('Error in createCharts:', e);
      }
    }

    // ì ‘ê¸°/í¼ì¹˜ê¸° ìƒíƒœ ê´€ë¦¬
    // ì ‘ê¸°/í¼ì¹˜ê¸° ìƒíƒœ (APP_CONFIG.UI.defaultCollapsed ê¸°ë³¸ê°’ ì ìš©)
    const collapseState = {
      materialDefect: APP_CONFIG.UI.defaultCollapsed,
      repairStatus: APP_CONFIG.UI.defaultCollapsed,
      oee: APP_CONFIG.UI.defaultCollapsed,
      downtime: APP_CONFIG.UI.defaultCollapsed,
      pivot: APP_CONFIG.UI.defaultCollapsed,
      defectType: APP_CONFIG.UI.defaultCollapsed,
      partDefectType: APP_CONFIG.UI.defaultCollapsed,
      packaging: APP_CONFIG.UI.defaultCollapsed,
      wipType: APP_CONFIG.UI.defaultCollapsed,
      wipSpec: APP_CONFIG.UI.defaultCollapsed,
      wipPrice: APP_CONFIG.UI.defaultCollapsed,
      wipHighPrice: APP_CONFIG.UI.defaultCollapsed,
      wipLowPrice: APP_CONFIG.UI.defaultCollapsed,
      ctLowPerf: APP_CONFIG.UI.defaultCollapsed,
      itemDefect: APP_CONFIG.UI.defaultCollapsed
    };

    function toggleCollapse(sectionId) {
      collapseState[sectionId] = !collapseState[sectionId];
      const content = document.getElementById(`collapse-${sectionId}`);
      const toggle = document.getElementById(`toggle-${sectionId}`);
      if (content && toggle) {
        content.classList.toggle('collapsed', collapseState[sectionId]);
        toggle.classList.toggle('collapsed', collapseState[sectionId]);
        toggle.innerHTML = collapseState[sectionId]
          ? `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>í¼ì¹˜ê¸°`
          : `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>ì ‘ê¸°`;
      }
    }

    // ìì¬ë¶ˆëŸ‰ í…Œì´ë¸” ì •ë ¬ ìƒíƒœ
    let materialDefectSortField = null;
    let materialDefectSortAsc = true;

    function sortMaterialDefectTable(field) {
      if (materialDefectSortField === field) {
        materialDefectSortAsc = !materialDefectSortAsc;
      } else {
        materialDefectSortField = field;
        materialDefectSortAsc = true;
      }

      if (state.materialDefectData && state.materialDefectData.length > 0) {
        state.materialDefectData.sort((a, b) => {
          let valA = a[field] || '';
          let valB = b[field] || '';
          if (field === 'defectTotal') {
            valA = parseInt(valA) || 0;
            valB = parseInt(valB) || 0;
          }
          if (valA < valB) return materialDefectSortAsc ? -1 : 1;
          if (valA > valB) return materialDefectSortAsc ? 1 : -1;
          return 0;
        });
        render();
        setTimeout(createCharts, 100);
      }
    }

    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    async function handleLogin() {
      const email = document.getElementById('emailInput')?.value;
      const password = document.getElementById('passwordInput')?.value;

      if (!email || !password) {
        alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const loginBtn = document.getElementById('loginBtn');
      if (loginBtn) {
        loginBtn.disabled = true;
        loginBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
      }

      const result = await signIn(email, password);

      if (result.success) {
        state.isAuthenticated = true;

        // Supabaseì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ
        if (supabaseConnected) {
          await loadAllFromSupabase();
          // ğŸ”´ ì‹¤ì‹œê°„ ë™ê¸°í™” ì´ˆê¸°í™”
          await initRealtimeSync();
        }

        render();
        if (state.rawData.length > 0) {
          setTimeout(() => { createCharts(); initTableSort(); }, 100);
        }
      } else {
        alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + result.error);
        if (loginBtn) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'ì‹œìŠ¤í…œ ì ‘ì†';
        }
      }
    }

    async function handleSignUp() {
      const email = document.getElementById('emailInput')?.value;
      const password = document.getElementById('passwordInput')?.value;
      const displayName = document.getElementById('displayNameInput')?.value || email.split('@')[0];

      if (!email || !password) {
        alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (password.length < 6) {
        alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      const result = await signUp(email, password, displayName);

      if (result.success) {
        alert(result.message);
        toggleAuthMode();
      } else {
        alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + result.error);
      }
    }

    async function handlePasswordReset() {
      const email = document.getElementById('emailInput')?.value;
      if (!email) {
        alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const result = await requestPasswordReset(email);
      alert(result.success ? result.message : 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì‹¤íŒ¨: ' + result.error);
    }

    let isSignUpMode = false;
    function toggleAuthMode() {
      isSignUpMode = !isSignUpMode;
      render();
    }

    async function handleLogout(isAutoLogout = false) {
      if (isAutoLogout || confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // ğŸ”´ ì‹¤ì‹œê°„ ë™ê¸°í™” ì •ë¦¬
        cleanupRealtimeSync();

        await signOut();
        state.isAuthenticated = false;
        currentUser = null;
        userProfile = null;
        render();
      }
    }

    function handleClearData() {
      if (confirm('ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        clearStorage();
        alert('ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë°ì´í„°ì—ì„œ ì›” ëª©ë¡ ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)
    function getMonthsFromData(data) {
      const months = new Set();
      data.forEach(row => {
        if (!row.date) return;
        const { month } = extractYearMonth(row.date);
        if (month) months.add(month);
      });
      return months;
    }

    // ê¸°ì¡´ ë°ì´í„°ì—ì„œ íŠ¹ì • ì›” ë°ì´í„° ì œê±°
    function removeMonthsFromData(existingData, monthsToRemove) {
      return existingData.filter(row => {
        if (!row.date) return true; // ë‚ ì§œ ì—†ëŠ” ë°ì´í„°ëŠ” ìœ ì§€
        const { month } = extractYearMonth(row.date);
        return !monthsToRemove.has(month);
      });
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // í¸ì§‘ ê¶Œí•œ í™•ì¸
      if (userProfile && !['admin', 'editor'].includes(userProfile.role)) {
        alert('ë°ì´í„° ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        // ğŸ”´ ì—…ë¡œë“œ ì‹œì‘ - ë™ê¸°í™” ë°©ì§€
        isUploading = true;
        console.log('ğŸ“¤ ì—…ë¡œë“œ ì‹œì‘ - ë™ê¸°í™” ì¼ì‹œ ì¤‘ì§€');

        try {
          const newData = parseCSV(e.target.result);

          // ìƒˆ ë°ì´í„°ì—ì„œ ì›” ì¶”ì¶œ
          const newMonths = getMonthsFromData(newData);
          const monthNames = Array.from(newMonths).sort().map(m => m + 'ì›”').join(', ');

          // Supabaseì—ì„œ ìµœì‹  ë°ì´í„° ë¨¼ì € ë¡œë“œ (ë‹¤ë¥¸ ì»´í“¨í„°ì—ì„œ ì—…ë¡œë“œí•œ ë°ì´í„° í¬í•¨)
          if (supabaseConnected) {
            const supabaseData = await loadFromSupabase('production_data');
            if (supabaseData && supabaseData.length > 0) {
              state.rawData = supabaseData;
              console.log('ğŸ“¥ Supabaseì—ì„œ ìµœì‹  ìƒì‚° ë°ì´í„° ë¡œë“œ:', supabaseData.length + 'ê±´');
            }
          }

          // ê¸°ì¡´ ë°ì´í„°ì—ì„œ í•´ë‹¹ ì›” ë°ì´í„° ì œê±° í›„ ìƒˆ ë°ì´í„° ë³‘í•©
          const filteredExisting = removeMonthsFromData(state.rawData, newMonths);
          state.rawData = [...filteredExisting, ...newData];

          saveToStorage(state.rawData);
          render();
          setTimeout(() => { createCharts(); initTableSort(); }, 100);
          alert(`${monthNames} ë°ì´í„° ${newData.length}ê±´ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì´ ${state.rawData.length}ê±´)`);
          // Supabase ë™ê¸°í™” ë° ë¡œê·¸ ê¸°ë¡
          if (supabaseConnected) {
            await saveToSupabase('production_data', state.rawData);
            await logAccess('data_upload', { type: 'production_data', count: newData.length, filename: file.name });
          }
        } finally {
          // ğŸ”´ ì—…ë¡œë“œ ì™„ë£Œ - ë™ê¸°í™” ì¬ê°œ
          isUploading = false;
          console.log('âœ… ì—…ë¡œë“œ ì™„ë£Œ - ë™ê¸°í™” ì¬ê°œ');
        }
      };
      reader.readAsText(file, 'UTF-8');
    }

    function handleAvailabilityUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // í¸ì§‘ ê¶Œí•œ í™•ì¸
      if (userProfile && !['admin', 'editor'].includes(userProfile.role)) {
        alert('ë°ì´í„° ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        isUploading = true;
        try {
          const newData = parseAvailabilityCSV(e.target.result);

          // ìƒˆ ë°ì´í„°ì—ì„œ ì›” ì¶”ì¶œ
          const newMonths = getMonthsFromData(newData);
          const monthNames = Array.from(newMonths).sort().map(m => m + 'ì›”').join(', ');

          // Supabaseì—ì„œ ìµœì‹  ë°ì´í„° ë¨¼ì € ë¡œë“œ (ë‹¤ë¥¸ ì»´í“¨í„°ì—ì„œ ì—…ë¡œë“œí•œ ë°ì´í„° í¬í•¨)
          if (supabaseConnected) {
            const supabaseData = await loadFromSupabase('availability_data');
            if (supabaseData && supabaseData.length > 0) {
              state.availabilityData = supabaseData;
              console.log('ğŸ“¥ Supabaseì—ì„œ ìµœì‹  ê°€ë™ìœ¨ ë°ì´í„° ë¡œë“œ:', supabaseData.length + 'ê±´');
            }
          }

          // ê¸°ì¡´ ë°ì´í„°ì—ì„œ í•´ë‹¹ ì›” ë°ì´í„° ì œê±° í›„ ìƒˆ ë°ì´í„° ë³‘í•©
          const filteredExisting = removeMonthsFromData(state.availabilityData, newMonths);
          state.availabilityData = [...filteredExisting, ...newData];

          saveAvailabilityToStorage(state.availabilityData);
          render();
          setTimeout(() => { createCharts(); initTableSort(); }, 100);
          alert(`ê°€ë™ìœ¨ ${monthNames} ë°ì´í„° ${newData.length}ê±´ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì´ ${state.availabilityData.length}ê±´)`);
          // Supabase ë™ê¸°í™” ë° ë¡œê·¸ ê¸°ë¡
          if (supabaseConnected) {
            await saveToSupabase('availability_data', state.availabilityData);
            await logAccess('data_upload', { type: 'availability_data', count: newData.length, filename: file.name });
          }
        } finally {
          isUploading = false;
        }
      };
      reader.readAsText(file, 'UTF-8');
    }

    // ë¶€í’ˆë‹¨ê°€í‘œ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    function handlePriceUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // í¸ì§‘ ê¶Œí•œ í™•ì¸
      if (userProfile && !['admin', 'editor'].includes(userProfile.role)) {
        alert('ë°ì´í„° ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        const newData = parsePriceCSV(e.target.result);
        state.priceData = newData;
        savePriceToStorage(newData);
        render();
        setTimeout(() => { createCharts(); initTableSort(); }, 100);
        alert('ë¶€í’ˆë‹¨ê°€í‘œ ' + newData.length + 'ê±´ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nìƒì‚°ê¸ˆì•¡/ë¶ˆëŸ‰ê¸ˆì•¡ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.');
        // Supabase ë™ê¸°í™” ë° ë¡œê·¸ ê¸°ë¡
        if (supabaseConnected) {
          await saveToSupabase('price_data', newData);
          await logAccess('data_upload', { type: 'price_data', count: newData.length, filename: file.name });
        }
      };
      reader.readAsText(file, 'UTF-8');
    }

    // ë¶€í’ˆë‹¨ê°€í‘œ CSV íŒŒì‹±
    function parsePriceCSV(csvText) {
      const lines = csvText.trim().split('\n');
      if (lines.length < 2) return [];

      const headers = lines[0].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        if (values.length < 12) continue;

        const row = {};
        headers.forEach((h, idx) => {
          row[h] = values[idx] || '';
        });

        // í•„ë“œ ë§¤í•‘
        const item = {
          itemCode: row['í’ˆëª©ì½”ë“œ'] || '',
          customerPN: row['ê³ ê°ì‚¬ P/N'] || '',
          itemName: row['í’ˆëª©ëª…'] || '',
          itemStatus: row['í’ˆëª©ìƒíƒœ'] || '',
          itemType: row['í’ˆëª©ìœ í˜•'] || '',
          supplyType: row['ì¡°ë‹¬êµ¬ë¶„'] || '',
          materialCost: parseFloat(row['ì¬ë£Œë¹„'] || row[' ì¬ë£Œë¹„ '] || '0') || 0,
          processingCost: parseFloat(row['ê°€ê³µë¹„'] || row[' ê°€ê³µë¹„ '] || '0') || 0,
          unitPrice: parseFloat(row['ë‹¨ê°€'] || row[' ë‹¨ê°€ '] || '0') || 0,
          remark: row['ë¹„ê³ '] || ''
        };

        if (item.itemCode || item.itemName) {
          data.push(item);
        }
      }

      console.log('ë‹¨ê°€í‘œ íŒŒì‹± ì™„ë£Œ:', data.length + 'ê±´');
      return data;
    }

    // í’ˆëª©ëª…ìœ¼ë¡œ ë‹¨ê°€ ì¡°íšŒ
    function getUnitPrice(productName) {
      if (!state.priceData || state.priceData.length === 0) return null;

      // í’ˆëª©ëª…ìœ¼ë¡œ ë§¤ì¹­ (ë¶€ë¶„ ë§¤ì¹­)
      const match = state.priceData.find(p =>
        productName && p.itemName &&
        (productName.includes(p.itemName) || p.itemName.includes(productName) ||
         productName.replace(/[-_\s]/g, '').toLowerCase().includes(p.itemName.replace(/[-_\s]/g, '').toLowerCase()))
      );

      return match ? match.unitPrice : null;
    }

    // í’ˆëª©ì½”ë“œë¡œ ë‹¨ê°€ ì¡°íšŒ
    function getUnitPriceByCode(itemCode) {
      if (!state.priceData || state.priceData.length === 0) return null;
      const match = state.priceData.find(p => p.itemCode === itemCode || p.customerPN === itemCode);
      return match ? match.unitPrice : null;
    }

    function setTab(tab) {
      state.activeTab = tab;
      if (tab !== 'process') {
        state.activeProcess = null;
        state.activeSubMenu = 'production';
      }
      render();
      setTimeout(() => { createCharts(); initTableSort(); }, 100);
    }

    function setWipSubTab(subTab) {
      state.wipSubTab = subTab;
      render();
      setTimeout(() => { createWipInventoryCharts(); initTableSort(); }, 100);
    }

    function setProcess(processId) {
      state.activeTab = 'process';
      state.activeProcess = processId;
      state.activeSubMenu = 'production';  // ê³µì • ë³€ê²½ì‹œ ê¸°ë³¸ í•˜ìœ„ë©”ë‰´ë¡œ
      render();
      setTimeout(() => { createCharts(); initTableSort(); }, 100);
    }

    function setSubMenu(subMenuId) {
      state.activeSubMenu = subMenuId;
      render();
      setTimeout(() => { createCharts(); initTableSort(); }, 100);
    }

    function setFilter(key, value) {
      state.filters[key] = value;
      render();
      setTimeout(() => { createCharts(); initTableSort(); }, 100);
    }

    // ë Œë”ë§
    function render() {
      const app = document.getElementById('app');
      app.innerHTML = state.isAuthenticated ? renderDashboard() : renderLogin();

      // ê´€ë¦¬ì íŒ¨ë„ ë¹„ë™ê¸° ë¡œë”©
      if (state.isAuthenticated && state.activeTab === 'admin' && isAdmin()) {
        loadAdminPanel();
      }
    }

    async function loadAdminPanel() {
      const container = document.getElementById('admin-panel-container');
      if (container) {
        const html = await renderAdminPanel();
        container.innerHTML = html;
      }
    }

    // ğŸ” Supabase ë°ì´í„° í˜„í™© í™•ì¸ (ì½˜ì†”ì—ì„œ checkSupabaseData() ì‹¤í–‰)
    window.checkSupabaseData = async function() {
      console.log('=== ğŸ“Š Supabase vs LocalStorage ë°ì´í„° ë¹„êµ ===');

      for (const [stateKey, tableName] of Object.entries(TABLE_MAPPING)) {
        const localData = state[stateKey] || [];
        const supabaseData = await loadFromSupabase(tableName);
        const supabaseCount = supabaseData ? supabaseData.length : 0;

        const status = supabaseCount >= localData.length ? 'âœ…' : 'âš ï¸ LOCAL > SUPABASE';
        console.log(`${status} ${tableName}: Supabase=${supabaseCount}ê±´, Local=${localData.length}ê±´`);
      }

      console.log('\nğŸ’¡ ë§Œì•½ Supabase ë°ì´í„°ê°€ ì ìœ¼ë©´ forceUploadAll() ì‹¤í–‰í•˜ì„¸ìš”');
    };

    // ğŸ”„ ë¡œì»¬ ë°ì´í„°ë¥¼ Supabaseì— ê°•ì œ ì—…ë¡œë“œ (ì½˜ì†”ì—ì„œ forceUploadAll() ì‹¤í–‰)
    window.forceUploadAll = async function() {
      if (!confirm('í˜„ì¬ ë¡œì»¬ ë°ì´í„°ë¥¼ Supabaseì— ê°•ì œë¡œ ì—…ë¡œë“œí•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      console.log('=== ğŸš€ ê°•ì œ ì—…ë¡œë“œ ì‹œì‘ ===');
      isUploading = true;

      try {
        for (const [stateKey, tableName] of Object.entries(TABLE_MAPPING)) {
          const localData = state[stateKey] || [];
          if (localData.length > 0) {
            console.log(`ğŸ“¤ ${tableName}: ${localData.length}ê±´ ì—…ë¡œë“œ ì¤‘...`);
            await saveToSupabase(tableName, localData);
          }
        }
        console.log('âœ… ê°•ì œ ì—…ë¡œë“œ ì™„ë£Œ!');
        alert('ëª¨ë“  ë°ì´í„°ê°€ Supabaseì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (e) {
        console.error('âŒ ê°•ì œ ì—…ë¡œë“œ ì‹¤íŒ¨:', e);
        alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
      } finally {
        isUploading = false;
      }
    };

    // ğŸ” ë°ì´í„° ì§„ë‹¨ í•¨ìˆ˜ (ì½˜ì†”ì—ì„œ debugProductionData() ì‹¤í–‰)
    window.debugProductionData = function() {
      console.log('=== ğŸ“Š ìƒì‚°ì‹¤ì  ë°ì´í„° ì§„ë‹¨ ===');
      console.log('ì „ì²´ rawData:', state.rawData.length + 'ê±´');

      // ê³µì •ë³„ ì§‘ê³„
      const byProcess = {};
      state.rawData.forEach(d => {
        if (!byProcess[d.process]) byProcess[d.process] = { total: 0, byMonth: {} };
        byProcess[d.process].total++;

        // ì›” ì¶”ì¶œ
        const dateStr = String(d.date);
        let month = '?';
        if (dateStr.includes('-')) {
          month = parseInt(dateStr.split('-')[1]) || '?';
        } else if (dateStr.includes('/')) {
          const parts = dateStr.split('/');
          month = parts[0].length === 4 ? parseInt(parts[1]) : parseInt(parts[0]);
        }
        byProcess[d.process].byMonth[month] = (byProcess[d.process].byMonth[month] || 0) + 1;
      });

      console.log('\nê³µì •ë³„ ì›”ë³„ ë ˆì½”ë“œ ìˆ˜:');
      Object.keys(byProcess).forEach(proc => {
        console.log(`  ${proc}: ì´ ${byProcess[proc].total}ê±´`, byProcess[proc].byMonth);
      });

      // ê³µì •ë³„ ìƒì‚°ìˆ˜ëŸ‰ í•©ê³„
      console.log('\nê³µì •ë³„ ìƒì‚°ìˆ˜ëŸ‰ í•©ê³„ (2ì›”ë§Œ):');
      const sumByProcess = {};
      state.rawData.forEach(d => {
        const dateStr = String(d.date);
        let month = null;
        if (dateStr.includes('-')) {
          month = parseInt(dateStr.split('-')[1]) || null;
        } else if (dateStr.includes('/')) {
          const parts = dateStr.split('/');
          month = parts[0].length === 4 ? parseInt(parts[1]) : parseInt(parts[0]);
        }
        if (month === 2) {
          sumByProcess[d.process] = (sumByProcess[d.process] || 0) + (d.productionQty || 0);
        }
      });
      console.log(sumByProcess);

      // ì¡°ë¦½ ë°ì´í„° ìƒ˜í”Œ
      const assemblyData = state.rawData.filter(d => d.process === 'ì¡°ë¦½');
      console.log('\nì¡°ë¦½ ë°ì´í„° ìƒ˜í”Œ (ì²˜ìŒ 5ê±´):');
      assemblyData.slice(0, 5).forEach(d => console.log('  ', d.date, d.productionQty));

      return sumByProcess;
    };

    // ì´ˆê¸°í™”
    async function initApp() {
      // ê¸°ì¡´ localStorageì˜ Supabase ì„¸ì…˜ ì •ë¦¬ (sessionStorageë¡œ ì „í™˜í–ˆìœ¼ë¯€ë¡œ)
      const oldKeys = Object.keys(localStorage).filter(k => k.startsWith('sb-') || k.includes('supabase'));
      oldKeys.forEach(k => localStorage.removeItem(k));

      // Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
      await testSupabaseConnection();

      // ê¸°ì¡´ ì„¸ì…˜ í™•ì¸ (Supabase Auth)
      if (supabaseConnected) {
        const hasSession = await checkAuthSession();
        if (hasSession) {
          state.isAuthenticated = true;
          await logAccess('session_restored');
          console.log('âœ… ê¸°ì¡´ ì„¸ì…˜ ë³µì›:', currentUser?.email);
        }
      }

      // ì¸ì¦ëœ ê²½ìš°ì—ë§Œ Supabaseì—ì„œ ë°ì´í„° ë¡œë“œ
      if (state.isAuthenticated && supabaseConnected) {
        const loaded = await loadAllFromSupabase();
        if (loaded) {
          console.log('ğŸ“Š Supabaseì—ì„œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
        }

        // ğŸ”´ ì‹¤ì‹œê°„ ë™ê¸°í™” ì´ˆê¸°í™” (ë‹¤ë¥¸ ì»´í“¨í„°ì™€ ì‹¤ì‹œê°„ ë™ê¸°í™”)
        await initRealtimeSync();
      }

      // í™”ë©´ ë Œë”ë§
      render();

      if (state.isAuthenticated && state.rawData.length > 0) {
        setTimeout(() => { createCharts(); initTableSort(); }, 100);
      }
    }

    // ì•± ì‹œì‘
    initApp();
  </script>
</body>
</html>
