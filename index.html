<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ïã†ÏÑ±Ïò§ÌÜ†ÌÖç ÏÉùÏÇ∞Ïã§ ÎåÄÏãúÎ≥¥Îìú</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    /* Apple Style Card */
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid #f0f0f0;
    }

    /* Main Navigation */
    .nav-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }
    .nav-btn.active { background: #3b82f6; color: white; }
    .nav-btn:not(.active) { color: #94a3b8; }
    .nav-btn:not(.active):hover { background: #1e293b; color: #e2e8f0; }

    /* 2Ï∞® ÏÑúÎ∏åÎ©îÎâ¥ (Í≥µÏ†ï ÏÑ†ÌÉù) */
    .sub-nav {
      background: #fafafa;
      border-bottom: 1px solid #e5e5e5;
      padding: 0;
    }
    .sub-nav-inner {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
    }
    .sub-nav-tabs {
      display: flex;
      gap: 0;
    }
    .sub-nav-tab {
      padding: 16px 28px;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sub-nav-tab:hover {
      color: #111827;
      background: #f3f4f6;
    }
    .sub-nav-tab.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
      font-weight: 600;
    }

    /* 3Ï∞® ÏÑúÎ∏åÎ©îÎâ¥ (ÌïòÏúÑ Î©îÎâ¥) */
    .third-nav {
      background: white;
      border-bottom: 1px solid #e5e5e5;
    }
    .third-nav-inner {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
    }
    .third-nav-tabs {
      display: flex;
      gap: 4px;
    }
    .third-nav-tab {
      padding: 12px 20px;
      font-size: 13px;
      font-weight: 500;
      color: #9ca3af;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
      cursor: pointer;
    }
    .third-nav-tab:hover {
      color: #374151;
    }
    .third-nav-tab.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
      font-weight: 600;
    }

    /* Section Header */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      background: white;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid #f0f0f0;
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: #2563eb;
      border-radius: 2px;
    }

    /* Filter & Upload */
    .filter-select {
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      background: #f8fafc;
      color: #475569;
      cursor: pointer;
      min-width: 80px;
    }
    .filter-select:focus {
      outline: none;
      border-color: #94a3b8;
      box-shadow: 0 0 0 2px rgba(148,163,184,0.2);
    }

    .upload-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: #f1f5f9;
      color: #475569;
      font-size: 12px;
      font-weight: 500;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-btn:hover {
      background: #e2e8f0;
      border-color: #cbd5e1;
    }

    /* Data Table - Auto-fit columns with modern sorting */
    .data-table {
      width: 100%;
      font-size: 13px;
      border-collapse: collapse;
      table-layout: auto;
    }
    .data-table th {
      text-align: left;
      padding: 12px 16px;
      font-weight: 600;
      color: #64748b;
      border-bottom: 2px solid #e2e8f0;
      background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
      white-space: nowrap;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .data-table th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 28px;
      transition: all 0.15s ease;
    }
    .data-table th.sortable:hover {
      background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
      color: #1e293b;
    }
    .data-table th.sortable::after {
      content: '';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 5px solid #cbd5e1;
      opacity: 0.5;
    }
    .data-table th.sortable::before {
      content: '';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%) translateY(-5px);
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 5px solid #cbd5e1;
      opacity: 0.5;
    }
    .data-table th.sortable.asc::before { border-bottom-color: #3b82f6; opacity: 1; }
    .data-table th.sortable.asc::after { opacity: 0.3; }
    .data-table th.sortable.desc::after { border-top-color: #3b82f6; opacity: 1; }
    .data-table th.sortable.desc::before { opacity: 0.3; }
    .data-table td {
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
      white-space: nowrap;
    }
    .data-table tr:hover { background: #f8fafc; }
    .data-table tr:nth-child(even) { background: #fafbfc; }
    .data-table tr:nth-child(even):hover { background: #f1f5f9; }
    .data-table .text-right { text-align: right; font-variant-numeric: tabular-nums; }

    /* Collapsible Section */
    .collapsible-content {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
      opacity: 1;
    }
    .collapsible-content.collapsed {
      max-height: 0;
      opacity: 0;
    }
    .collapse-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }
    .collapse-toggle:hover {
      background: #e2e8f0;
      color: #475569;
    }
    .collapse-toggle svg {
      transition: transform 0.2s;
    }
    .collapse-toggle.collapsed svg {
      transform: rotate(-90deg);
    }

    /* Badge - 3ÏÉâ ÌÜµÏùº: ÏùºÎ∞ò(ÌöåÏÉâ), Ï†ïÏÉÅ(Î∏îÎ£®), Î∂àÎüâ(Î†àÎìú) */
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .badge-success { background: #dbeafe; color: #1d4ed8; }
    .badge-warning { background: #f1f5f9; color: #475569; }
    .badge-danger { background: #fee2e2; color: #dc2626; }

    /* Stat Card */
    .stat-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid #e2e8f0;
    }
    .stat-card.blue {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-color: #bfdbfe;
    }
    .stat-card.red {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border-color: #fecaca;
    }
    .stat-card.green {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-color: #bbf7d0;
    }
    .stat-label {
      font-size: 12px;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      line-height: 1;
    }
    .stat-sub {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }

    /* Chart Card */
    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      border: 1px solid #f0f0f0;
    }
    .chart-card canvas {
      max-height: 300px !important;
    }
    .chart-title {
      font-size: 15px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chart-title::before {
      content: '';
      width: 3px;
      height: 16px;
      background: #3b82f6;
      border-radius: 2px;
    }

    /* Process Icon */
    .process-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    // ‚ïë                               üîß Í∏∞Î≥∏ ÏÑ§Ï†ï (DEFAULT CONFIG)                                ‚ïë
    // ‚ïë  ‚ö†Ô∏è ÏóÖÎç∞Ïù¥Ìä∏ Ïãú ÏïÑÎûò Í∑úÏπôÏùÑ Î∞òÎìúÏãú Ï§ÄÏàòÌïòÏÑ∏Ïöî!                                               ‚ïë
    // ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
    // ‚ïë  1. Ïà´Ïûê Ìè¨Îß∑: Î™®Îì† Ïà´ÏûêÎäî Ï≤úÎã®ÏúÑ ÏΩ§Îßà Ï†ÅÏö© ‚Üí formatNumber(), formatCompact() ÏÇ¨Ïö©          ‚ïë
    // ‚ïë  2. ÌçºÏÑºÌä∏: ÏÜåÏà´Ï†ê 1ÏûêÎ¶¨ÍπåÏßÄÎßå ÌëúÏãú ‚Üí formatPercent() ÏÇ¨Ïö©                                  ‚ïë
    // ‚ïë  3. Ï∞®Ìä∏ Ïà´Ïûê: Ï≤úÎã®ÏúÑ ÏΩ§Îßà ‚Üí chartNumberFormatter() / ÌçºÏÑºÌä∏ ‚Üí chartPercentFormatter()     ‚ïë
    // ‚ïë  4. Ï∞®Ìä∏ ÏÉâÏÉÅ: ÌååÏä§ÌÖîÌÜ§Îßå ÏÇ¨Ïö© ‚Üí generatePastelColor(index) ÎòêÎäî CHART_COLORS.pastel       ‚ïë
    // ‚ïë  5. ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞: Î™®Îì† ÌÖåÏù¥Î∏îÏùÄ Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ Í∏∞Îä• ÌïÑÏàò ‚Üí toggleCollapse() ÏÇ¨Ïö©                ‚ïë
    // ‚ïë  6. ÌÖåÏù¥Î∏î Ï†ïÎ†¨: Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏îÏùÄ Ï†ïÎ†¨ Í∏∞Îä• ÌïÑÏàò ‚Üí sortable ÌÅ¥ÎûòÏä§ ÏÇ¨Ïö©                 ‚ïë
    // ‚ïë  7. Î©îÎâ¥ ÎîîÏûêÏù∏: ÌïòÏúÑÎ©îÎâ¥Îäî third-nav ÌÅ¥ÎûòÏä§ ÏÇ¨Ïö© (Í≥µÏ†ïÌòÑÌô© Ïä§ÌÉÄÏùº ÌëúÏ§Ä)                    ‚ïë
    // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

    const APP_CONFIG = {
      // Ïà´Ïûê Ìè¨Îß∑ÌåÖ
      NUMBER_FORMAT: {
        useThousandSeparator: true,    // Ï≤úÎã®ÏúÑ ÏΩ§Îßà
        percentDecimals: 1,             // ÌçºÏÑºÌä∏ ÏÜåÏà´Ï†ê ÏûêÎ¶øÏàò
        numberDecimals: 0               // ÏùºÎ∞ò Ïà´Ïûê ÏÜåÏà´Ï†ê ÏûêÎ¶øÏàò
      },

      // Ï∞®Ìä∏ ÏÉâÏÉÅ (ÌååÏä§ÌÖîÌÜ§) - Î™®Îì† Ï∞®Ìä∏ÏóêÏÑú Ïù¥ ÏÉâÏÉÅ ÏÇ¨Ïö©
      CHART_COLORS: {
        // Í∏∞Î≥∏ ÌååÏä§ÌÖî ÌåîÎ†àÌä∏ (8ÏÉâ)
        pastel: [
          'rgba(147, 197, 253, 0.85)',   // [0] ÌååÏä§ÌÖî Î∏îÎ£®
          'rgba(110, 231, 183, 0.85)',   // [1] ÌååÏä§ÌÖî Í∑∏Î¶∞
          'rgba(253, 186, 116, 0.85)',   // [2] ÌååÏä§ÌÖî Ïò§Î†åÏßÄ
          'rgba(252, 165, 165, 0.85)',   // [3] ÌååÏä§ÌÖî Î†àÎìú
          'rgba(196, 181, 253, 0.85)',   // [4] ÌååÏä§ÌÖî ÌçºÌîå
          'rgba(253, 224, 71, 0.85)',    // [5] ÌååÏä§ÌÖî ÏòêÎ°úÏö∞
          'rgba(165, 243, 252, 0.85)',   // [6] ÌååÏä§ÌÖî ÏãúÏïà
          'rgba(251, 207, 232, 0.85)'    // [7] ÌååÏä§ÌÖî ÌïëÌÅ¨
        ],
        // Í≥µÏ†ïÎ≥Ñ ÏÉâÏÉÅ (ÌååÏä§ÌÖîÌÜ§)
        process: {
          injection: '#fdba74',   // ÏÇ¨Ï∂ú - ÌååÏä§ÌÖî Ïò§Î†åÏßÄ
          painting: '#7dd3fc',    // ÎèÑÏû• - ÌååÏä§ÌÖî Ïä§Ïπ¥Ïù¥
          printing: '#fcd34d',    // Ïù∏ÏáÑ - ÌååÏä§ÌÖî ÏòêÎ°úÏö∞
          assembly: '#c4b5fd'     // Ï°∞Î¶Ω - ÌååÏä§ÌÖî ÌçºÌîå
        },
        // OEE/Í∞ÄÎèôÏú® Ï∞®Ìä∏Ïö©
        oee: {
          availability: '#e2e8f0',   // ÏãúÍ∞ÑÍ∞ÄÎèôÏú® - Ïó∞Ìïú ÌöåÏÉâ
          performance: '#cbd5e1',    // ÏÑ±Îä•Í∞ÄÎèôÏú® - ÌöåÏÉâ
          quality: '#bfdbfe',        // ÏñëÌíàÏú® - Ïó∞Ìïú ÌååÎûë
          oeeLine: '#fca5a5'         // OEE ÎùºÏù∏ - ÌååÏä§ÌÖî Î†àÎìú
        },
        // ÏÉÅÌÉúÎ≥Ñ ÏÉâÏÉÅ
        status: {
          good: 'rgba(110, 231, 183, 0.85)',    // ÏñëÌò∏ - ÌååÏä§ÌÖî Í∑∏Î¶∞
          warning: 'rgba(253, 186, 116, 0.85)', // Í≤ΩÍ≥† - ÌååÏä§ÌÖî Ïò§Î†åÏßÄ
          bad: 'rgba(252, 165, 165, 0.85)'      // Î∂àÎüâ - ÌååÏä§ÌÖî Î†àÎìú
        }
      },

      // UI ÏÑ§Ï†ï
      UI: {
        defaultCollapsed: false,        // ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Í∏∞Î≥∏ ÌéºÏπ® ÏÉÅÌÉú (trueÎ°ú Î≥ÄÍ≤ΩÌïòÎ©¥ Í∏∞Î≥∏ Ï†ëÌûò)
        enableTableSort: true,          // ÌÖåÏù¥Î∏î Ï†ïÎ†¨ Í∏∞Îä•
        enableCollapse: true            // Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ Í∏∞Îä•
      },

      // Î©îÎâ¥ ÎîîÏûêÏù∏ ÌëúÏ§Ä
      MENU_DESIGN: {
        // Î©îÏù∏ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò: nav-btn ÌÅ¥ÎûòÏä§ ÏÇ¨Ïö©
        // 2Ï∞® ÏÑúÎ∏åÎ©îÎâ¥ (Í≥µÏ†ïÏÑ†ÌÉù Îì±): sub-nav ÌÅ¥ÎûòÏä§ ÏÇ¨Ïö©
        // 3Ï∞® ÏÑúÎ∏åÎ©îÎâ¥ (ÌïòÏúÑÌÉ≠): third-nav ÌÅ¥ÎûòÏä§ ÏÇ¨Ïö© ‚Üê Ïû¨Í≥µÏû¨Í≥† Îì± Î™®Îì† ÌïòÏúÑÌÉ≠Ïóê Ï†ÅÏö©
        subMenuClass: 'third-nav',
        subMenuInnerClass: 'third-nav-inner',
        subMenuTabClass: 'third-nav-tab'
      }
    };

    // ÌååÏä§ÌÖî ÏÉâÏÉÅ Í∞ÄÏ†∏Ïò§Í∏∞ Ìó¨Ìçº Ìï®Ïàò
    function getPastelColor(index) {
      return APP_CONFIG.CHART_COLORS.pastel[index % APP_CONFIG.CHART_COLORS.pastel.length];
    }

    // ÎèôÏ†Å ÌååÏä§ÌÖî ÏÉâÏÉÅ ÏÉùÏÑ± (hsla Í∏∞Î∞ò)
    function generatePastelColor(index, saturation = 50, lightness = 70) {
      const hue = (index * 40 + 180) % 360;
      return `hsla(${hue}, ${saturation}%, ${lightness}%, 0.85)`;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Supabase ÏÑ§Ï†ï
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const SUPABASE_URL = 'https://gipksxojxdkqpyyiihcc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpcGtzeG9qeGRrcXB5eWlpaGNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTExOTQsImV4cCI6MjA4NTI2NzE5NH0.ZE7kpdUUEW--Ggum7s3f6OJ4bm7CdKkW3yuAZldgrqg';

    // Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Supabase Ïó∞Í≤∞ ÏÉÅÌÉú
    let supabaseConnected = false;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Î≥¥Ïïà ÏÑ§Ï†ï
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const SECURITY_CONFIG = {
      SESSION_TIMEOUT: 30 * 60 * 1000,    // 30Î∂Ñ (Î∞ÄÎ¶¨Ï¥à)
      WARNING_BEFORE: 5 * 60 * 1000,       // ÎßåÎ£å 5Î∂Ñ Ï†Ñ Í≤ΩÍ≥†
      ACTIVITY_EVENTS: ['mousedown', 'keydown', 'scroll', 'touchstart']
    };

    // ÌòÑÏû¨ Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥
    let currentUser = null;
    let userProfile = null;
    let sessionTimer = null;
    let warningTimer = null;
    let lastActivity = Date.now();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ÏÑ∏ÏÖò Í¥ÄÎ¶¨
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function resetSessionTimer() {
      lastActivity = Date.now();
      clearTimeout(sessionTimer);
      clearTimeout(warningTimer);

      // Í≤ΩÍ≥† ÌÉÄÏù¥Î®∏ (ÎßåÎ£å 5Î∂Ñ Ï†Ñ)
      warningTimer = setTimeout(() => {
        if (currentUser) {
          const remaining = Math.ceil(SECURITY_CONFIG.WARNING_BEFORE / 60000);
          if (confirm(`ÏÑ∏ÏÖòÏù¥ ${remaining}Î∂Ñ ÌõÑ ÎßåÎ£åÎê©ÎãàÎã§. Ïó∞Ïû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
            resetSessionTimer();
            logAccess('session_extended');
          }
        }
      }, SECURITY_CONFIG.SESSION_TIMEOUT - SECURITY_CONFIG.WARNING_BEFORE);

      // ÏÑ∏ÏÖò ÎßåÎ£å ÌÉÄÏù¥Î®∏
      sessionTimer = setTimeout(() => {
        if (currentUser) {
          alert('ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
          handleLogout(true);
        }
      }, SECURITY_CONFIG.SESSION_TIMEOUT);
    }

    function setupActivityListeners() {
      SECURITY_CONFIG.ACTIVITY_EVENTS.forEach(event => {
        document.addEventListener(event, () => {
          if (currentUser && Date.now() - lastActivity > 60000) {
            resetSessionTimer();
          }
        }, { passive: true });
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Ï†ëÍ∑º Î°úÍ∑∏ Í∏∞Î°ù
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function logAccess(action, details = null) {
      if (!supabaseConnected || !currentUser) return;
      try {
        await supabaseClient.from('access_logs').insert({
          user_id: currentUser.id,
          user_email: currentUser.email,
          action: action,
          details: details,
          user_agent: navigator.userAgent
        });
      } catch (e) {
        console.warn('Ï†ëÍ∑º Î°úÍ∑∏ Í∏∞Î°ù Ïã§Ìå®:', e);
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Supabase Auth Ïù∏Ï¶ù
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Í¥ÄÎ¶¨Ïûê Ïù¥Î©îÏùº
    const ADMIN_EMAIL = 'greenfordkang@gmail.com';

    async function signIn(email, password) {
      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: password
        });
        if (error) throw error;

        currentUser = data.user;
        await loadUserProfile();

        // Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏïÑÎãàÍ≥† ÏäπÏù∏ÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞
        if (email !== ADMIN_EMAIL && userProfile && !userProfile.approved) {
          await supabaseClient.auth.signOut();
          currentUser = null;
          userProfile = null;
          return { success: false, error: 'Í¥ÄÎ¶¨Ïûê ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ëÏûÖÎãàÎã§. ÏäπÏù∏ ÌõÑ Î°úÍ∑∏Ïù∏Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.' };
        }

        await logAccess('login');

        await supabaseClient.from('user_profiles')
          .update({ last_login: new Date().toISOString() })
          .eq('id', currentUser.id);

        resetSessionTimer();
        setupActivityListeners();

        return { success: true, user: currentUser, isAdmin: email === ADMIN_EMAIL };
      } catch (e) {
        console.error('Î°úÍ∑∏Ïù∏ Ïã§Ìå®:', e);
        return { success: false, error: e.message };
      }
    }

    async function signUp(email, password, displayName) {
      try {
        const { data, error } = await supabaseClient.auth.signUp({
          email: email,
          password: password,
          options: { data: { display_name: displayName } }
        });
        if (error) throw error;
        return { success: true, message: 'ÌöåÏõêÍ∞ÄÏûÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Ïù¥Î©îÏùºÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.' };
      } catch (e) {
        console.error('ÌöåÏõêÍ∞ÄÏûÖ Ïã§Ìå®:', e);
        return { success: false, error: e.message };
      }
    }

    async function signOut() {
      try {
        await logAccess('logout');
        await supabaseClient.auth.signOut();
        currentUser = null;
        userProfile = null;
        clearTimeout(sessionTimer);
        clearTimeout(warningTimer);
        return { success: true };
      } catch (e) {
        console.error('Î°úÍ∑∏ÏïÑÏõÉ Ïã§Ìå®:', e);
        return { success: false, error: e.message };
      }
    }

    async function loadUserProfile() {
      if (!currentUser) return null;
      try {
        const { data, error } = await supabaseClient
          .from('user_profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();
        if (error) throw error;
        userProfile = data;
        return data;
      } catch (e) {
        console.warn('ÌîÑÎ°úÌïÑ Î°úÎìú Ïã§Ìå®:', e);
        return null;
      }
    }

    async function checkAuthSession() {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
          currentUser = session.user;
          await loadUserProfile();

          if (userProfile && !userProfile.is_active) {
            alert('Í≥ÑÏ†ïÏù¥ ÎπÑÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.');
            await signOut();
            return false;
          }

          resetSessionTimer();
          setupActivityListeners();
          return true;
        }
        return false;
      } catch (e) {
        console.error('ÏÑ∏ÏÖò ÌôïÏù∏ Ïã§Ìå®:', e);
        return false;
      }
    }

    async function requestPasswordReset(email) {
      try {
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin
        });
        if (error) throw error;
        return { success: true, message: 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï Ïù¥Î©îÏùºÏùÑ Î∞úÏÜ°ÌñàÏäµÎãàÎã§.' };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    // Í¥ÄÎ¶¨Ïûê Í∏∞Îä•: Ï†ÑÏ≤¥ ÏÇ¨Ïö©Ïûê Î™©Î°ù Ï°∞Ìöå
    async function getAllUsers() {
      try {
        const { data, error } = await supabaseClient
          .from('user_profiles')
          .select('*')
          .order('created_at', { ascending: false });
        if (error) throw error;
        return data || [];
      } catch (e) {
        console.error('ÏÇ¨Ïö©Ïûê Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®:', e);
        return [];
      }
    }

    // Í¥ÄÎ¶¨Ïûê Í∏∞Îä•: ÏÇ¨Ïö©Ïûê ÏäπÏù∏
    async function approveUser(userId) {
      try {
        const { error } = await supabaseClient
          .from('user_profiles')
          .update({ approved: true })
          .eq('id', userId);
        if (error) throw error;
        return { success: true };
      } catch (e) {
        console.error('ÏÇ¨Ïö©Ïûê ÏäπÏù∏ Ïã§Ìå®:', e);
        return { success: false, error: e.message };
      }
    }

    // Í¥ÄÎ¶¨Ïûê Í∏∞Îä•: ÏÇ¨Ïö©Ïûê Í±∞Î∂Ä/ÏÇ≠Ï†ú
    async function rejectUser(userId) {
      try {
        const { error } = await supabaseClient
          .from('user_profiles')
          .update({ approved: false, is_active: false })
          .eq('id', userId);
        if (error) throw error;
        return { success: true };
      } catch (e) {
        console.error('ÏÇ¨Ïö©Ïûê Í±∞Î∂Ä Ïã§Ìå®:', e);
        return { success: false, error: e.message };
      }
    }

    // Í¥ÄÎ¶¨Ïûê Ïó¨Î∂Ä ÌôïÏù∏
    function isAdmin() {
      return currentUser && currentUser.email === ADMIN_EMAIL;
    }

    // Supabase Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
    async function testSupabaseConnection() {
      try {
        const { data, error } = await supabaseClient.from('production_data').select('count', { count: 'exact', head: true });
        if (error) throw error;
        supabaseConnected = true;
        console.log('‚úÖ Supabase Ïó∞Í≤∞ ÏÑ±Í≥µ');
        return true;
      } catch (e) {
        console.warn('‚ö†Ô∏è Supabase Ïó∞Í≤∞ Ïã§Ìå®, localStorage Î™®ÎìúÎ°ú ÎèôÏûë:', e.message);
        supabaseConnected = false;
        return false;
      }
    }

    // ÌÖåÏù¥Î∏îÎ™Ö Îß§Ìïë
    const TABLE_MAPPING = {
      rawData: 'production_data',
      availabilityData: 'availability_data',
      detailData: 'detail_data',  // JSONBÎ°ú Ï†ÄÏû•
      ctData: 'ct_data',
      materialDefectData: 'material_defect_data',
      wipInventoryData: 'wip_inventory_data',
      repairStatusData: 'repair_status_data',
      packagingStatusData: 'packaging_status_data'
    };

    // JSONBÎ°ú Ï†ÄÏû•Ìï¥Ïïº ÌïòÎäî ÌÖåÏù¥Î∏î (ÎèôÏ†Å Ïª¨Îüº)
    const JSONB_TABLES = ['detail_data'];

    // ÌïÑÎìúÎ™Ö Î≥ÄÌôò (camelCase ‚Üí snake_case)
    function toSnakeCase(obj) {
      const result = {};
      for (const key in obj) {
        const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
        result[snakeKey] = obj[key];
      }
      return result;
    }

    // ÌïÑÎìúÎ™Ö Î≥ÄÌôò (snake_case ‚Üí camelCase)
    function toCamelCase(obj) {
      const result = {};
      for (const key in obj) {
        const camelKey = key.replace(/_([a-z])/g, (_, c) => c.toUpperCase());
        result[camelKey] = obj[key];
      }
      return result;
    }

    // SupabaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    async function loadFromSupabase(tableName) {
      if (!supabaseConnected) return null;
      try {
        const { data, error } = await supabaseClient.from(tableName).select('*');
        if (error) throw error;

        // JSONB ÌÖåÏù¥Î∏îÏùÄ data Ïª¨ÎüºÏóêÏÑú Ï∂îÏ∂ú
        if (JSONB_TABLES.includes(tableName)) {
          return data.map(row => row.data);
        }
        return data.map(toCamelCase);
      } catch (e) {
        console.error(`Supabase Î°úÎìú Ïã§Ìå® (${tableName}):`, e);
        return null;
      }
    }

    // SupabaseÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (Ï†ÑÏ≤¥ ÍµêÏ≤¥)
    async function saveToSupabase(tableName, data) {
      if (!supabaseConnected || !data || data.length === 0) return false;
      try {
        // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
        await supabaseClient.from(tableName).delete().neq('id', 0);

        // JSONB ÌÖåÏù¥Î∏îÏùÄ data Ïª¨ÎüºÏóê Ï†ÑÏ≤¥ Í∞ùÏ≤¥ Ï†ÄÏû•
        let insertData;
        if (JSONB_TABLES.includes(tableName)) {
          insertData = data.map(item => ({ data: item }));
        } else {
          insertData = data.map(toSnakeCase);
        }

        const { error } = await supabaseClient.from(tableName).insert(insertData);
        if (error) throw error;
        console.log(`‚úÖ Supabase Ï†ÄÏû• ÏôÑÎ£å (${tableName}): ${data.length}Í±¥`);
        return true;
      } catch (e) {
        console.error(`Supabase Ï†ÄÏû• Ïã§Ìå® (${tableName}):`, e);
        return false;
      }
    }

    // Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî (localStorage ‚Üî Supabase)
    async function syncWithSupabase() {
      if (!supabaseConnected) return;

      const syncStatus = document.getElementById('sync-status');
      if (syncStatus) syncStatus.textContent = 'ÎèôÍ∏∞Ìôî Ï§ë...';

      try {
        // Í∞Å Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖÎ≥Ñ ÎèôÍ∏∞Ìôî
        for (const [stateKey, tableName] of Object.entries(TABLE_MAPPING)) {
          const localData = state[stateKey] || [];
          if (localData.length > 0) {
            await saveToSupabase(tableName, localData);
          }
        }
        if (syncStatus) syncStatus.textContent = 'ÎèôÍ∏∞Ìôî ÏôÑÎ£å ‚úì';
        setTimeout(() => { if (syncStatus) syncStatus.textContent = ''; }, 3000);
      } catch (e) {
        console.error('ÎèôÍ∏∞Ìôî Ïã§Ìå®:', e);
        if (syncStatus) syncStatus.textContent = 'ÎèôÍ∏∞Ìôî Ïã§Ìå®';
      }
    }

    // SupabaseÏóêÏÑú Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
    async function loadAllFromSupabase() {
      if (!supabaseConnected) return false;

      try {
        for (const [stateKey, tableName] of Object.entries(TABLE_MAPPING)) {
          const data = await loadFromSupabase(tableName);
          if (data && data.length > 0) {
            state[stateKey] = data;
            console.log(`üì• ${tableName}: ${data.length}Í±¥ Î°úÎìú`);
          }
        }
        return true;
      } catch (e) {
        console.error('Supabase Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
        return false;
      }
    }

    // localStorage ÌÇ§
    const STORAGE_KEY = 'mes_dashboard_data';
    const AVAILABILITY_KEY = 'mes_availability_data';
    const DETAIL_DATA_KEY = 'mes_detail_data';
    const CT_DATA_KEY = 'mes_ct_data';
    const AUTH_KEY = 'mes_dashboard_auth';
    const MATERIAL_DEFECT_KEY = 'mes_material_defect_data';  // Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ
    const WIP_INVENTORY_KEY = 'mes_wip_inventory_data';      // Ïû¨Í≥µÏû¨Í≥†Í∏àÏï°
    const REPAIR_STATUS_KEY = 'mes_repair_status_data';      // Î∂àÎüâÏàòÎ¶¨ÌòÑÌô©
    const PACKAGING_STATUS_KEY = 'mes_packaging_status_data'; // Í≤ÄÌè¨Ïû•ÌòÑÌô©

    // localStorageÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    function loadFromStorage() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
        return [];
      }
    }

    // localStorageÏóêÏÑú Í∞ÄÎèôÏú® Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    function loadAvailabilityFromStorage() {
      try {
        const saved = localStorage.getItem(AVAILABILITY_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('Í∞ÄÎèôÏú® Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
        return [];
      }
    }

    // localStorageÏóêÏÑú ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    function loadDetailFromStorage() {
      try {
        const saved = localStorage.getItem(DETAIL_DATA_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
        return [];
      }
    }

    // localStorageÏóêÏÑú CT Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    function loadCTFromStorage() {
      try {
        const saved = localStorage.getItem(CT_DATA_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('CT Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
        return [];
      }
    }

    // localStorageÏóê CT Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    function saveCTToStorage(data) {
      try {
        localStorage.setItem(CT_DATA_KEY, JSON.stringify(data));
        console.log('CT Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å:', data.length + 'Í±¥');
      } catch (e) {
        console.error('CT Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', e);
      }
    }

    // Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ Îç∞Ïù¥ÌÑ∞ Î°úÎìú/Ï†ÄÏû•
    function loadMaterialDefectFromStorage() {
      try {
        const saved = localStorage.getItem(MATERIAL_DEFECT_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
        return [];
      }
    }
    function saveMaterialDefectToStorage(data) {
      try {
        localStorage.setItem(MATERIAL_DEFECT_KEY, JSON.stringify(data));
        console.log('Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å:', data.length + 'Í±¥');
      } catch (e) {
        console.error('Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', e);
      }
    }

    // Ïû¨Í≥µÏû¨Í≥†Í∏àÏï° Îç∞Ïù¥ÌÑ∞ Î°úÎìú/Ï†ÄÏû•
    function loadWipInventoryFromStorage() {
      try {
        const saved = localStorage.getItem(WIP_INVENTORY_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('Ïû¨Í≥µÏû¨Í≥†Í∏àÏï° Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
        return [];
      }
    }
    function saveWipInventoryToStorage(data) {
      try {
        localStorage.setItem(WIP_INVENTORY_KEY, JSON.stringify(data));
        console.log('Ïû¨Í≥µÏû¨Í≥†Í∏àÏï° Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å:', data.length + 'Í±¥');
      } catch (e) {
        console.error('Ïû¨Í≥µÏû¨Í≥†Í∏àÏï° Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', e);
      }
    }

    // Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Î°úÎìú/Ï†ÄÏû•
    function loadRepairStatusFromStorage() {
      try {
        const saved = localStorage.getItem(REPAIR_STATUS_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
        return [];
      }
    }
    function saveRepairStatusToStorage(data) {
      try {
        localStorage.setItem(REPAIR_STATUS_KEY, JSON.stringify(data));
        console.log('Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å:', data.length + 'Í±¥');
      } catch (e) {
        console.error('Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', e);
      }
    }

    // Í≤ÄÌè¨Ïû•ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Î°úÎìú/Ï†ÄÏû•
    function loadPackagingStatusFromStorage() {
      try {
        const saved = localStorage.getItem(PACKAGING_STATUS_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('Í≤ÄÌè¨Ïû•ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
        return [];
      }
    }
    function savePackagingStatusToStorage(data) {
      try {
        localStorage.setItem(PACKAGING_STATUS_KEY, JSON.stringify(data));
        console.log('Í≤ÄÌè¨Ïû•ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å:', data.length + 'Í±¥');
      } catch (e) {
        console.error('Í≤ÄÌè¨Ïû•ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', e);
      }
    }

    // localStorageÏóê ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    function saveDetailToStorage(data) {
      try {
        localStorage.setItem(DETAIL_DATA_KEY, JSON.stringify(data));
        console.log('ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å:', data.length + 'Í±¥');
      } catch (e) {
        console.error('ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', e);
        try {
          localStorage.setItem(DETAIL_DATA_KEY, JSON.stringify(data.slice(-3000)));
        } catch (e2) {
          console.error('Ï∂ïÏÜå Ï†ÄÏû•ÎèÑ Ïã§Ìå®:', e2);
        }
      }
    }

    // localStorageÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    function saveToStorage(data) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        console.log('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å:', data.length + 'Í±¥');
      } catch (e) {
        console.error('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', e);
        alert('Îç∞Ïù¥ÌÑ∞Í∞Ä ÎÑàÎ¨¥ Ïª§ÏÑú Ï†ÄÏû•Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data.slice(-5000)));
        } catch (e2) {
          console.error('Ï∂ïÏÜå Ï†ÄÏû•ÎèÑ Ïã§Ìå®:', e2);
        }
      }
    }

    // localStorageÏóê Í∞ÄÎèôÏú® Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    function saveAvailabilityToStorage(data) {
      try {
        localStorage.setItem(AVAILABILITY_KEY, JSON.stringify(data));
        console.log('Í∞ÄÎèôÏú® Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å:', data.length + 'Í±¥');
      } catch (e) {
        console.error('Í∞ÄÎèôÏú® Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', e);
      }
    }

    // Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
    function clearStorage() {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(AVAILABILITY_KEY);
      localStorage.removeItem(DETAIL_DATA_KEY);
      localStorage.removeItem(CT_DATA_KEY);
      localStorage.removeItem(MATERIAL_DEFECT_KEY);
      localStorage.removeItem(WIP_INVENTORY_KEY);
      localStorage.removeItem(REPAIR_STATUS_KEY);
      localStorage.removeItem(PACKAGING_STATUS_KEY);
      state.rawData = [];
      state.availabilityData = [];
      state.detailData = [];
      state.ctData = [];
      state.materialDefectData = [];
      state.wipInventoryData = [];
      state.repairStatusData = [];
      state.packagingStatusData = [];
      render();
    }

    // Í≥µÌÜµ ÌïòÏúÑÎ©îÎâ¥ (Î™®Îì† Í≥µÏ†ï)
    const commonSubMenus = [
      { id: 'production', name: 'ÏÉùÏÇ∞ÌòÑÌô©', icon: 'üìä' },
      { id: 'uph', name: 'UPHÌòÑÌô©', icon: '‚ö°' },
      { id: 'cycletime', name: 'Cycle Time', icon: '‚è±Ô∏è' },
      { id: 'packaging', name: 'Í≤ÄÌè¨Ïû•ÌòÑÌô©', icon: 'üì¶' }
    ];

    // Ï°∞Î¶ΩÍ≥µÏ†ï Ï∂îÍ∞Ä ÌïòÏúÑÎ©îÎâ¥
    const assemblyExtraMenus = [
      { id: 'defect-repair', name: 'Î∂àÎüâÏàòÎ¶¨ÌòÑÌô©', icon: 'üîß' },
      { id: 'material-defect', name: 'ÏûêÏû¨Î∂àÎüâÌòÑÌô©', icon: '‚ö†Ô∏è' }
    ];

    // Í≥µÏ†ï ÏÑúÎ∏åÎ©îÎâ¥ Ï†ïÏùò (Laser Ï†úÏô∏)
    const processMenus = [
      { id: 'injection', name: 'ÏÇ¨Ï∂úÍ≥µÏ†ï', icon: 'üíâ', color: '#3B82F6', subMenus: [...commonSubMenus] },
      { id: 'painting', name: 'ÎèÑÏû•Í≥µÏ†ï', icon: 'üé®', color: '#10B981', subMenus: [...commonSubMenus] },
      { id: 'printing', name: 'Ïù∏ÏáÑÍ≥µÏ†ï', icon: 'üñ®Ô∏è', color: '#F59E0B', subMenus: [...commonSubMenus] },
      { id: 'assembly', name: 'Ï°∞Î¶ΩÍ≥µÏ†ï', icon: 'üîß', color: '#EF4444', subMenus: [...commonSubMenus, ...assemblyExtraMenus] }
    ];

    // Í≥µÏ†ï Îç∞Ïù¥ÌÑ∞ Îß§Ìïë (Laser Ï†úÏô∏)
    const processDataMapping = {
      'injection': 'ÏÇ¨Ï∂ú',
      'painting': 'ÎèÑÏû•',
      'printing': 'Ïù∏ÏáÑ',
      'assembly': 'Ï°∞Î¶Ω'
    };

    // ÏßëÍ≥ÑÏóêÏÑú Ï†úÏô∏Ìï† Í≥µÏ†ï
    const excludedProcesses = ['Laser', 'LASER', 'laser', 'Ïù∏ÏáÑ'];

    // ÏÉÅÌÉú Í¥ÄÎ¶¨
    let state = {
      isAuthenticated: false,  // Supabase AuthÎ°ú Í¥ÄÎ¶¨
      activeTab: 'overview',
      activeProcess: null,
      activeSubMenu: 'production',  // Í∏∞Î≥∏Í∞í: ÏÉùÏÇ∞ÌòÑÌô©
      wipSubTab: 'status',  // Ïû¨Í≥µÏû¨Í≥† ÌïòÏúÑÌÉ≠: status(ÌòÑÌô©), price(Îã®Í∞ÄÌëú)
      rawData: loadFromStorage(),
      availabilityData: loadAvailabilityFromStorage(),
      detailData: loadDetailFromStorage(),
      ctData: loadCTFromStorage(),
      materialDefectData: loadMaterialDefectFromStorage(),
      wipInventoryData: loadWipInventoryFromStorage(),
      repairStatusData: loadRepairStatusFromStorage(),
      packagingStatusData: loadPackagingStatusFromStorage(),
      filters: { process: 'all', equipment: 'all', product: 'all' },
      selectedMonth: new Date().getMonth() + 1,  // ÌòÑÏû¨ Ïõî Í∏∞Î≥∏Í∞í (1-12)
      pivot: {
        rows: 'Í≥µÏ†ï',
        cols: 'ÌíàÏ¢Ö',
        values: 'ÏÉùÏÇ∞ÏàòÎüâ',
        aggFunc: 'sum'
      }
    };

    // Ïõî ÏÑ†ÌÉù Î≥ÄÍ≤Ω
    function setSelectedMonth(month) {
      state.selectedMonth = parseInt(month);
      render();
    }

    // ÌîºÎ¥á ÏÑ§Ï†ï Î≥ÄÍ≤Ω
    function setPivotConfig(key, value) {
      state.pivot[key] = value;
      render();
    }

    // Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ÄÏû•
    let charts = {};

    // CSV ÌååÏã±
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = lines[0].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = [];
        let current = '';
        let inQuotes = false;

        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        if (values.length >= 20) {
          const row = {};
          headers.forEach((header, index) => {
            let value = values[index] || '';
            value = value.replace(/,/g, '').replace(/"/g, '');
            row[header] = value;
          });

          if (row['ÌíàÎ™©Î™Ö'] !== 'TOTAL' && row['ÏÉùÏÇ∞ÏùºÏûê']) {
            data.push({
              date: row['ÏÉùÏÇ∞ÏùºÏûê'] || '',
              process: row['Í≥µÏ†ï'] || '',
              itemCode: row['ÌíàÎ™©ÏΩîÎìú'] || '',
              itemName: row['ÌíàÎ™©Î™Ö'] || '',
              equipment: row['ÏÑ§ÎπÑ/LINE'] || '',
              productType: row['ÌíàÏ¢Ö'] || 'Í∏∞ÌÉÄ',
              standardQty: parseFloat(row['ÌëúÏ§ÄÏÉùÏÇ∞Îüâ']) || 0,
              productionQty: parseFloat(row['ÏÉùÏÇ∞ÏàòÎüâ']) || 0,
              goodQty: parseFloat(row['ÏñëÌíàÏàòÎüâ']) || 0,
              defectQty: parseFloat(row['Î∂àÎüâÏàòÎüâ']) || 0,
              disposalQty: parseFloat(row['ÌèêÍ∏∞ÏàòÎüâ']) || 0,
              yieldRate: parseFloat(row['ÏàòÏú®(%)']) || 0,
            });
          }
        }
      }
      return data;
    }

    // Í∞ÄÎèôÏú® CSV ÌååÏã±
    function parseAvailabilityCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 3) return [];

      // Ìó§ÎçîÎäî 2Î≤àÏß∏ Ï§Ñ (Ïù∏Îç±Ïä§ 1)
      const headers = lines[1].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));
      const data = [];

      for (let i = 2; i < lines.length; i++) {
        const values = [];
        let current = '';
        let inQuotes = false;

        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          let value = values[index] || '';
          value = value.replace(/,/g, '').replace(/"/g, '');
          row[header] = value;
        });

        // TOTAL Ìñâ Ï†úÏô∏, Í≥µÏ†ïÏù¥ ÏûàÎäî ÌñâÎßå
        if (row['Í≥µÏ†ï'] && row['Í≥µÏ†ï'] !== '' && row['ÏÑ§ÎπÑ/LINE'] !== 'TOTAL') {
          data.push({
            date: row['ÏÉùÏÇ∞ÏùºÏûê'] || '',
            process: row['Í≥µÏ†ï'] || '',
            equipment: row['ÏÑ§ÎπÑ/LINE'] || '',
            operatingTime: parseFloat(row['Ï°∞ÏóÖÏãúÍ∞Ñ(Î∂Ñ)']) || 0,
            runningTime: parseFloat(row['Í∞ÄÎèôÏãúÍ∞Ñ(Î∂Ñ)']) || 0,
            timeAvailability: parseFloat(row['ÏãúÍ∞ÑÍ∞ÄÎèôÏú®(%)']) || 0,
            equipmentAvailability: parseFloat(row['ÏÑ§ÎπÑÍ∞ÄÎèôÏú®(%)']) || 0
          });
        }
      }
      return data;
    }

    // CT ÌòÑÌô© CSV ÌååÏã±
    function parseCTCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 3) return [];

      // Ìó§ÎçîÎäî 2Î≤àÏß∏ Ï§Ñ (Ïù∏Îç±Ïä§ 1)
      const headers = lines[1].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));
      const data = [];

      for (let i = 2; i < lines.length; i++) {
        const values = [];
        let current = '';
        let inQuotes = false;

        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          let value = values[index] || '';
          value = value.replace(/,/g, '').replace(/"/g, '');
          row[header] = value;
        });

        // Í≥µÏ†ïÍµ¨Î∂ÑÍ≥º ÏÑ§ÎπÑÎ™Ö(ÎòêÎäî ÎùºÏù∏Î™Ö)Ïù¥ ÏûàÎäî ÌñâÎßå
        const equipmentName = row['ÏÑ§ÎπÑÎ™Ö'] || row['ÎùºÏù∏Î™Ö'] || '';
        if (row['Í≥µÏ†ïÍµ¨Î∂Ñ'] && equipmentName) {
          const standardCT = parseFloat(row['ÌëúÏ§Ä C/T[Ï¥à]']) || 0;
          const actualCT = parseFloat(row['Ïã§Ï†ú C/T[Ï¥à]']) || 0;
          const efficiency = parseFloat(row['Ìö®Ïú®[%]']) || (standardCT > 0 && actualCT > 0 ? (standardCT / actualCT * 100) : 0);

          data.push({
            process: row['Í≥µÏ†ïÍµ¨Î∂Ñ'] || '',
            product: row['ÌíàÏ¢Ö'] || '',
            partCode: row['Î∂ÄÌíàÏΩîÎìú'] || '',
            partName: row['Î∂ÄÌíàÎ™Ö'] || row['Í≥†Í∞ùÏÇ¨ P/N'] || '',
            equipment: equipmentName,
            cavity: parseInt(row['ÏÇ¨Ïö©CAVITY']) || 1,
            standardCT: standardCT,
            actualCT: actualCT,
            efficiency: efficiency,
            workTime: parseFloat(row['ÏûëÏóÖÏãúÍ∞Ñ[Î∂Ñ]']) || 0,
            quantity: parseInt(row['ÏÉùÏÇ∞ÏàòÎüâ']?.replace(/,/g, '')) || 0
          });
        }
      }
      return data;
    }

    // CT CSV ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨ (Í∏∞Ï°¥ - Î™®Îì† Í≥µÏ†ï ÌÜµÌï©)
    function handleCTUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        const newData = parseCTCSV(e.target.result);
        if (newData.length > 0) {
          state.ctData = newData;
          saveCTToStorage(newData);
          alert(`CT ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ ${newData.length}Í±¥Ïù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
          render();
          setTimeout(() => { createCharts(); initTableSort(); }, 100);
          // Supabase ÎèôÍ∏∞Ìôî
          if (supabaseConnected) await saveToSupabase('ct_data', newData);
        } else {
          alert('Ïú†Ìö®Ìïú CT Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // Í≥µÏ†ïÎ≥Ñ CT Îç∞Ïù¥ÌÑ∞ Í∞úÏàò Ï°∞Ìöå
    function getCTCountByProcess(processName) {
      if (!state.ctData || state.ctData.length === 0) return 0;
      return state.ctData.filter(d => d.process === processName).length;
    }

    // Í≥µÏ†ïÎ≥Ñ CT CSV ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
    function handleCTUploadByProcess(event, processName) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const newData = parseCTCSV(e.target.result);
        if (newData.length > 0) {
          // ÏóÖÎ°úÎìúÎêú Îç∞Ïù¥ÌÑ∞Ïóê Í≥µÏ†ïÎ™Ö Í∞ïÏ†ú ÏßÄÏ†ï (ÌååÏùºÏóê Í≥µÏ†ïÍµ¨Î∂ÑÏù¥ ÏóÜÍ±∞ÎÇò Îã§Î•º Í≤ΩÏö∞ ÎåÄÎπÑ)
          const processedData = newData.map(d => ({
            ...d,
            process: processName
          }));

          // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ìï¥Îãπ Í≥µÏ†ï Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞ ÌõÑ ÏÉà Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
          const otherProcessData = state.ctData.filter(d => d.process !== processName);
          state.ctData = [...otherProcessData, ...processedData];
          saveCTToStorage(state.ctData);

          alert(`${processName} Í≥µÏ†ï CT Îç∞Ïù¥ÌÑ∞ ${processedData.length}Í±¥Ïù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
          render();
          setTimeout(() => { createCharts(); initTableSort(); }, 100);
        } else {
          alert('Ïú†Ìö®Ìïú CT Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // Í≥µÏ†ïÎ≥Ñ CT Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
    function deleteCTByProcess(processName) {
      if (!confirm(`${processName} Í≥µÏ†ï CT Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
      state.ctData = state.ctData.filter(d => d.process !== processName);
      saveCTToStorage(state.ctData);
      render();
      setTimeout(() => { createCharts(); initTableSort(); }, 100);
    }

    // Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ CSV ÌååÏã±
    function parseMaterialDefectCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = [];
      let current = '';
      let inQuotes = false;
      for (let char of lines[0]) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headers.push(current.trim().replace(/^\uFEFF/, '')); current = ''; }
        else current += char;
      }
      headers.push(current.trim());

      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = [];
        current = '';
        inQuotes = false;
        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          if (header && header !== '') {
            let value = values[index] || '';
            value = value.replace(/,/g, '').replace(/"/g, '');
            row[header] = value;
          }
        });

        if (row['Î∂ÄÌíàÏΩîÎìú'] && row['Î∂ÄÌíàÏΩîÎìú'] !== '') {
          data.push({
            partCode: row['Î∂ÄÌíàÏΩîÎìú'] || '',
            customerPN: row['Í≥†Í∞ùÏÇ¨ P/N'] || '',
            partName: row['Î∂ÄÌíàÎ™Ö'] || '',
            spec: row['Í∑úÍ≤©'] || '',
            date: row['ÏÉùÏÇ∞ÏùºÏûê'] || '',
            defectTotal: parseInt(row['Î∂àÎüâÌï©Í≥Ñ']?.replace(/,/g, '')) || 0,
            rawData: row
          });
        }
      }
      return data;
    }

    // Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
    function handleMaterialDefectUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const data = parseMaterialDefectCSV(e.target.result);
        if (data.length > 0) {
          state.materialDefectData = data;
          saveMaterialDefectToStorage(data);
          alert(`Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ Îç∞Ïù¥ÌÑ∞ ${data.length}Í±¥Ïù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
          render();
          setTimeout(() => { initTableSort(); }, 100);
          // Supabase ÎèôÍ∏∞Ìôî
          if (supabaseConnected) await saveToSupabase('material_defect_data', data);
        } else {
          alert('Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // Ïû¨Í≥µÏû¨Í≥†Í∏àÏï° CSV ÌååÏã±
    function parseWipInventoryCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = [];
      let current = '';
      let inQuotes = false;
      for (let char of lines[0]) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headers.push(current.trim().replace(/^\uFEFF/, '')); current = ''; }
        else current += char;
      }
      headers.push(current.trim());

      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = [];
        current = '';
        inQuotes = false;
        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          if (header && header !== '') {
            let value = values[index] || '';
            value = value.replace(/"/g, '');
            row[header] = value;
          }
        });

        if (row['ÌíàÎ™©ÏΩîÎìú'] && row['ÌíàÎ™©ÏΩîÎìú'] !== '') {
          data.push({
            itemType: row['ÌíàÎ™©Ïú†Ìòï'] || '',
            itemCode: row['ÌíàÎ™©ÏΩîÎìú'] || '',
            customerPN: row['Í≥†Í∞ùÏÇ¨ P/N'] || '',
            itemName: row['ÌíàÎ™©Î™Ö'] || '',
            spec: row['Í∑úÍ≤©'] || '',
            stock: parseInt(row['Ïû¨Í≥†']?.replace(/,/g, '')) || 0,
            unitCost: parseInt(row['Ï†úÏ°∞ÏõêÍ∞Ä']?.replace(/,/g, '')) || 0,
            stockValue: parseInt(row['Ïû¨Í≥†Í∏àÏï°']?.replace(/,/g, '')) || 0
          });
        }
      }
      return data;
    }

    // Ïû¨Í≥µÏû¨Í≥†Í∏àÏï° ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
    function handleWipInventoryUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const data = parseWipInventoryCSV(e.target.result);
        if (data.length > 0) {
          state.wipInventoryData = data;
          saveWipInventoryToStorage(data);
          alert(`Ïû¨Í≥µÏû¨Í≥†Í∏àÏï° Îç∞Ïù¥ÌÑ∞ ${data.length}Í±¥Ïù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
          render();
          setTimeout(() => { initTableSort(); }, 100);
          // Supabase ÎèôÍ∏∞Ìôî
          if (supabaseConnected) await saveToSupabase('wip_inventory_data', data);
        } else {
          alert('Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© CSV ÌååÏã±
    function parseRepairStatusCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = [];
      let current = '';
      let inQuotes = false;
      for (let char of lines[0]) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headers.push(current.trim().replace(/^\uFEFF/, '')); current = ''; }
        else current += char;
      }
      headers.push(current.trim());

      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = [];
        current = '';
        inQuotes = false;
        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          if (header && header !== '') {
            let value = values[index] || '';
            value = value.replace(/"/g, '');
            row[header] = value;
          }
        });

        if (row['Î∂ÄÌíàÏΩîÎìú'] && row['Î∂ÄÌíàÏΩîÎìú'] !== '') {
          data.push({
            itemType: row['ÌíàÎ™©Ïú†Ìòï'] || '',
            partCode: row['Î∂ÄÌíàÏΩîÎìú'] || '',
            customerPN: row['Í≥†Í∞ùÏÇ¨ P/N'] || '',
            partName: row['Î∂ÄÌíàÎ™Ö'] || '',
            spec: row['Í∑úÍ≤©'] || '',
            date: row['ÏÉùÏÇ∞ÏùºÏûê'] || '',
            workOrder: row['ÏûëÏóÖÏßÄÏãúÎ≤àÌò∏'] || '',
            productionQty: parseInt(row['ÏÉùÏÇ∞ÏàòÎüâ']?.replace(/,/g, '')) || 0,
            repairQty: parseInt(row['ÏàòÎ¶¨ÏàòÎüâ']?.replace(/,/g, '')) || 0
          });
        }
      }
      return data;
    }

    // Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
    function handleRepairStatusUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const data = parseRepairStatusCSV(e.target.result);
        if (data.length > 0) {
          state.repairStatusData = data;
          saveRepairStatusToStorage(data);
          alert(`Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ ${data.length}Í±¥Ïù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
          render();
          setTimeout(() => { initTableSort(); }, 100);
          // Supabase ÎèôÍ∏∞Ìôî
          if (supabaseConnected) await saveToSupabase('repair_status_data', data);
        } else {
          alert('Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // Í≤ÄÌè¨Ïû•ÌòÑÌô© CSV ÌååÏã±
    function parsePackagingStatusCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = [];
      let current = '';
      let inQuotes = false;
      for (let char of lines[0]) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headers.push(current.trim().replace(/^\uFEFF/, '')); current = ''; }
        else current += char;
      }
      headers.push(current.trim());

      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = [];
        current = '';
        inQuotes = false;
        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          if (header && header !== '') {
            let value = values[index] || '';
            value = value.replace(/"/g, '');
            row[header] = value;
          }
        });

        if (row['ÌíàÎ™©ÏΩîÎìú'] && row['ÌíàÎ™©ÏΩîÎìú'] !== '') {
          // ÏÉùÏÇ∞ Lot NoÏóêÏÑú ÎÇ†Ïßú Ï∂îÏ∂ú (1PMA260102004 -> 2026-01-02)
          const lotNo = row['ÏÉùÏÇ∞ Lot No'] || '';
          let productionDate = '';
          if (lotNo.length >= 11) {
            const yearPart = lotNo.substring(3, 5);
            const monthPart = lotNo.substring(5, 7);
            const dayPart = lotNo.substring(7, 9);
            productionDate = `2026-${monthPart}-${dayPart}`;
          }

          data.push({
            process: row['Í≥µÏ†ï'] || '',
            processType: row['Í≥µÏ†ïÍµ¨Î∂Ñ'] || '',
            itemCode: row['ÌíàÎ™©ÏΩîÎìú'] || '',
            customerPN: row['Í≥†Í∞ùÏÇ¨ P/N'] || '',
            itemName: row['ÌíàÎ™©Î™Ö'] || '',
            lotNo: lotNo,
            equipmentCode: row['ÏÑ§ÎπÑ(ÎùºÏù∏)ÏΩîÎìú'] || '',
            equipmentName: row['ÏÑ§ÎπÑ(ÎùºÏù∏)Î™Ö'] || '',
            defectQty: parseInt(row['Î∂àÎüâÏàòÎüâ']?.replace(/,/g, '')) || 0,
            repairQty: parseInt(row['ÏàòÎ¶¨ÏàòÎüâ']?.replace(/,/g, '')) || 0,
            disposalQty: parseInt(row['ÌèêÍ∏∞ÏàòÎüâ']?.replace(/,/g, '')) || 0,
            productionDate: productionDate
          });
        }
      }
      return data;
    }

    // Í≤ÄÌè¨Ïû•ÌòÑÌô© ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
    function handlePackagingStatusUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const data = parsePackagingStatusCSV(e.target.result);
        if (data.length > 0) {
          state.packagingStatusData = data;
          savePackagingStatusToStorage(data);
          alert(`Í≤ÄÌè¨Ïû•ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ ${data.length}Í±¥Ïù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
          render();
          setTimeout(() => { createCharts(); initTableSort(); }, 100);
          // Supabase ÎèôÍ∏∞Ìôî
          if (supabaseConnected) await saveToSupabase('packaging_status_data', data);
        } else {
          alert('Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // ÏóÖÏ¢ÖÎ≥Ñ ÏÉÅÏÑ∏ CSV ÌååÏã±
    function parseDetailCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      // Ìó§Îçî ÌååÏã± (Ï≤´ Î≤àÏß∏ ÎòêÎäî Îëê Î≤àÏß∏ Ï§Ñ)
      let headerLine = lines[0];
      let startRow = 1;
      if (headerLine.split(',')[1] === 'ÏÇ¨ÏóÖÏû•' || lines[1].split(',')[1] === 'ÏÇ¨ÏóÖÏû•') {
        headerLine = lines[1].includes('ÏÇ¨ÏóÖÏû•') ? lines[1] : lines[0];
        startRow = headerLine === lines[1] ? 2 : 1;
      }

      const headers = [];
      let current = '';
      let inQuotes = false;
      for (let char of headerLine) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headers.push(current.trim().replace(/^\uFEFF/, '')); current = ''; }
        else current += char;
      }
      headers.push(current.trim());

      const data = [];
      for (let i = startRow; i < lines.length; i++) {
        const values = [];
        current = '';
        inQuotes = false;
        for (let char of lines[i]) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
          else current += char;
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, index) => {
          if (header && header !== '') {
            let value = values[index] || '';
            value = value.replace(/,/g, '').replace(/"/g, '');
            row[header] = value;
          }
        });

        // Îπà ÌñâÏù¥ ÏïÑÎãå Í≤ΩÏö∞Îßå Ï∂îÍ∞Ä
        if (row['Í≥µÏ†ï'] && row['Í≥µÏ†ï'] !== '') {
          data.push(row);
        }
      }
      return data;
    }

    // ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
    function handleDetailUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const text = e.target.result;
        const data = parseDetailCSV(text);

        if (data.length > 0) {
          state.detailData = data;
          saveDetailToStorage(data);
          alert(`ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ ${data.length}Í±¥Ïù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
          render();
          // Supabase ÎèôÍ∏∞Ìôî
          if (supabaseConnected) await saveToSupabase('detail_data', data);
        } else {
          alert('Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        }
      };
      reader.readAsText(file, 'UTF-8');
      event.target.value = '';
    }

    // ÌîºÎ¥á ÌÖåÏù¥Î∏î ÏÉùÏÑ±
    function generatePivotTable(data, rowField, colField, valueField, aggFunc) {
      if (!data || data.length === 0) return { rows: [], cols: [], values: {} };

      // Ïú†ÎãàÌÅ¨ Ìñâ/Ïó¥ Í∞í Ï∂îÏ∂ú
      const rowValues = [...new Set(data.map(d => d[rowField] || '(ÏóÜÏùå)'))].sort();
      const colValues = [...new Set(data.map(d => d[colField] || '(ÏóÜÏùå)'))].sort();

      // ÌîºÎ¥á Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞
      const pivotData = {};
      const rowTotals = {};
      const colTotals = {};
      let grandTotal = 0;

      rowValues.forEach(r => {
        pivotData[r] = {};
        rowTotals[r] = { sum: 0, count: 0 };
        colValues.forEach(c => {
          pivotData[r][c] = { sum: 0, count: 0 };
        });
      });
      colValues.forEach(c => {
        colTotals[c] = { sum: 0, count: 0 };
      });

      // Îç∞Ïù¥ÌÑ∞ ÏßëÍ≥Ñ
      data.forEach(d => {
        const r = d[rowField] || '(ÏóÜÏùå)';
        const c = d[colField] || '(ÏóÜÏùå)';
        let v = parseFloat(String(d[valueField] || '0').replace(/,/g, '')) || 0;

        if (pivotData[r] && pivotData[r][c]) {
          pivotData[r][c].sum += v;
          pivotData[r][c].count++;
          rowTotals[r].sum += v;
          rowTotals[r].count++;
          colTotals[c].sum += v;
          colTotals[c].count++;
          grandTotal += v;
        }
      });

      // ÏßëÍ≥Ñ Ìï®Ïàò Ï†ÅÏö©
      const getValue = (obj) => {
        if (aggFunc === 'sum') return obj.sum;
        if (aggFunc === 'count') return obj.count;
        if (aggFunc === 'avg') return obj.count > 0 ? obj.sum / obj.count : 0;
        return obj.sum;
      };

      return {
        rows: rowValues,
        cols: colValues,
        values: pivotData,
        rowTotals,
        colTotals,
        grandTotal,
        getValue
      };
    }

    // ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ ÌïÑÎìú Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
    function getDetailFields() {
      if (state.detailData.length === 0) return [];
      return Object.keys(state.detailData[0]).filter(k => k && k !== '');
    }

    // Ïà´Ïûê ÌïÑÎìú Î™©Î°ù (ÌîºÎ¥á Í∞íÏúºÎ°ú ÏÇ¨Ïö©)
    function getNumericFields() {
      const numericCandidates = ['ÏÉùÏÇ∞ÏàòÎüâ', 'ÏñëÌíàÏàòÎüâ', 'Î∂àÎüâÏàòÎüâ', 'ÌèêÍ∏∞ÏàòÎüâ', 'ÏûëÏóÖÏãúÍ∞Ñ(Î∂Ñ)', 'ÏûëÏóÖÏù∏Ïõê', 'UPH', 'UPPH', 'Î∂àÎüâÏú®', 'ÌèêÍ∏∞Ïú®'];
      const fields = getDetailFields();
      return fields.filter(f => numericCandidates.includes(f) ||
        (state.detailData.length > 0 && !isNaN(parseFloat(String(state.detailData[0][f] || '0').replace(/,/g, '')))));
    }

    // Í≥µÏ†ïÎ≥Ñ ÏãúÍ∞ÑÍ∞ÄÎèôÏú® Í≥ÑÏÇ∞ (Í∞ÄÎèôÏú® Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò - CSVÏùò ÏãúÍ∞ÑÍ∞ÄÎèôÏú®(%) Í∞í ÏÇ¨Ïö©)
    function getProcessAvailability() {
      if (state.availabilityData.length === 0) return {};

      const grouped = {};
      state.availabilityData.forEach(row => {
        if (!grouped[row.process]) {
          grouped[row.process] = {
            totalOperatingTime: 0,
            weightedAvailability: 0,
            count: 0,
            sumAvailability: 0
          };
        }
        grouped[row.process].totalOperatingTime += row.operatingTime;
        // Í∞ÄÏ§ë ÌèâÍ∑†ÏùÑ ÏúÑÌï¥ Ï°∞ÏóÖÏãúÍ∞Ñ * ÏãúÍ∞ÑÍ∞ÄÎèôÏú® ÎàÑÏ†Å
        grouped[row.process].weightedAvailability += row.timeAvailability * row.operatingTime;
        grouped[row.process].count++;
        grouped[row.process].sumAvailability += row.timeAvailability;
      });

      const result = {};
      Object.keys(grouped).forEach(process => {
        const g = grouped[process];
        // Í∞ÄÏ§ë ÌèâÍ∑† ÏãúÍ∞ÑÍ∞ÄÎèôÏú® (Ï°∞ÏóÖÏãúÍ∞Ñ Í∏∞Ï§ÄÏúºÎ°ú CSVÏùò ÏãúÍ∞ÑÍ∞ÄÎèôÏú® Í∞í ÏÇ¨Ïö©)
        result[process] = g.totalOperatingTime > 0
          ? g.weightedAvailability / g.totalOperatingTime
          : (g.count > 0 ? g.sumAvailability / g.count : 0);
      });
      return result;
    }

    // ÏõîÎ≥Ñ OEE Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞ (1Ïõî~12Ïõî Ï†ÑÏ≤¥)
    function getMonthlyOEEData(data) {
      const processAvailability = getProcessAvailability();

      // Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ïó∞ÎèÑ Ï∂îÏ∂ú (ÏóÜÏúºÎ©¥ ÌòÑÏû¨ Ïó∞ÎèÑ)
      let year = new Date().getFullYear();
      if (data.length > 0 && data[0].date) {
        year = parseInt(data[0].date.substring(0, 4)) || year;
      }

      // 1Ïõî~12Ïõî Î™®Îì† Ïõî Ï¥àÍ∏∞Ìôî
      const allMonths = {};
      for (let m = 1; m <= 12; m++) {
        const monthStr = `${year}-${String(m).padStart(2, '0')}`;
        allMonths[monthStr] = { month: monthStr, label: `${m}Ïõî`, production: 0, good: 0, standard: 0, hasData: false };
      }

      // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäî Ïõî Ï±ÑÏö∞Í∏∞
      data.forEach(row => {
        if (!row.date) return;
        const month = row.date.substring(0, 7); // YYYY-MM
        if (allMonths[month]) {
          allMonths[month].production += row.productionQty;
          allMonths[month].good += row.goodQty;
          allMonths[month].standard += row.standardQty;
          allMonths[month].hasData = true;
        }
      });

      // Ï†ÑÏ≤¥ ÌèâÍ∑† ÏãúÍ∞ÑÍ∞ÄÎèôÏú® Í≥ÑÏÇ∞
      const avgAvailability = Object.keys(processAvailability).length > 0
        ? Object.values(processAvailability).reduce((a, b) => a + b, 0) / Object.keys(processAvailability).length
        : 80; // Í∏∞Î≥∏Í∞í

      return Object.values(allMonths)
        .sort((a, b) => a.month.localeCompare(b.month))
        .map(d => {
          if (!d.hasData) {
            return { ...d, availability: null, performance: null, quality: null, oee: null };
          }
          const availability = Math.min(avgAvailability, 100);
          const performance = d.standard > 0 ? Math.min((d.production / d.standard) * 100, 100) : 0;
          const quality = d.production > 0 ? (d.good / d.production) * 100 : 0;
          const oee = (availability / 100) * (performance / 100) * (quality / 100) * 100;
          return {
            ...d,
            availability: availability.toFixed(1),
            performance: performance.toFixed(1),
            quality: quality.toFixed(1),
            oee: oee.toFixed(1)
          };
        });
    }

    // ÌïÑÌÑ∞ÎßÅÎêú Îç∞Ïù¥ÌÑ∞
    function getFilteredData() {
      return state.rawData.filter(row => {
        // Laser Í≥µÏ†ï Ï†úÏô∏
        if (excludedProcesses.includes(row.process)) return false;
        if (state.filters.process !== 'all' && row.process !== state.filters.process) return false;
        if (state.filters.equipment !== 'all' && row.equipment !== state.filters.equipment) return false;
        if (state.filters.product !== 'all' && row.productType !== state.filters.product) return false;
        return true;
      });
    }

    // Í≥†Ïú†Í∞í Ï∂îÏ∂ú (Laser Ï†úÏô∏)
    function getUniqueValues(key) {
      let values = [...new Set(state.rawData.map(r => r[key]).filter(Boolean))];
      if (key === 'process') {
        values = values.filter(v => !excludedProcesses.includes(v));
      }
      return values;
    }

    // ÏöîÏïΩ ÌÜµÍ≥Ñ
    function getSummaryStats(data) {
      if (data.length === 0) return null;
      const totalProduction = data.reduce((sum, r) => sum + r.productionQty, 0);
      const totalGood = data.reduce((sum, r) => sum + r.goodQty, 0);
      const totalDefect = data.reduce((sum, r) => sum + r.defectQty, 0);
      const totalDisposal = data.reduce((sum, r) => sum + r.disposalQty, 0);
      const totalStandard = data.reduce((sum, r) => sum + r.standardQty, 0);

      return {
        totalProduction, totalGood, totalDefect, totalDisposal, totalStandard,
        avgYield: totalProduction > 0 ? (totalGood / totalProduction * 100).toFixed(1) : 0,
        avgDefectRate: totalProduction > 0 ? (totalDefect / totalProduction * 100).toFixed(1) : 0,
        avgDisposalRate: totalProduction > 0 ? (totalDisposal / totalProduction * 100).toFixed(1) : 0,
        achievementRate: totalStandard > 0 ? (totalProduction / totalStandard * 100).toFixed(1) : 0,
        uniqueItems: new Set(data.map(r => r.itemCode)).size,
        uniqueDates: new Set(data.map(r => r.date)).size,
        totalRecords: data.length
      };
    }

    // ÏùºÎ≥Ñ Îç∞Ïù¥ÌÑ∞
    function getDailyData(data) {
      const grouped = {};
      data.forEach(row => {
        if (!grouped[row.date]) grouped[row.date] = { date: row.date, production: 0, good: 0, standard: 0 };
        grouped[row.date].production += row.productionQty;
        grouped[row.date].good += row.goodQty;
        grouped[row.date].standard += row.standardQty;
      });
      return Object.values(grouped).sort((a, b) => a.date.localeCompare(b.date));
    }

    // Í≥µÏ†ï Ï†ïÎ†¨ ÏàúÏÑú (ÏÇ¨Ï∂ú > ÎèÑÏû• > Ï°∞Î¶Ω > Ïù∏ÏáÑ) - Laser Ï†úÏô∏
    const processOrder = ['ÏÇ¨Ï∂ú', 'ÎèÑÏû•', 'Ï°∞Î¶Ω', 'Ïù∏ÏáÑ'];

    // Í≥µÏ†ïÎ≥Ñ Îç∞Ïù¥ÌÑ∞ (Laser Ï†úÏô∏)
    function getProcessData(data) {
      const grouped = {};
      data.forEach(row => {
        // Laser Í≥µÏ†ï Ï†úÏô∏
        if (excludedProcesses.includes(row.process)) return;
        if (!grouped[row.process]) grouped[row.process] = { process: row.process, production: 0, good: 0, defect: 0, disposal: 0 };
        grouped[row.process].production += row.productionQty;
        grouped[row.process].good += row.goodQty;
        grouped[row.process].defect += row.defectQty;
        grouped[row.process].disposal += row.disposalQty;
      });

      // ÏßÄÏ†ïÎêú ÏàúÏÑúÎ°ú Ï†ïÎ†¨
      return Object.values(grouped)
        .sort((a, b) => {
          const orderA = processOrder.indexOf(a.process);
          const orderB = processOrder.indexOf(b.process);
          // ÏàúÏÑúÏóê ÏóÜÎäî Í≥µÏ†ïÏùÄ Îß® Îí§Î°ú
          if (orderA === -1) return 1;
          if (orderB === -1) return -1;
          return orderA - orderB;
        })
        .map(d => ({
          ...d, yieldRate: d.production > 0 ? (d.good / d.production * 100).toFixed(1) : 0
        }));
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Ïà´Ïûê Ìè¨Îß∑ÌåÖ Ìï®Ïàò (APP_CONFIG Í∏∞Ï§Ä Ï†ÅÏö©)
    // - Î™®Îì† Ïà´Ïûê: Ï≤úÎã®ÏúÑ ÏΩ§Îßà ‚Üí formatNumber(), formatCompact()
    // - ÌçºÏÑºÌä∏: ÏÜåÏà´Ï†ê 1ÏûêÎ¶¨ ‚Üí formatPercent()
    // - Ï∞®Ìä∏ ÎùºÎ≤®: chartNumberFormatter(), chartPercentFormatter()
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ÏùºÎ∞ò Ïà´Ïûê: Ï≤úÎã®ÏúÑ ÏΩ§Îßà
    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return '0';
      return Number(num).toLocaleString();
    }

    // Ï∞®Ìä∏Ïö© Ïà´Ïûê: Ï≤úÎã®ÏúÑ ÏΩ§Îßà (Ïª¥Ìå©Ìä∏)
    function formatCompact(num) {
      if (num === null || num === undefined || isNaN(num)) return '0';
      return Number(num).toLocaleString();
    }

    // ÌçºÏÑºÌä∏: ÏÜåÏà´Ï†ê 1ÏûêÎ¶¨ (APP_CONFIG.NUMBER_FORMAT.percentDecimals Ï†ÅÏö©)
    function formatPercent(num) {
      if (num === null || num === undefined || isNaN(num)) return '0.0%';
      return parseFloat(num).toFixed(APP_CONFIG.NUMBER_FORMAT.percentDecimals) + '%';
    }

    // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ÎùºÎ≤®Ïö© Ìè¨Îß∑ÌÑ∞ (Ïà´Ïûê - Ï≤úÎã®ÏúÑ ÏΩ§Îßà)
    function chartNumberFormatter(value) {
      if (value === null || value === undefined) return '';
      return formatNumber(value);
    }

    // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ÎùºÎ≤®Ïö© Ìè¨Îß∑ÌÑ∞ (ÌçºÏÑºÌä∏ - ÏÜåÏà´Ï†ê 1ÏûêÎ¶¨)
    function chartPercentFormatter(value) {
      if (value === null || value === undefined) return '';
      return formatPercent(value);
    }

    // CT Ï†ÄÏ°∞ Ïã§Ï†Å ÏÉÅÏÑ∏ Î¶¨Ïä§Ìä∏ ÎπåÎçî
    function buildCtLowPerfList(ctData, processName) {
      const filteredCT = ctData.filter(d => d.process === processName && d.efficiency > 0);
      const sortedCT = [...filteredCT].sort((a, b) => a.efficiency - b.efficiency);
      const worstItems = sortedCT.slice(0, 20);

      if (worstItems.length === 0) return '';

      const toggleBtnClass = collapseState.ctLowPerf ? 'rotate-180' : '';
      const toggleBtnText = collapseState.ctLowPerf ? 'ÌéºÏπòÍ∏∞' : 'Ï†ëÍ∏∞';
      const collapseClass = collapseState.ctLowPerf ? 'collapsed' : '';

      let rows = '';
      worstItems.forEach((item, idx) => {
        const effClass = item.efficiency < 80 ? 'text-red-600 font-bold' :
                        item.efficiency < 90 ? 'text-amber-600 font-semibold' :
                        item.efficiency < 100 ? 'text-blue-600' : 'text-emerald-600';
        const statusBadge = item.efficiency < 80 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">ÏúÑÌóò</span>' :
                           item.efficiency < 90 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">Ï£ºÏùò</span>' :
                           item.efficiency < 100 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">ÎØ∏Îã¨</span>' :
                           '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">ÏñëÌò∏</span>';
        const rankClass = idx < 3 ? 'text-red-500' : 'text-slate-400';
        rows += '<tr>' +
          '<td class="text-center font-bold ' + rankClass + '">' + (idx + 1) + '</td>' +
          '<td class="font-medium">' + item.equipment + '</td>' +
          '<td class="text-slate-600">' + (item.partName || item.partCode || '-') + '</td>' +
          '<td class="text-right">' + item.standardCT.toFixed(1) + 's</td>' +
          '<td class="text-right">' + item.actualCT.toFixed(1) + 's</td>' +
          '<td class="text-right ' + effClass + '">' + formatPercent(item.efficiency) + '</td>' +
          '<td class="text-center">' + statusBadge + '</td>' +
          '</tr>';
      });

      const footerText = sortedCT.length > 20 ?
        '<div class="text-center text-sm text-slate-500 mt-4">ÏÉÅÏúÑ 20Í±¥ ÌëúÏãú Ï§ë (Ï†ÑÏ≤¥ ' + sortedCT.length + 'Í±¥)</div>' : '';

      return '<div class="card">' +
        '<div class="flex justify-between items-center mb-4">' +
          '<h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">' +
            '<span class="text-xl">‚ö†Ô∏è</span>' +
            '<span>CT Îã¨ÏÑ±Î•† Ï†ÄÏ°∞ Ìï≠Î™©</span>' +
            '<span class="text-sm font-normal text-slate-500">(Ìö®Ïú® ÎÇÆÏùÄ Ïàú)</span>' +
          '</h3>' +
          '<button id="toggle-ctLowPerf" onclick="toggleCollapse(\'ctLowPerf\')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">' +
            '<svg class="w-4 h-4 transition-transform ' + toggleBtnClass + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>' +
            toggleBtnText +
          '</button>' +
        '</div>' +
        '<div id="collapse-ctLowPerf" class="collapsible-content ' + collapseClass + '">' +
          '<div class="overflow-x-auto">' +
            '<table class="data-table w-full">' +
              '<thead>' +
                '<tr>' +
                  '<th class="text-center" style="width: 50px;">ÏàúÏúÑ</th>' +
                  '<th class="text-left sortable" data-type="string">ÏÑ§ÎπÑÎ™Ö</th>' +
                  '<th class="text-left sortable" data-type="string">Î∂ÄÌíàÎ™Ö</th>' +
                  '<th class="text-right sortable" data-type="number">ÌëúÏ§ÄCT</th>' +
                  '<th class="text-right sortable" data-type="number">Ïã§Ï†ÅCT</th>' +
                  '<th class="text-right sortable" data-type="number">Îã¨ÏÑ±Î•†</th>' +
                  '<th class="text-center">ÏÉÅÌÉú</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' + rows + '</tbody>' +
            '</table>' +
          '</div>' +
          footerText +
        '</div>' +
      '</div>';
    }

    // ÌíàÎ™©Î≥Ñ Î∂àÎüâÏú® ÏÉÅÏÑ∏ Î¶¨Ïä§Ìä∏ ÎπåÎçî
    function buildItemDefectList(data) {
      const itemStats = {};
      data.forEach(d => {
        const itemName = d.itemName || d.product || 'ÎØ∏Î∂ÑÎ•ò';
        if (!itemStats[itemName]) {
          itemStats[itemName] = { production: 0, good: 0, defect: 0, disposal: 0, process: d.process || '' };
        }
        // rawData ÌïÑÎìúÎ™Ö: productionQty, goodQty, defectQty, disposalQty
        itemStats[itemName].production += d.productionQty || d.production || 0;
        itemStats[itemName].good += d.goodQty || d.good || 0;
        itemStats[itemName].defect += d.defectQty || d.defect || 0;
        itemStats[itemName].disposal += d.disposalQty || d.disposal || 0;
      });

      const itemList = Object.entries(itemStats)
        .map(([name, s]) => ({
          name,
          process: s.process,
          production: s.production,
          good: s.good,
          defect: s.defect,
          disposal: s.disposal,
          defectRate: s.production > 0 ? (s.defect / s.production * 100) : 0,
          yieldRate: s.production > 0 ? (s.good / s.production * 100) : 0
        }))
        .filter(item => item.production > 0)
        .sort((a, b) => b.defectRate - a.defectRate);

      const topItems = itemList.slice(0, 30);
      if (topItems.length === 0) return '';

      const toggleBtnClass = collapseState.itemDefect ? 'rotate-180' : '';
      const toggleBtnText = collapseState.itemDefect ? 'ÌéºÏπòÍ∏∞' : 'Ï†ëÍ∏∞';
      const collapseClass = collapseState.itemDefect ? 'collapsed' : '';

      let rows = '';
      topItems.forEach((item, idx) => {
        const defectClass = item.defectRate >= 5 ? 'text-red-600 font-bold' :
                           item.defectRate >= 3 ? 'text-amber-600 font-semibold' :
                           item.defectRate >= 1 ? 'text-blue-600' : 'text-emerald-600';
        const statusBadge = item.defectRate >= 5 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">ÏúÑÌóò</span>' :
                           item.defectRate >= 3 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">Ï£ºÏùò</span>' :
                           item.defectRate >= 1 ? '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">Í¥ÄÎ¶¨</span>' :
                           '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">ÏñëÌò∏</span>';
        const rankClass = idx < 3 ? 'text-red-500' : 'text-slate-400';
        rows += '<tr>' +
          '<td class="text-center font-bold ' + rankClass + '">' + (idx + 1) + '</td>' +
          '<td class="font-medium">' + item.name + '</td>' +
          '<td class="text-slate-500">' + item.process + '</td>' +
          '<td class="text-right">' + formatNumber(item.production) + '</td>' +
          '<td class="text-right text-emerald-600">' + formatNumber(item.good) + '</td>' +
          '<td class="text-right text-red-500">' + formatNumber(item.defect) + '</td>' +
          '<td class="text-right ' + defectClass + '">' + formatPercent(item.defectRate) + '</td>' +
          '<td class="text-right text-blue-600">' + formatPercent(item.yieldRate) + '</td>' +
          '<td class="text-center">' + statusBadge + '</td>' +
          '</tr>';
      });

      const footerText = itemList.length > 30 ?
        '<div class="text-center text-sm text-slate-500 mt-4">ÏÉÅÏúÑ 30Í±¥ ÌëúÏãú Ï§ë (Ï†ÑÏ≤¥ ' + itemList.length + 'Í±¥)</div>' : '';

      return '<div class="card">' +
        '<div class="flex justify-between items-center mb-4">' +
          '<h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">' +
            '<span class="text-xl">üìã</span>' +
            '<span>ÌíàÎ™©Î≥Ñ Î∂àÎüâÏú® ÌòÑÌô©</span>' +
            '<span class="text-sm font-normal text-slate-500">(Î∂àÎüâÏú® ÎÜíÏùÄ Ïàú)</span>' +
          '</h3>' +
          '<button id="toggle-itemDefect" onclick="toggleCollapse(\'itemDefect\')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">' +
            '<svg class="w-4 h-4 transition-transform ' + toggleBtnClass + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>' +
            toggleBtnText +
          '</button>' +
        '</div>' +
        '<div id="collapse-itemDefect" class="collapsible-content ' + collapseClass + '">' +
          '<div class="overflow-x-auto">' +
            '<table class="data-table w-full">' +
              '<thead>' +
                '<tr>' +
                  '<th class="text-center" style="width: 50px;">ÏàúÏúÑ</th>' +
                  '<th class="text-left sortable" data-type="string">ÌíàÎ™©Î™Ö</th>' +
                  '<th class="text-left sortable" data-type="string">Í≥µÏ†ï</th>' +
                  '<th class="text-right sortable" data-type="number">ÏÉùÏÇ∞ÏàòÎüâ</th>' +
                  '<th class="text-right sortable" data-type="number">ÏñëÌíàÏàòÎüâ</th>' +
                  '<th class="text-right sortable" data-type="number">Î∂àÎüâÏàòÎüâ</th>' +
                  '<th class="text-right sortable" data-type="number">Î∂àÎüâÏú®</th>' +
                  '<th class="text-right sortable" data-type="number">ÏàòÏú®</th>' +
                  '<th class="text-center">ÏÉÅÌÉú</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' + rows + '</tbody>' +
            '</table>' +
          '</div>' +
          footerText +
        '</div>' +
      '</div>';
    }

    // ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ìï®Ïàò
    function downloadExcel(data, headers, filename) {
      if (!data || data.length === 0) {
        alert('Îã§Ïö¥Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }

      // BOM for UTF-8
      const BOM = '\uFEFF';

      // Ìó§Îçî Ìñâ
      let csv = headers.join(',') + '\n';

      // Îç∞Ïù¥ÌÑ∞ Ìñâ
      data.forEach(row => {
        const values = headers.map(header => {
          let value = row[header] ?? '';
          // ÏâºÌëú, Îî∞Ïò¥Ìëú, Ï§ÑÎ∞îÍøàÏù¥ ÏûàÏúºÎ©¥ Îî∞Ïò¥ÌëúÎ°ú Í∞êÏã∏Í∏∞
          if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
            value = '"' + value.replace(/"/g, '""') + '"';
          }
          return value;
        });
        csv += values.join(',') + '\n';
      });

      // Îã§Ïö¥Î°úÎìú
      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename + '_' + new Date().toISOString().slice(0, 10) + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ÏûêÏû¨Î∂àÎüâ ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
    function downloadMaterialDefectExcel() {
      const data = state.materialDefectData || [];
      if (data.length === 0) {
        alert('Îã§Ïö¥Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }

      const headers = ['Î∂ÄÌíàÏΩîÎìú', 'Í≥†Í∞ùÏÇ¨ P/N', 'Î∂ÄÌíàÎ™Ö', 'Í∑úÍ≤©', 'ÏÉùÏÇ∞ÏùºÏûê', 'Î∂àÎüâÌï©Í≥Ñ'];
      const exportData = data.map(d => ({
        'Î∂ÄÌíàÏΩîÎìú': d.partCode,
        'Í≥†Í∞ùÏÇ¨ P/N': d.customerPN,
        'Î∂ÄÌíàÎ™Ö': d.partName,
        'Í∑úÍ≤©': d.spec,
        'ÏÉùÏÇ∞ÏùºÏûê': d.date,
        'Î∂àÎüâÌï©Í≥Ñ': d.defectTotal
      }));

      downloadExcel(exportData, headers, 'ÏûêÏû¨Î∂àÎüâÌòÑÌô©');
    }

    // Î∂àÎüâÏàòÎ¶¨ ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
    function downloadRepairStatusExcel() {
      const data = state.repairStatusData || [];
      if (data.length === 0) {
        alert('Îã§Ïö¥Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }

      const headers = ['ÌíàÎ™©Ïú†Ìòï', 'Î∂ÄÌíàÏΩîÎìú', 'Í≥†Í∞ùÏÇ¨ P/N', 'Î∂ÄÌíàÎ™Ö', 'Í∑úÍ≤©', 'ÏÉùÏÇ∞ÏùºÏûê', 'ÏûëÏóÖÏßÄÏãúÎ≤àÌò∏', 'ÏÉùÏÇ∞ÏàòÎüâ', 'ÏàòÎ¶¨ÏàòÎüâ'];
      const exportData = data.map(d => ({
        'ÌíàÎ™©Ïú†Ìòï': d.itemType,
        'Î∂ÄÌíàÏΩîÎìú': d.partCode,
        'Í≥†Í∞ùÏÇ¨ P/N': d.customerPN,
        'Î∂ÄÌíàÎ™Ö': d.partName,
        'Í∑úÍ≤©': d.spec,
        'ÏÉùÏÇ∞ÏùºÏûê': d.date,
        'ÏûëÏóÖÏßÄÏãúÎ≤àÌò∏': d.workOrder,
        'ÏÉùÏÇ∞ÏàòÎüâ': d.productionQty,
        'ÏàòÎ¶¨ÏàòÎüâ': d.repairQty
      }));

      downloadExcel(exportData, headers, 'Î∂àÎüâÏàòÎ¶¨ÌòÑÌô©');
    }

    // Í≤ÄÌè¨Ïû•ÌòÑÌô© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
    function downloadPackagingExcel() {
      const data = state.packagingStatusData || [];
      if (data.length === 0) {
        alert('Îã§Ïö¥Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }

      const headers = ['Í≥µÏ†ï', 'Í≥µÏ†ïÍµ¨Î∂Ñ', 'ÌíàÎ™©ÏΩîÎìú', 'Í≥†Í∞ùÏÇ¨ P/N', 'ÌíàÎ™©Î™Ö', 'ÏÉùÏÇ∞ Lot No', 'ÏÑ§ÎπÑÏΩîÎìú', 'ÏÑ§ÎπÑÎ™Ö', 'Î∂àÎüâÏàòÎüâ', 'ÏàòÎ¶¨ÏàòÎüâ', 'ÌèêÍ∏∞ÏàòÎüâ', 'ÏÉùÏÇ∞ÏùºÏûê'];
      const exportData = data.map(d => ({
        'Í≥µÏ†ï': d.process,
        'Í≥µÏ†ïÍµ¨Î∂Ñ': d.processType,
        'ÌíàÎ™©ÏΩîÎìú': d.itemCode,
        'Í≥†Í∞ùÏÇ¨ P/N': d.customerPN,
        'ÌíàÎ™©Î™Ö': d.itemName,
        'ÏÉùÏÇ∞ Lot No': d.lotNo,
        'ÏÑ§ÎπÑÏΩîÎìú': d.equipmentCode,
        'ÏÑ§ÎπÑÎ™Ö': d.equipmentName,
        'Î∂àÎüâÏàòÎüâ': d.defectQty,
        'ÏàòÎ¶¨ÏàòÎüâ': d.repairQty,
        'ÌèêÍ∏∞ÏàòÎüâ': d.disposalQty,
        'ÏÉùÏÇ∞ÏùºÏûê': d.productionDate
      }));

      downloadExcel(exportData, headers, 'Í≤ÄÌè¨Ïû•ÌòÑÌô©');
    }

    // Ïû¨Í≥µÏû¨Í≥† ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
    function downloadWipInventoryExcel() {
      const data = state.wipInventoryData || [];
      if (data.length === 0) {
        alert('Îã§Ïö¥Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }

      const headers = ['ÌíàÎ™©Ïú†Ìòï', 'ÌíàÎ™©ÏΩîÎìú', 'Í≥†Í∞ùÏÇ¨ P/N', 'ÌíàÎ™©Î™Ö', 'Í∑úÍ≤©', 'Ïû¨Í≥†', 'Ï†úÏ°∞ÏõêÍ∞Ä', 'Ïû¨Í≥†Í∏àÏï°'];
      const exportData = data.map(d => ({
        'ÌíàÎ™©Ïú†Ìòï': d.itemType,
        'ÌíàÎ™©ÏΩîÎìú': d.itemCode,
        'Í≥†Í∞ùÏÇ¨ P/N': d.customerPN,
        'ÌíàÎ™©Î™Ö': d.itemName,
        'Í∑úÍ≤©': d.spec,
        'Ïû¨Í≥†': d.stock,
        'Ï†úÏ°∞ÏõêÍ∞Ä': d.unitCost,
        'Ïû¨Í≥†Í∏àÏï°': d.stockValue
      }));

      downloadExcel(exportData, headers, 'Ïû¨Í≥µÏû¨Í≥†Í∏àÏï°');
    }

    // ÏÉùÏÇ∞Îç∞Ïù¥ÌÑ∞ ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
    function downloadProductionDataExcel() {
      const data = getFilteredData();
      if (data.length === 0) {
        alert('Îã§Ïö¥Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }

      const headers = ['ÏÉùÏÇ∞ÏùºÏûê', 'Í≥µÏ†ï', 'ÌíàÏ¢Ö', 'Í≥†Í∞ùÏÇ¨', 'ÏÑ§ÎπÑ(ÎùºÏù∏)Î™Ö', 'ÌíàÎ™©Î™Ö', 'ÏÉùÏÇ∞ÏàòÎüâ', 'ÏñëÌíàÏàòÎüâ', 'Î∂àÎüâÏàòÎüâ', 'ÌèêÍ∏∞ÏàòÎüâ', 'ÏûëÏóÖÏãúÍ∞Ñ(Î∂Ñ)', 'ÏûëÏóÖÏù∏Ïõê', 'UPH', 'UPPH'];
      const exportData = data.map(d => ({
        'ÏÉùÏÇ∞ÏùºÏûê': d['ÏÉùÏÇ∞ÏùºÏûê'],
        'Í≥µÏ†ï': d['Í≥µÏ†ï'],
        'ÌíàÏ¢Ö': d['ÌíàÏ¢Ö'],
        'Í≥†Í∞ùÏÇ¨': d['Í≥†Í∞ùÏÇ¨'],
        'ÏÑ§ÎπÑ(ÎùºÏù∏)Î™Ö': d['ÏÑ§ÎπÑ(ÎùºÏù∏)Î™Ö'],
        'ÌíàÎ™©Î™Ö': d['ÌíàÎ™©Î™Ö'],
        'ÏÉùÏÇ∞ÏàòÎüâ': d['ÏÉùÏÇ∞ÏàòÎüâ'],
        'ÏñëÌíàÏàòÎüâ': d['ÏñëÌíàÏàòÎüâ'],
        'Î∂àÎüâÏàòÎüâ': d['Î∂àÎüâÏàòÎüâ'],
        'ÌèêÍ∏∞ÏàòÎüâ': d['ÌèêÍ∏∞ÏàòÎüâ'],
        'ÏûëÏóÖÏãúÍ∞Ñ(Î∂Ñ)': d['ÏûëÏóÖÏãúÍ∞Ñ(Î∂Ñ)'],
        'ÏûëÏóÖÏù∏Ïõê': d['ÏûëÏóÖÏù∏Ïõê'],
        'UPH': d['UPH'],
        'UPPH': d['UPPH']
      }));

      downloadExcel(exportData, headers, 'ÏÉùÏÇ∞Îç∞Ïù¥ÌÑ∞');
    }

    // ÌîºÎ¥á ÌÖåÏù¥Î∏î ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
    function downloadPivotExcel() {
      const data = state.detailData || [];
      if (data.length === 0) {
        alert('Îã§Ïö¥Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }

      const headers = Object.keys(data[0] || {});
      downloadExcel(data, headers, 'ÌîºÎ¥áÎç∞Ïù¥ÌÑ∞');
    }

    // OEE ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
    function downloadOEEExcel() {
      const filteredData = getFilteredData();
      const oeeData = getOEEData(filteredData);
      if (oeeData.length === 0) {
        alert('Îã§Ïö¥Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }

      const headers = ['Í≥µÏ†ï', 'ÏÉùÏÇ∞ÏàòÎüâ', 'ÏñëÌíàÏàòÎüâ', 'ÏãúÍ∞ÑÍ∞ÄÎèôÏú®(%)', 'ÏÑ±Îä•Í∞ÄÎèôÏú®(%)', 'ÏñëÌíàÏú®(%)', 'Ï¢ÖÌï©Ìö®Ïú®(OEE)(%)'];
      const exportData = oeeData.map(d => ({
        'Í≥µÏ†ï': d.process,
        'ÏÉùÏÇ∞ÏàòÎüâ': d.production,
        'ÏñëÌíàÏàòÎüâ': d.good,
        'ÏãúÍ∞ÑÍ∞ÄÎèôÏú®(%)': d.availability,
        'ÏÑ±Îä•Í∞ÄÎèôÏú®(%)': d.performance,
        'ÏñëÌíàÏú®(%)': d.quality,
        'Ï¢ÖÌï©Ìö®Ïú®(OEE)(%)': d.oee
      }));

      downloadExcel(exportData, headers, 'OEE_Ï¢ÖÌï©Ìö®Ïú®');
    }

    // ÎπÑÍ∞ÄÎèô ÌòÑÌô© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
    function downloadDowntimeExcel() {
      const downtimeData = state.downtimeData || [];
      if (downtimeData.length === 0) {
        alert('Îã§Ïö¥Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }

      const headers = Object.keys(downtimeData[0] || {});
      downloadExcel(downtimeData, headers, 'ÎπÑÍ∞ÄÎèôÌòÑÌô©');
    }

    // ÏÑ§ÎπÑ Ï†ïÎ†¨ (1Ìò∏Í∏∞~24Ìò∏Í∏∞ Ïàú)
    function sortEquipments(equipments) {
      return [...equipments].sort((a, b) => {
        const numA = parseInt(a.equipment.match(/(\d+)Ìò∏Í∏∞/)?.[1] || '999');
        const numB = parseInt(b.equipment.match(/(\d+)Ìò∏Í∏∞/)?.[1] || '999');
        return numA - numB;
      });
    }

    // ÌÖåÏù¥Î∏î Ï†ïÎ†¨ Í∏∞Îä•
    function initTableSort() {
      document.querySelectorAll('.data-table').forEach(table => {
        const headers = table.querySelectorAll('th.sortable');
        headers.forEach(header => {
          header.addEventListener('click', () => {
            const sortKey = header.dataset.sort;
            const sortType = header.dataset.type;
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const isAsc = header.classList.contains('asc');

            // Ï†ïÎ†¨ Î∞©Ìñ• ÌÜ†Í∏Ä
            headers.forEach(h => h.classList.remove('asc', 'desc'));
            header.classList.add(isAsc ? 'desc' : 'asc');

            // Ï†ïÎ†¨ ÏàòÌñâ
            rows.sort((a, b) => {
              let aVal, bVal;
              const colIndex = Array.from(headers).indexOf(header);
              const aCell = a.cells[colIndex];
              const bCell = b.cells[colIndex];

              if (sortType === 'number') {
                aVal = parseFloat(aCell.textContent.replace(/[,%]/g, '')) || 0;
                bVal = parseFloat(bCell.textContent.replace(/[,%]/g, '')) || 0;
              } else if (sortType === 'equipment') {
                const aNum = parseInt(aCell.textContent.match(/(\d+)Ìò∏Í∏∞/)?.[1] || '999');
                const bNum = parseInt(bCell.textContent.match(/(\d+)Ìò∏Í∏∞/)?.[1] || '999');
                aVal = aNum; bVal = bNum;
              } else {
                aVal = aCell.textContent; bVal = bCell.textContent;
              }

              if (isAsc) return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
              return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            });

            rows.forEach(row => tbody.appendChild(row));
          });
        });
      });
    }

    // Ï∞®Ìä∏ ÌååÍ¥¥
    function destroyCharts() {
      Object.values(charts).forEach(chart => chart && chart.destroy());
      charts = {};
    }

    // Î°úÍ∑∏Ïù∏ ÌôîÎ©¥
    function renderLogin() {
      if (isSignUpMode) {
        return `
          <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6">
            <div class="w-full max-w-md bg-white/5 backdrop-blur-xl p-10 rounded-3xl border border-white/10 shadow-2xl">
              <div class="text-center mb-8">
                <h1 class="text-xl font-bold text-white mb-2">Í≥ÑÏ†ï Îì±Î°ù</h1>
                <p class="text-slate-400 text-sm">Ïã†ÏÑ±Ïò§ÌÜ†ÌÖç ÏÉùÏÇ∞Ïã§ ÎåÄÏãúÎ≥¥Îìú</p>
              </div>
              <div class="space-y-4">
                <input type="text" id="displayNameInput" placeholder="Ïù¥Î¶Ñ (ÏÑ†ÌÉùÏÇ¨Ìï≠)"
                  class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <input type="email" id="emailInput" placeholder="Ïù¥Î©îÏùº Ï£ºÏÜå"
                  class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <input type="password" id="passwordInput" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ (6Ïûê Ïù¥ÏÉÅ)"
                  class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  onkeypress="if(event.key==='Enter')handleSignUp()">
                <button onclick="handleSignUp()"
                  class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-400 hover:to-blue-500 py-4 rounded-xl font-bold text-lg text-white transition-all shadow-lg">
                  Í≥ÑÏ†ï ÏÉùÏÑ±
                </button>
              </div>
              <div class="mt-6 text-center">
                <button onclick="toggleAuthMode()" class="text-slate-400 hover:text-white text-sm transition-colors">
                  ‚Üê Î°úÍ∑∏Ïù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                </button>
              </div>
              <p class="mt-4 text-center text-slate-500 text-xs">Ï≤´ Î≤àÏß∏ Îì±Î°ùÏûêÎäî Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏùÑ Î∞õÏäµÎãàÎã§</p>
            </div>
          </div>
        `;
      }

      return `
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6">
          <div class="w-full max-w-md bg-white/5 backdrop-blur-xl p-10 rounded-3xl border border-white/10 shadow-2xl">
            <div class="text-center mb-8">
              <h1 class="text-2xl font-bold text-white mb-2">Ïã†ÏÑ±Ïò§ÌÜ†ÌÖç</h1>
              <p class="text-emerald-400 text-sm font-medium tracking-wide">ÏÉùÏÇ∞Ïã§ ÎåÄÏãúÎ≥¥Îìú</p>
            </div>
            <div class="space-y-4">
              <input type="email" id="emailInput" placeholder="Ïù¥Î©îÏùº Ï£ºÏÜå"
                class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
              <input type="password" id="passwordInput" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏"
                class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                onkeypress="if(event.key==='Enter')handleLogin()">
              <button id="loginBtn" onclick="handleLogin()"
                class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 py-4 rounded-xl font-bold text-lg text-white transition-all shadow-lg">
                ÏãúÏä§ÌÖú Ï†ëÏÜç
              </button>
            </div>
            <div class="mt-6 flex justify-between items-center">
              <button onclick="handlePasswordReset()" class="text-slate-400 hover:text-white text-sm transition-colors">
                ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞
              </button>
              <button onclick="toggleAuthMode()" class="text-emerald-400 hover:text-emerald-300 text-sm transition-colors font-medium">
                Í≥ÑÏ†ï Îì±Î°ù ‚Üí
              </button>
            </div>
            <div class="mt-6 pt-6 border-t border-white/10">
              <p class="text-center text-slate-500 text-xs">üîí Supabase Auth Î≥¥Ïïà Ïù∏Ï¶ù</p>
            </div>
          </div>
        </div>
      `;
    }

    // ÌòÑÏû¨ Í≥µÏ†ïÏùò ÌïòÏúÑÎ©îÎâ¥ Í∞ÄÏ†∏Ïò§Í∏∞
    function getCurrentSubMenus() {
      if (!state.activeProcess) return [];
      const process = processMenus.find(p => p.id === state.activeProcess);
      return process ? process.subMenus : [];
    }

    // Î©îÏù∏ ÎåÄÏãúÎ≥¥Îìú
    function renderDashboard() {
      const filteredData = getFilteredData();
      const stats = getSummaryStats(filteredData);
      const equipments = getUniqueValues('equipment');
      const currentSubMenus = getCurrentSubMenus();

      return `
        <div class="min-h-screen bg-[#f5f5f7]">
          <!-- Main Navigation -->
          <nav class="bg-slate-900 px-6 py-3 flex items-center justify-between sticky top-0 z-50">
            <div class="flex items-center gap-8">
              <div class="flex items-center gap-3">
                <div class="flex gap-0.5">
                  <div class="w-1 h-4 bg-emerald-400 rounded-full opacity-70"></div>
                  <div class="w-1 h-5 bg-emerald-500 rounded-full"></div>
                  <div class="w-1 h-4 bg-emerald-400 rounded-full opacity-70"></div>
                </div>
                <div>
                  <h1 class="text-sm font-bold text-white tracking-tight leading-none">Ïã†ÏÑ±Ïò§ÌÜ†ÌÖç</h1>
                  <p class="text-[10px] text-emerald-400 font-medium tracking-wider">PRODUCTION</p>
                </div>
              </div>
              <div class="flex gap-1">
                <button onclick="setTab('overview')" class="nav-btn ${state.activeTab === 'overview' ? 'active' : ''}">Ï¢ÖÌï©ÌòÑÌô©</button>
                <button onclick="setTab('process')" class="nav-btn ${state.activeTab === 'process' ? 'active' : ''}">Í≥µÏ†ïÌòÑÌô©</button>
                <button onclick="setTab('downtime')" class="nav-btn ${state.activeTab === 'downtime' ? 'active' : ''}">ÎπÑÍ∞ÄÎèôÌòÑÌô©</button>
                <button onclick="setTab('wip-inventory')" class="nav-btn ${state.activeTab === 'wip-inventory' ? 'active' : ''}">Ïû¨Í≥µÏû¨Í≥†</button>
                <button onclick="setTab('quality')" class="nav-btn ${state.activeTab === 'quality' ? 'active' : ''}">ÌíàÏßàÎ∂ÑÏÑù</button>
                <button onclick="setTab('data')" class="nav-btn ${state.activeTab === 'data' ? 'active' : ''}">Îç∞Ïù¥ÌÑ∞Ï°∞Ìöå</button>
                <button onclick="setTab('upload')" class="nav-btn ${state.activeTab === 'upload' ? 'active' : ''}">ÌååÏùºÏóÖÎ°úÎìú</button>
                ${isAdmin() ? `<button onclick="setTab('admin')" class="nav-btn ${state.activeTab === 'admin' ? 'active' : ''}" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white;">üëë Í¥ÄÎ¶¨Ïûê</button>` : ''}
              </div>
            </div>
            <div class="flex items-center gap-4">
              ${userProfile ? `
                <span class="flex items-center gap-2 text-white text-sm">
                  <span class="px-2 py-1 rounded text-xs font-medium ${
                    userProfile.role === 'admin' ? 'bg-red-500/20 text-red-400' :
                    userProfile.role === 'editor' ? 'bg-blue-500/20 text-blue-400' :
                    'bg-slate-500/20 text-slate-400'
                  }">${userProfile.role === 'admin' ? 'Í¥ÄÎ¶¨Ïûê' : userProfile.role === 'editor' ? 'Ìé∏ÏßëÏûê' : 'Ï°∞ÌöåÏûê'}</span>
                  ${userProfile.display_name || currentUser?.email?.split('@')[0]}
                </span>
              ` : ''}
              <span class="flex items-center gap-2 text-blue-400 text-sm font-medium">
                <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span>
                ${state.rawData.length.toLocaleString()}Í±¥
              </span>
              <span class="flex items-center gap-2 ${supabaseConnected ? 'text-emerald-400' : 'text-slate-500'} text-sm">
                <span class="w-2 h-2 ${supabaseConnected ? 'bg-emerald-400' : 'bg-slate-500'} rounded-full"></span>
                ${supabaseConnected ? 'üîí Ïó∞Í≤∞Îê®' : 'Offline'}
              </span>
              <span id="sync-status" class="text-amber-400 text-xs"></span>
              ${supabaseConnected ? `<button onclick="syncWithSupabase()" class="text-sky-400 hover:text-sky-300 text-sm font-medium transition-colors">ÎèôÍ∏∞Ìôî</button>` : ''}
              <button onclick="handleLogout()" class="text-slate-400 hover:text-white text-sm font-medium transition-colors">Î°úÍ∑∏ÏïÑÏõÉ</button>
            </div>
          </nav>

          <!-- 2Ï∞® ÏÑúÎ∏åÎ©îÎâ¥ (Ïû¨Í≥µÏû¨Í≥†) - third-nav Ïä§ÌÉÄÏùº Ï†ÅÏö© -->
          ${state.activeTab === 'wip-inventory' ? `
            <div class="third-nav">
              <div class="third-nav-inner">
                <div class="third-nav-tabs">
                  <div class="third-nav-tab ${state.wipSubTab === 'status' ? 'active' : ''}" onclick="setWipSubTab('status')">
                    üìä Ïû¨Í≥µÏû¨Í≥†ÌòÑÌô©
                  </div>
                  <div class="third-nav-tab ${state.wipSubTab === 'price' ? 'active' : ''}" onclick="setWipSubTab('price')">
                    üí∞ Ïû¨Í≥µÏû¨Í≥†Îã®Í∞ÄÌëú
                  </div>
                </div>
              </div>
            </div>
          ` : ''}

          <!-- 2Ï∞® ÏÑúÎ∏åÎ©îÎâ¥ (Í≥µÏ†ï ÏÑ†ÌÉù) -->
          ${state.activeTab === 'process' ? `
            <div class="sub-nav">
              <div class="sub-nav-inner">
                <div class="sub-nav-tabs">
                  ${processMenus.map(p => `
                    <div class="sub-nav-tab ${state.activeProcess === p.id ? 'active' : ''}" onclick="setProcess('${p.id}')">
                      ${p.name}
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          ` : ''}

          <!-- 3Ï∞® ÏÑúÎ∏åÎ©îÎâ¥ (ÌïòÏúÑ Î©îÎâ¥) -->
          ${state.activeTab === 'process' && state.activeProcess && currentSubMenus.length > 0 ? `
            <div class="third-nav">
              <div class="third-nav-inner">
                <div class="third-nav-tabs">
                  ${currentSubMenus.map(sub => `
                    <div class="third-nav-tab ${state.activeSubMenu === sub.id ? 'active' : ''}" onclick="setSubMenu('${sub.id}')">
                      ${sub.name}
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          ` : ''}

          <main class="p-6 max-w-[1400px] mx-auto">
            ${state.activeTab === 'upload' ? renderFileUpload() : ''}
            ${state.activeTab === 'downtime' ? renderDowntime() : ''}
            ${state.activeTab === 'wip-inventory' ? renderWipInventoryPage() : ''}
            ${state.activeTab === 'admin' ? '<div id="admin-panel-container"><div class="text-center py-8"><div class="animate-spin w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full mx-auto"></div><p class="mt-4 text-slate-500">ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎî© Ï§ë...</p></div></div>' : ''}
            ${state.activeTab !== 'upload' && state.activeTab !== 'downtime' && state.activeTab !== 'wip-inventory' && state.activeTab !== 'admin' ? (state.rawData.length === 0 ? renderUploadPrompt() : `
              ${state.activeTab === 'overview' ? renderOverview(stats, filteredData) : ''}
              ${state.activeTab === 'process' ? renderProcess(filteredData) : ''}
              ${state.activeTab === 'quality' ? renderQuality(stats, filteredData) : ''}
              ${state.activeTab === 'data' ? renderDataTable(filteredData) : ''}
            `) : ''}
          </main>
        </div>
      `;
    }

    // Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê - ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨
    async function renderAdminPanel() {
      const users = await getAllUsers();
      const pendingUsers = users.filter(u => !u.approved && u.email !== ADMIN_EMAIL);
      const approvedUsers = users.filter(u => u.approved || u.email === ADMIN_EMAIL);

      return `
        <div class="space-y-6">
          <div class="section-header">
            <div class="section-title">üëë Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê - ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨</div>
          </div>

          <!-- ÏäπÏù∏ ÎåÄÍ∏∞ ÏÇ¨Ïö©Ïûê -->
          <div class="card">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <span class="w-3 h-3 bg-amber-500 rounded-full animate-pulse"></span>
              ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ë (${pendingUsers.length}Î™Ö)
            </h3>
            ${pendingUsers.length === 0 ? `
              <div class="text-center py-8 text-slate-400">
                <div class="text-4xl mb-2">‚úÖ</div>
                <p>ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ëÏù∏ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</p>
              </div>
            ` : `
              <div class="overflow-x-auto">
                <table class="data-table w-full">
                  <thead>
                    <tr>
                      <th>Ïù¥Î©îÏùº</th>
                      <th>Ïù¥Î¶Ñ</th>
                      <th>Í∞ÄÏûÖÏùº</th>
                      <th class="text-center">ÏûëÏóÖ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${pendingUsers.map(user => `
                      <tr class="bg-amber-50">
                        <td class="font-medium">${user.email}</td>
                        <td>${user.display_name || '-'}</td>
                        <td>${new Date(user.created_at).toLocaleDateString('ko-KR')}</td>
                        <td class="text-center">
                          <button onclick="handleApproveUser('${user.id}')"
                            class="px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white text-sm rounded-lg mr-2 transition-colors">
                            ‚úì ÏäπÏù∏
                          </button>
                          <button onclick="handleRejectUser('${user.id}')"
                            class="px-3 py-1.5 bg-rose-500 hover:bg-rose-600 text-white text-sm rounded-lg transition-colors">
                            ‚úï Í±∞Î∂Ä
                          </button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>

          <!-- ÏäπÏù∏Îêú ÏÇ¨Ïö©Ïûê Î™©Î°ù -->
          <div class="card">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <span class="w-3 h-3 bg-emerald-500 rounded-full"></span>
              ÏäπÏù∏Îêú ÏÇ¨Ïö©Ïûê (${approvedUsers.length}Î™Ö)
            </h3>
            <div class="overflow-x-auto">
              <table class="data-table w-full">
                <thead>
                  <tr>
                    <th>Ïù¥Î©îÏùº</th>
                    <th>Ïù¥Î¶Ñ</th>
                    <th>Ïó≠Ìï†</th>
                    <th>ÎßàÏßÄÎßâ Î°úÍ∑∏Ïù∏</th>
                    <th>Í∞ÄÏûÖÏùº</th>
                    <th class="text-center">ÏÉÅÌÉú</th>
                  </tr>
                </thead>
                <tbody>
                  ${approvedUsers.map(user => `
                    <tr>
                      <td class="font-medium">
                        ${user.email}
                        ${user.email === ADMIN_EMAIL ? '<span class="ml-2 px-2 py-0.5 bg-amber-100 text-amber-700 text-xs rounded-full">Í¥ÄÎ¶¨Ïûê</span>' : ''}
                      </td>
                      <td>${user.display_name || '-'}</td>
                      <td><span class="px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded-full">${user.role || 'viewer'}</span></td>
                      <td>${user.last_login ? new Date(user.last_login).toLocaleString('ko-KR') : '-'}</td>
                      <td>${new Date(user.created_at).toLocaleDateString('ko-KR')}</td>
                      <td class="text-center">
                        ${user.email === ADMIN_EMAIL ?
                          '<span class="text-amber-500">üëë</span>' :
                          `<button onclick="handleRejectUser('${user.id}')" class="px-2 py-1 text-xs text-rose-500 hover:bg-rose-50 rounded transition-colors">ÎπÑÌôúÏÑ±Ìôî</button>`
                        }
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // ÏÇ¨Ïö©Ïûê ÏäπÏù∏ Ìï∏Îì§Îü¨
    async function handleApproveUser(userId) {
      if (!confirm('Ïù¥ ÏÇ¨Ïö©ÏûêÎ•º ÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
      const result = await approveUser(userId);
      if (result.success) {
        alert('ÏÇ¨Ïö©ÏûêÍ∞Ä ÏäπÏù∏ÎêòÏóàÏäµÎãàÎã§.');
        render();
      } else {
        alert('ÏäπÏù∏ Ïã§Ìå®: ' + result.error);
      }
    }

    // ÏÇ¨Ïö©Ïûê Í±∞Î∂Ä Ìï∏Îì§Îü¨
    async function handleRejectUser(userId) {
      if (!confirm('Ïù¥ ÏÇ¨Ïö©ÏûêÎ•º Í±∞Î∂Ä/ÎπÑÌôúÏÑ±ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
      const result = await rejectUser(userId);
      if (result.success) {
        alert('Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.');
        render();
      } else {
        alert('Ï≤òÎ¶¨ Ïã§Ìå®: ' + result.error);
      }
    }

    // ÏóÖÎ°úÎìú ÏïàÎÇ¥
    function renderUploadPrompt() {
      return `
        <div class="card text-center py-16" style="background: linear-gradient(135deg, #f8fafc 0%, #fff 100%);">
          <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-slate-800 mb-2">Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</h2>
          <p class="text-slate-500 mb-8">MESÏóêÏÑú Ï∂îÏ∂úÌïú CSV ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏó¨ ÏãúÏûëÌï©ÎãàÎã§</p>

          <div class="inline-flex items-center gap-3 px-5 py-3 bg-white rounded-xl shadow-sm border border-slate-200 mb-8">
            <span class="text-slate-500 text-sm font-medium">ÎåÄÏÉÅÏõî</span>
            <select class="bg-slate-50 border-0 rounded-lg px-4 py-2 text-slate-700 font-semibold text-base focus:ring-2 focus:ring-blue-500 cursor-pointer" onchange="setSelectedMonth(this.value)">
              ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}Ïõî</option>`).join('')}
            </select>
          </div>

          <div class="flex items-center justify-center gap-4 flex-wrap max-w-2xl mx-auto">
            <label class="group flex-1 min-w-[180px] max-w-[220px] p-5 bg-white rounded-2xl border-2 border-dashed border-slate-200 hover:border-emerald-400 hover:shadow-lg cursor-pointer transition-all duration-300">
              <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-emerald-50 group-hover:bg-emerald-100 flex items-center justify-center text-2xl transition-colors">üìä</div>
              <div class="font-semibold text-slate-700 mb-1">ÏÉùÏÇ∞Ïã§Ï†Å</div>
              <div class="text-xs text-slate-400">CSV ÌååÏùº ÏÑ†ÌÉù</div>
              <input type="file" accept=".csv" onchange="handleFileUpload(event)" class="hidden">
            </label>
            <label class="group flex-1 min-w-[180px] max-w-[220px] p-5 bg-white rounded-2xl border-2 border-dashed border-slate-200 hover:border-blue-400 hover:shadow-lg cursor-pointer transition-all duration-300">
              <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-blue-50 group-hover:bg-blue-100 flex items-center justify-center text-2xl transition-colors">‚öôÔ∏è</div>
              <div class="font-semibold text-slate-700 mb-1">Í∞ÄÎèôÏú®</div>
              <div class="text-xs text-slate-400">CSV ÌååÏùº ÏÑ†ÌÉù</div>
              <input type="file" accept=".csv" onchange="handleAvailabilityUpload(event)" class="hidden">
            </label>
            <label class="group flex-1 min-w-[180px] max-w-[220px] p-5 bg-white rounded-2xl border-2 border-dashed border-slate-200 hover:border-amber-400 hover:shadow-lg cursor-pointer transition-all duration-300">
              <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-amber-50 group-hover:bg-amber-100 flex items-center justify-center text-2xl transition-colors">‚è±Ô∏è</div>
              <div class="font-semibold text-slate-700 mb-1">CTÌòÑÌô©</div>
              <div class="text-xs text-slate-400">CSV ÌååÏùº ÏÑ†ÌÉù</div>
              <input type="file" accept=".csv" onchange="handleCTUpload(event)" class="hidden">
            </label>
          </div>
          ${state.ctData.length > 0 ? `<div class="mt-6 inline-flex items-center gap-2 px-4 py-2 bg-amber-50 text-amber-700 rounded-lg text-sm font-medium"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>CTÌòÑÌô© ${state.ctData.length.toLocaleString()}Í±¥ Î°úÎìúÎê®</div>` : ''}
        </div>
      `;
    }

    // ÌååÏùº ÏóÖÎ°úÎìú Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ
    function renderFileUpload() {
      return `
        <div class="card mb-6" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
          <div class="flex items-center justify-between mb-8">
            <div>
              <h2 class="text-2xl font-bold text-slate-800 mb-1">Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú</h2>
              <p class="text-slate-500 text-sm">MESÏóêÏÑú Ï∂îÏ∂úÌïú CSV ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
            </div>
            <div class="flex items-center gap-3 px-5 py-3 bg-white rounded-xl shadow-sm border border-slate-200">
              <span class="text-slate-500 text-sm font-medium">ÎåÄÏÉÅÏõî</span>
              <select class="bg-slate-50 border-0 rounded-lg px-4 py-2 text-slate-700 font-semibold text-base focus:ring-2 focus:ring-blue-500 cursor-pointer" onchange="setSelectedMonth(this.value)">
                ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}Ïõî</option>`).join('')}
              </select>
            </div>
          </div>

          <!-- Î©îÏù∏ ÏóÖÎ°úÎìú ÏòÅÏó≠ -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8">
            <!-- ÏÉùÏÇ∞Ïã§Ï†Å -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-emerald-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-emerald-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-emerald-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üìä</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">ÏÉùÏÇ∞Ïã§Ï†Å</h3>
                  <p class="text-xs text-slate-400 mb-4">ÏÉùÏÇ∞ÏàòÎüâ, ÏñëÌíà, Î∂àÎüâ</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ÏóÖÎ°úÎìú
                    <input type="file" accept=".csv" onchange="handleFileUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.rawData.length > 0 ? 'text-emerald-600' : 'text-slate-400'}">
                ${state.rawData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.rawData.length.toLocaleString()}Í±¥</span>` : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}
              </div>
            </div>

            <!-- Í∞ÄÎèôÏú® -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-blue-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-blue-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">‚öôÔ∏è</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">Í∞ÄÎèôÏú®</h3>
                  <p class="text-xs text-slate-400 mb-4">Í∞ÄÎèôÏãúÍ∞Ñ, ÏãúÍ∞ÑÍ∞ÄÎèôÏú®</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ÏóÖÎ°úÎìú
                    <input type="file" accept=".csv" onchange="handleAvailabilityUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.availabilityData.length > 0 ? 'text-blue-600' : 'text-slate-400'}">
                ${state.availabilityData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.availabilityData.length.toLocaleString()}Í±¥</span>` : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}
              </div>
            </div>

            <!-- ÏóÖÏ¢ÖÎ≥Ñ Îç∞Ïù¥ÌÑ∞ -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-slate-400 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-slate-400 to-slate-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üìã</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">ÏóÖÏ¢ÖÎ≥Ñ Îç∞Ïù¥ÌÑ∞</h3>
                  <p class="text-xs text-slate-400 mb-4">ÌîºÎ¥á Î∂ÑÏÑùÏö©</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-slate-600 hover:bg-slate-700 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ÏóÖÎ°úÎìú
                    <input type="file" accept=".csv" onchange="handleDetailUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.detailData.length > 0 ? 'text-slate-600' : 'text-slate-400'}">
                ${state.detailData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.detailData.length.toLocaleString()}Í±¥</span>` : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}
              </div>
            </div>
          </div>

          <!-- CTÌòÑÌô© ÏÑπÏÖò -->
          <div class="mb-5">
            <div class="flex items-center gap-2 mb-4">
              <div class="w-8 h-8 rounded-lg bg-amber-100 flex items-center justify-center text-lg">‚è±Ô∏è</div>
              <h3 class="font-bold text-slate-700">Cycle Time Îç∞Ïù¥ÌÑ∞</h3>
              <span class="text-xs text-slate-400 ml-2">Í≥µÏ†ïÎ≥Ñ Î∂ÑÎ¶¨ ÏóÖÎ°úÎìú</span>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
            <!-- CT - ÏÇ¨Ï∂ú -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-orange-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-400 to-orange-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-orange-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üíâ</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">CT - ÏÇ¨Ï∂ú</h3>
                  <p class="text-xs text-slate-400 mb-4">Injection Molding</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-orange-500 hover:bg-orange-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ÏóÖÎ°úÎìú
                    <input type="file" accept=".csv" onchange="handleCTUploadByProcess(event, 'ÏÇ¨Ï∂ú')" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${getCTCountByProcess('ÏÇ¨Ï∂ú') > 0 ? 'text-orange-600' : 'text-slate-400'}">
                ${getCTCountByProcess('ÏÇ¨Ï∂ú') > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${getCTCountByProcess('ÏÇ¨Ï∂ú').toLocaleString()}Í±¥</span>` : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}
              </div>
            </div>

            <!-- CT - ÎèÑÏû• -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-sky-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-sky-400 to-sky-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-sky-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üé®</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">CT - ÎèÑÏû•</h3>
                  <p class="text-xs text-slate-400 mb-4">Painting Process</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-sky-500 hover:bg-sky-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ÏóÖÎ°úÎìú
                    <input type="file" accept=".csv" onchange="handleCTUploadByProcess(event, 'ÎèÑÏû•')" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${getCTCountByProcess('ÎèÑÏû•') > 0 ? 'text-sky-600' : 'text-slate-400'}">
                ${getCTCountByProcess('ÎèÑÏû•') > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${getCTCountByProcess('ÎèÑÏû•').toLocaleString()}Í±¥</span>` : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}
              </div>
            </div>

            <!-- CT - Ï°∞Î¶Ω -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-violet-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-violet-400 to-violet-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-violet-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üîß</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">CT - Ï°∞Î¶Ω</h3>
                  <p class="text-xs text-slate-400 mb-4">Assembly Line</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-violet-500 hover:bg-violet-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ÏóÖÎ°úÎìú
                    <input type="file" accept=".csv" onchange="handleCTUploadByProcess(event, 'Ï°∞Î¶Ω')" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${getCTCountByProcess('Ï°∞Î¶Ω') > 0 ? 'text-violet-600' : 'text-slate-400'}">
                ${getCTCountByProcess('Ï°∞Î¶Ω') > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${getCTCountByProcess('Ï°∞Î¶Ω').toLocaleString()}Í±¥</span>` : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}
              </div>
            </div>
          </div>

          <!-- Ï°∞Î¶ΩÍ≥µÏ†ï Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ ÏÑπÏÖò -->
          <div class="mb-5 mt-8">
            <div class="flex items-center gap-2 mb-4">
              <div class="w-8 h-8 rounded-lg bg-rose-100 flex items-center justify-center text-lg">üîß</div>
              <h3 class="font-bold text-slate-700">Ï°∞Î¶ΩÍ≥µÏ†ï Îç∞Ïù¥ÌÑ∞</h3>
              <span class="text-xs text-slate-400 ml-2">ÏûêÏû¨Î∂àÎüâ, Ïû¨Í≥†, ÏàòÎ¶¨, Í≤ÄÌè¨Ïû•</span>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
            <!-- Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-rose-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-rose-400 to-rose-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-rose-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">‚ö†Ô∏è</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ</h3>
                  <p class="text-xs text-slate-400 mb-4">Material Defects</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-rose-500 hover:bg-rose-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ÏóÖÎ°úÎìú
                    <input type="file" accept=".csv" onchange="handleMaterialDefectUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.materialDefectData.length > 0 ? 'text-rose-600' : 'text-slate-400'}">
                ${state.materialDefectData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.materialDefectData.length.toLocaleString()}Í±¥</span>` : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}
              </div>
            </div>

            <!-- Ïû¨Í≥µÏû¨Í≥†Í∏àÏï° -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-teal-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-teal-400 to-teal-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-teal-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üí∞</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">Ïû¨Í≥µÏû¨Í≥†Í∏àÏï°</h3>
                  <p class="text-xs text-slate-400 mb-4">WIP Inventory</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-teal-500 hover:bg-teal-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ÏóÖÎ°úÎìú
                    <input type="file" accept=".csv" onchange="handleWipInventoryUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.wipInventoryData.length > 0 ? 'text-teal-600' : 'text-slate-400'}">
                ${state.wipInventoryData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.wipInventoryData.length.toLocaleString()}Í±¥</span>` : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}
              </div>
            </div>

            <!-- Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-indigo-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-400 to-indigo-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-indigo-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üî®</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">Î∂àÎüâÏàòÎ¶¨ÌòÑÌô©</h3>
                  <p class="text-xs text-slate-400 mb-4">Repair Status</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ÏóÖÎ°úÎìú
                    <input type="file" accept=".csv" onchange="handleRepairStatusUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.repairStatusData.length > 0 ? 'text-indigo-600' : 'text-slate-400'}">
                ${state.repairStatusData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.repairStatusData.length.toLocaleString()}Í±¥</span>` : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}
              </div>
            </div>

            <!-- Í≤ÄÌè¨Ïû•ÌòÑÌô© -->
            <div class="group relative bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-lg hover:border-purple-300 transition-all duration-300 overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-400 to-purple-500"></div>
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-purple-50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üì¶</div>
                <div class="flex-1">
                  <h3 class="font-bold text-slate-800 mb-1">Í≤ÄÌè¨Ïû•ÌòÑÌô©</h3>
                  <p class="text-xs text-slate-400 mb-4">Packaging Status</p>
                  <label class="flex items-center justify-center gap-2 w-full py-2.5 bg-purple-500 hover:bg-purple-600 text-white text-sm font-semibold rounded-lg cursor-pointer transition-all shadow-sm hover:shadow">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    ÏóÖÎ°úÎìú
                    <input type="file" accept=".csv" onchange="handlePackagingStatusUpload(event)" class="hidden">
                  </label>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-slate-100 text-xs font-medium ${state.packagingStatusData.length > 0 ? 'text-purple-600' : 'text-slate-400'}">
                ${state.packagingStatusData.length > 0 ? `<span class="inline-flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${state.packagingStatusData.length.toLocaleString()}Í±¥</span>` : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}
              </div>
            </div>
          </div>
        </div>

        <!-- Îç∞Ïù¥ÌÑ∞ ÌòÑÌô© ÏöîÏïΩ -->
        <div class="card" style="background: white;">
          <div class="flex items-center justify-between mb-5">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-lg">üìã</div>
              <h3 class="font-bold text-slate-700">ÏóÖÎ°úÎìú ÌòÑÌô©</h3>
            </div>
            <button onclick="if(confirm('Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) { clearStorage(); }" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg text-xs font-medium transition-colors border border-red-200">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî
            </button>
          </div>
          <div class="overflow-hidden rounded-xl border border-slate-200">
            <table class="data-table" style="margin: 0;">
              <thead>
                <tr>
                  <th class="sortable" data-sort="type" data-type="text">Îç∞Ïù¥ÌÑ∞ Ïú†Ìòï</th>
                  <th class="sortable text-right" data-sort="count" data-type="number">Í±¥Ïàò</th>
                  <th class="sortable" data-sort="status" data-type="text">ÏÉÅÌÉú</th>
                  <th class="text-center" style="width: 80px;">Í¥ÄÎ¶¨</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-emerald-100 flex items-center justify-center text-sm">üìä</span><span class="font-medium">ÏÉùÏÇ∞Ïã§Ï†Å</span></div></td>
                  <td class="text-right font-semibold">${state.rawData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.rawData.length > 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'}">${state.rawData.length > 0 ? 'ÌôúÏÑ±' : 'ÏóÜÏùå'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('ÏÉùÏÇ∞Ïã§Ï†Å Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) { localStorage.removeItem('${STORAGE_KEY}'); state.rawData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.rawData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-blue-100 flex items-center justify-center text-sm">‚öôÔ∏è</span><span class="font-medium">Í∞ÄÎèôÏú®</span></div></td>
                  <td class="text-right font-semibold">${state.availabilityData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.availabilityData.length > 0 ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'}">${state.availabilityData.length > 0 ? 'ÌôúÏÑ±' : 'ÏóÜÏùå'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('Í∞ÄÎèôÏú® Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) { localStorage.removeItem('${AVAILABILITY_KEY}'); state.availabilityData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.availabilityData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-slate-200 flex items-center justify-center text-sm">üìã</span><span class="font-medium">ÏóÖÏ¢ÖÎ≥Ñ Îç∞Ïù¥ÌÑ∞</span></div></td>
                  <td class="text-right font-semibold">${state.detailData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.detailData.length > 0 ? 'bg-slate-200 text-slate-700' : 'bg-slate-100 text-slate-500'}">${state.detailData.length > 0 ? 'ÌôúÏÑ±' : 'ÏóÜÏùå'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('ÏóÖÏ¢ÖÎ≥Ñ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) { clearDetailData(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.detailData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-orange-100 flex items-center justify-center text-sm">üíâ</span><span class="font-medium">CT - ÏÇ¨Ï∂ú</span></div></td>
                  <td class="text-right font-semibold">${getCTCountByProcess('ÏÇ¨Ï∂ú').toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${getCTCountByProcess('ÏÇ¨Ï∂ú') > 0 ? 'bg-orange-100 text-orange-700' : 'bg-slate-100 text-slate-500'}">${getCTCountByProcess('ÏÇ¨Ï∂ú') > 0 ? 'ÌôúÏÑ±' : 'ÏóÜÏùå'}</span></td>
                  <td class="text-center"><button onclick="deleteCTByProcess('ÏÇ¨Ï∂ú')" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${getCTCountByProcess('ÏÇ¨Ï∂ú') === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-sky-100 flex items-center justify-center text-sm">üé®</span><span class="font-medium">CT - ÎèÑÏû•</span></div></td>
                  <td class="text-right font-semibold">${getCTCountByProcess('ÎèÑÏû•').toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${getCTCountByProcess('ÎèÑÏû•') > 0 ? 'bg-sky-100 text-sky-700' : 'bg-slate-100 text-slate-500'}">${getCTCountByProcess('ÎèÑÏû•') > 0 ? 'ÌôúÏÑ±' : 'ÏóÜÏùå'}</span></td>
                  <td class="text-center"><button onclick="deleteCTByProcess('ÎèÑÏû•')" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${getCTCountByProcess('ÎèÑÏû•') === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-violet-100 flex items-center justify-center text-sm">üîß</span><span class="font-medium">CT - Ï°∞Î¶Ω</span></div></td>
                  <td class="text-right font-semibold">${getCTCountByProcess('Ï°∞Î¶Ω').toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${getCTCountByProcess('Ï°∞Î¶Ω') > 0 ? 'bg-violet-100 text-violet-700' : 'bg-slate-100 text-slate-500'}">${getCTCountByProcess('Ï°∞Î¶Ω') > 0 ? 'ÌôúÏÑ±' : 'ÏóÜÏùå'}</span></td>
                  <td class="text-center"><button onclick="deleteCTByProcess('Ï°∞Î¶Ω')" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${getCTCountByProcess('Ï°∞Î¶Ω') === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-rose-100 flex items-center justify-center text-sm">‚ö†Ô∏è</span><span class="font-medium">Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ</span></div></td>
                  <td class="text-right font-semibold">${state.materialDefectData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.materialDefectData.length > 0 ? 'bg-rose-100 text-rose-700' : 'bg-slate-100 text-slate-500'}">${state.materialDefectData.length > 0 ? 'ÌôúÏÑ±' : 'ÏóÜÏùå'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) { localStorage.removeItem(MATERIAL_DEFECT_KEY); state.materialDefectData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.materialDefectData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-teal-100 flex items-center justify-center text-sm">üí∞</span><span class="font-medium">Ïû¨Í≥µÏû¨Í≥†Í∏àÏï°</span></div></td>
                  <td class="text-right font-semibold">${state.wipInventoryData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.wipInventoryData.length > 0 ? 'bg-teal-100 text-teal-700' : 'bg-slate-100 text-slate-500'}">${state.wipInventoryData.length > 0 ? 'ÌôúÏÑ±' : 'ÏóÜÏùå'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('Ïû¨Í≥µÏû¨Í≥†Í∏àÏï° Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) { localStorage.removeItem(WIP_INVENTORY_KEY); state.wipInventoryData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.wipInventoryData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-indigo-100 flex items-center justify-center text-sm">üî®</span><span class="font-medium">Î∂àÎüâÏàòÎ¶¨ÌòÑÌô©</span></div></td>
                  <td class="text-right font-semibold">${state.repairStatusData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.repairStatusData.length > 0 ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-500'}">${state.repairStatusData.length > 0 ? 'ÌôúÏÑ±' : 'ÏóÜÏùå'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) { localStorage.removeItem(REPAIR_STATUS_KEY); state.repairStatusData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.repairStatusData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
                <tr>
                  <td><div class="flex items-center gap-2"><span class="w-6 h-6 rounded bg-purple-100 flex items-center justify-center text-sm">üì¶</span><span class="font-medium">Í≤ÄÌè¨Ïû•ÌòÑÌô©</span></div></td>
                  <td class="text-right font-semibold">${state.packagingStatusData.length.toLocaleString()}</td>
                  <td><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${state.packagingStatusData.length > 0 ? 'bg-purple-100 text-purple-700' : 'bg-slate-100 text-slate-500'}">${state.packagingStatusData.length > 0 ? 'ÌôúÏÑ±' : 'ÏóÜÏùå'}</span></td>
                  <td class="text-center"><button onclick="if(confirm('Í≤ÄÌè¨Ïû•ÌòÑÌô© Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) { localStorage.removeItem(PACKAGING_STATUS_KEY); state.packagingStatusData = []; render(); }" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" ${state.packagingStatusData.length === 0 ? 'disabled style="opacity:0.3"' : ''}><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ÎπÑÍ∞ÄÎèôÌòÑÌô© ÌéòÏù¥ÏßÄ
    function renderDowntime() {
      if (state.availabilityData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">Í∞ÄÎèôÏú® Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p class="text-slate-500 mb-6">ÎπÑÍ∞ÄÎèôÌòÑÌô© Î∂ÑÏÑùÏùÑ ÏúÑÌï¥ Í∞ÄÎèôÏú® CSV ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              üì§ ÌååÏùºÏóÖÎ°úÎìú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            </button>
          </div>
        `;
      }

      // ÎπÑÍ∞ÄÎèô Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞
      const downtimeData = state.availabilityData.map(d => ({
        ...d,
        downtimeMinutes: d.operatingTime - d.runningTime,
        downtimeRate: d.operatingTime > 0 ? ((d.operatingTime - d.runningTime) / d.operatingTime * 100) : 0
      }));

      // Í≥µÏ†ïÎ≥Ñ ÎπÑÍ∞ÄÎèô ÏßëÍ≥Ñ
      const processSummary = {};
      downtimeData.forEach(d => {
        if (excludedProcesses.includes(d.process)) return;
        if (!processSummary[d.process]) {
          processSummary[d.process] = {
            process: d.process,
            totalOperating: 0,
            totalRunning: 0,
            totalDowntime: 0,
            equipmentCount: new Set(),
            records: []
          };
        }
        processSummary[d.process].totalOperating += d.operatingTime;
        processSummary[d.process].totalRunning += d.runningTime;
        processSummary[d.process].totalDowntime += d.downtimeMinutes;
        processSummary[d.process].equipmentCount.add(d.equipment);
        processSummary[d.process].records.push(d);
      });

      // Í≥µÏ†ïÎ≥Ñ ÏöîÏïΩ Î∞∞Ïó¥
      const processStats = Object.values(processSummary).map(p => ({
        ...p,
        equipmentCount: p.equipmentCount.size,
        avgDowntimeRate: p.totalOperating > 0 ? (p.totalDowntime / p.totalOperating * 100) : 0,
        avgAvailability: p.totalOperating > 0 ? (p.totalRunning / p.totalOperating * 100) : 0
      })).sort((a, b) => b.totalDowntime - a.totalDowntime);

      // Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ
      const totalStats = {
        totalOperating: processStats.reduce((sum, p) => sum + p.totalOperating, 0),
        totalDowntime: processStats.reduce((sum, p) => sum + p.totalDowntime, 0),
        totalEquipment: processStats.reduce((sum, p) => sum + p.equipmentCount, 0)
      };
      totalStats.avgDowntimeRate = totalStats.totalOperating > 0
        ? (totalStats.totalDowntime / totalStats.totalOperating * 100) : 0;

      // ÏÑ§ÎπÑÎ≥Ñ ÎπÑÍ∞ÄÎèô TOP 10
      const equipmentDowntime = {};
      downtimeData.forEach(d => {
        if (excludedProcesses.includes(d.process)) return;
        const key = `${d.process}_${d.equipment}`;
        if (!equipmentDowntime[key]) {
          equipmentDowntime[key] = { process: d.process, equipment: d.equipment, totalDowntime: 0, totalOperating: 0, count: 0 };
        }
        equipmentDowntime[key].totalDowntime += d.downtimeMinutes;
        equipmentDowntime[key].totalOperating += d.operatingTime;
        equipmentDowntime[key].count++;
      });

      const topDowntimeEquipment = Object.values(equipmentDowntime)
        .map(e => ({ ...e, downtimeRate: e.totalOperating > 0 ? (e.totalDowntime / e.totalOperating * 100) : 0 }))
        .sort((a, b) => b.totalDowntime - a.totalDowntime)
        .slice(0, 10);

      // Í≥µÏ†ïÎ≥Ñ ÏÉâÏÉÅ
      const processColors = {
        'ÏÇ¨Ï∂ú': { bg: 'bg-orange-100', border: 'border-orange-300', text: 'text-orange-600', chart: '#fdba74' },
        'ÎèÑÏû•': { bg: 'bg-sky-100', border: 'border-sky-300', text: 'text-sky-600', chart: '#7dd3fc' },
        'Ïù∏ÏáÑ': { bg: 'bg-amber-100', border: 'border-amber-300', text: 'text-amber-600', chart: '#fcd34d' },
        'Ï°∞Î¶Ω': { bg: 'bg-violet-100', border: 'border-violet-300', text: 'text-violet-600', chart: '#c4b5fd' }
      };

      return `
        <div class="section-header">
          <div class="section-title">ÎπÑÍ∞ÄÎèôÌòÑÌô© Î∂ÑÏÑù</div>
          <div class="flex items-center gap-3">
            <select class="filter-select" style="background: #f1f5f9; border-color: #cbd5e1; font-weight: 500;" onchange="setSelectedMonth(this.value)">
              ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}Ïõî</option>`).join('')}
            </select>
            <span class="text-sm text-slate-500">Ï¥ù ${state.availabilityData.length.toLocaleString()}Í±¥ Î∂ÑÏÑù</span>
          </div>
        </div>

        <!-- Ï†ÑÏ≤¥ ÏöîÏïΩ Ïπ¥Îìú -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="card text-center" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid #fca5a5;">
            <div class="text-3xl font-bold text-red-700">${(totalStats.totalDowntime / 60).toFixed(1)}h</div>
            <div class="text-sm text-red-600 mt-1">Ï¥ù ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ</div>
          </div>
          <div class="card text-center" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b;">
            <div class="text-3xl font-bold text-amber-700">${totalStats.avgDowntimeRate.toFixed(1)}%</div>
            <div class="text-sm text-amber-600 mt-1">ÌèâÍ∑† ÎπÑÍ∞ÄÎèôÏú®</div>
          </div>
          <div class="card text-center" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6;">
            <div class="text-3xl font-bold text-blue-700">${(100 - totalStats.avgDowntimeRate).toFixed(1)}%</div>
            <div class="text-sm text-blue-600 mt-1">ÌèâÍ∑† Í∞ÄÎèôÏú®</div>
          </div>
          <div class="card text-center" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-left: 4px solid #6366f1;">
            <div class="text-3xl font-bold text-indigo-700">${totalStats.totalEquipment}</div>
            <div class="text-sm text-indigo-600 mt-1">Î∂ÑÏÑù ÏÑ§ÎπÑÏàò</div>
          </div>
        </div>

        <!-- Í≥µÏ†ïÎ≥Ñ ÎπÑÍ∞ÄÎèô ÌòÑÌô© -->
        <div class="card mb-6">
          <h3 class="text-lg font-bold text-slate-800 mb-4">üìä Í≥µÏ†ïÎ≥Ñ ÎπÑÍ∞ÄÎèô ÌòÑÌô©</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            ${processStats.map(p => {
              const colors = processColors[p.process] || { bg: 'bg-slate-100', border: 'border-slate-400', text: 'text-slate-700' };
              const downtimeHours = (p.totalDowntime / 60).toFixed(1);
              const barWidth = totalStats.totalDowntime > 0 ? (p.totalDowntime / totalStats.totalDowntime * 100) : 0;
              return `
                <div class="p-4 rounded-xl ${colors.bg} border-l-4 ${colors.border}">
                  <div class="flex justify-between items-start mb-2">
                    <span class="font-bold ${colors.text}">${p.process}</span>
                    <span class="text-xs px-2 py-1 rounded-full bg-white/60 ${colors.text}">${p.equipmentCount}ÏÑ§ÎπÑ</span>
                  </div>
                  <div class="text-2xl font-bold ${colors.text} mb-1">${downtimeHours}h</div>
                  <div class="text-sm ${colors.text} opacity-75">ÎπÑÍ∞ÄÎèôÏú® ${p.avgDowntimeRate.toFixed(1)}%</div>
                  <div class="mt-3 h-2 bg-white/50 rounded-full overflow-hidden">
                    <div class="h-full rounded-full transition-all" style="width: ${barWidth}%; background: ${processColors[p.process]?.chart || '#64748b'}"></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- Ï∞®Ìä∏ ÏòÅÏó≠ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- Í≥µÏ†ïÎ≥Ñ ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ Ï∞®Ìä∏ -->
          <div class="card">
            <div class="chart-title">Í≥µÏ†ïÎ≥Ñ ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ ÎπÑÍµê</div>
            <div style="height: 280px;"><canvas id="downtimeByProcessChart"></canvas></div>
          </div>

          <!-- ÏÑ§ÎπÑÎ≥Ñ ÎπÑÍ∞ÄÎèô TOP 10 Ï∞®Ìä∏ -->
          <div class="card">
            <div class="chart-title">ÏÑ§ÎπÑÎ≥Ñ ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ TOP 10</div>
            <div style="height: 280px;"><canvas id="downtimeByEquipmentChart"></canvas></div>
          </div>
        </div>

        <!-- ÎπÑÍ∞ÄÎèô ÏÉÅÏÑ∏ ÌÖåÏù¥Î∏î -->
        <div class="card">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-bold text-slate-800">üìã Í≥µÏ†ïÎ≥Ñ ÎπÑÍ∞ÄÎèô ÏÉÅÏÑ∏</h3>
              <button id="toggle-downtime" class="collapse-toggle" onclick="toggleCollapse('downtime')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                Ï†ëÍ∏∞
              </button>
            </div>
            <button onclick="downloadDowntimeExcel()" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
              ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
            </button>
          </div>
          <div id="collapse-downtime" class="collapsible-content">
            <div class="overflow-x-auto">
              <table class="data-table">
                <thead>
                  <tr>
                    <th class="sortable" data-type="string">Í≥µÏ†ï</th>
                    <th class="sortable text-right" data-type="number">ÏÑ§ÎπÑÏàò</th>
                    <th class="sortable text-right" data-type="number">Ï°∞ÏóÖÏãúÍ∞Ñ(h)</th>
                    <th class="sortable text-right" data-type="number">Í∞ÄÎèôÏãúÍ∞Ñ(h)</th>
                    <th class="sortable text-right" data-type="number">ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ(h)</th>
                    <th class="sortable text-right" data-type="number">ÎπÑÍ∞ÄÎèôÏú®</th>
                    <th class="sortable text-right" data-type="number">Í∞ÄÎèôÏú®</th>
                  </tr>
                </thead>
                <tbody>
                  ${processStats.map(p => {
                    const colors = processColors[p.process] || { text: 'text-slate-700' };
                    const downtimeRateClass = p.avgDowntimeRate > 20 ? 'text-red-600 font-bold' :
                                             p.avgDowntimeRate > 10 ? 'text-amber-600' : 'text-slate-600';
                    return `
                      <tr>
                        <td class="font-medium ${colors.text}">${p.process}</td>
                        <td class="text-right">${p.equipmentCount}</td>
                        <td class="text-right">${(p.totalOperating / 60).toFixed(1)}</td>
                        <td class="text-right">${(p.totalRunning / 60).toFixed(1)}</td>
                        <td class="text-right font-medium text-red-600">${(p.totalDowntime / 60).toFixed(1)}</td>
                        <td class="text-right ${downtimeRateClass}">${p.avgDowntimeRate.toFixed(1)}%</td>
                        <td class="text-right text-blue-600">${p.avgAvailability.toFixed(1)}%</td>
                      </tr>
                    `;
                  }).join('')}
                  <tr class="bg-slate-100 font-bold">
                    <td>Ìï©Í≥Ñ</td>
                    <td class="text-right">${totalStats.totalEquipment}</td>
                    <td class="text-right">${(totalStats.totalOperating / 60).toFixed(1)}</td>
                    <td class="text-right">${((totalStats.totalOperating - totalStats.totalDowntime) / 60).toFixed(1)}</td>
                    <td class="text-right text-red-600">${(totalStats.totalDowntime / 60).toFixed(1)}</td>
                    <td class="text-right">${totalStats.avgDowntimeRate.toFixed(1)}%</td>
                    <td class="text-right text-blue-600">${(100 - totalStats.avgDowntimeRate).toFixed(1)}%</td>
                </tr>
              </tbody>
            </table>
            </div>
          </div>
        </div>

        <!-- ÏÑ§ÎπÑÎ≥Ñ ÎπÑÍ∞ÄÎèô TOP 10 ÌÖåÏù¥Î∏î -->
        <div class="card mt-6">
          <h3 class="text-lg font-bold text-slate-800 mb-4">üîß ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ TOP 10 ÏÑ§ÎπÑ</h3>
          <div class="overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th class="sortable text-center" data-sort="rank" data-type="number" style="width: 60px;">ÏàúÏúÑ</th>
                  <th class="sortable" data-sort="process" data-type="text">Í≥µÏ†ï</th>
                  <th class="sortable" data-sort="equipment" data-type="text">ÏÑ§ÎπÑÎ™Ö</th>
                  <th class="sortable text-right" data-sort="downtime" data-type="number">ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ(h)</th>
                  <th class="sortable text-right" data-sort="operating" data-type="number">Ï°∞ÏóÖÏãúÍ∞Ñ(h)</th>
                  <th class="sortable text-right" data-sort="rate" data-type="number">ÎπÑÍ∞ÄÎèôÏú®</th>
                  <th class="sortable" data-sort="status" data-type="text">ÏÉÅÌÉú</th>
                </tr>
              </thead>
              <tbody>
                ${topDowntimeEquipment.map((e, idx) => {
                  const colors = processColors[e.process] || { text: 'text-slate-700' };
                  const statusBadge = e.downtimeRate > 30 ? '<span class="badge" style="background: #fee2e2; color: #dc2626;">ÏúÑÌóò</span>' :
                                     e.downtimeRate > 15 ? '<span class="badge" style="background: #fef3c7; color: #d97706;">Ï£ºÏùò</span>' :
                                     '<span class="badge" style="background: #dcfce7; color: #16a34a;">ÏñëÌò∏</span>';
                  return `
                    <tr>
                      <td class="text-center font-bold ${idx < 3 ? 'text-red-500' : 'text-slate-500'}">${idx + 1}</td>
                      <td class="${colors.text}">${e.process}</td>
                      <td class="font-medium">${e.equipment}</td>
                      <td class="text-right font-medium text-red-600">${(e.totalDowntime / 60).toFixed(1)}</td>
                      <td class="text-right">${(e.totalOperating / 60).toFixed(1)}</td>
                      <td class="text-right">${e.downtimeRate.toFixed(1)}%</td>
                      <td>${statusBadge}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // Ïû¨Í≥µÏû¨Í≥† ÌéòÏù¥ÏßÄ Î©îÏù∏ Î†åÎçîÎßÅ
    function renderWipInventoryPage() {
      const wipData = state.wipInventoryData || [];

      if (wipData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center shadow-lg">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">Ïû¨Í≥µÏû¨Í≥† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p class="text-slate-500 mb-6">ÌååÏùºÏóÖÎ°úÎìú Î©îÎâ¥ÏóêÏÑú Ïû¨Í≥µÏû¨Í≥†Í∏àÏï° CSV ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              üì§ ÌååÏùºÏóÖÎ°úÎìú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            </button>
          </div>
        `;
      }

      // ÏÑúÎ∏åÌÉ≠Ïóê Îî∞Îùº Îã§Î•∏ ÏΩòÌÖêÏ∏† Î†åÎçîÎßÅ
      if (state.wipSubTab === 'status') {
        return renderWipInventoryStatus(wipData);
      } else {
        return renderWipInventoryPriceTable(wipData);
      }
    }

    // Ïû¨Í≥µÏû¨Í≥†ÌòÑÌô© ÌÉ≠
    function renderWipInventoryStatus(wipData) {
      // ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
      const totalStock = wipData.reduce((sum, d) => sum + d.stock, 0);
      const totalValue = wipData.reduce((sum, d) => sum + d.stockValue, 0);
      const avgCost = wipData.length > 0 ? totalValue / totalStock : 0;
      const uniqueItems = wipData.length;

      // ÌíàÎ™©Ïú†ÌòïÎ≥Ñ ÏßëÍ≥Ñ
      const typeData = {};
      wipData.forEach(d => {
        const type = d.itemType || 'Í∏∞ÌÉÄ';
        if (!typeData[type]) {
          typeData[type] = { type, stock: 0, value: 0, count: 0 };
        }
        typeData[type].stock += d.stock;
        typeData[type].value += d.stockValue;
        typeData[type].count++;
      });
      const typeList = Object.values(typeData).sort((a, b) => b.value - a.value);

      // Í∑úÍ≤©Î≥Ñ ÏßëÍ≥Ñ
      const specData = {};
      wipData.forEach(d => {
        const spec = d.spec || 'Í∏∞ÌÉÄ';
        if (!specData[spec]) {
          specData[spec] = { spec, stock: 0, value: 0, count: 0 };
        }
        specData[spec].stock += d.stock;
        specData[spec].value += d.stockValue;
        specData[spec].count++;
      });
      const specList = Object.values(specData).sort((a, b) => b.value - a.value);

      // Ïû¨Í≥†Í∏àÏï° TOP 10
      const topValueItems = [...wipData].sort((a, b) => b.stockValue - a.stockValue).slice(0, 10);

      // Ïû¨Í≥†ÏàòÎüâ TOP 10
      const topStockItems = [...wipData].sort((a, b) => b.stock - a.stock).slice(0, 10);

      return `
        <div class="section-header">
          <div class="section-title">
            <span class="inline-flex items-center gap-2">
              <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white text-xl shadow-md">üì¶</span>
              Ïû¨Í≥µÏû¨Í≥† ÌòÑÌô© Î∂ÑÏÑù
            </span>
          </div>
          <div class="text-sm text-slate-500">${formatNumber(uniqueItems)}Í∞ú ÌíàÎ™© Î∂ÑÏÑù</div>
        </div>

        <!-- ÏöîÏïΩ Ïπ¥Îìú -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card" style="background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); border-left: 4px solid #14b8a6;">
            <div class="stat-label">Ï¥ù Ïû¨Í≥†ÏàòÎüâ</div>
            <div class="stat-value text-teal-600">${formatNumber(totalStock)} EA</div>
            <div class="stat-sub">${formatNumber(uniqueItems)}Í∞ú ÌíàÎ™©</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0ea5e9;">
            <div class="stat-label">Ï¥ù Ïû¨Í≥†Í∏àÏï°</div>
            <div class="stat-value text-sky-600">${formatNumber(Math.round(totalValue / 10000))} ÎßåÏõê</div>
            <div class="stat-sub">${formatNumber(totalValue)} Ïõê</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border-left: 4px solid #eab308;">
            <div class="stat-label">ÌèâÍ∑† Îã®Í∞Ä</div>
            <div class="stat-value text-amber-600">${formatNumber(Math.round(avgCost))} Ïõê</div>
            <div class="stat-sub">ÌíàÎ™©Îãπ ÌèâÍ∑†</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-left: 4px solid #a855f7;">
            <div class="stat-label">ÌíàÎ™©Ïú†Ìòï</div>
            <div class="stat-value text-purple-600">${typeList.length} Ï¢Ö</div>
            <div class="stat-sub">Ïú†Ìòï Î∂ÑÎ•ò</div>
          </div>
        </div>

        <!-- Ï∞®Ìä∏ ÏòÅÏó≠ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">ÌíàÎ™©Ïú†ÌòïÎ≥Ñ Ïû¨Í≥†Í∏àÏï° Íµ¨ÏÑ±</div>
            <div style="height: 280px;"><canvas id="wipTypeChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">Í∑úÍ≤©Î≥Ñ Ïû¨Í≥†Í∏àÏï° TOP 10</div>
            <div style="height: 280px;"><canvas id="wipSpecChart"></canvas></div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">Ïû¨Í≥†Í∏àÏï° TOP 10 ÌíàÎ™©</div>
            <div style="height: 280px;"><canvas id="wipTopValueChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">Ïû¨Í≥†ÏàòÎüâ TOP 10 ÌíàÎ™©</div>
            <div style="height: 280px;"><canvas id="wipTopStockChart"></canvas></div>
          </div>
        </div>

        <!-- ÌíàÎ™©Ïú†ÌòïÎ≥Ñ ÏÉÅÏÑ∏ ÌÖåÏù¥Î∏î -->
        <div class="card mb-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              <span>üìä ÌíàÎ™©Ïú†ÌòïÎ≥Ñ Ïû¨Í≥†ÌòÑÌô©</span>
              <span class="text-sm font-normal text-slate-500">(${typeList.length}Í∞ú Ïú†Ìòï)</span>
            </h3>
            <div class="flex items-center gap-2">
              <button onclick="downloadWipInventoryExcel()" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-emerald-700 bg-emerald-100 hover:bg-emerald-200 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Excel
              </button>
              <button id="toggle-wipType" onclick="toggleCollapse('wipType')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                <svg class="w-4 h-4 transition-transform ${collapseState.wipType ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                ${collapseState.wipType ? 'ÌéºÏπòÍ∏∞' : 'Ï†ëÍ∏∞'}
              </button>
            </div>
          </div>
          <div id="collapse-wipType" class="collapsible-content ${collapseState.wipType ? 'collapsed' : ''}">
            <div class="overflow-x-auto">
              <table class="data-table w-full">
                <thead>
                  <tr>
                    <th class="text-left sortable" data-type="string">ÌíàÎ™©Ïú†Ìòï</th>
                    <th class="text-right sortable" data-type="number">ÌíàÎ™©Ïàò</th>
                    <th class="text-right sortable" data-type="number">Ïû¨Í≥†ÏàòÎüâ</th>
                    <th class="text-right sortable" data-type="number">Ïû¨Í≥†Í∏àÏï°</th>
                    <th class="text-right sortable" data-type="number">ÌèâÍ∑†Îã®Í∞Ä</th>
                    <th class="text-right sortable" data-type="number">Íµ¨ÏÑ±ÎπÑ</th>
                  </tr>
                </thead>
                <tbody>
                  ${typeList.map(t => `
                    <tr>
                      <td class="font-medium">${t.type}</td>
                      <td class="text-right">${formatNumber(t.count)}</td>
                      <td class="text-right text-teal-600">${formatNumber(t.stock)}</td>
                      <td class="text-right text-sky-600 font-semibold">${formatNumber(t.value)}</td>
                      <td class="text-right">${formatNumber(Math.round(t.value / t.stock))}</td>
                      <td class="text-right">
                        <div class="flex items-center justify-end gap-2">
                          <div class="w-16 h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div class="h-full bg-teal-400 rounded-full" style="width: ${(t.value / totalValue * 100).toFixed(1)}%"></div>
                          </div>
                          <span class="text-sm">${(t.value / totalValue * 100).toFixed(1)}%</span>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                  <tr class="bg-slate-100 font-bold">
                    <td>Ìï©Í≥Ñ</td>
                    <td class="text-right">${formatNumber(uniqueItems)}</td>
                    <td class="text-right text-teal-700">${formatNumber(totalStock)}</td>
                    <td class="text-right text-sky-700">${formatNumber(totalValue)}</td>
                    <td class="text-right">${formatNumber(Math.round(avgCost))}</td>
                    <td class="text-right">100%</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Í∑úÍ≤©Î≥Ñ ÏÉÅÏÑ∏ ÌÖåÏù¥Î∏î -->
        <div class="card">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              <span>üìã Í∑úÍ≤©Î≥Ñ Ïû¨Í≥†ÌòÑÌô©</span>
              <span class="text-sm font-normal text-slate-500">(${specList.length}Í∞ú Í∑úÍ≤©)</span>
            </h3>
            <button id="toggle-wipSpec" onclick="toggleCollapse('wipSpec')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
              <svg class="w-4 h-4 transition-transform ${collapseState.wipSpec ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              ${collapseState.wipSpec ? 'ÌéºÏπòÍ∏∞' : 'Ï†ëÍ∏∞'}
            </button>
          </div>
          <div id="collapse-wipSpec" class="collapsible-content ${collapseState.wipSpec ? 'collapsed' : ''}">
            <div class="overflow-x-auto">
              <table class="data-table w-full">
                <thead>
                  <tr>
                    <th class="text-left sortable" data-type="string">Í∑úÍ≤©</th>
                    <th class="text-right sortable" data-type="number">ÌíàÎ™©Ïàò</th>
                    <th class="text-right sortable" data-type="number">Ïû¨Í≥†ÏàòÎüâ</th>
                    <th class="text-right sortable" data-type="number">Ïû¨Í≥†Í∏àÏï°</th>
                    <th class="text-right sortable" data-type="number">ÌèâÍ∑†Îã®Í∞Ä</th>
                    <th class="text-right sortable" data-type="number">Íµ¨ÏÑ±ÎπÑ</th>
                  </tr>
                </thead>
                <tbody>
                  ${specList.slice(0, 15).map(s => `
                    <tr>
                      <td class="font-medium">${s.spec}</td>
                      <td class="text-right">${formatNumber(s.count)}</td>
                      <td class="text-right text-teal-600">${formatNumber(s.stock)}</td>
                      <td class="text-right text-sky-600 font-semibold">${formatNumber(s.value)}</td>
                      <td class="text-right">${formatNumber(Math.round(s.value / s.stock))}</td>
                      <td class="text-right">${(s.value / totalValue * 100).toFixed(1)}%</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${specList.length > 15 ? `<div class="text-center text-sm text-slate-500 mt-4">ÏÉÅÏúÑ 15Í∞ú Í∑úÍ≤© ÌëúÏãú Ï§ë (Ï†ÑÏ≤¥ ${specList.length}Í∞ú)</div>` : ''}
          </div>
        </div>
      `;
    }

    // Ïû¨Í≥µÏû¨Í≥†Îã®Í∞ÄÌëú ÌÉ≠
    function renderWipInventoryPriceTable(wipData) {
      // Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ
      const totalValue = wipData.reduce((sum, d) => sum + d.stockValue, 0);
      const totalStock = wipData.reduce((sum, d) => sum + d.stock, 0);

      // Îã®Í∞Ä Íµ¨Í∞ÑÎ≥Ñ Î∂ÑÌè¨
      const priceRanges = [
        { label: '1,000Ïõê ÎØ∏Îßå', min: 0, max: 1000, count: 0, value: 0, stock: 0 },
        { label: '1,000~5,000Ïõê', min: 1000, max: 5000, count: 0, value: 0, stock: 0 },
        { label: '5,000~10,000Ïõê', min: 5000, max: 10000, count: 0, value: 0, stock: 0 },
        { label: '10,000~20,000Ïõê', min: 10000, max: 20000, count: 0, value: 0, stock: 0 },
        { label: '20,000~50,000Ïõê', min: 20000, max: 50000, count: 0, value: 0, stock: 0 },
        { label: '50,000Ïõê Ïù¥ÏÉÅ', min: 50000, max: Infinity, count: 0, value: 0, stock: 0 }
      ];

      wipData.forEach(d => {
        const range = priceRanges.find(r => d.unitCost >= r.min && d.unitCost < r.max);
        if (range) {
          range.count++;
          range.value += d.stockValue;
          range.stock += d.stock;
        }
      });

      // Í≥†Í∞Ä ÌíàÎ™© TOP 20 (Îã®Í∞Ä Í∏∞Ï§Ä)
      const highPriceItems = [...wipData].sort((a, b) => b.unitCost - a.unitCost).slice(0, 20);

      // Ï†ÄÍ∞Ä ÌíàÎ™© TOP 20 (Îã®Í∞Ä Í∏∞Ï§Ä)
      const lowPriceItems = [...wipData].filter(d => d.unitCost > 0).sort((a, b) => a.unitCost - b.unitCost).slice(0, 20);

      return `
        <div class="section-header">
          <div class="section-title">
            <span class="inline-flex items-center gap-2">
              <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center text-white text-xl shadow-md">üí∞</span>
              Ïû¨Í≥µÏû¨Í≥† Îã®Í∞ÄÌëú
            </span>
          </div>
          <div class="text-sm text-slate-500">${formatNumber(wipData.length)}Í∞ú ÌíàÎ™© Îã®Í∞Ä Î∂ÑÏÑù</div>
        </div>

        <!-- ÏöîÏïΩ Ïπ¥Îìú -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card" style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-left: 4px solid #f59e0b;">
            <div class="stat-label">ÏµúÍ≥† Îã®Í∞Ä</div>
            <div class="stat-value text-amber-600">${formatNumber(Math.max(...wipData.map(d => d.unitCost)))} Ïõê</div>
            <div class="stat-sub">ÏµúÍ≥†Í∞Ä ÌíàÎ™©</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-left: 4px solid #10b981;">
            <div class="stat-label">ÏµúÏ†Ä Îã®Í∞Ä</div>
            <div class="stat-value text-emerald-600">${formatNumber(Math.min(...wipData.filter(d => d.unitCost > 0).map(d => d.unitCost)))} Ïõê</div>
            <div class="stat-sub">ÏµúÏ†ÄÍ∞Ä ÌíàÎ™©</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0ea5e9;">
            <div class="stat-label">ÌèâÍ∑† Îã®Í∞Ä</div>
            <div class="stat-value text-sky-600">${formatNumber(Math.round(totalValue / totalStock))} Ïõê</div>
            <div class="stat-sub">Í∞ÄÏ§ë ÌèâÍ∑†</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%); border-left: 4px solid #d946ef;">
            <div class="stat-label">Ï§ëÍ∞Ñ Îã®Í∞Ä</div>
            <div class="stat-value text-fuchsia-600">${formatNumber(wipData.sort((a, b) => a.unitCost - b.unitCost)[Math.floor(wipData.length / 2)]?.unitCost || 0)} Ïõê</div>
            <div class="stat-sub">Ï§ëÏïôÍ∞í</div>
          </div>
        </div>

        <!-- Ï∞®Ìä∏ ÏòÅÏó≠ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">Îã®Í∞Ä Íµ¨Í∞ÑÎ≥Ñ ÌíàÎ™© Î∂ÑÌè¨</div>
            <div style="height: 280px;"><canvas id="wipPriceRangeChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">Îã®Í∞Ä Íµ¨Í∞ÑÎ≥Ñ Ïû¨Í≥†Í∏àÏï° Î∂ÑÌè¨</div>
            <div style="height: 280px;"><canvas id="wipPriceValueChart"></canvas></div>
          </div>
        </div>

        <!-- Îã®Í∞Ä Íµ¨Í∞ÑÎ≥Ñ ÌÖåÏù¥Î∏î -->
        <div class="card mb-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              <span>üìä Îã®Í∞Ä Íµ¨Í∞ÑÎ≥Ñ Î∂ÑÌè¨</span>
            </h3>
            <button id="toggle-wipPrice" onclick="toggleCollapse('wipPrice')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
              <svg class="w-4 h-4 transition-transform ${collapseState.wipPrice ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              ${collapseState.wipPrice ? 'ÌéºÏπòÍ∏∞' : 'Ï†ëÍ∏∞'}
            </button>
          </div>
          <div id="collapse-wipPrice" class="collapsible-content ${collapseState.wipPrice ? 'collapsed' : ''}">
            <div class="overflow-x-auto">
              <table class="data-table w-full">
                <thead>
                  <tr>
                    <th class="text-left sortable" data-type="string">Îã®Í∞Ä Íµ¨Í∞Ñ</th>
                    <th class="text-right sortable" data-type="number">ÌíàÎ™©Ïàò</th>
                    <th class="text-right sortable" data-type="number">Ïû¨Í≥†ÏàòÎüâ</th>
                    <th class="text-right sortable" data-type="number">Ïû¨Í≥†Í∏àÏï°</th>
                    <th class="text-right sortable" data-type="number">Íµ¨ÏÑ±ÎπÑ</th>
                  </tr>
                </thead>
                <tbody>
                  ${priceRanges.map(r => `
                    <tr>
                      <td class="font-medium">${r.label}</td>
                      <td class="text-right">${formatNumber(r.count)}</td>
                      <td class="text-right text-teal-600">${formatNumber(r.stock)}</td>
                      <td class="text-right text-sky-600 font-semibold">${formatNumber(r.value)}</td>
                      <td class="text-right">
                        <div class="flex items-center justify-end gap-2">
                          <div class="w-20 h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div class="h-full bg-amber-400 rounded-full" style="width: ${totalValue > 0 ? (r.value / totalValue * 100) : 0}%"></div>
                          </div>
                          <span class="text-sm">${totalValue > 0 ? (r.value / totalValue * 100).toFixed(1) : 0}%</span>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Í≥†Í∞Ä/Ï†ÄÍ∞Ä ÌíàÎ™© ÌÖåÏù¥Î∏î -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span class="text-xl">üíé</span>
                <span>Í≥†Í∞Ä ÌíàÎ™© TOP 20</span>
              </h3>
              <button id="toggle-wipHighPrice" onclick="toggleCollapse('wipHighPrice')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                <svg class="w-4 h-4 transition-transform ${collapseState.wipHighPrice ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                ${collapseState.wipHighPrice ? 'ÌéºÏπòÍ∏∞' : 'Ï†ëÍ∏∞'}
              </button>
            </div>
            <div id="collapse-wipHighPrice" class="collapsible-content ${collapseState.wipHighPrice ? 'collapsed' : ''}">
              <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table w-full">
                  <thead class="sticky top-0 bg-white">
                    <tr>
                      <th class="text-center sortable" data-type="number" style="width: 40px;">ÏàúÏúÑ</th>
                      <th class="text-left sortable" data-type="string">ÌíàÎ™©Î™Ö</th>
                      <th class="text-right sortable" data-type="number">Îã®Í∞Ä</th>
                      <th class="text-right sortable" data-type="number">Ïû¨Í≥†</th>
                      <th class="text-right sortable" data-type="number">Í∏àÏï°</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${highPriceItems.map((item, idx) => `
                      <tr>
                        <td class="text-center font-bold ${idx < 3 ? 'text-amber-500' : 'text-slate-400'}">${idx + 1}</td>
                        <td class="font-medium text-sm">${item.itemName?.substring(0, 25) || item.itemCode}${item.itemName?.length > 25 ? '...' : ''}</td>
                        <td class="text-right text-amber-600 font-semibold">${formatNumber(item.unitCost)}</td>
                        <td class="text-right">${formatNumber(item.stock)}</td>
                        <td class="text-right text-sky-600">${formatNumber(item.stockValue)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span class="text-xl">üè∑Ô∏è</span>
                <span>Ï†ÄÍ∞Ä ÌíàÎ™© TOP 20</span>
              </h3>
              <button id="toggle-wipLowPrice" onclick="toggleCollapse('wipLowPrice')" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                <svg class="w-4 h-4 transition-transform ${collapseState.wipLowPrice ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                ${collapseState.wipLowPrice ? 'ÌéºÏπòÍ∏∞' : 'Ï†ëÍ∏∞'}
              </button>
            </div>
            <div id="collapse-wipLowPrice" class="collapsible-content ${collapseState.wipLowPrice ? 'collapsed' : ''}">
              <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table w-full">
                  <thead class="sticky top-0 bg-white">
                    <tr>
                      <th class="text-center sortable" data-type="number" style="width: 40px;">ÏàúÏúÑ</th>
                      <th class="text-left sortable" data-type="string">ÌíàÎ™©Î™Ö</th>
                      <th class="text-right sortable" data-type="number">Îã®Í∞Ä</th>
                      <th class="text-right sortable" data-type="number">Ïû¨Í≥†</th>
                      <th class="text-right sortable" data-type="number">Í∏àÏï°</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${lowPriceItems.map((item, idx) => `
                      <tr>
                        <td class="text-center font-bold ${idx < 3 ? 'text-emerald-500' : 'text-slate-400'}">${idx + 1}</td>
                        <td class="font-medium text-sm">${item.itemName?.substring(0, 25) || item.itemCode}${item.itemName?.length > 25 ? '...' : ''}</td>
                        <td class="text-right text-emerald-600 font-semibold">${formatNumber(item.unitCost)}</td>
                        <td class="text-right">${formatNumber(item.stock)}</td>
                        <td class="text-right text-sky-600">${formatNumber(item.stockValue)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Ïû¨Í≥µÏû¨Í≥† Ï∞®Ìä∏ ÏÉùÏÑ±
    function createWipInventoryCharts() {
      const wipData = state.wipInventoryData || [];
      if (wipData.length === 0) return;

      const totalValue = wipData.reduce((sum, d) => sum + d.stockValue, 0);

      // ÌíàÎ™©Ïú†ÌòïÎ≥Ñ ÏßëÍ≥Ñ
      const typeData = {};
      wipData.forEach(d => {
        const type = d.itemType || 'Í∏∞ÌÉÄ';
        if (!typeData[type]) typeData[type] = { type, value: 0 };
        typeData[type].value += d.stockValue;
      });
      const typeList = Object.values(typeData).sort((a, b) => b.value - a.value);

      // Í∑úÍ≤©Î≥Ñ ÏßëÍ≥Ñ
      const specData = {};
      wipData.forEach(d => {
        const spec = d.spec || 'Í∏∞ÌÉÄ';
        if (!specData[spec]) specData[spec] = { spec, value: 0 };
        specData[spec].value += d.stockValue;
      });
      const specList = Object.values(specData).sort((a, b) => b.value - a.value).slice(0, 10);

      // TOP 10 ÌíàÎ™©
      const topValueItems = [...wipData].sort((a, b) => b.stockValue - a.stockValue).slice(0, 10);
      const topStockItems = [...wipData].sort((a, b) => b.stock - a.stock).slice(0, 10);

      // ÌíàÎ™©Ïú†ÌòïÎ≥Ñ Ï∞®Ìä∏
      const typeChartCtx = document.getElementById('wipTypeChart');
      if (typeChartCtx) {
        if (charts.wipType) charts.wipType.destroy();
        charts.wipType = new Chart(typeChartCtx, {
          type: 'doughnut',
          data: {
            labels: typeList.map(t => t.type),
            datasets: [{
              data: typeList.map(t => t.value),
              backgroundColor: typeList.map((_, i) => generatePastelColor(i)),
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { boxWidth: 12, padding: 8 } },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.label}: ${formatNumber(ctx.raw)}Ïõê (${(ctx.raw / totalValue * 100).toFixed(1)}%)`
                }
              }
            }
          }
        });
      }

      // Í∑úÍ≤©Î≥Ñ Ï∞®Ìä∏
      const specChartCtx = document.getElementById('wipSpecChart');
      if (specChartCtx) {
        if (charts.wipSpec) charts.wipSpec.destroy();
        charts.wipSpec = new Chart(specChartCtx, {
          type: 'bar',
          data: {
            labels: specList.map(s => s.spec),
            datasets: [{
              label: 'Ïû¨Í≥†Í∏àÏï°',
              data: specList.map(s => s.value),
              backgroundColor: specList.map((_, i) => generatePastelColor(i + 2)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatCompact(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }

      // Ïû¨Í≥†Í∏àÏï° TOP 10 Ï∞®Ìä∏
      const topValueCtx = document.getElementById('wipTopValueChart');
      if (topValueCtx) {
        if (charts.wipTopValue) charts.wipTopValue.destroy();
        charts.wipTopValue = new Chart(topValueCtx, {
          type: 'bar',
          data: {
            labels: topValueItems.map(i => (i.itemName || i.itemCode).substring(0, 12) + '...'),
            datasets: [{
              label: 'Ïû¨Í≥†Í∏àÏï°',
              data: topValueItems.map(i => i.stockValue),
              backgroundColor: topValueItems.map((_, idx) => generatePastelColor(idx + 1)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatCompact(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }

      // Ïû¨Í≥†ÏàòÎüâ TOP 10 Ï∞®Ìä∏
      const topStockCtx = document.getElementById('wipTopStockChart');
      if (topStockCtx) {
        if (charts.wipTopStock) charts.wipTopStock.destroy();
        charts.wipTopStock = new Chart(topStockCtx, {
          type: 'bar',
          data: {
            labels: topStockItems.map(i => (i.itemName || i.itemCode).substring(0, 12) + '...'),
            datasets: [{
              label: 'Ïû¨Í≥†ÏàòÎüâ',
              data: topStockItems.map(i => i.stock),
              backgroundColor: topStockItems.map((_, idx) => generatePastelColor(idx)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }

      // Îã®Í∞Ä Íµ¨Í∞ÑÎ≥Ñ Î∂ÑÌè¨ Ï∞®Ìä∏
      const priceRanges = [
        { label: '~1Ï≤ú', min: 0, max: 1000, count: 0, value: 0 },
        { label: '1~5Ï≤ú', min: 1000, max: 5000, count: 0, value: 0 },
        { label: '5Ï≤ú~1Îßå', min: 5000, max: 10000, count: 0, value: 0 },
        { label: '1~2Îßå', min: 10000, max: 20000, count: 0, value: 0 },
        { label: '2~5Îßå', min: 20000, max: 50000, count: 0, value: 0 },
        { label: '5Îßå~', min: 50000, max: Infinity, count: 0, value: 0 }
      ];

      wipData.forEach(d => {
        const range = priceRanges.find(r => d.unitCost >= r.min && d.unitCost < r.max);
        if (range) {
          range.count++;
          range.value += d.stockValue;
        }
      });

      const priceRangeCtx = document.getElementById('wipPriceRangeChart');
      if (priceRangeCtx) {
        if (charts.wipPriceRange) charts.wipPriceRange.destroy();
        charts.wipPriceRange = new Chart(priceRangeCtx, {
          type: 'bar',
          data: {
            labels: priceRanges.map(r => r.label),
            datasets: [{
              label: 'ÌíàÎ™©Ïàò',
              data: priceRanges.map(r => r.count),
              backgroundColor: 'rgba(147, 197, 253, 0.85)',
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      const priceValueCtx = document.getElementById('wipPriceValueChart');
      if (priceValueCtx) {
        if (charts.wipPriceValue) charts.wipPriceValue.destroy();
        charts.wipPriceValue = new Chart(priceValueCtx, {
          type: 'doughnut',
          data: {
            labels: priceRanges.map(r => r.label),
            datasets: [{
              data: priceRanges.map(r => r.value),
              backgroundColor: [
                'rgba(147, 197, 253, 0.85)',
                'rgba(110, 231, 183, 0.85)',
                'rgba(253, 186, 116, 0.85)',
                'rgba(252, 165, 165, 0.85)',
                'rgba(196, 181, 253, 0.85)',
                'rgba(249, 168, 212, 0.85)'
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { boxWidth: 12, padding: 8 } },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.label}: ${formatNumber(ctx.raw)}Ïõê`
                }
              }
            }
          }
        });
      }
    }

    // Í≥µÏ†ïÎ≥Ñ OEE(Ï¢ÖÌï©Ìö®Ïú®) Í≥ÑÏÇ∞
    // OEE = ÏãúÍ∞ÑÍ∞ÄÎèôÏú® √ó ÏÑ±Îä•Í∞ÄÎèôÏú® √ó ÏñëÌíàÏú® (Í∞ÅÍ∞Å 0~1 ÏÇ¨Ïù¥ Í∞íÏúºÎ°ú Í≥ÑÏÇ∞)
    function getOEEData(data) {
      // Í∞ÄÎèôÏú® Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Í≥µÏ†ïÎ≥Ñ ÏãúÍ∞ÑÍ∞ÄÎèôÏú® Í∞ÄÏ†∏Ïò§Í∏∞
      const processAvailability = getProcessAvailability();

      const grouped = {};
      data.forEach(row => {
        // Laser Í≥µÏ†ï Ï†úÏô∏
        if (excludedProcesses.includes(row.process)) return;
        if (!grouped[row.process]) {
          grouped[row.process] = {
            process: row.process,
            production: 0,
            good: 0,
            defect: 0,
            standard: 0,
            records: 0
          };
        }
        grouped[row.process].production += row.productionQty;
        grouped[row.process].good += row.goodQty;
        grouped[row.process].defect += row.defectQty;
        grouped[row.process].standard += row.standardQty;
        grouped[row.process].records++;
      });

      return Object.values(grouped)
        .sort((a, b) => {
          const orderA = processOrder.indexOf(a.process);
          const orderB = processOrder.indexOf(b.process);
          if (orderA === -1) return 1;
          if (orderB === -1) return -1;
          return orderA - orderB;
        })
        .map(d => {
          // ÏãúÍ∞ÑÍ∞ÄÎèôÏú®: Í∞ÄÎèôÏú® Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Í≥ÑÏÇ∞
          const availability = processAvailability[d.process] !== undefined
            ? Math.min(processAvailability[d.process], 100)
            : (d.standard > 0 ? Math.min((d.production / d.standard) * 100, 100) : 0);

          // ÏÑ±Îä•Í∞ÄÎèôÏú®: Ïã§Ï†ú ÏÉùÏÇ∞Îüâ / ÌëúÏ§Ä ÏÉùÏÇ∞Îüâ (ÏµúÎåÄ 100%)
          const performance = d.standard > 0 ? Math.min((d.production / d.standard) * 100, 100) : 0;

          // ÏñëÌíàÏú®: ÏñëÌíà / ÏÉùÏÇ∞Îüâ
          const quality = d.production > 0 ? (d.good / d.production) * 100 : 0;

          // Ï¢ÖÌï©Ìö®Ïú® OEE = (ÏãúÍ∞ÑÍ∞ÄÎèôÏú®/100) √ó (ÏÑ±Îä•Í∞ÄÎèôÏú®/100) √ó (ÏñëÌíàÏú®/100) √ó 100
          const oee = (availability / 100) * (performance / 100) * (quality / 100) * 100;

          return {
            ...d,
            availability: availability.toFixed(1),
            performance: performance.toFixed(1),
            quality: quality.toFixed(1),
            oee: oee.toFixed(1)
          };
        });
    }

    // Ï¢ÖÌï©ÌòÑÌô© - Apple Ïä§ÌÉÄÏùº
    function renderOverview(stats, data) {
      if (!stats) return '<p class="text-center text-slate-500 py-8">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
      const oeeData = getOEEData(data);
      const totalOEE = oeeData.length > 0
        ? (oeeData.reduce((sum, d) => sum + parseFloat(d.oee), 0) / oeeData.length).toFixed(1)
        : 0;

      return `
        <!-- Section Header -->
        <div class="section-header">
          <div class="section-title">Í≥µÏ†ïÎ≥Ñ Ï¢ÖÌï©Ìö®Ïú® (OEE)</div>
          <div class="flex items-center gap-3">
            <select class="filter-select" style="background: #f1f5f9; border-color: #cbd5e1; font-weight: 500;" onchange="setSelectedMonth(this.value)">
              ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}Ïõî</option>`).join('')}
            </select>
            <select class="filter-select" onchange="setFilter('process', this.value)">
              <option value="all">All</option>
              ${getUniqueValues('process').map(p => `<option value="${p}" ${state.filters.process === p ? 'selected' : ''}>${p}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="flex gap-4 mb-2">
          ${state.availabilityData.length > 0 ? `<span class="text-sm text-blue-600">‚úì Í∞ÄÎèôÏú® ${state.availabilityData.length}Í±¥</span>` : ''}
          ${state.ctData.length > 0 ? `<span class="text-sm text-amber-600">‚úì CTÌòÑÌô© ${state.ctData.length}Í±¥</span>` : ''}
        </div>

        <!-- Total OEE Card -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card ${parseFloat(totalOEE) >= 85 ? 'green' : parseFloat(totalOEE) >= 60 ? '' : 'red'}">
            <div class="stat-label">Ï†ÑÏ≤¥ Ï¢ÖÌï©Ìö®Ïú® (OEE)</div>
            <div class="stat-value ${parseFloat(totalOEE) >= 85 ? 'text-emerald-600' : parseFloat(totalOEE) >= 60 ? 'text-slate-600' : 'text-red-400'}">${totalOEE}%</div>
            <div class="stat-sub">ÏãúÍ∞ÑÍ∞ÄÎèôÏú® √ó ÏÑ±Îä•Í∞ÄÎèôÏú® √ó ÏñëÌíàÏú®</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ÌèâÍ∑† ÏãúÍ∞ÑÍ∞ÄÎèôÏú®</div>
            <div class="stat-value text-slate-600">${oeeData.length > 0 ? (oeeData.reduce((sum, d) => sum + parseFloat(d.availability), 0) / oeeData.length).toFixed(1) : 0}%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ÌèâÍ∑† ÏÑ±Îä•Í∞ÄÎèôÏú®</div>
            <div class="stat-value text-slate-600">${oeeData.length > 0 ? (oeeData.reduce((sum, d) => sum + parseFloat(d.performance), 0) / oeeData.length).toFixed(1) : 0}%</div>
          </div>
          <div class="stat-card blue">
            <div class="stat-label">ÌèâÍ∑† ÏñëÌíàÏú®</div>
            <div class="stat-value text-blue-600">${stats.avgYield}%</div>
          </div>
        </div>

        <!-- Monthly OEE Chart -->
        <div class="chart-card mb-6">
          <div class="chart-title">ÏõîÎ≥Ñ Ï¢ÖÌï©Ìö®Ïú® (OEE) Ï∂îÏù¥</div>
          <div style="height: 280px;"><canvas id="monthlyOeeChart"></canvas></div>
        </div>

        <!-- OEE by Process Table -->
        <div class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-base font-bold text-slate-800">Í≥µÏ†ïÎ≥Ñ Ï¢ÖÌï©Ìö®Ïú® ÏÉÅÏÑ∏</h3>
              <button id="toggle-oee" class="collapse-toggle" onclick="toggleCollapse('oee')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                Ï†ëÍ∏∞
              </button>
            </div>
            <button onclick="downloadOEEExcel()" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
              ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
            </button>
          </div>
          <div id="collapse-oee" class="collapsible-content">
            <table class="data-table">
              <thead>
                <tr>
                  <th class="sortable" data-sort="process" data-type="text">Í≥µÏ†ï</th>
                  <th class="sortable text-right" data-sort="production" data-type="number">ÏÉùÏÇ∞ÏàòÎüâ</th>
                  <th class="sortable text-right" data-sort="good" data-type="number">ÏñëÌíàÏàòÎüâ</th>
                  <th class="sortable text-right" data-sort="availability" data-type="number">ÏãúÍ∞ÑÍ∞ÄÎèôÏú®</th>
                  <th class="sortable text-right" data-sort="performance" data-type="number">ÏÑ±Îä•Í∞ÄÎèôÏú®</th>
                  <th class="sortable text-right" data-sort="quality" data-type="number">ÏñëÌíàÏú®</th>
                  <th class="sortable text-right" data-sort="oee" data-type="number">Ï¢ÖÌï©Ìö®Ïú®(OEE)</th>
                </tr>
              </thead>
              <tbody>
                ${oeeData.map(d => `
                  <tr>
                    <td class="font-medium">${d.process}</td>
                    <td class="text-right">${formatNumber(d.production)}</td>
                    <td class="text-right text-blue-600">${formatNumber(d.good)}</td>
                    <td class="text-right">${d.availability}%</td>
                    <td class="text-right">${d.performance}%</td>
                    <td class="text-right">${d.quality}%</td>
                    <td class="text-right">
                      <span class="badge ${parseFloat(d.oee) >= 85 ? 'badge-success' : parseFloat(d.oee) >= 60 ? 'badge-warning' : 'badge-danger'}">
                        ${d.oee}%
                      </span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- OEE Chart -->
        <div class="chart-card">
          <div class="chart-title">Í≥µÏ†ïÎ≥Ñ Ï¢ÖÌï©Ìö®Ïú® (OEE) ÎπÑÍµê</div>
          <div style="height: 280px;"><canvas id="oeeChart"></canvas></div>
        </div>
      `;
    }

    // Í≥µÏ†ïÌòÑÌô©
    function renderProcess(data) {
      if (!state.activeProcess) {
        return `
          <div class="text-center py-16">
            <div class="text-6xl mb-4">üëÜ</div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">Í≥µÏ†ïÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</h3>
            <p class="text-slate-500">ÏÉÅÎã® Î©îÎâ¥ÏóêÏÑú ÌôïÏù∏Ìï† Í≥µÏ†ïÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</p>
          </div>
        `;
      }

      const processInfo = processMenus.find(p => p.id === state.activeProcess);
      const processName = processDataMapping[state.activeProcess];
      const filteredData = data.filter(d => d.process === processName);
      const stats = getSummaryStats(filteredData);

      // ÏÑ§ÎπÑÎ≥Ñ Îç∞Ïù¥ÌÑ∞
      const equipmentData = {};
      filteredData.forEach(row => {
        if (!equipmentData[row.equipment]) {
          equipmentData[row.equipment] = { equipment: row.equipment, production: 0, good: 0, defect: 0 };
        }
        equipmentData[row.equipment].production += row.productionQty;
        equipmentData[row.equipment].good += row.goodQty;
        equipmentData[row.equipment].defect += row.defectQty;
      });
      const equipments = Object.values(equipmentData);

      // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÌïòÏúÑÎ©îÎâ¥Ïóê Îî∞Îùº Îã§Î•∏ ÏΩòÌÖêÏ∏† ÌëúÏãú
      const subMenuContent = renderSubMenuContent(state.activeSubMenu, filteredData, stats, processInfo, equipments);

      return `
        <!-- Section Header -->
        <div class="section-header">
          <div class="section-title">
            ${processInfo.name} - ${getCurrentSubMenuName()}
          </div>
          <div class="flex items-center gap-3">
            <select class="filter-select" style="background: #f1f5f9; border-color: #cbd5e1; font-weight: 500;" onchange="setSelectedMonth(this.value)">
              ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}Ïõî</option>`).join('')}
            </select>
            <select class="filter-select" onchange="setFilter('equipment', this.value)">
              <option value="all">All</option>
              ${equipments.map(e => `<option value="${e.equipment}" ${state.filters.equipment === e.equipment ? 'selected' : ''}>${e.equipment}</option>`).join('')}
            </select>
          </div>
        </div>

        ${subMenuContent}
      `;
    }

    // ÌòÑÏû¨ ÌïòÏúÑÎ©îÎâ¥ Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
    function getCurrentSubMenuName() {
      const subMenus = getCurrentSubMenus();
      const current = subMenus.find(s => s.id === state.activeSubMenu);
      return current ? current.name : 'ÏÉùÏÇ∞ÌòÑÌô©';
    }

    // ÌïòÏúÑÎ©îÎâ¥Î≥Ñ ÏΩòÌÖêÏ∏† Î†åÎçîÎßÅ
    function renderSubMenuContent(subMenuId, data, stats, processInfo, equipments) {
      if (!stats) return '<p class="text-center text-slate-500 py-8">Ìï¥Îãπ Í≥µÏ†ïÏùò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';

      switch(subMenuId) {
        case 'production':
          return renderProductionContent(data, stats, processInfo, equipments);
        case 'uph':
          return renderUPHContent(data, stats, processInfo, equipments);
        case 'cycletime':
          return renderCycleTimeContent(data, stats, processInfo, equipments);
        case 'packaging':
          return renderPackagingContent(data, stats, processInfo, equipments);
        case 'defect-repair':
          return renderDefectRepairContent(data, stats, processInfo, equipments);
        case 'material-defect':
          return renderMaterialDefectContent(data, stats, processInfo, equipments);
        default:
          return renderProductionContent(data, stats, processInfo, equipments);
      }
    }

    // ÏÉùÏÇ∞ÌòÑÌô© ÏΩòÌÖêÏ∏†
    function renderProductionContent(data, stats, processInfo, equipments) {
      return `
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card">
            <div class="stat-label">Ï¥ù ÏÉùÏÇ∞ÏàòÎüâ</div>
            <div class="stat-value" style="color: ${processInfo.color}">${formatNumber(stats.totalProduction)} EA</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ÏàòÏú®</div>
            <div class="stat-value text-blue-600">${stats.avgYield}%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Î∂àÎüâÏú®</div>
            <div class="stat-value text-red-500">${stats.avgDefectRate}%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ÌèêÍ∏∞Ïú®</div>
            <div class="stat-value text-red-500">${stats.avgDisposalRate}%</div>
          </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">ÏùºÎ≥Ñ ÏÉùÏÇ∞ Ï∂îÏù¥</div>
            <div style="height: 320px;"><canvas id="processDetailDailyChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ÏÑ§ÎπÑÎ≥Ñ ÏÉùÏÇ∞ÌòÑÌô©</div>
            <div style="height: 320px;"><canvas id="processDetailEquipmentChart"></canvas></div>
          </div>
        </div>

        <!-- Equipment Table -->
        <div class="card">
          <h3 class="text-base font-bold text-slate-800 mb-4">ÏÑ§ÎπÑÎ≥Ñ ÏÉÅÏÑ∏ ÌòÑÌô©</h3>
          <table class="data-table" id="equipmentTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="equipment" data-type="equipment">ÏÑ§ÎπÑ/LINE</th>
                <th class="sortable text-right" data-sort="production" data-type="number">ÏÉùÏÇ∞ÏàòÎüâ</th>
                <th class="sortable text-right" data-sort="good" data-type="number">ÏñëÌíàÏàòÎüâ</th>
                <th class="sortable text-right" data-sort="defect" data-type="number">Î∂àÎüâÏàòÎüâ</th>
                <th class="sortable text-right" data-sort="yield" data-type="number">ÏàòÏú®</th>
              </tr>
            </thead>
            <tbody>
              ${sortEquipments(equipments).map(eq => `
                <tr>
                  <td class="font-medium">${eq.equipment}</td>
                  <td class="text-right">${eq.production.toLocaleString()}</td>
                  <td class="text-right text-blue-600">${eq.good.toLocaleString()}</td>
                  <td class="text-right text-red-500">${eq.defect.toLocaleString()}</td>
                  <td class="text-right">
                    <span class="badge ${(eq.good/eq.production*100) >= 95 ? 'badge-success' : (eq.good/eq.production*100) >= 90 ? 'badge-warning' : 'badge-danger'}">
                      ${(eq.good/eq.production*100).toFixed(1)}%
                    </span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // UPHÌòÑÌô© ÏΩòÌÖêÏ∏†
    function renderUPHContent(data, stats, processInfo, equipments) {
      return `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
          <div class="stat-card">
            <div class="stat-label">ÌèâÍ∑† UPH</div>
            <div class="stat-value" style="color: ${processInfo.color}">${formatNumber(Math.round(stats.totalProduction / stats.uniqueDates / 8))} EA/H</div>
            <div class="stat-sub">ÏãúÍ∞ÑÎãπ ÏÉùÏÇ∞Îüâ</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ÏµúÎåÄ UPH</div>
            <div class="stat-value text-blue-600">${formatNumber(Math.round(stats.totalProduction / stats.uniqueDates / 6))} EA/H</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Î™©Ìëú Îã¨ÏÑ±Î•†</div>
            <div class="stat-value text-blue-600">${stats.achievementRate}%</div>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">ÏùºÎ≥Ñ UPH Ï∂îÏù¥</div>
          <div style="height: 250px;"><canvas id="uphChart"></canvas></div>
        </div>
      `;
    }

    // Cycle Time ÏΩòÌÖêÏ∏†
    function renderCycleTimeContent(data, stats, processInfo, equipments) {
      // CT Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÌòÑÏû¨ Í≥µÏ†ï ÌïÑÌÑ∞ÎßÅ (ÏòÅÏñ¥ ID -> ÌïúÍ∏Ä Í≥µÏ†ïÎ™Ö Îß§Ìïë)
      const currentProcessId = state.activeProcess;
      const currentProcessName = processDataMapping[currentProcessId] || currentProcessId;
      let ctStats = { avgActualCT: 0, avgStandardCT: 0, avgEfficiency: 0, count: 0 };
      let filteredCTCount = 0;

      if (state.ctData && state.ctData.length > 0) {
        const filteredCT = state.ctData.filter(d => d.process === currentProcessName);

        filteredCTCount = filteredCT.length;

        if (filteredCT.length > 0) {
          const validCT = filteredCT.filter(d => d.actualCT > 0 && d.standardCT > 0);
          ctStats.avgActualCT = validCT.reduce((sum, d) => sum + d.actualCT, 0) / validCT.length || 0;
          ctStats.avgStandardCT = validCT.reduce((sum, d) => sum + d.standardCT, 0) / validCT.length || 0;
          ctStats.avgEfficiency = validCT.reduce((sum, d) => sum + d.efficiency, 0) / validCT.length || 0;
          ctStats.count = filteredCT.length;
        }
      }

      const ctDiff = ctStats.avgActualCT - ctStats.avgStandardCT;
      const ctDiffText = ctDiff >= 0 ? `+${ctDiff.toFixed(1)}sec` : `${ctDiff.toFixed(1)}sec`;
      const efficiencyColor = ctStats.avgEfficiency >= 100 ? 'text-emerald-600' : ctStats.avgEfficiency >= 90 ? 'text-blue-600' : 'text-red-500';

      // ÌòÑÏû¨ Í≥µÏ†ïÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞
      const noDataForProcess = state.ctData.length > 0 && filteredCTCount === 0;

      return `
        ${state.ctData.length > 0
          ? `<div class="text-sm text-amber-600 mb-4">‚úì CTÌòÑÌô© Ï¥ù ${state.ctData.length}Í±¥ (${currentProcessName}: ${filteredCTCount}Í±¥)</div>`
          : '<div class="text-sm text-slate-400 mb-4">CT Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå - ÌååÏùºÏóÖÎ°úÎìú Î©îÎâ¥ÏóêÏÑú Îì±Î°ùÌïòÏÑ∏Ïöî</div>'}
        ${noDataForProcess ? `
          <div class="card text-center py-12 mb-6">
            <div class="text-5xl mb-4">üì≠</div>
            <h3 class="text-lg font-bold text-slate-600 mb-2">${currentProcessName} Í≥µÏ†ïÏùò CT Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p class="text-sm text-slate-400">ÌååÏùºÏóÖÎ°úÎìú Î©îÎâ¥ÏóêÏÑú Ìï¥Îãπ Í≥µÏ†ïÏùò CTÌòÑÌô© CSVÎ•º Îì±Î°ùÌï¥ Ï£ºÏÑ∏Ïöî</p>
          </div>
        ` : `
          <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
            <div class="stat-card">
              <div class="stat-label">ÌèâÍ∑† Ïã§Ï†ú CT</div>
              <div class="stat-value" style="color: ${processInfo.color}">${ctStats.avgActualCT > 0 ? ctStats.avgActualCT.toFixed(1) : '-'} sec</div>
              <div class="stat-sub">${ctStats.count > 0 ? `ÌëúÏ§Ä CT ÎåÄÎπÑ ${ctDiffText}` : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ÌèâÍ∑† ÌëúÏ§Ä CT</div>
              <div class="stat-value text-slate-600">${ctStats.avgStandardCT > 0 ? ctStats.avgStandardCT.toFixed(1) : '-'} sec</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ÌèâÍ∑† CT Îã¨ÏÑ±Î•†</div>
              <div class="stat-value ${efficiencyColor}">${ctStats.avgEfficiency > 0 ? ctStats.avgEfficiency.toFixed(1) : '-'}%</div>
            </div>
          </div>
          <div class="chart-card mb-6">
            <div class="chart-title">ÏÑ§ÎπÑÎ≥Ñ Cycle Time ÎπÑÍµê (${currentProcessName})</div>
            <div style="height: 320px;"><canvas id="cycleTimeChart"></canvas></div>
          </div>

          <!-- CT Ï†ÄÏ°∞ Ïã§Ï†Å ÏÉÅÏÑ∏ Î¶¨Ïä§Ìä∏ -->
          ${buildCtLowPerfList(state.ctData, currentProcessName)}
        `}`;
    }

    // Í≤ÄÌè¨Ïû•ÌòÑÌô© ÏΩòÌÖêÏ∏†
    function renderPackagingContent(data, stats, processInfo, equipments) {
      // ÏóÖÎ°úÎìúÎêú Í≤ÄÌè¨Ïû•ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© - ÌòÑÏû¨ Í≥µÏ†ïÏúºÎ°ú ÌïÑÌÑ∞ÎßÅ
      const allPackagingData = state.packagingStatusData || [];
      const currentProcessName = processDataMapping[processInfo.id] || '';

      // ÌòÑÏû¨ Í≥µÏ†ïÏóê Ìï¥ÎãπÌïòÎäî Îç∞Ïù¥ÌÑ∞Îßå ÌïÑÌÑ∞ÎßÅ
      const packagingData = allPackagingData.filter(d => {
        const processName = d.process || '';
        return processName.includes(currentProcessName) || currentProcessName.includes(processName);
      });

      // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞
      if (allPackagingData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-lg">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">Í≤ÄÌè¨Ïû•ÌòÑÌô© Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p class="text-slate-500 mb-6">ÌååÏùºÏóÖÎ°úÎìú Î©îÎâ¥ÏóêÏÑú Í≤ÄÌè¨Ïû•ÌòÑÌô© CSV ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              üì§ ÌååÏùºÏóÖÎ°úÎìú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            </button>
          </div>
        `;
      }

      // ÌòÑÏû¨ Í≥µÏ†ï Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞
      if (packagingData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-slate-400 to-slate-500 flex items-center justify-center shadow-lg">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">${processInfo.name} Í≤ÄÌè¨Ïû• Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p class="text-slate-500 mb-6">ÏóÖÎ°úÎìúÎêú Í≤ÄÌè¨Ïû•ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Ï§ë ${currentProcessName}Í≥µÏ†ï Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</p>
            <div class="text-sm text-slate-400">Ï†ÑÏ≤¥ ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞: ${allPackagingData.length.toLocaleString()}Í±¥</div>
          </div>
        `;
      }

      // ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
      const totalDefect = packagingData.reduce((sum, d) => sum + d.defectQty, 0);
      const totalRepair = packagingData.reduce((sum, d) => sum + d.repairQty, 0);
      const totalDisposal = packagingData.reduce((sum, d) => sum + d.disposalQty, 0);
      const uniqueParts = new Set(packagingData.map(d => d.itemCode)).size;
      const uniqueDates = new Set(packagingData.map(d => d.productionDate)).size;
      const uniqueEquipments = new Set(packagingData.map(d => d.equipmentName)).size;

      // ÏùºÎ≥Ñ ÏßëÍ≥Ñ
      const dailySummary = {};
      packagingData.forEach(d => {
        if (!dailySummary[d.productionDate]) {
          dailySummary[d.productionDate] = { date: d.productionDate, defect: 0, repair: 0, disposal: 0 };
        }
        dailySummary[d.productionDate].defect += d.defectQty;
        dailySummary[d.productionDate].repair += d.repairQty;
        dailySummary[d.productionDate].disposal += d.disposalQty;
      });
      const dailyList = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      // Í≥µÏ†ïÍµ¨Î∂ÑÎ≥Ñ ÏßëÍ≥Ñ
      const processTypeSummary = {};
      packagingData.forEach(d => {
        const pType = d.processType || 'ÎØ∏Î∂ÑÎ•ò';
        if (!processTypeSummary[pType]) {
          processTypeSummary[pType] = { processType: pType, defect: 0, repair: 0, disposal: 0, count: 0 };
        }
        processTypeSummary[pType].defect += d.defectQty;
        processTypeSummary[pType].repair += d.repairQty;
        processTypeSummary[pType].disposal += d.disposalQty;
        processTypeSummary[pType].count++;
      });
      const processTypeList = Object.values(processTypeSummary).sort((a, b) => b.defect - a.defect);

      // ÏÑ§ÎπÑÎ≥Ñ ÏßëÍ≥Ñ
      const equipmentSummary = {};
      packagingData.forEach(d => {
        const eqName = d.equipmentName || 'ÎØ∏Î∂ÑÎ•ò';
        if (!equipmentSummary[eqName]) {
          equipmentSummary[eqName] = { equipment: eqName, defect: 0, repair: 0, disposal: 0, count: 0 };
        }
        equipmentSummary[eqName].defect += d.defectQty;
        equipmentSummary[eqName].repair += d.repairQty;
        equipmentSummary[eqName].disposal += d.disposalQty;
        equipmentSummary[eqName].count++;
      });
      const equipmentList = Object.values(equipmentSummary).sort((a, b) => b.defect - a.defect);

      // ÌíàÎ™©Î≥Ñ ÏßëÍ≥Ñ (TOP 10)
      const itemSummary = {};
      packagingData.forEach(d => {
        if (!itemSummary[d.itemCode]) {
          itemSummary[d.itemCode] = {
            itemCode: d.itemCode,
            itemName: d.itemName,
            defect: 0,
            repair: 0,
            disposal: 0
          };
        }
        itemSummary[d.itemCode].defect += d.defectQty;
        itemSummary[d.itemCode].repair += d.repairQty;
        itemSummary[d.itemCode].disposal += d.disposalQty;
      });
      const itemList = Object.values(itemSummary).sort((a, b) => b.defect - a.defect);

      return `
        <!-- ÏöîÏïΩ Ïπ¥Îìú -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card">
            <div class="stat-label">Ï¥ù Î∂àÎüâÏàòÎüâ</div>
            <div class="stat-value text-red-600">${formatNumber(totalDefect)} EA</div>
            <div class="stat-sub">${uniqueDates}ÏùºÍ∞Ñ Îç∞Ïù¥ÌÑ∞</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ï¥ù ÏàòÎ¶¨ÏàòÎüâ</div>
            <div class="stat-value text-purple-600">${formatNumber(totalRepair)} EA</div>
            <div class="stat-sub">${uniqueParts}Í∞ú ÌíàÎ™©</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ï¥ù ÌèêÍ∏∞ÏàòÎüâ</div>
            <div class="stat-value text-orange-600">${formatNumber(totalDisposal)} EA</div>
            <div class="stat-sub">${uniqueEquipments}Í∞ú ÏÑ§ÎπÑ</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ÏàòÎ¶¨Ïú®</div>
            <div class="stat-value text-emerald-600">${totalDefect > 0 ? (totalRepair / totalDefect * 100).toFixed(1) : 0}%</div>
            <div class="stat-sub">ÏàòÎ¶¨ / Î∂àÎüâ</div>
          </div>
        </div>

        <!-- Ï∞®Ìä∏ ÏòÅÏó≠ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">ÏùºÎ≥Ñ Í≤ÄÌè¨Ïû• ÌòÑÌô©</div>
            <div style="height: 250px;"><canvas id="packagingDailyChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">Í≥µÏ†ïÍµ¨Î∂ÑÎ≥Ñ ÌòÑÌô©</div>
            <div style="height: 250px;"><canvas id="packagingProcessChart"></canvas></div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">ÏÑ§ÎπÑÎ≥Ñ Î∂àÎüâ ÌòÑÌô© TOP 5</div>
            <div style="height: 250px;"><canvas id="packagingEquipmentChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ÌíàÎ™©Î≥Ñ Î∂àÎüâ TOP 5</div>
            <div style="height: 250px;"><canvas id="packagingItemChart"></canvas></div>
          </div>
        </div>

        <!-- ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î -->
        <div class="card mb-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
              <span>üìã ÌíàÎ™©Î≥Ñ Í≤ÄÌè¨Ïû• ÌòÑÌô©</span>
              <span class="text-sm font-normal text-slate-500">(${itemList.length}Í∞ú ÌíàÎ™©)</span>
            </h3>
            <div class="flex gap-2">
              <button onclick="toggleCollapse('packaging')" class="collapse-toggle inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                <svg class="w-4 h-4 transition-transform ${collapseState.packaging ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                ${collapseState.packaging ? 'ÌéºÏπòÍ∏∞' : 'Ï†ëÍ∏∞'}
              </button>
              <button onclick="downloadPackagingExcel()" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-emerald-700 bg-emerald-100 hover:bg-emerald-200 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Excel Îã§Ïö¥Î°úÎìú
              </button>
            </div>
          </div>
          <div class="collapsible-content ${collapseState.packaging ? 'collapsed' : ''}">
            <div class="overflow-x-auto">
              <table class="data-table w-full">
                <thead>
                  <tr>
                    <th class="text-left sortable" data-type="number">ÏàúÏúÑ</th>
                    <th class="text-left sortable" data-type="string">ÌíàÎ™©ÏΩîÎìú</th>
                    <th class="text-left sortable" data-type="string">ÌíàÎ™©Î™Ö</th>
                    <th class="text-right sortable" data-type="number">Î∂àÎüâÏàòÎüâ</th>
                    <th class="text-right sortable" data-type="number">ÏàòÎ¶¨ÏàòÎüâ</th>
                    <th class="text-right sortable" data-type="number">ÌèêÍ∏∞ÏàòÎüâ</th>
                    <th class="text-right sortable" data-type="number">ÏàòÎ¶¨Ïú®</th>
                  </tr>
                </thead>
                <tbody>
                  ${itemList.map((item, idx) => `
                    <tr>
                      <td class="text-slate-500">${idx + 1}</td>
                      <td class="font-mono text-xs">${item.itemCode}</td>
                      <td>${item.itemName}</td>
                      <td class="text-right font-semibold text-red-600">${formatNumber(item.defect)}</td>
                      <td class="text-right text-purple-600">${formatNumber(item.repair)}</td>
                      <td class="text-right text-orange-600">${formatNumber(item.disposal)}</td>
                      <td class="text-right">${item.defect > 0 ? (item.repair / item.defect * 100).toFixed(1) : 0}%</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© ÏΩòÌÖêÏ∏† (Ï°∞Î¶ΩÍ≥µÏ†ï Ï†ÑÏö©) - ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò
    function renderDefectRepairContent(data, stats, processInfo, equipments) {
      // ÏóÖÎ°úÎìúÎêú Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
      const repairData = state.repairStatusData || [];

      // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞
      if (repairData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-indigo-500 to-indigo-600 flex items-center justify-center shadow-lg">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p class="text-slate-500 mb-6">ÌååÏùºÏóÖÎ°úÎìú Î©îÎâ¥ÏóêÏÑú Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© CSV ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              üì§ ÌååÏùºÏóÖÎ°úÎìú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            </button>
          </div>
        `;
      }

      // ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
      const totalProduction = repairData.reduce((sum, d) => sum + d.productionQty, 0);
      const totalRepair = repairData.reduce((sum, d) => sum + d.repairQty, 0);
      const repairRate = totalProduction > 0 ? (totalRepair / totalProduction * 100).toFixed(1) : 0;
      const uniqueParts = new Set(repairData.map(d => d.partCode)).size;
      const uniqueDates = new Set(repairData.map(d => d.date)).size;

      // ÌíàÎ™©Î≥Ñ ÏàòÎ¶¨ ÏßëÍ≥Ñ
      const partSummary = {};
      repairData.forEach(d => {
        if (!partSummary[d.partCode]) {
          partSummary[d.partCode] = {
            partCode: d.partCode,
            partName: d.partName,
            spec: d.spec,
            totalProduction: 0,
            totalRepair: 0
          };
        }
        partSummary[d.partCode].totalProduction += d.productionQty;
        partSummary[d.partCode].totalRepair += d.repairQty;
      });

      // ÏàòÎ¶¨Ïú® Í∏∞Ï§Ä Ï†ïÎ†¨ (ÎÜíÏùÄ Ïàú)
      const partList = Object.values(partSummary)
        .map(p => ({ ...p, repairRate: p.totalProduction > 0 ? (p.totalRepair / p.totalProduction * 100) : 0 }))
        .sort((a, b) => b.totalRepair - a.totalRepair);

      // ÏùºÎ≥Ñ ÏàòÎ¶¨ ÏßëÍ≥Ñ
      const dailySummary = {};
      repairData.forEach(d => {
        if (!dailySummary[d.date]) {
          dailySummary[d.date] = { date: d.date, production: 0, repair: 0 };
        }
        dailySummary[d.date].production += d.productionQty;
        dailySummary[d.date].repair += d.repairQty;
      });
      const dailyList = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      return `
        <!-- ÏöîÏïΩ Ïπ¥Îìú -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card">
            <div class="stat-label">Ï¥ù ÏÉùÏÇ∞ÏàòÎüâ</div>
            <div class="stat-value" style="color: ${processInfo.color}">${formatNumber(totalProduction)} EA</div>
            <div class="stat-sub">${uniqueDates}ÏùºÍ∞Ñ ÏÉùÏÇ∞</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ï¥ù ÏàòÎ¶¨ÏàòÎüâ</div>
            <div class="stat-value text-indigo-600">${formatNumber(totalRepair)} EA</div>
            <div class="stat-sub">${uniqueParts}Í∞ú ÌíàÎ™©</div>
          </div>
          <div class="stat-card red">
            <div class="stat-label">ÏàòÎ¶¨Ïú®</div>
            <div class="stat-value text-red-500">${repairRate}%</div>
            <div class="stat-sub">ÏàòÎ¶¨ / ÏÉùÏÇ∞</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ï¥ù Îç∞Ïù¥ÌÑ∞</div>
            <div class="stat-value text-slate-600">${formatNumber(repairData.length)} Í±¥</div>
            <div class="stat-sub">ÏóÖÎ°úÎìú Î†àÏΩîÎìú</div>
          </div>
        </div>

        <!-- Ï∞®Ìä∏ ÏòÅÏó≠ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="chart-card">
            <div class="chart-title">ÏùºÎ≥Ñ ÏàòÎ¶¨ Ï∂îÏù¥</div>
            <div style="height: 280px;"><canvas id="repairDailyChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ÌíàÎ™©Î≥Ñ ÏàòÎ¶¨ TOP 10</div>
            <div style="height: 280px;"><canvas id="repairPartChart"></canvas></div>
          </div>
        </div>

        <!-- ÌíàÎ™©Î≥Ñ ÏÉÅÏÑ∏ ÌÖåÏù¥Î∏î -->
        <div class="card">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-base font-bold text-slate-800">ÌíàÎ™©Î≥Ñ ÏàòÎ¶¨ÌòÑÌô© ÏÉÅÏÑ∏</h3>
              <button id="toggle-repairStatus" class="collapse-toggle" onclick="toggleCollapse('repairStatus')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                Ï†ëÍ∏∞
              </button>
            </div>
            <div class="flex items-center gap-3">
              <span class="text-sm text-slate-500">${formatNumber(partList.length)}Í∞ú ÌíàÎ™©</span>
              <button onclick="downloadRepairStatusExcel()" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
              </button>
            </div>
          </div>
          <div id="collapse-repairStatus" class="collapsible-content">
            <div class="overflow-x-auto">
              <table class="data-table" id="repairDetailTable">
                <thead>
                  <tr>
                    <th class="sortable" data-sort="partCode" data-type="text">Î∂ÄÌíàÏΩîÎìú</th>
                    <th class="sortable" data-sort="partName" data-type="text">Î∂ÄÌíàÎ™Ö</th>
                    <th class="sortable" data-sort="spec" data-type="text">Í∑úÍ≤©</th>
                    <th class="sortable text-right" data-sort="production" data-type="number">ÏÉùÏÇ∞ÏàòÎüâ</th>
                    <th class="sortable text-right" data-sort="repair" data-type="number">ÏàòÎ¶¨ÏàòÎüâ</th>
                    <th class="sortable text-right" data-sort="rate" data-type="number">ÏàòÎ¶¨Ïú®</th>
                  </tr>
                </thead>
                <tbody>
                  ${partList.slice(0, 50).map(p => `
                    <tr>
                      <td class="font-mono text-sm">${p.partCode}</td>
                      <td class="font-medium">${p.partName}</td>
                      <td class="text-slate-500">${p.spec || '-'}</td>
                      <td class="text-right">${formatNumber(p.totalProduction)}</td>
                      <td class="text-right text-indigo-600 font-semibold">${formatNumber(p.totalRepair)}</td>
                      <td class="text-right">
                        <span class="badge ${p.repairRate >= 10 ? 'badge-danger' : p.repairRate >= 5 ? 'badge-warning' : 'badge-success'}">
                          ${p.repairRate.toFixed(1)}%
                        </span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${partList.length > 50 ? `<p class="text-sm text-slate-400 mt-3 text-center">ÏÉÅÏúÑ 50Í∞ú ÌíàÎ™©Îßå ÌëúÏãúÎê©ÎãàÎã§</p>` : ''}
          </div>
        </div>
      `;
    }

    // Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© Ï∞®Ìä∏ ÏÉùÏÑ±
    function createRepairCharts() {
      const repairData = state.repairStatusData || [];
      if (repairData.length === 0) return;

      // ÏùºÎ≥Ñ ÏßëÍ≥Ñ
      const dailySummary = {};
      repairData.forEach(d => {
        if (!dailySummary[d.date]) {
          dailySummary[d.date] = { date: d.date, production: 0, repair: 0 };
        }
        dailySummary[d.date].production += d.productionQty;
        dailySummary[d.date].repair += d.repairQty;
      });
      const dailyList = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      // ÌíàÎ™©Î≥Ñ ÏßëÍ≥Ñ
      const partSummary = {};
      repairData.forEach(d => {
        if (!partSummary[d.partCode]) {
          partSummary[d.partCode] = { partName: d.partName, repair: 0 };
        }
        partSummary[d.partCode].repair += d.repairQty;
      });
      const topParts = Object.entries(partSummary)
        .map(([code, v]) => ({ code, name: v.partName, repair: v.repair }))
        .sort((a, b) => b.repair - a.repair)
        .slice(0, 10);

      // ÏùºÎ≥Ñ ÏàòÎ¶¨ Ï∞®Ìä∏
      const dailyCtx = document.getElementById('repairDailyChart');
      if (dailyCtx) {
        if (charts.repairDaily) charts.repairDaily.destroy();
        charts.repairDaily = new Chart(dailyCtx, {
          type: 'bar',
          data: {
            labels: dailyList.map(d => d.date.substring(5)),
            datasets: [
              {
                label: 'ÏàòÎ¶¨ÏàòÎüâ',
                data: dailyList.map(d => d.repair),
                backgroundColor: 'rgba(165, 180, 252, 0.85)',
                borderRadius: 4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // ÌíàÎ™©Î≥Ñ ÏàòÎ¶¨ Ï∞®Ìä∏
      const partCtx = document.getElementById('repairPartChart');
      if (partCtx) {
        if (charts.repairPart) charts.repairPart.destroy();
        charts.repairPart = new Chart(partCtx, {
          type: 'bar',
          data: {
            labels: topParts.map(p => p.name.length > 15 ? p.name.substring(0, 15) + '...' : p.name),
            datasets: [{
              label: 'ÏàòÎ¶¨ÏàòÎüâ',
              data: topParts.map(p => p.repair),
              backgroundColor: topParts.map((_, i) => generatePastelColor(i + 4)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }
    }

    // ÏûêÏû¨Î∂àÎüâ Ï∞®Ìä∏ ÏÉùÏÑ±
    function createMaterialDefectCharts() {
      const defectData = state.materialDefectData || [];
      if (defectData.length === 0) return;

      // Í≥µÏ†ïÎ≥Ñ Î∂àÎüâ ÏßëÍ≥Ñ
      const processDefects = {};
      const processTypes = ['Ï°∞Î¶Ω', 'Î†àÏù¥Ï†∏', 'Ïù∏ÏáÑ', 'ÎèÑÏû•', 'Ï¶ùÏ∞©', 'ÎèÑÍ∏à', 'ÏÇ¨Ï∂ú'];
      processTypes.forEach(p => processDefects[p] = 0);

      defectData.forEach(d => {
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0) {
              processTypes.forEach(p => {
                if (key.includes(`(${p})`)) {
                  processDefects[p] += val;
                }
              });
            }
          });
        }
      });

      // ÏùºÎ≥Ñ Î∂àÎüâ ÏßëÍ≥Ñ
      const dailySummary = {};
      defectData.forEach(d => {
        const date = d.date || 'N/A';
        if (!dailySummary[date]) {
          dailySummary[date] = { date, total: 0 };
        }
        dailySummary[date].total += d.defectTotal || 0;
      });
      const dailyList = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      // ÌíàÎ™©Î≥Ñ Î∂àÎüâ ÏßëÍ≥Ñ
      const partSummary = {};
      defectData.forEach(d => {
        if (!partSummary[d.partCode]) {
          partSummary[d.partCode] = { partName: d.partName, total: 0 };
        }
        partSummary[d.partCode].total += d.defectTotal || 0;
      });
      const topParts = Object.entries(partSummary)
        .map(([code, v]) => ({ code, name: v.partName, total: v.total }))
        .sort((a, b) => b.total - a.total)
        .slice(0, 10);

      // ÏùºÎ≥Ñ Î∂àÎüâ Ï∞®Ìä∏
      const dailyCtx = document.getElementById('materialDailyChart');
      if (dailyCtx) {
        if (charts.materialDaily) charts.materialDaily.destroy();
        charts.materialDaily = new Chart(dailyCtx, {
          type: 'bar',
          data: {
            labels: dailyList.map(d => d.date.substring(5)),
            datasets: [{
              label: 'Î∂àÎüâÏàòÎüâ',
              data: dailyList.map(d => d.total),
              backgroundColor: 'rgba(252, 165, 165, 0.85)',
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // Í≥µÏ†ïÎ≥Ñ Î∂àÎüâ Ï∞®Ìä∏ (ÎèÑÎÑõ)
      const processCtx = document.getElementById('materialProcessChart');
      if (processCtx) {
        if (charts.materialProcess) charts.materialProcess.destroy();
        const processData = processTypes.map(p => processDefects[p]).filter(v => v > 0);
        const processLabels = processTypes.filter(p => processDefects[p] > 0);
        charts.materialProcess = new Chart(processCtx, {
          type: 'doughnut',
          data: {
            labels: processLabels,
            datasets: [{
              data: processData,
              backgroundColor: [
                'rgba(252, 165, 165, 0.85)',
                'rgba(253, 186, 116, 0.85)',
                'rgba(110, 231, 183, 0.85)',
                'rgba(147, 197, 253, 0.85)',
                'rgba(196, 181, 253, 0.85)',
                'rgba(249, 168, 212, 0.85)',
                'rgba(94, 234, 212, 0.85)'
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { boxWidth: 12, padding: 12 } }
            }
          }
        });
      }

      // ÌíàÎ™©Î≥Ñ Î∂àÎüâ Ï∞®Ìä∏
      const partCtx = document.getElementById('materialPartChart');
      if (partCtx) {
        if (charts.materialPart) charts.materialPart.destroy();
        charts.materialPart = new Chart(partCtx, {
          type: 'bar',
          data: {
            labels: topParts.map(p => p.name.length > 20 ? p.name.substring(0, 20) + '...' : p.name),
            datasets: [{
              label: 'Î∂àÎüâÏàòÎüâ',
              data: topParts.map(p => p.total),
              backgroundColor: topParts.map((_, i) => generatePastelColor(i + 3)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }

      // Î∂àÎüâÏú†ÌòïÎ≥Ñ ÏßëÍ≥Ñ
      const defectTypeSummary = {};
      defectData.forEach(d => {
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0 && key.includes('(') && key.includes(')')) {
              if (!defectTypeSummary[key]) {
                defectTypeSummary[key] = 0;
              }
              defectTypeSummary[key] += val;
            }
          });
        }
      });
      const topDefectTypes = Object.entries(defectTypeSummary)
        .map(([type, total]) => ({ type, total }))
        .sort((a, b) => b.total - a.total)
        .slice(0, 15);

      // Î∂àÎüâÏú†Ìòï TOP 15 Ï∞®Ìä∏
      const defectTypeCtx = document.getElementById('defectTypeChart');
      if (defectTypeCtx) {
        if (charts.defectType) charts.defectType.destroy();
        charts.defectType = new Chart(defectTypeCtx, {
          type: 'bar',
          data: {
            labels: topDefectTypes.map(t => t.type.length > 15 ? t.type.substring(0, 15) + '...' : t.type),
            datasets: [{
              label: 'Î∂àÎüâÏàòÎüâ',
              data: topDefectTypes.map(t => t.total),
              backgroundColor: topDefectTypes.map((_, i) => generatePastelColor(i)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false }, ticks: { font: { size: 10 } } }
            }
          }
        });
      }

      // Î∂ÄÌíàÎ≥Ñ Î∂àÎüâÏú†Ìòï ÏßëÍ≥Ñ (TOP 10 Î∂ÄÌíà)
      const partDefectTypes = {};
      defectData.forEach(d => {
        const partKey = d.partCode;
        if (!partDefectTypes[partKey]) {
          partDefectTypes[partKey] = { partCode: d.partCode, partName: d.partName, defects: {} };
        }
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0 && key.includes('(') && key.includes(')')) {
              if (!partDefectTypes[partKey].defects[key]) {
                partDefectTypes[partKey].defects[key] = 0;
              }
              partDefectTypes[partKey].defects[key] += val;
            }
          });
        }
      });

      const partDefectList = Object.values(partDefectTypes).map(p => {
        const totalDefect = Object.values(p.defects).reduce((sum, v) => sum + v, 0);
        return { ...p, totalDefect };
      }).sort((a, b) => b.totalDefect - a.totalDefect).slice(0, 10);

      // Î∂ÄÌíàÎ≥Ñ Î∂àÎüâÏú†Ìòï Ïä§ÌÉù Ï∞®Ìä∏
      const partDefectTypeCtx = document.getElementById('partDefectTypeChart');
      if (partDefectTypeCtx) {
        if (charts.partDefectType) charts.partDefectType.destroy();

        // Ï£ºÏöî Î∂àÎüâÏú†Ìòï Ï∂îÏ∂ú (Ï†ÑÏ≤¥ÏóêÏÑú TOP 5)
        const mainTypes = topDefectTypes.slice(0, 5).map(t => t.type);
        const colors = [
          'rgba(252, 165, 165, 0.85)',
          'rgba(253, 186, 116, 0.85)',
          'rgba(147, 197, 253, 0.85)',
          'rgba(110, 231, 183, 0.85)',
          'rgba(196, 181, 253, 0.85)'
        ];

        const datasets = mainTypes.map((type, idx) => ({
          label: type.length > 12 ? type.substring(0, 12) + '...' : type,
          data: partDefectList.map(p => p.defects[type] || 0),
          backgroundColor: colors[idx],
          borderRadius: 2
        }));

        // Í∏∞ÌÉÄ Î∂àÎüâÏú†Ìòï Ìï©Í≥Ñ
        const otherData = partDefectList.map(p => {
          const mainTotal = mainTypes.reduce((sum, t) => sum + (p.defects[t] || 0), 0);
          return p.totalDefect - mainTotal;
        });

        if (otherData.some(v => v > 0)) {
          datasets.push({
            label: 'Í∏∞ÌÉÄ',
            data: otherData,
            backgroundColor: 'rgba(203, 213, 225, 0.85)',
            borderRadius: 2
          });
        }

        charts.partDefectType = new Chart(partDefectTypeCtx, {
          type: 'bar',
          data: {
            labels: partDefectList.map(p => (p.partName || p.partCode).length > 12 ? (p.partName || p.partCode).substring(0, 12) + '...' : (p.partName || p.partCode)),
            datasets: datasets
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8, font: { size: 10 } } }
            },
            scales: {
              x: { stacked: true, beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } }
            }
          }
        });
      }
    }

    // Í≤ÄÌè¨Ïû•ÌòÑÌô© Ï∞®Ìä∏ ÏÉùÏÑ±
    function createPackagingCharts() {
      const allPackagingData = state.packagingStatusData || [];
      if (allPackagingData.length === 0) return;

      // ÌòÑÏû¨ Í≥µÏ†ïÏúºÎ°ú ÌïÑÌÑ∞ÎßÅ
      const currentProcessName = processDataMapping[state.activeProcess] || '';
      const packagingData = allPackagingData.filter(d => {
        const processName = d.process || '';
        return processName.includes(currentProcessName) || currentProcessName.includes(processName);
      });

      if (packagingData.length === 0) return;

      // ÏùºÎ≥Ñ ÏßëÍ≥Ñ
      const dailySummary = {};
      packagingData.forEach(d => {
        if (!dailySummary[d.productionDate]) {
          dailySummary[d.productionDate] = { date: d.productionDate, defect: 0, repair: 0, disposal: 0 };
        }
        dailySummary[d.productionDate].defect += d.defectQty;
        dailySummary[d.productionDate].repair += d.repairQty;
        dailySummary[d.productionDate].disposal += d.disposalQty;
      });
      const dailyList = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      // Í≥µÏ†ïÍµ¨Î∂ÑÎ≥Ñ ÏßëÍ≥Ñ
      const processTypeSummary = {};
      packagingData.forEach(d => {
        const pType = d.processType || 'ÎØ∏Î∂ÑÎ•ò';
        if (!processTypeSummary[pType]) {
          processTypeSummary[pType] = { processType: pType, defect: 0, repair: 0, disposal: 0 };
        }
        processTypeSummary[pType].defect += d.defectQty;
        processTypeSummary[pType].repair += d.repairQty;
        processTypeSummary[pType].disposal += d.disposalQty;
      });
      const processTypeList = Object.values(processTypeSummary).sort((a, b) => b.defect - a.defect);

      // ÏÑ§ÎπÑÎ≥Ñ ÏßëÍ≥Ñ
      const equipmentSummary = {};
      packagingData.forEach(d => {
        const eqName = d.equipmentName || 'ÎØ∏Î∂ÑÎ•ò';
        if (!equipmentSummary[eqName]) {
          equipmentSummary[eqName] = { equipment: eqName, defect: 0, repair: 0, disposal: 0 };
        }
        equipmentSummary[eqName].defect += d.defectQty;
        equipmentSummary[eqName].repair += d.repairQty;
        equipmentSummary[eqName].disposal += d.disposalQty;
      });
      const equipmentList = Object.values(equipmentSummary).sort((a, b) => b.defect - a.defect).slice(0, 5);

      // ÌíàÎ™©Î≥Ñ ÏßëÍ≥Ñ
      const itemSummary = {};
      packagingData.forEach(d => {
        if (!itemSummary[d.itemCode]) {
          itemSummary[d.itemCode] = { itemCode: d.itemCode, itemName: d.itemName, defect: 0, repair: 0, disposal: 0 };
        }
        itemSummary[d.itemCode].defect += d.defectQty;
        itemSummary[d.itemCode].repair += d.repairQty;
        itemSummary[d.itemCode].disposal += d.disposalQty;
      });
      const itemList = Object.values(itemSummary).sort((a, b) => b.defect - a.defect).slice(0, 5);

      // ÏùºÎ≥Ñ Í≤ÄÌè¨Ïû• Ï∞®Ìä∏
      const dailyCtx = document.getElementById('packagingDailyChart');
      if (dailyCtx) {
        if (charts.packagingDaily) charts.packagingDaily.destroy();
        charts.packagingDaily = new Chart(dailyCtx, {
          type: 'bar',
          data: {
            labels: dailyList.map(d => d.date.substring(5)),
            datasets: [
              {
                label: 'Î∂àÎüâ',
                data: dailyList.map(d => d.defect),
                backgroundColor: 'rgba(252, 165, 165, 0.85)',
                borderRadius: 4
              },
              {
                label: 'ÏàòÎ¶¨',
                data: dailyList.map(d => d.repair),
                backgroundColor: 'rgba(196, 181, 253, 0.85)',
                borderRadius: 4
              },
              {
                label: 'ÌèêÍ∏∞',
                data: dailyList.map(d => d.disposal),
                backgroundColor: 'rgba(253, 186, 116, 0.85)',
                borderRadius: 4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8 } }
            },
            scales: {
              y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // Í≥µÏ†ïÍµ¨Î∂ÑÎ≥Ñ Ï∞®Ìä∏
      const processCtx = document.getElementById('packagingProcessChart');
      if (processCtx) {
        if (charts.packagingProcess) charts.packagingProcess.destroy();
        charts.packagingProcess = new Chart(processCtx, {
          type: 'doughnut',
          data: {
            labels: processTypeList.map(p => p.processType),
            datasets: [{
              data: processTypeList.map(p => p.defect),
              backgroundColor: processTypeList.map((_, i) => generatePastelColor(i + 4))
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8 } }
            }
          }
        });
      }

      // ÏÑ§ÎπÑÎ≥Ñ Î∂àÎüâ Ï∞®Ìä∏
      const equipmentCtx = document.getElementById('packagingEquipmentChart');
      if (equipmentCtx) {
        if (charts.packagingEquipment) charts.packagingEquipment.destroy();
        charts.packagingEquipment = new Chart(equipmentCtx, {
          type: 'bar',
          data: {
            labels: equipmentList.map(e => e.equipment.length > 10 ? e.equipment.substring(0, 10) + '...' : e.equipment),
            datasets: [
              {
                label: 'Î∂àÎüâ',
                data: equipmentList.map(e => e.defect),
                backgroundColor: 'rgba(252, 165, 165, 0.85)',
                borderRadius: 4
              },
              {
                label: 'ÏàòÎ¶¨',
                data: equipmentList.map(e => e.repair),
                backgroundColor: 'rgba(196, 181, 253, 0.85)',
                borderRadius: 4
              }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8 } }
            },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }

      // ÌíàÎ™©Î≥Ñ Î∂àÎüâ Ï∞®Ìä∏
      const itemCtx = document.getElementById('packagingItemChart');
      if (itemCtx) {
        if (charts.packagingItem) charts.packagingItem.destroy();
        charts.packagingItem = new Chart(itemCtx, {
          type: 'bar',
          data: {
            labels: itemList.map(i => (i.itemName || i.itemCode).length > 10 ? (i.itemName || i.itemCode).substring(0, 10) + '...' : (i.itemName || i.itemCode)),
            datasets: [{
              label: 'Î∂àÎüâÏàòÎüâ',
              data: itemList.map(i => i.defect),
              backgroundColor: itemList.map((_, idx) => generatePastelColor(idx + 4)),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: v => formatNumber(v) } },
              y: { grid: { display: false } }
            }
          }
        });
      }
    }

    // ÏûêÏû¨Î∂àÎüâÌòÑÌô© ÏΩòÌÖêÏ∏† (Ï°∞Î¶ΩÍ≥µÏ†ï Ï†ÑÏö©)
    function renderMaterialDefectContent(data, stats, processInfo, equipments) {
      const defectData = state.materialDefectData || [];

      if (defectData.length === 0) {
        return `
          <div class="card text-center py-16">
            <div class="text-6xl mb-4">üì¶</div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">ÏûêÏû¨Î∂àÎüâ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p class="text-slate-500 mb-6">Ï°∞Î¶ΩÏûêÏû¨Î∂àÎüâ CSV ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              üì§ ÌååÏùºÏóÖÎ°úÎìú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            </button>
          </div>
        `;
      }

      // ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
      const totalDefects = defectData.reduce((sum, d) => sum + (d.defectTotal || 0), 0);
      const uniqueParts = new Set(defectData.map(d => d.partCode)).size;
      const uniqueDates = new Set(defectData.map(d => d.date)).size;
      const avgDefectPerPart = uniqueParts > 0 ? (totalDefects / uniqueParts).toFixed(1) : 0;

      // Í≥µÏ†ïÎ≥Ñ Î∂àÎüâ ÏßëÍ≥Ñ
      const processDefects = {};
      const processTypes = ['Ï°∞Î¶Ω', 'Î†àÏù¥Ï†∏', 'Ïù∏ÏáÑ', 'ÎèÑÏû•', 'Ï¶ùÏ∞©', 'ÎèÑÍ∏à', 'ÏÇ¨Ï∂ú'];
      processTypes.forEach(p => processDefects[p] = 0);

      defectData.forEach(d => {
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0) {
              processTypes.forEach(p => {
                if (key.includes(`(${p})`)) {
                  processDefects[p] += val;
                }
              });
            }
          });
        }
      });

      // ÌíàÎ™©Î≥Ñ Î∂àÎüâ ÏßëÍ≥Ñ
      const partSummary = {};
      defectData.forEach(d => {
        const key = d.partCode;
        if (!partSummary[key]) {
          partSummary[key] = { partCode: d.partCode, partName: d.partName, customerPN: d.customerPN, total: 0, count: 0 };
        }
        partSummary[key].total += d.defectTotal || 0;
        partSummary[key].count++;
      });
      const topParts = Object.values(partSummary).sort((a, b) => b.total - a.total).slice(0, 10);

      // ÏùºÎ≥Ñ Î∂àÎüâ ÏßëÍ≥Ñ
      const dailySummary = {};
      defectData.forEach(d => {
        const date = d.date || 'N/A';
        if (!dailySummary[date]) {
          dailySummary[date] = { date, total: 0, count: 0 };
        }
        dailySummary[date].total += d.defectTotal || 0;
        dailySummary[date].count++;
      });
      const dailyData = Object.values(dailySummary).sort((a, b) => a.date.localeCompare(b.date));

      // Î∂àÎüâÏú†ÌòïÎ≥Ñ ÏßëÍ≥Ñ
      const defectTypeSummary = {};
      defectData.forEach(d => {
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0 && key.includes('(') && key.includes(')')) {
              if (!defectTypeSummary[key]) {
                defectTypeSummary[key] = { type: key, total: 0, count: 0 };
              }
              defectTypeSummary[key].total += val;
              defectTypeSummary[key].count++;
            }
          });
        }
      });
      const topDefectTypes = Object.values(defectTypeSummary).sort((a, b) => b.total - a.total).slice(0, 15);

      // Î∂ÄÌíàÎ≥Ñ Î∂àÎüâÏú†Ìòï ÏßëÍ≥Ñ (TOP 10 Î∂ÄÌíàÏùò Î∂àÎüâÏú†Ìòï Î∂ÑÏÑù)
      const partDefectTypes = {};
      defectData.forEach(d => {
        const partKey = d.partCode;
        if (!partDefectTypes[partKey]) {
          partDefectTypes[partKey] = { partCode: d.partCode, partName: d.partName, defects: {} };
        }
        if (d.rawData) {
          Object.keys(d.rawData).forEach(key => {
            const val = parseInt(d.rawData[key]) || 0;
            if (val > 0 && key.includes('(') && key.includes(')')) {
              if (!partDefectTypes[partKey].defects[key]) {
                partDefectTypes[partKey].defects[key] = 0;
              }
              partDefectTypes[partKey].defects[key] += val;
            }
          });
        }
      });

      // Í∞Å Î∂ÄÌíàÎ≥ÑÎ°ú Ï¥ù Î∂àÎüâÏàòÎüâ Í≥ÑÏÇ∞ ÌõÑ TOP 10 Ï∂îÏ∂ú
      const partDefectList = Object.values(partDefectTypes).map(p => {
        const totalDefect = Object.values(p.defects).reduce((sum, v) => sum + v, 0);
        const topTypes = Object.entries(p.defects)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
          .map(([type, count]) => ({ type, count }));
        return { ...p, totalDefect, topTypes };
      }).sort((a, b) => b.totalDefect - a.totalDefect).slice(0, 10);

      return `
        <div class="section-header">
          <div class="section-title">ÏûêÏû¨Î∂àÎüâ ÌòÑÌô© Î∂ÑÏÑù</div>
          <div class="text-sm text-slate-500">Ï¥ù ${formatNumber(defectData.length)}Í±¥ Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-6">
          <div class="stat-card red">
            <div class="stat-label">Ï¥ù Î∂àÎüâ ÏàòÎüâ</div>
            <div class="stat-value text-red-500">${formatNumber(totalDefects)} EA</div>
            <div class="stat-sub">${uniqueDates}ÏùºÍ∞Ñ Î∞úÏÉù</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Î∂àÎüâ ÌíàÎ™© Ïàò</div>
            <div class="stat-value">${formatNumber(uniqueParts)} Ï¢Ö</div>
            <div class="stat-sub">ÌíàÎ™©Îãπ ÌèâÍ∑† ${avgDefectPerPart} EA</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ÏµúÎã§ Î∂àÎüâ Í≥µÏ†ï</div>
            <div class="stat-value text-orange-500">${Object.entries(processDefects).sort((a,b) => b[1] - a[1])[0]?.[0] || '-'}</div>
            <div class="stat-sub">${formatNumber(Object.entries(processDefects).sort((a,b) => b[1] - a[1])[0]?.[1] || 0)} EA</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ï¥ù Îç∞Ïù¥ÌÑ∞</div>
            <div class="stat-value">${formatNumber(defectData.length)} Í±¥</div>
            <div class="stat-sub">ÏÉÅÏÑ∏ Î∂àÎüâ Í∏∞Î°ù</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
          <div class="chart-card">
            <div class="chart-title">ÏùºÎ≥Ñ Î∂àÎüâ Ï∂îÏù¥</div>
            <div style="height: 280px;"><canvas id="materialDailyChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">Í≥µÏ†ïÎ≥Ñ Î∂àÎüâ Î∂ÑÌè¨</div>
            <div style="height: 280px;"><canvas id="materialProcessChart"></canvas></div>
          </div>
        </div>

        <div class="chart-card mb-6">
          <div class="chart-title">ÌíàÎ™©Î≥Ñ Î∂àÎüâ TOP 10</div>
          <div style="height: 300px;"><canvas id="materialPartChart"></canvas></div>
        </div>

        <!-- Î∂àÎüâÏú†Ìòï Î∂ÑÏÑù ÏÑπÏÖò -->
        <div class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-base font-bold text-slate-800">üîç Î∂àÎüâÏú†ÌòïÎ≥Ñ Î∂ÑÏÑù</h3>
              <button id="toggle-defectType" class="collapse-toggle" onclick="toggleCollapse('defectType')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                Ï†ëÍ∏∞
              </button>
            </div>
            <span class="text-sm text-slate-500">${topDefectTypes.length}Í∞ú Î∂àÎüâÏú†Ìòï</span>
          </div>
          <div id="collapse-defectType" class="collapsible-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="chart-card" style="box-shadow: none; border: 1px solid #e2e8f0;">
                <div class="chart-title">Î∂àÎüâÏú†Ìòï TOP 15</div>
                <div style="height: 320px;"><canvas id="defectTypeChart"></canvas></div>
              </div>
              <div>
                <div class="chart-title mb-3">Î∂àÎüâÏú†Ìòï ÏàúÏúÑ</div>
                <div class="overflow-x-auto">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th class="sortable" data-type="number" style="width: 50px;">ÏàúÏúÑ</th>
                        <th class="sortable" data-type="string">Î∂àÎüâÏú†Ìòï</th>
                        <th class="text-right sortable" data-type="number">ÏàòÎüâ</th>
                        <th class="text-right sortable" data-type="number">ÎπÑÏú®</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${topDefectTypes.map((t, idx) => {
                        const pct = totalDefects > 0 ? ((t.total / totalDefects) * 100).toFixed(1) : 0;
                        return `
                          <tr>
                            <td class="text-center font-bold ${idx < 3 ? 'text-red-500' : 'text-slate-500'}">${idx + 1}</td>
                            <td class="font-medium">${t.type}</td>
                            <td class="text-right text-red-600 font-semibold">${formatNumber(t.total)}</td>
                            <td class="text-right">
                              <div class="flex items-center justify-end gap-2">
                                <div class="w-16 h-2 bg-slate-200 rounded-full overflow-hidden">
                                  <div class="h-full bg-red-400 rounded-full" style="width: ${Math.min(pct * 2, 100)}%"></div>
                                </div>
                                <span class="text-sm text-slate-600">${pct}%</span>
                              </div>
                            </td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Î∂ÄÌíàÎ≥Ñ Î∂àÎüâÏú†Ìòï Î∂ÑÏÑù -->
        <div class="card mb-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-base font-bold text-slate-800">üì¶ Î∂ÄÌíàÎ≥Ñ Î∂àÎüâÏú†Ìòï Î∂ÑÏÑù</h3>
              <button id="toggle-partDefectType" class="collapse-toggle" onclick="toggleCollapse('partDefectType')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                Ï†ëÍ∏∞
              </button>
            </div>
            <span class="text-sm text-slate-500">TOP 10 Î∂ÄÌíà</span>
          </div>
          <div id="collapse-partDefectType" class="collapsible-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="chart-card" style="box-shadow: none; border: 1px solid #e2e8f0;">
                <div class="chart-title">Î∂ÄÌíàÎ≥Ñ Î∂àÎüâÏú†Ìòï Íµ¨ÏÑ±</div>
                <div style="height: 350px;"><canvas id="partDefectTypeChart"></canvas></div>
              </div>
              <div>
                <div class="chart-title mb-3">Î∂ÄÌíàÎ≥Ñ Ï£ºÏöî Î∂àÎüâÏú†Ìòï</div>
                <div class="space-y-3" style="max-height: 350px; overflow-y: auto;">
                  ${partDefectList.map((p, idx) => `
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                      <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                          <span class="w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${idx < 3 ? 'bg-red-100 text-red-600' : 'bg-slate-200 text-slate-600'}">${idx + 1}</span>
                          <span class="font-medium text-sm text-slate-800 truncate" style="max-width: 180px;" title="${p.partName}">${p.partName || p.partCode}</span>
                        </div>
                        <span class="text-red-600 font-bold text-sm">${formatNumber(p.totalDefect)} EA</span>
                      </div>
                      <div class="flex flex-wrap gap-1">
                        ${p.topTypes.map(t => `
                          <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-white border border-slate-200 rounded text-xs">
                            <span class="text-slate-600">${t.type.replace(/\(.*?\)/, '').trim() || t.type}</span>
                            <span class="font-semibold text-red-500">${t.count}</span>
                          </span>
                        `).join('')}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="chart-title">ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞</div>
              <button id="toggle-materialDefect" class="collapse-toggle" onclick="toggleCollapse('materialDefect')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                Ï†ëÍ∏∞
              </button>
            </div>
            <button onclick="downloadMaterialDefectExcel()" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
              ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
            </button>
          </div>
          <div id="collapse-materialDefect" class="collapsible-content">
            <div class="overflow-x-auto">
              <table class="data-table">
                <thead>
                  <tr>
                    <th class="sortable" data-type="string">Î∂ÄÌíàÏΩîÎìú</th>
                    <th class="sortable" data-type="string">Í≥†Í∞ùÏÇ¨ P/N</th>
                    <th class="sortable" data-type="string">Î∂ÄÌíàÎ™Ö</th>
                    <th class="sortable" data-type="string">Í∑úÍ≤©</th>
                    <th class="sortable" data-type="string">ÏÉùÏÇ∞ÏùºÏûê</th>
                    <th class="sortable text-right" data-type="number">Î∂àÎüâÌï©Í≥Ñ</th>
                  </tr>
                </thead>
                <tbody>
                  ${defectData.slice(0, 100).map(d => `
                    <tr>
                      <td>${d.partCode || '-'}</td>
                      <td>${d.customerPN || '-'}</td>
                      <td>${d.partName || '-'}</td>
                      <td>${d.spec || '-'}</td>
                      <td>${d.date || '-'}</td>
                      <td class="text-right font-medium text-red-600">${formatNumber(d.defectTotal || 0)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${defectData.length > 100 ? `<div class="text-center text-slate-500 text-sm mt-4">ÏÉÅÏúÑ 100Í±¥Îßå ÌëúÏãú (Ï†ÑÏ≤¥ ${formatNumber(defectData.length)}Í±¥)</div>` : ''}
          </div>
        </div>
      `;
    }

    // ÌíàÏßàÎ∂ÑÏÑù
    function renderQuality(stats, data) {
      if (!stats) return '<p class="text-center text-slate-500 py-8">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';

      return `
        <div class="section-header">
          <div class="section-title">ÌíàÏßà Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏</div>
          <div class="flex items-center gap-3">
            <select class="filter-select" onchange="setFilter('process', this.value)">
              <option value="all">All</option>
              ${getUniqueValues('process').map(p => `<option value="${p}" ${state.filters.process === p ? 'selected' : ''}>${p}</option>`).join('')}
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
          <div class="stat-card blue">
            <div class="stat-label">ÌèâÍ∑† ÏàòÏú®</div>
            <div class="stat-value text-blue-600">${stats.avgYield}%</div>
            <div class="stat-sub">ÏñëÌíà: ${formatNumber(stats.totalGood)} EA</div>
          </div>
          <div class="stat-card red">
            <div class="stat-label">ÌèâÍ∑† Î∂àÎüâÏú®</div>
            <div class="stat-value text-red-400">${stats.avgDefectRate}%</div>
            <div class="stat-sub">Î∂àÎüâ: ${formatNumber(stats.totalDefect)} EA</div>
          </div>
          <div class="stat-card red">
            <div class="stat-label">ÌèâÍ∑† ÌèêÍ∏∞Ïú®</div>
            <div class="stat-value text-red-400">${stats.avgDisposalRate}%</div>
            <div class="stat-sub">ÌèêÍ∏∞: ${formatNumber(stats.totalDisposal)} EA</div>
          </div>
        </div>

        <div class="chart-card mb-6">
          <div class="chart-title">Í≥µÏ†ïÎ≥Ñ ÌíàÏßà ÏßÄÌëú</div>
          <div style="height: 280px;"><canvas id="qualityChart"></canvas></div>
        </div>

        <!-- ÌíàÎ™©Î≥Ñ Î∂àÎüâÏú® ÏÉÅÏÑ∏ Î¶¨Ïä§Ìä∏ -->
        ${buildItemDefectList(data)}
      `;
    }

    // Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î
    function renderDataTable(data) {
      const fields = getDetailFields();
      const numericFields = ['ÏÉùÏÇ∞ÏàòÎüâ', 'ÏñëÌíàÏàòÎüâ', 'Î∂àÎüâÏàòÎüâ', 'ÌèêÍ∏∞ÏàòÎüâ', 'ÏûëÏóÖÏãúÍ∞Ñ(Î∂Ñ)', 'ÏûëÏóÖÏù∏Ïõê', 'UPH', 'UPPH'];
      const categoryFields = ['Í≥µÏ†ï', 'ÌíàÏ¢Ö', 'Í≥†Í∞ùÏÇ¨', 'ÏÑ§ÎπÑ(ÎùºÏù∏)Î™Ö', 'ÌíàÎ™©Î™Ö', 'ÏÉùÏÇ∞ÏùºÏûê', 'Í≤ÄÏÇ¨Ïú†Ìòï', 'Ï°∞Îã¨Íµ¨Î∂Ñ', 'ÏûëÏóÖÏûê', 'Ïû¨ÏßàÏΩîÎìú1'];

      // ÌîºÎ¥á ÌÖåÏù¥Î∏î ÏÉùÏÑ±
      const pivotResult = state.detailData.length > 0
        ? generatePivotTable(state.detailData, state.pivot.rows, state.pivot.cols, state.pivot.values, state.pivot.aggFunc)
        : null;

      return `
        <div class="section-header">
          <div class="section-title">ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (ÌîºÎ¥á)</div>
          <div class="flex items-center gap-3">
            <select class="filter-select" style="background: #f1f5f9; border-color: #cbd5e1; font-weight: 500;" onchange="setSelectedMonth(this.value)">
              ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${state.selectedMonth === m ? 'selected' : ''}>${m}Ïõî</option>`).join('')}
            </select>
            ${state.detailData.length > 0 ? `
              <button onclick="downloadPivotExcel()" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
              </button>
              <button onclick="clearDetailData()" class="px-4 py-2 bg-slate-100 hover:bg-rose-100 text-slate-600 hover:text-rose-600 text-sm font-medium rounded-lg transition-colors">Ï¥àÍ∏∞Ìôî</button>
            ` : ''}
          </div>
        </div>

        ${state.detailData.length === 0 ? `
          <div class="card text-center py-16">
            <div class="text-6xl mb-4">üìä</div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">ÏóÖÏ¢ÖÎ≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p class="text-slate-500 mb-6">ÌîºÎ¥á Î∂ÑÏÑùÏùÑ ÏúÑÌï¥ ÏóÖÏ¢ÖÎ≥Ñ CSV ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
            <button onclick="setTab('upload')" class="inline-flex items-center gap-2 px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded-xl cursor-pointer transition-all">
              üì§ ÌååÏùºÏóÖÎ°úÎìú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            </button>
          </div>
        ` : `
          <!-- ÌîºÎ¥á ÏÑ§Ï†ï -->
          <div class="card mb-4">
            <div class="flex flex-wrap items-center gap-4">
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-slate-600">Ìñâ:</span>
                <select class="filter-select text-sm" onchange="setPivotConfig('rows', this.value)">
                  ${categoryFields.map(f => `<option value="${f}" ${state.pivot.rows === f ? 'selected' : ''}>${f}</option>`).join('')}
                </select>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-slate-600">Ïó¥:</span>
                <select class="filter-select text-sm" onchange="setPivotConfig('cols', this.value)">
                  ${categoryFields.map(f => `<option value="${f}" ${state.pivot.cols === f ? 'selected' : ''}>${f}</option>`).join('')}
                </select>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-slate-600">Í∞í:</span>
                <select class="filter-select text-sm" onchange="setPivotConfig('values', this.value)">
                  ${numericFields.map(f => `<option value="${f}" ${state.pivot.values === f ? 'selected' : ''}>${f}</option>`).join('')}
                </select>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-slate-600">ÏßëÍ≥Ñ:</span>
                <select class="filter-select text-sm" onchange="setPivotConfig('aggFunc', this.value)">
                  <option value="sum" ${state.pivot.aggFunc === 'sum' ? 'selected' : ''}>Ìï©Í≥Ñ</option>
                  <option value="count" ${state.pivot.aggFunc === 'count' ? 'selected' : ''}>Í∞úÏàò</option>
                  <option value="avg" ${state.pivot.aggFunc === 'avg' ? 'selected' : ''}>ÌèâÍ∑†</option>
                </select>
              </div>
              <span class="text-sm text-slate-400 ml-auto">Ï¥ù ${state.detailData.length.toLocaleString()}Í±¥</span>
            </div>
          </div>

          <!-- ÌîºÎ¥á ÌÖåÏù¥Î∏î -->
          <div class="card">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <h3 class="text-base font-bold text-slate-800">ÌîºÎ¥á ÌÖåÏù¥Î∏î Í≤∞Í≥º</h3>
                <button id="toggle-pivot" class="collapse-toggle" onclick="toggleCollapse('pivot')">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                  Ï†ëÍ∏∞
                </button>
              </div>
            </div>
            <div id="collapse-pivot" class="collapsible-content">
              <div class="overflow-x-auto">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th class="sortable bg-slate-100 font-bold" data-sort="row" data-type="text">${state.pivot.rows} \\ ${state.pivot.cols}</th>
                      ${pivotResult.cols.map((c, idx) => `<th class="sortable text-right bg-slate-50" data-sort="col${idx}" data-type="number">${c}</th>`).join('')}
                      <th class="sortable text-right bg-blue-50 text-blue-700 font-bold" data-sort="total" data-type="number">Ìï©Í≥Ñ</th>
                    </tr>
                  </thead>
                <tbody>
                  ${pivotResult.rows.map(r => `
                    <tr>
                      <td class="font-medium bg-slate-50">${r}</td>
                      ${pivotResult.cols.map(c => {
                        const val = pivotResult.getValue(pivotResult.values[r][c]);
                        return `<td class="text-right">${formatNumber(Math.round(val))}</td>`;
                      }).join('')}
                      <td class="text-right bg-blue-50 text-blue-700 font-bold">${formatNumber(Math.round(pivotResult.getValue(pivotResult.rowTotals[r])))}</td>
                    </tr>
                  `).join('')}
                </tbody>
                <tfoot>
                  <tr class="bg-slate-100 font-bold">
                    <td>Ìï©Í≥Ñ</td>
                    ${pivotResult.cols.map(c => `<td class="text-right">${formatNumber(Math.round(pivotResult.getValue(pivotResult.colTotals[c])))}</td>`).join('')}
                    <td class="text-right bg-blue-100 text-blue-800">${formatNumber(Math.round(state.pivot.aggFunc === 'count' ? pivotResult.grandTotal : (state.pivot.aggFunc === 'avg' ? pivotResult.grandTotal / state.detailData.length : pivotResult.grandTotal)))}</td>
                  </tr>
                </tfoot>
                </table>
              </div>
            </div>
          </div>
        `}
      `;
    }

    // ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
    function clearDetailData() {
      if (confirm('ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        localStorage.removeItem(DETAIL_DATA_KEY);
        state.detailData = [];
        render();
      }
    }

    // Ï∞®Ìä∏ ÏÉùÏÑ±
    function createCharts() {
      console.log('=== createCharts started ===');
      try {
      destroyCharts();
      const filteredData = getFilteredData();

      // Chart.js Í∏ÄÎ°úÎ≤å ÏÑ§Ï†ï - Apple Ïä§ÌÉÄÏùº
      Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, SF Pro Display, sans-serif';
      Chart.defaults.color = '#6b7280';

      // Ï∞®Ìä∏ Ìà¥ÌåÅ Ïà´Ïûê Ìè¨Îß∑ÌåÖ (Ï≤úÎã®ÏúÑ ÏΩ§Îßà)
      Chart.defaults.plugins.tooltip.callbacks.label = function(context) {
        let label = context.dataset.label || '';
        if (label) label += ': ';
        if (context.parsed.y !== null && context.parsed.y !== undefined) {
          label += formatNumber(context.parsed.y);
        } else if (context.parsed !== null && context.parsed !== undefined) {
          label += formatNumber(context.parsed);
        }
        return label;
      };

      // Îç∞Ïù¥ÌÑ∞ ÎùºÎ≤® ÌîåÎü¨Í∑∏Ïù∏ Îì±Î°ù
      Chart.register(ChartDataLabels);

      // Í≥µÌÜµ Îç∞Ïù¥ÌÑ∞ÎùºÎ≤® ÏòµÏÖò
      const dataLabelOptions = {
        anchor: 'end',
        align: 'end',
        color: '#374151',
        font: { size: 11, weight: '600' },
        formatter: (value) => formatCompact(value),
        padding: 4
      };

      // OEE Ï∞®Ìä∏ (ÎßâÎåÄ: 3ÎåÄ ÏßÄÌëú, Í∫æÏùÄÏÑ†: OEE Î≥¥Ï°∞Ï∂ï)
      const oeeCanvas = document.getElementById('oeeChart');
      if (oeeCanvas) {
        const oeeData = getOEEData(filteredData);
        charts.oee = new Chart(oeeCanvas, {
          type: 'bar',
          data: {
            labels: oeeData.map(d => d.process),
            datasets: [
              { label: 'ÏãúÍ∞ÑÍ∞ÄÎèôÏú®', data: oeeData.map(d => parseFloat(d.availability)), backgroundColor: '#e2e8f0', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'ÏÑ±Îä•Í∞ÄÎèôÏú®', data: oeeData.map(d => parseFloat(d.performance)), backgroundColor: '#cbd5e1', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'ÏñëÌíàÏú®', data: oeeData.map(d => parseFloat(d.quality)), backgroundColor: '#bfdbfe', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'OEE', data: oeeData.map(d => parseFloat(d.oee)), type: 'line', borderColor: '#fca5a5', borderWidth: 3, fill: false, pointRadius: 8, pointBackgroundColor: '#fca5a5', pointBorderColor: '#fff', pointBorderWidth: 2, tension: 0.3, yAxisID: 'y1', order: 1 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 40, right: 10 } },
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
              datalabels: {
                anchor: 'end',
                align: 'top',
                offset: 2,
                color: '#64748b',
                font: { size: 9, weight: '600' },
                formatter: (value) => formatPercent(value),
                display: (ctx) => ctx.datasetIndex !== 3
              }
            },
            scales: {
              y: { type: 'linear', position: 'left', beginAtZero: true, max: 120, grid: { color: '#f3f4f6' }, ticks: { callback: (v) => formatPercent(v) }, title: { display: true, text: 'Í∞ÄÎèôÏú®/ÏñëÌíàÏú®', color: '#64748b', font: { size: 11 } } },
              y1: { type: 'linear', position: 'right', beginAtZero: true, max: 100, grid: { display: false }, ticks: { callback: (v) => formatPercent(v), color: '#fca5a5' }, title: { display: true, text: 'OEE', color: '#fca5a5', font: { size: 11, weight: 'bold' } } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // ÏõîÎ≥Ñ OEE Ï∞®Ìä∏ (ÎßâÎåÄ: 3ÎåÄ ÏßÄÌëú, Í∫æÏùÄÏÑ†: OEE Î≥¥Ï°∞Ï∂ï)
      const monthlyOeeCanvas = document.getElementById('monthlyOeeChart');
      if (monthlyOeeCanvas) {
        const monthlyData = getMonthlyOEEData(filteredData);
        charts.monthlyOee = new Chart(monthlyOeeCanvas, {
          type: 'bar',
          data: {
            labels: monthlyData.map(d => d.label),
            datasets: [
              { label: 'ÏãúÍ∞ÑÍ∞ÄÎèôÏú®', data: monthlyData.map(d => d.availability !== null ? parseFloat(d.availability) : null), backgroundColor: '#e2e8f0', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'ÏÑ±Îä•Í∞ÄÎèôÏú®', data: monthlyData.map(d => d.performance !== null ? parseFloat(d.performance) : null), backgroundColor: '#cbd5e1', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'ÏñëÌíàÏú®', data: monthlyData.map(d => d.quality !== null ? parseFloat(d.quality) : null), backgroundColor: '#bfdbfe', borderRadius: 4, yAxisID: 'y', order: 2 },
              { label: 'OEE (%)', data: monthlyData.map(d => d.oee !== null ? parseFloat(d.oee) : null), type: 'line', borderColor: '#fca5a5', borderWidth: 3, fill: false, pointRadius: 8, pointBackgroundColor: '#fca5a5', pointBorderColor: '#fff', pointBorderWidth: 2, tension: 0.3, yAxisID: 'y1', order: 1 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 40, right: 10 } },
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
              datalabels: {
                anchor: 'end',
                align: 'top',
                offset: 4,
                color: '#fca5a5',
                font: { size: 11, weight: 'bold' },
                formatter: (value, ctx) => value !== null ? formatPercent(value) : '',
                display: (ctx) => ctx.datasetIndex === 3 && ctx.dataset.data[ctx.dataIndex] !== null
              }
            },
            scales: {
              y: { type: 'linear', position: 'left', beginAtZero: true, max: 120, grid: { color: '#f3f4f6' }, ticks: { callback: (v) => formatPercent(v) }, title: { display: true, text: 'Í∞ÄÎèôÏú®/ÏñëÌíàÏú® (%)', color: '#64748b', font: { size: 11 } } },
              y1: { type: 'linear', position: 'right', beginAtZero: true, max: 100, grid: { display: false }, ticks: { callback: (v) => formatPercent(v), color: '#fca5a5' }, title: { display: true, text: 'OEE (%)', color: '#fca5a5', font: { size: 11, weight: 'bold' } } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // ÌíàÏßà Ï∞®Ìä∏
      const qualityCanvas = document.getElementById('qualityChart');
      if (qualityCanvas) {
        const processData = getProcessData(filteredData);
        charts.quality = new Chart(qualityCanvas, {
          type: 'bar',
          data: {
            labels: processData.map(d => d.process),
            datasets: [
              { label: 'Î∂àÎüâ', data: processData.map(d => d.defect), backgroundColor: '#fecaca', borderRadius: 4, yAxisID: 'y' },
              { label: 'ÌèêÍ∏∞', data: processData.map(d => d.disposal), backgroundColor: '#fde8e8', borderRadius: 4, yAxisID: 'y' },
              { label: 'ÏàòÏú®(%)', data: processData.map(d => parseFloat(d.yieldRate)), type: 'line', borderColor: '#93c5fd', borderWidth: 3, fill: false, yAxisID: 'y1', pointRadius: 5, pointBackgroundColor: '#93c5fd', pointBorderColor: '#fff', pointBorderWidth: 2 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 30 } },
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
              datalabels: {
                anchor: 'end',
                align: 'end',
                color: '#374151',
                font: { size: 10, weight: '600' },
                formatter: (value, ctx) => ctx.dataset.label === 'ÏàòÏú®(%)' ? formatPercent(value) : formatCompact(value)
              }
            },
            scales: {
              y: { beginAtZero: true, position: 'left', grid: { color: '#f3f4f6' }, ticks: { callback: v => formatNumber(v) } },
              y1: { beginAtZero: false, min: 80, max: 100, position: 'right', grid: { drawOnChartArea: false } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      // Í≥µÏ†ï ÏÉÅÏÑ∏ Ï∞®Ìä∏Îì§
      if (state.activeProcess) {
        const processName = processDataMapping[state.activeProcess];
        const processFilteredData = filteredData.filter(d => d.process === processName);
        const processInfo = processMenus.find(p => p.id === state.activeProcess);
        const dailyData = getDailyData(processFilteredData);

        // ÏÑ§ÎπÑÎ≥Ñ ÏßëÍ≥Ñ
        const equipmentData = {};
        processFilteredData.forEach(row => {
          if (!equipmentData[row.equipment]) {
            equipmentData[row.equipment] = { equipment: row.equipment, production: 0, good: 0, defect: 0 };
          }
          equipmentData[row.equipment].production += row.productionQty;
          equipmentData[row.equipment].good += row.goodQty;
          equipmentData[row.equipment].defect += row.defectQty;
        });
        const equipments = Object.values(equipmentData);

        // ÏùºÎ≥Ñ Ï∞®Ìä∏
        const processDetailDailyCanvas = document.getElementById('processDetailDailyChart');
        if (processDetailDailyCanvas) {
          charts.processDetailDaily = new Chart(processDetailDailyCanvas, {
            type: 'bar',
            data: {
              labels: dailyData.map(d => d.date.slice(5)),
              datasets: [
                { label: 'ÏÉùÏÇ∞', data: dailyData.map(d => d.production), backgroundColor: '#bfdbfe', borderRadius: 4, barPercentage: 0.6 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 25 } },
              plugins: {
                legend: { display: false },
                datalabels: {
                  anchor: 'end',
                  align: 'end',
                  color: '#374151',
                  font: { size: 10, weight: '600' },
                  formatter: (value) => formatCompact(value),
                  display: (ctx) => ctx.dataIndex % 2 === 0
                }
              },
              scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { callback: (v) => formatCompact(v) } },
                x: { grid: { display: false } }
              }
            }
          });
        }

        // ÏÑ§ÎπÑÎ≥Ñ Ï∞®Ìä∏ - Ï†ÑÏ≤¥ ÏÑ§ÎπÑ (1Ìò∏Í∏∞~Ïàú Ï†ïÎ†¨) + ÏàòÏú® ÎùºÏù∏
        const processDetailEquipmentCanvas = document.getElementById('processDetailEquipmentChart');
        if (processDetailEquipmentCanvas) {
          // Ï†ÑÏ≤¥ ÏÑ§ÎπÑ (1Ìò∏Í∏∞~Ïàú Ï†ïÎ†¨)
          const sortedEquipments = sortEquipments(equipments);
          const equipLabels = sortedEquipments.map(e => e.equipment.replace(/_.*/, ''));
          const yieldRates = sortedEquipments.map(e => (e.good / e.production * 100).toFixed(1));

          charts.processDetailEquipment = new Chart(processDetailEquipmentCanvas, {
            type: 'bar',
            data: {
              labels: equipLabels,
              datasets: [
                {
                  label: 'ÏñëÌíà',
                  data: sortedEquipments.map(e => e.good),
                  backgroundColor: '#93c5fd',
                  borderRadius: 4,
                  barPercentage: 0.8,
                  yAxisID: 'y'
                },
                {
                  label: 'ÏàòÏú®(%)',
                  data: yieldRates,
                  type: 'line',
                  borderColor: '#fca5a5',
                  backgroundColor: '#fca5a5',
                  borderWidth: 2,
                  pointRadius: 3,
                  pointBackgroundColor: '#fff',
                  pointBorderWidth: 2,
                  tension: 0.3,
                  yAxisID: 'y1'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 20 } },
              plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
                datalabels: {
                  display: (ctx) => ctx.datasetIndex === 1,
                  anchor: 'end',
                  align: 'top',
                  offset: 4,
                  color: '#dc2626',
                  font: { size: 9, weight: '600' },
                  formatter: (value) => formatPercent(value)
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: '#f3f4f6' },
                  ticks: { callback: (v) => formatCompact(v) },
                  title: { display: true, text: 'ÏñëÌíàÏàòÎüâ', font: { size: 11 }, color: '#64748b' }
                },
                y1: {
                  position: 'right',
                  min: 80,
                  max: 100,
                  grid: { display: false },
                  ticks: { callback: (v) => formatPercent(v) },
                  title: { display: true, text: 'ÏàòÏú®', font: { size: 11 }, color: '#fca5a5' }
                },
                x: { grid: { display: false }, ticks: { font: { size: 10 } } }
              }
            }
          });
        }

        // UPH Ï∞®Ìä∏
        const uphCanvas = document.getElementById('uphChart');
        if (uphCanvas) {
          charts.uph = new Chart(uphCanvas, {
            type: 'bar',
            data: {
              labels: dailyData.map(d => d.date.slice(5)),
              datasets: [
                { label: 'UPH', data: dailyData.map(d => Math.round(d.production / 8)), backgroundColor: '#bfdbfe', borderRadius: 4, barPercentage: 0.6 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 30 } },
              plugins: {
                legend: { display: false },
                datalabels: {
                  ...dataLabelOptions,
                  display: (ctx) => ctx.dataIndex % 2 === 0
                }
              },
              scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { callback: (v) => formatCompact(v) } },
                x: { grid: { display: false } }
              }
            }
          });
        }

        // Cycle Time Ï∞®Ìä∏ - CT ÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò (ÏÑ§ÎπÑÎ≥Ñ ÌëúÏ§Ä CT ÎåÄÎπÑ Ïã§Ï†Å ÎπÑÍµê)
        const cycleTimeCanvas = document.getElementById('cycleTimeChart');
        if (cycleTimeCanvas) {
          // CT Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í
          let ctChartData = [];
          const currentProcessId = state.activeProcess;
          const currentProcessName = processDataMapping[currentProcessId] || currentProcessId;

          if (state.ctData && state.ctData.length > 0) {
            // ÌòÑÏû¨ Í≥µÏ†ïÏóê ÎßûÎäî CT Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ (ÌïúÍ∏Ä Í≥µÏ†ïÎ™ÖÏúºÎ°ú Îß§Ïπ≠)
            const filteredCT = state.ctData.filter(d => d.process === currentProcessName);

            // ÏÑ§ÎπÑÎ≥ÑÎ°ú Í∑∏Î£πÌïëÌïòÏó¨ ÌèâÍ∑† Í≥ÑÏÇ∞ (Ï†ÑÏ≤¥ ÏÑ§ÎπÑÎ™Ö Ïú†ÏßÄ)
            const equipmentMap = {};
            filteredCT.forEach(d => {
              // Ï†ÑÏ≤¥ ÏÑ§ÎπÑÎ™Ö ÏÇ¨Ïö© (Ïòà: ÎèÑÏû•_X,Y_1Ìò∏Í∏∞, ÎèÑÏû•_SPINDLE_2Ìò∏Í∏∞)
              const equipName = d.equipment;
              if (!equipmentMap[equipName]) {
                equipmentMap[equipName] = { standardCT: [], actualCT: [], efficiency: [], count: 0 };
              }
              if (d.standardCT > 0) equipmentMap[equipName].standardCT.push(d.standardCT);
              if (d.actualCT > 0) equipmentMap[equipName].actualCT.push(d.actualCT);
              if (d.efficiency > 0) equipmentMap[equipName].efficiency.push(d.efficiency);
              equipmentMap[equipName].count++;
            });

            // Î∞∞Ïó¥Î°ú Î≥ÄÌôòÌïòÍ≥† Ìò∏Í∏∞Ïàú Ï†ïÎ†¨
            ctChartData = Object.entries(equipmentMap).map(([name, data]) => ({
              equipment: name,
              standardCT: data.standardCT.length > 0 ? (data.standardCT.reduce((a,b) => a+b, 0) / data.standardCT.length) : 0,
              actualCT: data.actualCT.length > 0 ? (data.actualCT.reduce((a,b) => a+b, 0) / data.actualCT.length) : 0,
              efficiency: data.efficiency.length > 0 ? (data.efficiency.reduce((a,b) => a+b, 0) / data.efficiency.length) : 0
            })).filter(d => d.actualCT > 0).sort((a, b) => {
              // Ìò∏Í∏∞ Î≤àÌò∏ Ï∂îÏ∂úÌïòÏó¨ Ï†ïÎ†¨
              const numA = parseInt(a.equipment.match(/(\d+)Ìò∏Í∏∞/)?.[1] || '999');
              const numB = parseInt(b.equipment.match(/(\d+)Ìò∏Í∏∞/)?.[1] || '999');
              return numA - numB;
            });
          }

          // CT Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ÑÌòÄ ÏóÜÏùÑ ÎïåÎßå ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© (ÏóÖÎ°úÎìúÌñàÎäîÎç∞ Ìï¥Îãπ Í≥µÏ†ï Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Ï∞®Ìä∏ ÏïàÍ∑∏Î¶º)
          if (ctChartData.length === 0 && (!state.ctData || state.ctData.length === 0)) {
            const ctSortedEquipments = sortEquipments(equipments);
            ctChartData = ctSortedEquipments.map(e => {
              const stdCT = 11 + Math.random() * 2;
              const actCT = stdCT - 0.5 + Math.random() * 1.5;
              return {
                equipment: e.equipment,  // Ï†ÑÏ≤¥ ÏÑ§ÎπÑÎ™Ö ÏÇ¨Ïö©
                standardCT: stdCT,
                actualCT: actCT,
                efficiency: (stdCT / actCT * 100)
              };
            });
          }

          // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Ï∞®Ìä∏ Í∑∏Î¶¨ÏßÄ ÏïäÏùå
          if (ctChartData.length === 0) return;

          const ctLabels = ctChartData.map(d => d.equipment);
          const standardCTData = ctChartData.map(d => d.standardCT.toFixed(1));
          const actualCTData = ctChartData.map(d => d.actualCT.toFixed(1));
          const efficiencyData = ctChartData.map(d => d.efficiency.toFixed(1));
          // Ìö®Ïú® 100% ÎØ∏Îßå(Ïã§Ï†úCTÍ∞Ä ÌëúÏ§ÄÎ≥¥Îã§ ÌÅ∞ Í≤ΩÏö∞) = Îπ®Í∞ï, 100% Ïù¥ÏÉÅ = ÌååÎûë
          const ctColors = efficiencyData.map(eff => parseFloat(eff) < 100 ? 'rgba(252, 165, 165, 0.7)' : 'rgba(147, 197, 253, 0.7)');

          charts.cycleTime = new Chart(cycleTimeCanvas, {
            type: 'bar',
            data: {
              labels: ctLabels,
              datasets: [
                {
                  label: 'Ïã§Ï†ú CT',
                  data: actualCTData,
                  backgroundColor: ctColors,
                  borderColor: efficiencyData.map(eff => parseFloat(eff) < 100 ? '#fca5a5' : '#93c5fd'),
                  borderWidth: 1,
                  borderRadius: 4,
                  barPercentage: 0.75
                },
                {
                  label: 'ÌëúÏ§Ä CT',
                  data: standardCTData,
                  type: 'line',
                  borderColor: '#94a3b8',
                  backgroundColor: '#94a3b8',
                  borderWidth: 2,
                  pointRadius: 4,
                  pointStyle: 'rectRot',
                  pointBackgroundColor: '#fff',
                  pointBorderWidth: 2,
                  fill: false
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 25 } },
              plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
                datalabels: {
                  display: true,
                  anchor: (ctx) => ctx.datasetIndex === 0 ? 'end' : 'end',
                  align: (ctx) => ctx.datasetIndex === 0 ? 'top' : 'bottom',
                  offset: (ctx) => ctx.datasetIndex === 0 ? 2 : -2,
                  color: (ctx) => {
                    if (ctx.datasetIndex === 0) {
                      return parseFloat(efficiencyData[ctx.dataIndex]) < 100 ? '#dc2626' : '#059669';
                    }
                    return '#94a3b8';
                  },
                  font: { size: 9, weight: '600' },
                  formatter: (value, ctx) => {
                    if (ctx.datasetIndex === 0) {
                      return efficiencyData[ctx.dataIndex] + '%';
                    }
                    return parseFloat(value) > 0 ? value + 's' : '';
                  },
                  backgroundColor: (ctx) => ctx.datasetIndex === 1 ? 'rgba(255,255,255,0.8)' : 'transparent',
                  borderRadius: 3,
                  padding: (ctx) => ctx.datasetIndex === 1 ? { left: 3, right: 3, top: 1, bottom: 1 } : 0
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  grid: { color: '#f3f4f6' },
                  ticks: { callback: (v) => v + 's' },
                  title: { display: true, text: 'Cycle Time (Ï¥à)', font: { size: 11 }, color: '#64748b' }
                },
                x: { grid: { display: false }, ticks: { font: { size: 9 } } }
              }
            }
          });
        }

        // Í≤ÄÌè¨Ïû• Ï∞®Ìä∏
        const packagingCanvas = document.getElementById('packagingChart');
        if (packagingCanvas) {
          charts.packaging = new Chart(packagingCanvas, {
            type: 'bar',
            data: {
              labels: dailyData.map(d => d.date.slice(5)),
              datasets: [
                { label: 'Í≤ÄÏÇ¨ÏôÑÎ£å', data: dailyData.map(d => d.good), backgroundColor: '#e2e8f0', borderRadius: 4, barPercentage: 0.6 },
                { label: 'Ìè¨Ïû•ÏôÑÎ£å', data: dailyData.map(d => Math.round(d.good * 0.98)), backgroundColor: '#bfdbfe', borderRadius: 4, barPercentage: 0.6 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 30 } },
              plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
                datalabels: {
                  ...dataLabelOptions,
                  display: (ctx) => ctx.datasetIndex === 0 && ctx.dataIndex % 3 === 0
                }
              },
              scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { callback: (v) => formatCompact(v) } },
                x: { grid: { display: false } }
              }
            }
          });
        }

        // Î∂àÎüâÏàòÎ¶¨ Ï∞®Ìä∏
        const defectRepairCanvas = document.getElementById('defectRepairChart');
        if (defectRepairCanvas) {
          const defectTypes = ['Ïô∏Í¥ÄÎ∂àÎüâ', 'ÏπòÏàòÎ∂àÎüâ', 'Í∏∞Îä•Î∂àÎüâ', 'Ï°∞Î¶ΩÎ∂àÎüâ', 'Í∏∞ÌÉÄ'];
          charts.defectRepair = new Chart(defectRepairCanvas, {
            type: 'bar',
            data: {
              labels: defectTypes,
              datasets: [
                { label: 'Î∞úÏÉù', data: defectTypes.map(() => Math.round(Math.random() * 100 + 50)), backgroundColor: '#fecaca', borderRadius: 4 },
                { label: 'ÏàòÎ¶¨ÏôÑÎ£å', data: defectTypes.map(() => Math.round(Math.random() * 80 + 30)), backgroundColor: '#bfdbfe', borderRadius: 4 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 30 } },
              plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
                datalabels: dataLabelOptions
              },
              scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { callback: v => formatNumber(v) } },
                x: { grid: { display: false } }
              }
            }
          });
        }

        // ÏûêÏû¨Î∂àÎüâ Ï∞®Ìä∏
        const materialDefectCanvas = document.getElementById('materialDefectChart');
        if (materialDefectCanvas) {
          const materials = ['PCB', 'Ïª§ÎÑ•ÌÑ∞', 'ÌïòÏö∞Ïßï', 'ÏºÄÏù¥Î∏î', 'Í∏∞ÌÉÄ'];
          charts.materialDefect = new Chart(materialDefectCanvas, {
            type: 'bar',
            data: {
              labels: materials,
              datasets: [
                { label: 'Î∂àÎüâÍ±¥Ïàò', data: materials.map(() => Math.round(Math.random() * 30 + 10)), backgroundColor: '#fecaca', borderRadius: 4 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 30 } },
              plugins: {
                legend: { display: false },
                datalabels: dataLabelOptions
              },
              scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { callback: v => formatNumber(v) } },
                x: { grid: { display: false } }
              }
            }
          });
        }
      }

      // ÎπÑÍ∞ÄÎèôÌòÑÌô© Ï∞®Ìä∏ - if (state.activeProcess) Î∏îÎ°ù Î∞ñÏóêÏÑú Ïã§Ìñâ
      console.log('=== About to create downtime charts ===');

        // ÎπÑÍ∞ÄÎèôÌòÑÌô© Ï∞®Ìä∏Îì§
        // Í≥µÏ†ïÎ≥Ñ ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ Ï∞®Ìä∏
        const downtimeByProcessCanvas = document.getElementById('downtimeByProcessChart');
        console.log('Downtime chart canvas:', downtimeByProcessCanvas, 'Data length:', state.availabilityData.length);
        if (downtimeByProcessCanvas && state.availabilityData.length > 0) {
          try {
          if (charts.downtimeByProcess) charts.downtimeByProcess.destroy();
          const downtimeData = state.availabilityData.map(d => ({
            ...d,
            downtimeMinutes: d.operatingTime - d.runningTime
          }));

          const processSummary = {};
          downtimeData.forEach(d => {
            if (excludedProcesses.includes(d.process)) return;
            if (!processSummary[d.process]) {
              processSummary[d.process] = { totalDowntime: 0, totalOperating: 0 };
            }
            processSummary[d.process].totalDowntime += d.downtimeMinutes;
            processSummary[d.process].totalOperating += d.operatingTime;
          });

          const processLabels = Object.keys(processSummary);
          console.log('Process Labels:', processLabels, 'Process Summary:', processSummary);
          const processColors = {
            'ÏÇ¨Ï∂ú': '#fdba74', 'ÎèÑÏû•': '#7dd3fc', 'Ïù∏ÏáÑ': '#fcd34d', 'Ï°∞Î¶Ω': '#c4b5fd'
          };

          if (processLabels.length === 0) {
            console.warn('No process labels found for downtime chart');
          }

          charts.downtimeByProcess = new Chart(downtimeByProcessCanvas, {
            type: 'bar',
            data: {
              labels: processLabels,
              datasets: [
                {
                  label: 'ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ(h)',
                  data: processLabels.map(p => parseFloat((processSummary[p].totalDowntime / 60).toFixed(1))),
                  backgroundColor: processLabels.map(p => processColors[p] || '#94a3b8'),
                  borderRadius: 6,
                  barPercentage: 0.6
                },
                {
                  label: 'ÎπÑÍ∞ÄÎèôÏú®(%)',
                  data: processLabels.map(p => parseFloat((processSummary[p].totalDowntime / processSummary[p].totalOperating * 100).toFixed(1))),
                  type: 'line',
                  borderColor: '#fca5a5',
                  backgroundColor: '#fca5a5',
                  borderWidth: 3,
                  pointRadius: 6,
                  pointBackgroundColor: '#fff',
                  pointBorderWidth: 2,
                  fill: false,
                  yAxisID: 'y1'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { top: 30 } },
              plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 } },
                datalabels: {
                  display: (ctx) => ctx.datasetIndex === 0,
                  anchor: 'end',
                  align: 'top',
                  color: '#374151',
                  font: { size: 11, weight: '600' },
                  formatter: (value) => value + 'h'
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  position: 'left',
                  grid: { color: '#f3f4f6' },
                  ticks: { callback: (v) => formatNumber(v) },
                  title: { display: true, text: 'ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ (h)', font: { size: 10 }, color: '#64748b' }
                },
                y1: {
                  beginAtZero: true,
                  position: 'right',
                  grid: { display: false },
                  max: 50,
                  title: { display: true, text: 'ÎπÑÍ∞ÄÎèôÏú® (%)', font: { size: 10 }, color: '#fca5a5' },
                  ticks: { callback: (v) => formatPercent(v) }
                },
                x: { grid: { display: false } }
              }
            }
          });
          console.log('Downtime by process chart created successfully');
          } catch (e) {
            console.error('Error creating downtime by process chart:', e);
          }
        }

        // ÏÑ§ÎπÑÎ≥Ñ ÎπÑÍ∞ÄÎèô TOP 10 Ï∞®Ìä∏
        const downtimeByEquipmentCanvas = document.getElementById('downtimeByEquipmentChart');
        console.log('Equipment chart canvas:', downtimeByEquipmentCanvas);
        if (downtimeByEquipmentCanvas && state.availabilityData.length > 0) {
          try {
          if (charts.downtimeByEquipment) charts.downtimeByEquipment.destroy();
          const equipmentDowntime = {};
          state.availabilityData.forEach(d => {
            if (excludedProcesses.includes(d.process)) return;
            const key = `${d.process}_${d.equipment}`;
            if (!equipmentDowntime[key]) {
              equipmentDowntime[key] = { process: d.process, equipment: d.equipment, totalDowntime: 0, totalOperating: 0 };
            }
            equipmentDowntime[key].totalDowntime += (d.operatingTime - d.runningTime);
            equipmentDowntime[key].totalOperating += d.operatingTime;
          });

          const topEquipment = Object.values(equipmentDowntime)
            .sort((a, b) => b.totalDowntime - a.totalDowntime)
            .slice(0, 10);

          const processColors = {
            'ÏÇ¨Ï∂ú': '#fdba74', 'ÎèÑÏû•': '#7dd3fc', 'Ïù∏ÏáÑ': '#fcd34d', 'Ï°∞Î¶Ω': '#c4b5fd'
          };

          charts.downtimeByEquipment = new Chart(downtimeByEquipmentCanvas, {
            type: 'bar',
            data: {
              labels: topEquipment.map(e => e.equipment.length > 12 ? e.equipment.substring(0, 12) + '...' : e.equipment),
              datasets: [{
                label: 'ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ(h)',
                data: topEquipment.map(e => parseFloat((e.totalDowntime / 60).toFixed(1))),
                backgroundColor: topEquipment.map(e => processColors[e.process] || '#94a3b8'),
                borderRadius: 4,
                barPercentage: 0.7
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              layout: { padding: { right: 50 } },
              plugins: {
                legend: { display: false },
                datalabels: {
                  anchor: 'end',
                  align: 'right',
                  color: '#374151',
                  font: { size: 10, weight: '600' },
                  formatter: (value) => value + 'h'
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  grid: { color: '#f3f4f6' },
                  ticks: { callback: (v) => formatNumber(v) },
                  title: { display: true, text: 'ÎπÑÍ∞ÄÎèôÏãúÍ∞Ñ (h)', font: { size: 10 }, color: '#64748b' }
                },
                y: { grid: { display: false }, ticks: { font: { size: 9 } } }
              }
            }
          });
          console.log('Downtime by equipment chart created successfully');
          } catch (e) {
            console.error('Error creating downtime by equipment chart:', e);
          }
        }

      // Î∂àÎüâÏàòÎ¶¨ÌòÑÌô© Ï∞®Ìä∏ (ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò)
      createRepairCharts();

      // ÏûêÏû¨Î∂àÎüâÌòÑÌô© Ï∞®Ìä∏ (ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò)
      createMaterialDefectCharts();

      // Í≤ÄÌè¨Ïû•ÌòÑÌô© Ï∞®Ìä∏ (ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò)
      createPackagingCharts();

      // Ïû¨Í≥µÏû¨Í≥† Ï∞®Ìä∏ (ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò)
      createWipInventoryCharts();

      console.log('=== createCharts completed ===');
      } catch (e) {
        console.error('Error in createCharts:', e);
      }
    }

    // Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ ÏÉÅÌÉú Í¥ÄÎ¶¨
    // Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ ÏÉÅÌÉú (APP_CONFIG.UI.defaultCollapsed Í∏∞Î≥∏Í∞í Ï†ÅÏö©)
    const collapseState = {
      materialDefect: APP_CONFIG.UI.defaultCollapsed,
      repairStatus: APP_CONFIG.UI.defaultCollapsed,
      oee: APP_CONFIG.UI.defaultCollapsed,
      downtime: APP_CONFIG.UI.defaultCollapsed,
      pivot: APP_CONFIG.UI.defaultCollapsed,
      defectType: APP_CONFIG.UI.defaultCollapsed,
      partDefectType: APP_CONFIG.UI.defaultCollapsed,
      packaging: APP_CONFIG.UI.defaultCollapsed,
      wipType: APP_CONFIG.UI.defaultCollapsed,
      wipSpec: APP_CONFIG.UI.defaultCollapsed,
      wipPrice: APP_CONFIG.UI.defaultCollapsed,
      wipHighPrice: APP_CONFIG.UI.defaultCollapsed,
      wipLowPrice: APP_CONFIG.UI.defaultCollapsed,
      ctLowPerf: APP_CONFIG.UI.defaultCollapsed,
      itemDefect: APP_CONFIG.UI.defaultCollapsed
    };

    function toggleCollapse(sectionId) {
      collapseState[sectionId] = !collapseState[sectionId];
      const content = document.getElementById(`collapse-${sectionId}`);
      const toggle = document.getElementById(`toggle-${sectionId}`);
      if (content && toggle) {
        content.classList.toggle('collapsed', collapseState[sectionId]);
        toggle.classList.toggle('collapsed', collapseState[sectionId]);
        toggle.innerHTML = collapseState[sectionId]
          ? `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>ÌéºÏπòÍ∏∞`
          : `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>Ï†ëÍ∏∞`;
      }
    }

    // ÏûêÏû¨Î∂àÎüâ ÌÖåÏù¥Î∏î Ï†ïÎ†¨ ÏÉÅÌÉú
    let materialDefectSortField = null;
    let materialDefectSortAsc = true;

    function sortMaterialDefectTable(field) {
      if (materialDefectSortField === field) {
        materialDefectSortAsc = !materialDefectSortAsc;
      } else {
        materialDefectSortField = field;
        materialDefectSortAsc = true;
      }

      if (state.materialDefectData && state.materialDefectData.length > 0) {
        state.materialDefectData.sort((a, b) => {
          let valA = a[field] || '';
          let valB = b[field] || '';
          if (field === 'defectTotal') {
            valA = parseInt(valA) || 0;
            valB = parseInt(valB) || 0;
          }
          if (valA < valB) return materialDefectSortAsc ? -1 : 1;
          if (valA > valB) return materialDefectSortAsc ? 1 : -1;
          return 0;
        });
        render();
        setTimeout(createCharts, 100);
      }
    }

    // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
    async function handleLogin() {
      const email = document.getElementById('emailInput')?.value;
      const password = document.getElementById('passwordInput')?.value;

      if (!email || !password) {
        alert('Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      const loginBtn = document.getElementById('loginBtn');
      if (loginBtn) {
        loginBtn.disabled = true;
        loginBtn.textContent = 'Î°úÍ∑∏Ïù∏ Ï§ë...';
      }

      const result = await signIn(email, password);

      if (result.success) {
        state.isAuthenticated = true;
        render();
        if (state.rawData.length > 0) {
          setTimeout(() => { createCharts(); initTableSort(); }, 100);
        }
      } else {
        alert('Î°úÍ∑∏Ïù∏ Ïã§Ìå®: ' + result.error);
        if (loginBtn) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'ÏãúÏä§ÌÖú Ï†ëÏÜç';
        }
      }
    }

    async function handleSignUp() {
      const email = document.getElementById('emailInput')?.value;
      const password = document.getElementById('passwordInput')?.value;
      const displayName = document.getElementById('displayNameInput')?.value || email.split('@')[0];

      if (!email || !password) {
        alert('Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      if (password.length < 6) {
        alert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî ÏµúÏÜå 6Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.');
        return;
      }

      const result = await signUp(email, password, displayName);

      if (result.success) {
        alert(result.message);
        toggleAuthMode();
      } else {
        alert('ÌöåÏõêÍ∞ÄÏûÖ Ïã§Ìå®: ' + result.error);
      }
    }

    async function handlePasswordReset() {
      const email = document.getElementById('emailInput')?.value;
      if (!email) {
        alert('Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      const result = await requestPasswordReset(email);
      alert(result.success ? result.message : 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï Ïã§Ìå®: ' + result.error);
    }

    let isSignUpMode = false;
    function toggleAuthMode() {
      isSignUpMode = !isSignUpMode;
      render();
    }

    async function handleLogout(isAutoLogout = false) {
      if (isAutoLogout || confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        await signOut();
        state.isAuthenticated = false;
        currentUser = null;
        userProfile = null;
        render();
      }
    }

    function handleClearData() {
      if (confirm('Ï†ÄÏû•Îêú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        clearStorage();
        alert('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
      }
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Ìé∏Ïßë Í∂åÌïú ÌôïÏù∏
      if (userProfile && !['admin', 'editor'].includes(userProfile.role)) {
        alert('Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        const newData = parseCSV(e.target.result);
        state.rawData = newData;
        saveToStorage(newData);
        render();
        setTimeout(() => { createCharts(); initTableSort(); }, 100);
        alert('Îç∞Ïù¥ÌÑ∞ ' + newData.length + 'Í±¥Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        // Supabase ÎèôÍ∏∞Ìôî Î∞è Î°úÍ∑∏ Í∏∞Î°ù
        if (supabaseConnected) {
          await saveToSupabase('production_data', newData);
          await logAccess('data_upload', { type: 'production_data', count: newData.length, filename: file.name });
        }
      };
      reader.readAsText(file, 'UTF-8');
    }

    function handleAvailabilityUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Ìé∏Ïßë Í∂åÌïú ÌôïÏù∏
      if (userProfile && !['admin', 'editor'].includes(userProfile.role)) {
        alert('Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        const newData = parseAvailabilityCSV(e.target.result);
        state.availabilityData = newData;
        saveAvailabilityToStorage(newData);
        render();
        setTimeout(() => { createCharts(); initTableSort(); }, 100);
        alert('Í∞ÄÎèôÏú® Îç∞Ïù¥ÌÑ∞ ' + newData.length + 'Í±¥Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        // Supabase ÎèôÍ∏∞Ìôî Î∞è Î°úÍ∑∏ Í∏∞Î°ù
        if (supabaseConnected) {
          await saveToSupabase('availability_data', newData);
          await logAccess('data_upload', { type: 'availability_data', count: newData.length, filename: file.name });
        }
      };
      reader.readAsText(file, 'UTF-8');
    }

    function setTab(tab) {
      state.activeTab = tab;
      if (tab !== 'process') {
        state.activeProcess = null;
        state.activeSubMenu = 'production';
      }
      render();
      setTimeout(() => { createCharts(); initTableSort(); }, 100);
    }

    function setWipSubTab(subTab) {
      state.wipSubTab = subTab;
      render();
      setTimeout(() => { createWipInventoryCharts(); initTableSort(); }, 100);
    }

    function setProcess(processId) {
      state.activeTab = 'process';
      state.activeProcess = processId;
      state.activeSubMenu = 'production';  // Í≥µÏ†ï Î≥ÄÍ≤ΩÏãú Í∏∞Î≥∏ ÌïòÏúÑÎ©îÎâ¥Î°ú
      render();
      setTimeout(() => { createCharts(); initTableSort(); }, 100);
    }

    function setSubMenu(subMenuId) {
      state.activeSubMenu = subMenuId;
      render();
      setTimeout(() => { createCharts(); initTableSort(); }, 100);
    }

    function setFilter(key, value) {
      state.filters[key] = value;
      render();
      setTimeout(() => { createCharts(); initTableSort(); }, 100);
    }

    // Î†åÎçîÎßÅ
    function render() {
      const app = document.getElementById('app');
      app.innerHTML = state.isAuthenticated ? renderDashboard() : renderLogin();

      // Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê ÎπÑÎèôÍ∏∞ Î°úÎî©
      if (state.isAuthenticated && state.activeTab === 'admin' && isAdmin()) {
        loadAdminPanel();
      }
    }

    async function loadAdminPanel() {
      const container = document.getElementById('admin-panel-container');
      if (container) {
        const html = await renderAdminPanel();
        container.innerHTML = html;
      }
    }

    // Ï¥àÍ∏∞Ìôî
    async function initApp() {
      // Supabase Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
      await testSupabaseConnection();

      // Í∏∞Ï°¥ ÏÑ∏ÏÖò ÌôïÏù∏ (Supabase Auth)
      if (supabaseConnected) {
        const hasSession = await checkAuthSession();
        if (hasSession) {
          state.isAuthenticated = true;
          await logAccess('session_restored');
          console.log('‚úÖ Í∏∞Ï°¥ ÏÑ∏ÏÖò Î≥µÏõê:', currentUser?.email);
        }
      }

      // Ïù∏Ï¶ùÎêú Í≤ΩÏö∞ÏóêÎßå SupabaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
      if (state.isAuthenticated && supabaseConnected) {
        const loaded = await loadAllFromSupabase();
        if (loaded) {
          console.log('üìä SupabaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å');
        }
      }

      // ÌôîÎ©¥ Î†åÎçîÎßÅ
      render();

      if (state.isAuthenticated && state.rawData.length > 0) {
        setTimeout(() => { createCharts(); initTableSort(); }, 100);
      }
    }

    // Ïï± ÏãúÏûë
    initApp();
  </script>
</body>
</html>
